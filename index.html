<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ademruimte - Evidence-based hulp bij hyperventilatie</title>
    
    <style>
        :root {
            --primary-color: #06b6d4;
            --primary-dark: #0891b2;
            --secondary-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-dark: #374151;
            --text-light: #6b7280;
            --bg-light: #f8fafc;
            --border-color: #e5e7eb;
            --success-color: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .hidden { display: none; }

        /* Authentication Screen */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
        }

        #auth-screen.hidden {
            display: none !important;
        }

        #main-app {
            min-height: 100vh;
            width: 100%;
        }

        #main-app.hidden {
            display: none !important;
        }

        .auth-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 100%;
        }

        .auth-card h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .auth-card p {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 182, 212, 0.4);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin: 1rem 0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 1rem;
            text-align: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 0.5rem;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.7rem 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: var(--primary-color);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            color: var(--text-dark);
            margin-bottom: 1rem;
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Form elements */
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Range inputs */
        .range-input {
            width: 100%;
            margin: 0.5rem 0;
        }

        .range-value {
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 0.5rem;
        }

        /* Breathing Exercise Styles */
        .breathing-container {
            text-align: center;
            padding: 2rem 0;
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            border: 4px solid var(--primary-color);
            border-radius: 50%;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .breathing-circle.inhale {
            transform: scale(1.3);
            background: rgba(6, 182, 212, 0.1);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
        }

        .breathing-circle.exhale {
            transform: scale(0.8);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .breathing-circle.hold {
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.3);
        }

        /* Timer styles */
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 1rem 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Enhanced Insights Styles */
        .insights-container {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .insight-card {
            background: white;
            border-radius: 0.8rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.5s ease-out;
        }

        .insight-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .insight-text {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .insight-recommendation {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary-color);
            font-size: 0.9rem;
        }

        /* Process-focused elements */
        .process-indicator {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .process-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(6, 182, 212, 0.05) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        .process-text {
            color: var(--text-dark);
            font-size: 0.95rem;
            line-height: 1.6;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .cp-auto-fill-notice {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.5rem;
            padding: 0.8rem;
            margin: 0.5rem 0;
            color: #065f46;
            font-size: 0.9rem;
            animation: fadeIn 0.5s ease-out;
        }

        /* Chart container */
        .chart-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* User info */
        .user-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* Message system */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .message.warning {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        /* Tab content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Journal entries */
        .journal-entry {
            background: var(--bg-light);
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.3s ease-out;
        }

        .journal-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .journal-entry-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .journal-entry-technique {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Crisis protocol styles */
        .crisis-step {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid #f87171;
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .crisis-step.active {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: var(--primary-color);
        }

        .crisis-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .crisis-instructions {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header-title h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .tab-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .breathing-circle {
                width: 150px;
                height: 150px;
                font-size: 1rem;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-title h1 {
                font-size: 1.8rem;
            }
            
            .header-title p {
                font-size: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .breathing-circle {
                width: 120px;
                height: 120px;
                font-size: 0.9rem;
            }
        }

        /* Accessibility improvements */
        .btn:focus,
        .form-control:focus,
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .tab-btn:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .card {
                border: 2px solid var(--text-dark);
            }
            
            .btn {
                border: 2px solid currentColor;
            }
            
            .breathing-circle {
                border-width: 3px;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .breathing-circle,
            .btn,
            .stat-card,
            .tab-content,
            .insight-card,
            .journal-entry {
                animation: none;
                transition: none;
            }
            
            .breathing-circle.inhale,
            .breathing-circle.exhale,
            .breathing-circle.hold {
                transform: none;
                box-shadow: none;
            }
            
            .stat-card:hover,
            .btn:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <div id="login-form">
                <h2>Inloggen bij Ademruimte</h2>
                <p>Vul je gegevens in om door te gaan</p>
                
                <div class="form-group">
                    <label for="login-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="login-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Wachtwoord" required>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <input type="checkbox" id="remember-me" style="margin: 0; flex-shrink: 0;">
                    <label for="remember-me" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Onthoud mij</label>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="login-btn" onclick="loginUser()" style="width: 100%;">
                        <span>üîë Inloggen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1rem; font-size: 0.875rem; text-align: center;">
                    <button onclick="showPasswordResetForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; text-decoration: underline;">Wachtwoord vergeten?</button>
                </p>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem; text-align: center;">
                    Nog geen account? 
                    <button onclick="showRegisterForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Registreren</button>
                </p>
            </div>
            
            <div id="register-form" class="hidden">
                <h2>Account Aanmaken</h2>
                <p>Maak een nieuw account aan voor Ademruimte</p>
                
                <div class="form-group">
                    <label for="register-name">Volledige naam:</label>
                    <input type="text" class="form-control" id="register-name" placeholder="Je naam" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="register-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password" placeholder="Minimaal 6 karakters" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password-confirm">Bevestig wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password-confirm" placeholder="Herhaal wachtwoord" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="register-btn" onclick="registerUser()" style="width: 100%;">
                        <span>‚úÖ Account Aanmaken</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem; text-align: center;">
                    Al een account? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
            
            <div id="password-reset-form" class="hidden">
                <h2>Wachtwoord Resetten</h2>
                <p>Vul je e-mailadres in om een reset link te ontvangen</p>
                
                <div class="form-group">
                    <label for="reset-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="reset-email" placeholder="je@email.com" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-warning" id="reset-btn" onclick="resetPassword()" style="width: 100%;">
                        <span>üìß Reset Link Versturen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem; text-align: center;">
                    Weet je je wachtwoord weer? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header>
            <div class="user-info" id="user-info">
                <div class="spinner"></div>
            </div>
            <div class="header-title">
                <h1>Ademruimte</h1>
                <p>Evidence-based hulp bij hyperventilatie en maagklachten</p>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">üè† Dashboard</button>
            <button class="tab-btn" data-tab="buteyko">üí® Buteyko</button>
            <button class="tab-btn" data-tab="dagboek">üìä Dagboek</button>
            <button class="tab-btn" data-tab="crisis">üö® Crisis Hulp</button>
        </nav>

        <main class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 id="dashboard-greeting">Welkom bij Ademruimte</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Op basis van wetenschappelijk onderzoek biedt Ademruimte effectieve hulp bij hyperventilatie en gerelateerde maagklachten. 
                        <strong>70-80% van de pati√´nten</strong> behaalt significante verbetering met de juiste technieken.
                    </p>
                    
                    <div class="process-indicator">
                        <h3 style="margin-bottom: 0.8rem; color: var(--primary-color);">üå± Over Herstel en Geduld</h3>
                        <p class="process-text">
                            Chronische hyperventilatie ontwikkelt zich vaak over jaren. Herstel is een geleidelijk proces dat tijd nodig heeft. 
                            Elke oefening draagt bij aan je herstel, ook al merk je niet altijd onmiddellijke verbetering. 
                            Focus op consistentie en geduld - de grootste vooruitgang gebeurt over weken en maanden, niet minuten.
                        </p>
                    </div>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">-</div>
                            <div class="stat-label">Gem. verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="last-cp">-</div>
                            <div class="stat-label">Laatste CP</div>
                        </div>
                    </div>

                    <!-- Enhanced Insights Section -->
                    <div class="insights-container" id="insights-container">
                        <h3 style="text-align: center; margin-bottom: 1rem; color: var(--primary-color);">
                            üß† Psychotherapeutische Inzichten
                        </h3>
                        <p style="text-align: center; color: var(--text-light); margin-bottom: 1.5rem;">
                            Gebaseerd op bewezen cognitieve en mindfulness principes
                        </p>
                        <div class="insights-grid" id="insights-grid">
                            <div class="insight-card">
                                <div class="insight-icon">üìà</div>
                                <div class="insight-text">Begin met een paar sessies om inzichten te genereren</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button onclick="showTab('buteyko')" class="btn btn-primary">üí® Start Buteyko Oefening</button>
                        <button onclick="showTab('dagboek')" class="btn btn-success">üìù Dagboek Bijwerken</button>
                        <button onclick="showTab('crisis')" class="btn btn-danger">üö® Crisis Hulp</button>
                    </div>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content">
                <div class="card">
                    <h2>üí® Buteyko Ademhalingsoefeningen</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        De Buteyko methode helpt je ademhaling te normaliseren en hyperventilatie te verminderen.
                        <strong>Regelmatige beoefening</strong> is essentieel voor langdurige verbetering.
                    </p>

                    <!-- CP Measurement Section -->
                    <div class="card" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">‚è±Ô∏è Controle Pauze (CP) Meting</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--text-dark);">
                            Meet je CO2 tolerantie. Stop bij de eerste neiging om adem te halen (niet bij ongemak).
                        </p>
                        
                        <div class="breathing-container">
                            <div class="timer-display" id="cp-timer">00</div>
                            <div class="button-group">
                                <button id="start-cp" onclick="startCPMeasurement()" class="btn btn-primary">Start CP Meting</button>
                                <button id="stop-cp" onclick="stopCPMeasurement()" class="btn btn-success" disabled>Stop</button>
                                <button onclick="resetCPMeasurement()" class="btn btn-warning">Reset</button>
                            </div>
                        </div>
                        
                        <div id="cp-interpretation" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; display: none;">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">Interpretatie:</h4>
                            <p id="cp-interpretation-text"></p>
                        </div>
                    </div>

                    <!-- Breathing Exercise Section -->
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">ü´Å Ademhalingsoefening</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Kies je oefening:</label>
                            <select id="breathing-pattern" class="form-select" onchange="updatePatternDescription()">
                                <option value="gentle">Zachte Ademhaling (Beginners)</option>
                                <option value="standard">Standaard 4-7-8</option>
                                <option value="advanced">Gevorderd 6-10-12</option>
                            </select>
                        </div>
                        
                        <div id="pattern-description" class="message" style="background: var(--bg-light); border: none;">
                            10 sec vrij ademhalen (2x in/uit) + 3 sec vasthouden
                        </div>

                        <div class="breathing-container">
                            <div class="breathing-circle" id="breathing-circle">Klaar om te beginnen</div>
                            <div id="breathing-instruction" style="font-size: 1.2rem; margin: 1rem 0; min-height: 2rem;">
                                Klik op 'Start' om te beginnen
                            </div>
                            <div id="cycle-counter" style="font-size: 1rem; color: var(--text-light);">
                                Cyclus: 0 / 0
                            </div>
                        </div>

                        <div class="button-group">
                            <button id="start-breathing" onclick="startBreathingExercise()" class="btn btn-primary">Start Oefening</button>
                            <button id="stop-breathing" onclick="stopBreathingExercise()" class="btn btn-danger" disabled>Stop</button>
                            <button onclick="openDagboekModal('Buteyko')" class="btn btn-success">üìù Bijwerken Dagboek</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content">
                <div class="card">
                    <h2>üìä Ademhaling Dagboek</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Houd je vooruitgang bij en ontdek patronen in je herstelproces.
                    </p>

                    <div class="button-group">
                        <button onclick="openDagboekModal('Buteyko')" class="btn btn-primary">‚ûï Nieuwe Entry</button>
                        <button onclick="exportDagboek()" class="btn btn-success">üíæ Exporteer</button>
                    </div>

                    <!-- Chart Section -->
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 1rem;">üìà Vooruitgang Visualisatie</h3>
                        <div class="button-group">
                            <button id="chart-10days" onclick="updateChartFilter('10days')" class="btn btn-primary active">Laatste 10 dagen</button>
                            <button id="chart-30days" onclick="updateChartFilter('30days')" class="btn btn-primary">Laatste 30 dagen</button>
                            <button id="chart-all" onclick="updateChartFilter('all')" class="btn btn-primary">Alle data</button>
                        </div>
                        <canvas id="progress-chart" width="400" height="200"></canvas>
                        <div id="chart-empty" style="text-align: center; color: var(--text-light); display: none;">
                            Nog geen data om weer te geven. Voeg een dagboekentry toe!
                        </div>
                    </div>

                    <!-- Journal Entries -->
                    <div id="journal-entries">
                        <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                            <p>Nog geen dagboek entries. Klik op "Nieuwe Entry" om te beginnen!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crisis Tab -->
            <div id="crisis" class="tab-content">
                <div class="card">
                    <h2 style="color: var(--danger-color);">üö® Crisis Ademhaling Protocol</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Voor acute hyperventilatie episodes. <strong>Dit protocol helpt onmiddellijk</strong> bij paniekaanvallen en hyperventilatie.
                    </p>

                    <div class="message warning">
                        <strong>‚ö†Ô∏è Belangrijk:</strong> Bij ernstige symptomen, contact altijd je arts of bel 112.
                    </div>

                    <div class="crisis-step active" id="crisis-display">
                        <div class="crisis-title">üõë Klaar voor Crisis Protocol</div>
                        <div class="crisis-instructions">
                            Klik op "Start Crisis Protocol" wanneer je een hyperventilatie aanval voelt opkomen.
                            Dit protocol duurt ongeveer 4 minuten en helpt je ademhaling te normaliseren.
                        </div>
                        <button onclick="startCrisisProtocol()" class="btn btn-danger">Start Crisis Protocol</button>
                    </div>

                    <div class="timer-display" id="crisis-timer" style="display: none;">00:00</div>
                    
                    <div class="button-group" id="crisis-controls" style="display: none;">
                        <button onclick="stopCrisisProtocol()" class="btn btn-warning">Stoppen</button>
                        <button onclick="nextCrisisStep()" class="btn btn-primary">Volgende Stap</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Dagboek Modal -->
    <div id="dagboek-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Dagboek Entry Toevoegen</h3>
                <span class="close" onclick="closeDagboekModal()">&times;</span>
            </div>
            
            <form id="dagboek-form">
                <div class="form-group">
                    <label class="form-label">Techniek gebruikt:</label>
                    <select id="entry-technique" class="form-select">
                        <option value="Buteyko">Buteyko Ademhaling</option>
                        <option value="4-7-8">4-7-8 Ademhaling</option>
                        <option value="Crisis Protocol">Crisis Protocol</option>
                        <option value="Andere">Andere</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Duur (minuten):</label>
                    <input type="number" id="entry-duration" class="form-input" min="1" max="120" value="10">
                </div>

                <!-- Enhanced Intensity Section with Process Focus -->
                <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 0.8rem; margin: 1.5rem 0;">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">üí° Focus op het Proces</h4>
                    <p style="color: var(--text-dark); font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem;">
                        Bij chronische hyperventilatie gaat het om langdurige, geleidelijke verbetering. 
                        Een "slechte" sessie betekent niet dat je niet vooruitgaat. Elke oefening helpt je hersenen 
                        om nieuwe ademhalingspatronen aan te leren, ook als je het niet direct merkt.
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Gevoel v√≥√≥r oefening (1-10):</label>
                    <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before" oninput="updateRangeValue('entry-before')">
                    <div class="range-value" id="entry-before-value">5</div>
                    <small style="color: var(--text-light);">1 = Zeer ontspannen, 10 = Zeer benauwd/angstig</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Gevoel n√° oefening (1-10):</label>
                    <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after" oninput="updateRangeValue('entry-after')">
                    <div class="range-value" id="entry-after-value">5</div>
                    <small style="color: var(--text-light);">1 = Zeer ontspannen, 10 = Zeer benauwd/angstig</small>
                </div>

                <!-- Enhanced CP Score field with auto-fill -->
                <div class="form-group" id="cp-score-group" style="display: none;">
                    <label class="form-label">Controle Pauze Score (seconden):</label>
                    <input type="number" id="entry-cp-score" class="form-input" placeholder="bijv. 25" min="1" max="300">
                    <div id="cp-auto-fill-notice" class="cp-auto-fill-notice" style="display: none;">
                        ‚úÖ CP score automatisch ingevuld van je laatste meting
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Korte reflectie:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op? Hoe voelde de oefening? Welke gedachten kwamen er op?"></textarea>
                    <small style="color: var(--text-light);">
                        Tip: Beschrijf wat je opviel, ook als er weinig veranderde. Kleine observaties zijn waardevol!
                    </small>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üíæ Opslaan</button>
                    <button type="button" onclick="closeDagboekModal()" class="btn" style="background: var(--text-light); color: white;">Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
            authDomain: "ademruimte.vercel.app", 
            projectId: "ademruimte-12c09",
            storageBucket: "ademruimte-12c09.firebasestorage.app",
            messagingSenderId: "744941871331",
            appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
            measurementId: "G-SD2ZEYNMNY"
        };

        // Global variables
        let app, auth, db, currentUser = null;
        let currentTab = 'dashboard';
        let allJournalEntries = [];
        let allCPMeasurements = [];
        let progressChart = null;
        let chartFilter = '10days';

        // Breathing exercise variables
        let breathInterval = null;
        let breathPhase = 'rest';
        let breathCycleCount = 0;
        let breathingPattern = 'gentle';
        let isBreathing = false;

        // CP measurement variables
        let cpInterval = null;
        let cpStartTime = 0;
        let cpIsRunning = false;
        let lastCPScore = null;

        // Crisis variables
        let crisisInterval = null;
        let crisisProtocolActive = false;
        let crisisStep = 0;
        let crisisTimer = 0;

        // Enhanced user stats with better streak calculation
        let userStats = {
            totalSessions: 0,
            streakDays: 0,
            lastSessionDate: null,
            cpMeasurements: [],
            achievements: [],
            lastCPDate: null
        };

        // Crisis protocol steps
        const crisisProtocolSteps = [
            {
                name: "Stop & Erken",
                duration: 30,
                title: "üõë STOP - Je bent veilig",
                instructions: "Dit is hyperventilatie en het gaat voorbij. Leg je hand op je buik en voel je ademhaling.",
                breathingText: "Voel je buik...",
                encouragement: "Je bent veilig. Dit gevoel is tijdelijk."
            },
            {
                name: "Paradoxale Ademhaling", 
                duration: 90,
                title: "ü´Å Minder Ademhalen",
                instructions: "NIET diep ademen! Neem kleine, ondiepe ademhalingen. Houd je adem 2-3 seconden vast tussen elke ademhaling.",
                breathingText: "Klein inademen...",
                encouragement: "Perfect! Minder ademen helpt je CO2 te herstellen."
            },
            {
                name: "Grounding 5-4-3-2-1",
                duration: 60, 
                title: "üëÅÔ∏è Focus naar Buiten",
                instructions: "Kijk om je heen en benoem: 5 dingen die je ZIET, 4 dingen die je VOELT, 3 dingen die je HOORT.",
                breathingText: "Kijk om je heen...",
                encouragement: "Je hersenen komen terug in balans. Goed bezig!"
            },
            {
                name: "Rustgevende Ademhaling",
                duration: 60,
                title: "üåä Natuurlijke Ademhaling", 
                instructions: "Laat je ademhaling nu natuurlijk worden. Voel hoe je lichaam ontspant.",
                breathingText: "Natuurlijk ademhalen...",
                encouragement: "Geweldig! Je hebt de crisis succesvol doorstaan."
            }
        ];

        // Breathing patterns
        const breathingPatterns = {
            gentle: { freeBreathing: 10, hold: 3, cycles: 20, description: "10 sec vrij ademhalen (2x in/uit) + 3 sec vasthouden" },
            standard: { inhale: 4, hold: 7, exhale: 8, cycles: 10, description: "4-7-8 standaard patroon" },
            advanced: { inhale: 6, hold: 10, exhale: 12, cycles: 8, description: "6-10-12 gevorderd patroon" }
        };

        // Initialize app
        async function initializeApp() {
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
                const { getAuth, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        showMainApp();
                        loadUserData();
                    } else {
                        currentUser = null;
                        showAuthScreen();
                    }
                });

                setupEventListeners();
                updatePatternDescription();
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showUserMessage('Firebase kon niet worden geladen. Sommige functies werken mogelijk niet.', 'warning');
            }
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    showTab(tab);
                });
            });

            // Form submissions
            document.getElementById('dagboek-form').addEventListener('submit', handleDagboekSubmit);

            // Range input updates
            document.getElementById('entry-before').addEventListener('input', () => updateRangeValue('entry-before'));
            document.getElementById('entry-after').addEventListener('input', () => updateRangeValue('entry-after'));

            // Show CP score field for Buteyko entries
            document.getElementById('entry-technique').addEventListener('change', function() {
                const cpGroup = document.getElementById('cp-score-group');
                if (this.value === 'Buteyko') {
                    cpGroup.style.display = 'block';
                    // Auto-fill CP score if available
                    autoFillCPScore();
                } else {
                    cpGroup.style.display = 'none';
                }
            });
        }

        // Enhanced CP score auto-fill function
        function autoFillCPScore() {
            const cpScoreInput = document.getElementById('entry-cp-score');
            const autoFillNotice = document.getElementById('cp-auto-fill-notice');
            
            if (lastCPScore && lastCPScore > 0) {
                cpScoreInput.value = lastCPScore;
                autoFillNotice.style.display = 'block';
            } else {
                autoFillNotice.style.display = 'none';
            }
        }

        // Authentication functions
        window.showLoginForm = function() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.add('hidden');
            
            // Reset other forms
            document.getElementById('register-name').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-password-confirm').value = '';
            document.getElementById('reset-email').value = '';
        };

        window.showRegisterForm = function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('password-reset-form').classList.add('hidden');
            
            // Reset other forms
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('remember-me').checked = false;
            document.getElementById('reset-email').value = '';
        };

        window.showPasswordResetForm = function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.remove('hidden');
            
            // Reset other forms
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('remember-me').checked = false;
            document.getElementById('register-name').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-password-confirm').value = '';
        };

        window.loginUser = async function() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;

            if (!email || !password) {
                showUserMessage('‚ö†Ô∏è Vul alle velden in', 'warning');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Inloggen...';
            loginBtn.disabled = true;

            try {
                const { signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                
                // Set persistence based on remember me checkbox
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                
                await signInWithEmailAndPassword(auth, email, password);
                showUserMessage('‚úÖ Succesvol ingelogd!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = '‚ùå Inloggen mislukt. Controleer je gegevens.';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'üö´ Dit account is uitgeschakeld.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = '‚ùì Geen account gevonden met dit e-mailadres.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'üîê Onjuist wachtwoord. Probeer opnieuw.';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = '‚ùå Ongeldige inloggegevens. Controleer email en wachtwoord.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '‚è±Ô∏è Te veel pogingen. Probeer het later opnieuw.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                        break;
                }
                
                showUserMessage(errorMessage, 'error');
            }

            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        };

        window.registerUser = async function() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            if (!name || !email || !password || !confirmPassword) {
                showUserMessage('‚ö†Ô∏è Vul alle velden in', 'warning');
                return;
            }

            if (password !== confirmPassword) {
                showUserMessage('üîê Wachtwoorden komen niet overeen', 'error');
                return;
            }

            if (password.length < 6) {
                showUserMessage('üîí Wachtwoord moet minimaal 6 karakters lang zijn', 'error');
                return;
            }

            const registerBtn = document.getElementById('register-btn');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Account aanmaken...';
            registerBtn.disabled = true;

            try {
                const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Update the user's display name
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                
                showUserMessage('‚úÖ Account succesvol aangemaakt! Je wordt nu ingelogd.', 'success');
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = '‚ùå Registratie mislukt. Probeer het opnieuw.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'üìß Dit e-mailadres is al in gebruik.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'üö´ E-mail/wachtwoord accounts zijn uitgeschakeld.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'üîí Wachtwoord is te zwak. Kies een sterker wachtwoord.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                        break;
                }
                
                showUserMessage(errorMessage, 'error');
            }

            registerBtn.innerHTML = originalText;
            registerBtn.disabled = false;
        };

        window.resetPassword = async function() {
            const email = document.getElementById('reset-email').value.trim();

            if (!email) {
                showUserMessage('‚ö†Ô∏è Vul je e-mailadres in', 'warning');
                return;
            }

            const resetBtn = document.getElementById('reset-btn');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Versturen...';
            resetBtn.disabled = true;

            try {
                const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                
                await sendPasswordResetEmail(auth, email);
                
                showUserMessage('üìß Wachtwoord reset link verstuurd! Controleer je e-mail.', 'success');
                
                // Auto-switch back to login form after successful reset
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
                
            } catch (error) {
                console.error('Password reset error:', error);
                let errorMessage = '‚ùå Reset mislukt. Probeer het opnieuw.';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = '‚ùì Geen account gevonden met dit e-mailadres.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '‚è±Ô∏è Te veel pogingen. Probeer het later opnieuw.';
                        break;
                }
                
                showUserMessage(errorMessage, 'error');
            }

            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
        };

        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateDashboard();
            updateUserInfo();
        }

        window.showTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            currentTab = tabName;

            // Load data for specific tabs
            if (tabName === 'dagboek') {
                updateJournalEntries();
                createProgressChart();
            }
        };

        // Enhanced dashboard update with better streak calculation
        function updateDashboard() {
            if (!currentUser) return;
            
            // Update greeting
            const greeting = document.getElementById('dashboard-greeting');
            const hour = new Date().getHours();
            let timeGreeting = 'Goedemorgen';
            if (hour >= 12) timeGreeting = 'Goedemiddag';
            if (hour >= 18) timeGreeting = 'Goedenavond';
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'daar';
            const firstName = displayName.includes(' ') ? displayName.split(' ')[0] : displayName;
            
            greeting.textContent = `${timeGreeting}, ${firstName}!`;
            
            // Calculate enhanced stats
            const allCPData = [...userStats.cpMeasurements, ...allCPMeasurements]
                .filter(cp => cp.score !== undefined)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const avgImprovement = allJournalEntries.length > 0 ? 
                allJournalEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / allJournalEntries.length : 0;
            
            const lastCP = allCPData.length > 0 ? allCPData[0].score : null;
            
            // Enhanced streak calculation
            userStats.streakDays = calculateStreak();
            
            // Update stats display
            document.getElementById('total-sessions').textContent = userStats.totalSessions + allJournalEntries.length;
            document.getElementById('streak-days').textContent = userStats.streakDays;
            document.getElementById('avg-improvement').textContent = avgImprovement > 0 ? 
                `+${avgImprovement.toFixed(1)}` : avgImprovement.toFixed(1);
            document.getElementById('last-cp').textContent = lastCP ? `${lastCP}s` : '-';

            // Update insights
            updatePersonalizedInsights();
        }

        // Enhanced personalized insights with psychotherapeutic principles
        function updatePersonalizedInsights() {
            const insightsContainer = document.getElementById('insights-container');
            const insightsGrid = document.getElementById('insights-grid');
            
            if (allJournalEntries.length < 3) {
                insightsGrid.innerHTML = `
                    <div class="insight-card">
                        <div class="insight-icon">üå±</div>
                        <div class="insight-text">Start met enkele sessies om gepersonaliseerde inzichten te krijgen gebaseerd op cognitieve gedragstherapie en mindfulness principes.</div>
                    </div>
                `;
                return;
            }

            const insights = generateEnhancedInsights(allJournalEntries);
            
            let insightsHTML = '';
            insights.forEach(insight => {
                insightsHTML += `
                    <div class="insight-card">
                        <div class="insight-icon">${insight.icon}</div>
                        <div class="insight-text">${insight.text}</div>
                        ${insight.recommendation ? `<div class="insight-recommendation"><strong>Aanbeveling:</strong> ${insight.recommendation}</div>` : ''}
                    </div>
                `;
            });
            
            insightsGrid.innerHTML = insightsHTML;
        }

        // Enhanced insights based on psychotherapeutic principles
        function generateEnhancedInsights(entries) {
            const insights = [];
            const recentEntries = entries.slice(0, 10);
            const allNotes = entries.filter(e => e.notities && e.notities.length > 10);
            
            // 1. Cognitive Behavioral Therapy - Thought Pattern Analysis
            const negativeThoughtPatterns = [
                'lukt niet', 'moeilijk', 'zwaar', 'frustrerend', 'hopeloos', 'geen zin', 'beangstigend',
                'paniek', 'controle kwijt', 'gefaald', 'nutteloos', 'waardeloos'
            ];
            
            const positiveThoughtPatterns = [
                'goed', 'beter', 'gelukt', 'prettig', 'ontspannen', 'kalm', 'succesvol', 'trots',
                'vertrouwen', 'hoop', 'vooruitgang', 'groei', 'leren'
            ];
            
            let negativeCount = 0;
            let positiveCount = 0;
            
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                negativeThoughtPatterns.forEach(pattern => {
                    if (noteText.includes(pattern)) negativeCount++;
                });
                positiveThoughtPatterns.forEach(pattern => {
                    if (noteText.includes(pattern)) positiveCount++;
                });
            });

            // CBT Insight: Cognitive Restructuring
            if (negativeCount > positiveCount && negativeCount >= 3) {
                insights.push({
                    icon: 'üß†',
                    text: `Je notities bevatten vaak uitdagende gedachten. Dit is normaal bij het leren van nieuwe vaardigheden. Cognitieve gedragstherapie leert ons dat gedachten geen feiten zijn.`,
                    recommendation: `Probeer bij negatieve gedachten te vragen: "Is dit echt waar?" en "Wat zou ik tegen een vriend zeggen in deze situatie?"`
                });
            } else if (positiveCount > negativeCount) {
                insights.push({
                    icon: 'üåü',
                    text: `Je reflecties tonen een positieve mindset en groeigerichte houding. Dit is een sterke voorspeller voor succesvol herstel volgens cognitieve gedragstherapie.`,
                    recommendation: `Blijf deze positieve waarnemingen documenteren - ze versterken nieuwe neurale paden voor herstel.`
                });
            }

            // 2. Mindfulness - Present Moment Awareness
            const mindfulnessWords = [
                'voel', 'merk', 'aandacht', 'bewust', 'observeer', 'waarnemen', 'aanwezig',
                'moment', 'nu', 'rustig', 'ademhaling', 'lichaam'
            ];
            
            let mindfulnessScore = 0;
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                mindfulnessWords.forEach(word => {
                    if (noteText.includes(word)) mindfulnessScore++;
                });
            });

            if (mindfulnessScore >= 5) {
                insights.push({
                    icon: 'üßò',
                    text: `Je notities tonen goede mindfulness vaardigheden - je bent bewust van je lichamelijke sensaties en ademhaling. Dit is essentieel voor het doorbreken van automatische hyperventilatie patronen.`,
                    recommendation: `Verdiep je mindfulness door bewust te worden van het moment net voordat hyperventilatie begint.`
                });
            }

            // 3. Behavioral Activation - Activity and Engagement
            const improvementTrend = recentEntries.map(e => e.intensiteitVoor - e.intensiteitNa);
            const avgImprovement = improvementTrend.reduce((a, b) => a + b, 0) / improvementTrend.length;
            
            if (avgImprovement > 1.5) {
                insights.push({
                    icon: 'üìà',
                    text: `Je recente sessies tonen consistente verbetering (gemiddeld ${avgImprovement.toFixed(1)} punten). Dit wijst op effectieve gedragsactivatie - je neemt actie ondanks moeilijke gevoelens.`,
                    recommendation: `Continue met deze frequentie. Onderzoek toont dat consistente oefening binnen 2-3 weken neuroplastische veranderingen veroorzaakt.`
                });
            }

            // 4. Acceptance and Commitment Therapy - Psychological Flexibility
            const acceptanceWords = ['accepteer', 'toelaten', 'ok√©', 'loslaten', 'ermee leven', 'waarden', 'belangrijk'];
            const avoidanceWords = ['vermijden', 'weglopen', 'niet aan denken', 'onderdrukken', 'wegduwen'];
            
            let acceptanceScore = 0;
            let avoidanceScore = 0;
            
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                acceptanceWords.forEach(word => {
                    if (noteText.includes(word)) acceptanceScore++;
                });
                avoidanceWords.forEach(word => {
                    if (noteText.includes(word)) avoidanceScore++;
                });
            });

            if (acceptanceScore > avoidanceScore) {
                insights.push({
                    icon: 'ü§ù',
                    text: `Je toont psychologische flexibiliteit door moeilijke gevoelens te accepteren in plaats van te vermijden. Dit is een kernprincipe van ACT (Acceptance and Commitment Therapy).`,
                    recommendation: `Experimenteer met het volledig toelaten van sensaties tijdens oefeningen, ook als ze oncomfortabel zijn.`
                });
            }

            // 5. Trauma-Informed Approach - Safety and Regulation
            const safetyWords = ['veilig', 'controle', 'rustig', 'stabiel', 'beschermd'];
            const dysregulationWords = ['chaos', 'overweldigd', 'verdoofd', 'losgeslagen', 'paniek'];
            
            let safetyScore = 0;
            let dysregulationScore = 0;
            
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                safetyWords.forEach(word => {
                    if (noteText.includes(word)) safetyScore++;
                });
                dysregulationWords.forEach(word => {
                    if (noteText.includes(word)) dysregulationScore++;
                });
            });

            if (safetyScore > dysregulationScore) {
                insights.push({
                    icon: 'üõ°Ô∏è',
                    text: `Je beschrijvingen tonen een toenemend gevoel van veiligheid en zelfregulatie. Dit is cruciaal voor het zenuwstelsel om nieuwe ademhalingspatronen aan te leren.`,
                    recommendation: `Bouw verder aan dit veiligheidsgevoel door consistent dezelfde omgeving te gebruiken voor oefeningen.`
                });
            }

            // 6. Somatic Therapy - Body Awareness
            const bodySensations = ['spanning', 'ontspanning', 'warmte', 'trillen', 'zwaar', 'licht', 'druk', 'ruimte'];
            let bodyAwarenessScore = 0;
            
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                bodySensations.forEach(sensation => {
                    if (noteText.includes(sensation)) bodyAwarenessScore++;
                });
            });

            if (bodyAwarenessScore >= 4) {
                insights.push({
                    icon: 'üåä',
                    text: `Je hebt een goede verbinding met je lichaamssensaties ontwikkeld. Somatische therapie benadrukt dat herstel via het lichaam gaat, niet alleen via de geest.`,
                    recommendation: `Blijf deze lichamelijke signalen observeren - ze zijn je gids naar het reguleren van je zenuwstelsel.`
                });
            }

            // 7. Process vs Outcome Focus (based on research feedback)
            const processWords = ['oefenen', 'proberen', 'leren', 'ontdekken', 'experimenteren', 'proces'];
            const outcomeWords = ['resultaat', 'oplossen', 'wegmaken', 'genezen', 'klaar', 'af'];
            
            let processScore = 0;
            let outcomeScore = 0;
            
            allNotes.forEach(entry => {
                const noteText = entry.notities.toLowerCase();
                processWords.forEach(word => {
                    if (noteText.includes(word)) processScore++;
                });
                outcomeWords.forEach(word => {
                    if (noteText.includes(word)) outcomeScore++;
                });
            });

            if (processScore > outcomeScore) {
                insights.push({
                    icon: 'üéØ',
                    text: `Je focus ligt op het proces van oefenen in plaats van alleen op resultaten. Dit is de meest effectieve mindset voor langdurige verandering bij chronische hyperventilatie.`,
                    recommendation: `Blijf waarderen wat je leert in elke sessie, ongeacht de uitkomst. Onderzoek toont dat dit leidt tot betere langetermijnresultaten.`
                });
            }

            // If no specific insights were generated, provide general encouragement
            if (insights.length === 0) {
                insights.push({
                    icon: 'üí™',
                    text: `Je bent consistent bezig met je herstel. Elke oefening draagt bij aan het hertrainen van je ademhalingspatronen, ook als de veranderingen nog niet altijd merkbaar zijn.`,
                    recommendation: `Focus op consistentie boven perfectie. Kleine, dagelijkse stappen leiden tot duurzame verandering.`
                });
            }

            return insights.slice(0, 4); // Limit to max 4 insights to avoid overwhelm
        }

        // CP Measurement functions
        window.startCPMeasurement = function() {
            if (cpIsRunning) return;
            
            cpIsRunning = true;
            cpStartTime = Date.now();
            
            document.getElementById('start-cp').disabled = true;
            document.getElementById('stop-cp').disabled = false;
            
            cpInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - cpStartTime) / 1000);
                document.getElementById('cp-timer').textContent = elapsed.toString().padStart(2, '0');
            }, 100);
            
            showUserMessage('ü´Å CP meting gestart! Stop bij de eerste neiging om adem te halen.', 'success');
        };

        window.stopCPMeasurement = function() {
            if (!cpIsRunning) return;
            
            const cpScore = Math.floor((Date.now() - cpStartTime) / 1000);
            
            clearInterval(cpInterval);
            cpIsRunning = false;
            
            document.getElementById('start-cp').disabled = false;
            document.getElementById('stop-cp').disabled = true;
            
            // Store the last CP score for auto-fill
            lastCPScore = cpScore;
            userStats.lastCPDate = new Date().toDateString();
            
            // Save CP measurement
            const cpMeasurement = {
                score: cpScore,
                timestamp: new Date(),
                userId: currentUser?.uid,
                userEmail: currentUser?.email
            };
            
            allCPMeasurements.push(cpMeasurement);
            userStats.cpMeasurements.push(cpMeasurement);
            
            // Save to Firebase
            if (currentUser) {
                saveCPMeasurement(cpMeasurement);
            }
            
            // Show interpretation
            showCPInterpretation(cpScore);
            updateDashboard();
            showUserMessage(`‚úÖ CP Score: ${cpScore} seconden geregistreerd!`, 'success');
        };

        window.resetCPMeasurement = function() {
            clearInterval(cpInterval);
            cpIsRunning = false;
            
            document.getElementById('cp-timer').textContent = '00';
            document.getElementById('start-cp').disabled = false;
            document.getElementById('stop-cp').disabled = true;
            
            const interpretation = document.getElementById('cp-interpretation');
            interpretation.style.display = 'none';
        };

        function showCPInterpretation(seconds) {
            const interpretationEl = document.getElementById('cp-interpretation');
            const interpretationText = document.getElementById('cp-interpretation-text');
            
            let interpretation;
            if (seconds < 10) {
                interpretation = 'Zeer lage CO2 tolerantie. Regelmatige Buteyko oefening wordt sterk aangeraden.';
            } else if (seconds < 20) {
                interpretation = 'Lage CO2 tolerantie. Meer oefening kan dit verbeteren.';
            } else if (seconds < 40) {
                interpretation = 'Gemiddelde CO2 tolerantie. Doorgaan met oefenen kan dit verbeteren.';
            } else if (seconds < 60) {
                interpretation = 'Goede CO2 tolerantie. Houd dit niveau vast met regelmatige oefening.';
            } else {
                interpretation = 'Uitstekende CO2 tolerantie! Dit is een zeer goede score.';
            }
            
            interpretationText.textContent = interpretation;
            interpretationEl.style.display = 'block';
        }

        async function saveCPMeasurement(measurement) {
            try {
                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                await addDoc(collection(db, "cpMeasurements"), measurement);
            } catch (error) {
                console.error('Save CP error:', error);
            }
        }

        // Breathing exercise functions
        window.updatePatternDescription = function() {
            const pattern = document.getElementById('breathing-pattern').value;
            const description = document.getElementById('pattern-description');
            description.textContent = breathingPatterns[pattern].description;
        };

        window.startBreathingExercise = function() {
            if (isBreathing) return;
            
            breathingPattern = document.getElementById('breathing-pattern').value;
            const pattern = breathingPatterns[breathingPattern];
            
            isBreathing = true;
            breathCycleCount = 0;
            breathPhase = 'prepare';
            
            document.getElementById('start-breathing').disabled = true;
            document.getElementById('stop-breathing').disabled = false;
            
            updateBreathingDisplay('Bereid je voor...', 'prepare');
            
            setTimeout(() => {
                if (isBreathing) {
                    nextBreathingPhase();
                }
            }, 2000);
        };

        function nextBreathingPhase() {
            const pattern = breathingPatterns[breathingPattern];
            
            if (breathCycleCount >= pattern.cycles) {
                stopBreathingExercise();
                return;
            }

            if (breathingPattern === 'gentle') {
                switch(breathPhase) {
                    case 'prepare':
                        breathPhase = 'freeBreathing';
                        updateBreathingDisplay('Adem vrij en natuurlijk', 'inhale');
                        setTimeout(nextBreathingPhase, pattern.freeBreathing * 1000);
                        break;
                    case 'freeBreathing':
                        breathPhase = 'hold';
                        updateBreathingDisplay('Houd je adem vast', 'hold');
                        setTimeout(nextBreathingPhase, pattern.hold * 1000);
                        break;
                    case 'hold':
                        breathCycleCount++;
                        breathPhase = 'freeBreathing';
                        updateCycleCounter();
                        if (breathCycleCount < pattern.cycles) {
                            updateBreathingDisplay('Adem vrij en natuurlijk', 'inhale');
                            setTimeout(nextBreathingPhase, pattern.freeBreathing * 1000);
                        } else {
                            nextBreathingPhase();
                        }
                        break;
                }
            } else {
                // Standard and advanced patterns
                switch(breathPhase) {
                    case 'prepare':
                        breathPhase = 'inhale';
                        updateBreathingDisplay('Inademen...', 'inhale');
                        setTimeout(nextBreathingPhase, pattern.inhale * 1000);
                        break;
                    case 'inhale':
                        breathPhase = 'hold';
                        updateBreathingDisplay('Vasthouden...', 'hold');
                        setTimeout(nextBreathingPhase, pattern.hold * 1000);
                        break;
                    case 'hold':
                        breathPhase = 'exhale';
                        updateBreathingDisplay('Uitademen...', 'exhale');
                        setTimeout(nextBreathingPhase, pattern.exhale * 1000);
                        break;
                    case 'exhale':
                        breathCycleCount++;
                        breathPhase = 'inhale';
                        updateCycleCounter();
                        if (breathCycleCount < pattern.cycles) {
                            updateBreathingDisplay('Inademen...', 'inhale');
                            setTimeout(nextBreathingPhase, pattern.inhale * 1000);
                        } else {
                            nextBreathingPhase();
                        }
                        break;
                }
            }
        }

        function updateBreathingDisplay(instruction, phase) {
            const circle = document.getElementById('breathing-circle');
            const instructionEl = document.getElementById('breathing-instruction');
            
            circle.className = `breathing-circle ${phase}`;
            circle.textContent = instruction;
            instructionEl.textContent = instruction;
        }

        function updateCycleCounter() {
            const pattern = breathingPatterns[breathingPattern];
            document.getElementById('cycle-counter').textContent = `Cyclus: ${breathCycleCount} / ${pattern.cycles}`;
        }

        window.stopBreathingExercise = function() {
            if (!isBreathing) return;
            
            isBreathing = false;
            clearTimeout();
            
            document.getElementById('start-breathing').disabled = false;
            document.getElementById('stop-breathing').disabled = true;
            
            updateBreathingDisplay('Oefening voltooid!', 'rest');
            document.getElementById('breathing-instruction').textContent = 'Goed gedaan! Neem even de tijd om na te voelen.';
            
            userStats.totalSessions++;
            updateDashboard();
            showUserMessage('‚úÖ Ademhalingsoefening voltooid! Hoe voel je je nu?', 'success');
        };

        // Crisis protocol functions
        window.startCrisisProtocol = function() {
            if (crisisProtocolActive) return;
            
            crisisProtocolActive = true;
            crisisStep = 0;
            crisisTimer = 0;
            
            document.getElementById('crisis-controls').style.display = 'flex';
            document.getElementById('crisis-timer').style.display = 'block';
            
            updateCrisisStep();
            startCrisisTimer();
        };

        function updateCrisisStep() {
            if (crisisStep >= crisisProtocolSteps.length) {
                completeCrisisProtocol();
                return;
            }
            
            const step = crisisProtocolSteps[crisisStep];
            const display = document.getElementById('crisis-display');
            
            display.innerHTML = `
                <div class="crisis-title">${step.title}</div>
                <div class="crisis-instructions">${step.instructions}</div>
                <div style="margin-top: 1rem; font-style: italic; color: var(--primary-color);">${step.encouragement}</div>
            `;
            
            crisisTimer = step.duration;
        }

        function startCrisisTimer() {
            const timerEl = document.getElementById('crisis-timer');
            
            crisisInterval = setInterval(() => {
                const minutes = Math.floor(crisisTimer / 60);
                const seconds = crisisTimer % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (crisisTimer <= 0) {
                    nextCrisisStep();
                } else {
                    crisisTimer--;
                }
            }, 1000);
        }

        window.nextCrisisStep = function() {
            crisisStep++;
            updateCrisisStep();
        };

        window.stopCrisisProtocol = function() {
            clearInterval(crisisInterval);
            crisisProtocolActive = false;
            
            document.getElementById('crisis-controls').style.display = 'none';
            document.getElementById('crisis-timer').style.display = 'none';
            
            const display = document.getElementById('crisis-display');
            display.innerHTML = `
                <div class="crisis-title">üõë Klaar voor Crisis Protocol</div>
                <div class="crisis-instructions">
                    Klik op "Start Crisis Protocol" wanneer je een hyperventilatie aanval voelt opkomen.
                    Dit protocol duurt ongeveer 4 minuten en helpt je ademhaling te normaliseren.
                </div>
                <button onclick="startCrisisProtocol()" class="btn btn-danger">Start Crisis Protocol</button>
            `;
        };

        function completeCrisisProtocol() {
            clearInterval(crisisInterval);
            crisisProtocolActive = false;
            
            document.getElementById('crisis-controls').style.display = 'none';
            document.getElementById('crisis-timer').style.display = 'none';
            
            const display = document.getElementById('crisis-display');
            display.innerHTML = `
                <div class="crisis-title" style="color: var(--success-color);">‚úÖ Protocol Voltooid!</div>
                <div class="crisis-instructions">
                    Geweldig! Je hebt het crisis protocol succesvol doorlopen. 
                    Neem nog even de tijd om te voelen hoe je ademhaling is genormaliseerd.
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="openDagboekModal('Crisis Protocol')" class="btn btn-primary">üìù Documenteer in Dagboek</button>
                    <button onclick="stopCrisisProtocol()" class="btn" style="background: var(--text-light); color: white;">Opnieuw Starten</button>
                </div>
            `;
            
            userStats.totalSessions++;
            updateDashboard();
            showUserMessage('üéâ Crisis protocol succesvol voltooid! Je hebt dit geweldig gedaan.', 'success');
        }

        // Dagboek functions
        window.openDagboekModal = function(technique = '') {
            document.getElementById('dagboek-modal').classList.add('show');
            
            if (technique) {
                document.getElementById('entry-technique').value = technique;
                
                // Show CP score field for Buteyko entries and auto-fill
                const cpGroup = document.getElementById('cp-score-group');
                if (technique === 'Buteyko') {
                    cpGroup.style.display = 'block';
                    autoFillCPScore();
                } else {
                    cpGroup.style.display = 'none';
                }
            }
        };

        window.closeDagboekModal = function() {
            document.getElementById('dagboek-modal').classList.remove('show');
            document.getElementById('dagboek-form').reset();
            updateRangeValue('entry-before');
            updateRangeValue('entry-after');
        };

        function updateRangeValue(inputId) {
            const input = document.getElementById(inputId);
            const value = document.getElementById(inputId + '-value');
            value.textContent = input.value;
        }

        function handleDagboekSubmit(e) {
            e.preventDefault();
            
            const entry = {
                id: Date.now().toString(),
                timestamp: new Date(),
                clientTimestamp: new Date().toISOString(),
                techniekGebruikt: document.getElementById('entry-technique').value,
                duur: parseInt(document.getElementById('entry-duration').value),
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                notities: document.getElementById('entry-notes').value,
                userId: currentUser?.uid
            };

            // Add CP score if it's a Buteyko entry
            const cpScore = document.getElementById('entry-cp-score').value;
            if (entry.techniekGebruikt === 'Buteyko' && cpScore) {
                entry.cpScore = parseInt(cpScore);
            }
            
            allJournalEntries.unshift(entry);
            
            // Save to Firebase
            if (currentUser) {
                saveJournalEntry(entry);
            }
            
            closeDagboekModal();
            updateDashboard();
            updateJournalEntries();
            
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            let message = 'üìù Dagboek entry opgeslagen!';
            if (improvement > 0) {
                message += ` Mooie verbetering van ${improvement} punten!`;
            } else if (improvement === 0) {
                message += ' Geen verandering is ook waardevol om te documenteren.';
            } else {
                message += ' Elke observatie helpt bij je herstelproces.';
            }
            
            showUserMessage(message, 'success');
        }

        async function saveJournalEntry(entry) {
            try {
                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                await addDoc(collection(db, "journalEntries"), entry);
            } catch (error) {
                console.error('Save journal error:', error);
            }
        }

        function updateJournalEntries() {
            const container = document.getElementById('journal-entries');
            
            if (allJournalEntries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                        <p>Nog geen dagboek entries. Klik op "Nieuwe Entry" om te beginnen!</p>
                    </div>
                `;
                return;
            }
            
            let entriesHTML = '';
            allJournalEntries.slice(0, 20).forEach(entry => {
                const date = new Date(entry.timestamp || entry.clientTimestamp);
                const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                const improvementClass = improvement > 0 ? 'success' : improvement < 0 ? 'warning' : 'neutral';
                
                entriesHTML += `
                    <div class="journal-entry">
                        <div class="journal-entry-header">
                            <div>
                                <strong>${entry.techniekGebruikt}</strong>
                                <span class="journal-entry-technique">${entry.duur} min</span>
                                ${entry.cpScore ? `<span class="journal-entry-technique" style="background: var(--secondary-color);">CP: ${entry.cpScore}s</span>` : ''}
                            </div>
                            <div class="journal-entry-date">${date.toLocaleDateString('nl-NL')} ${date.toLocaleTimeString('nl-NL', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--text-light);">Voor:</span> <strong>${entry.intensiteitVoor}</strong> ‚Üí 
                            <span style="color: var(--text-light);">Na:</span> <strong>${entry.intensiteitNa}</strong>
                            <span class="message ${improvementClass}" style="display: inline-block; margin-left: 1rem; padding: 0.2rem 0.5rem; font-size: 0.8rem;">
                                ${improvement > 0 ? '+' : ''}${improvement}
                            </span>
                        </div>
                        ${entry.notities ? `<p style="color: var(--text-dark); font-style: italic;">"${entry.notities}"</p>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = entriesHTML;
        }

        // Chart functions
        window.updateChartFilter = function(filter) {
            chartFilter = filter;
            
            document.querySelectorAll('#chart-10days, #chart-30days, #chart-all').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`chart-${filter}`).classList.add('active');
            createProgressChart();
        };

        function createProgressChart() {
            const canvas = document.getElementById('progress-chart');
            const emptyDiv = document.getElementById('chart-empty');
            
            if (!canvas) return;
            
            const relevantEntries = allJournalEntries.filter(entry => 
                entry.intensiteitVoor !== undefined && entry.intensiteitNa !== undefined
            );
            
            if (relevantEntries.length === 0) {
                canvas.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }
            
            canvas.style.display = 'block';
            emptyDiv.style.display = 'none';
            
            // Filter by time period
            let filteredEntries = [...relevantEntries];
            const now = Date.now();
            
            if (chartFilter === '10days') {
                const cutoff = now - (10 * 24 * 60 * 60 * 1000);
                filteredEntries = relevantEntries.filter(entry => {
                    const entryTime = new Date(entry.timestamp || entry.clientTimestamp).getTime();
                    return entryTime >= cutoff;
                });
            } else if (chartFilter === '30days') {
                const cutoff = now - (30 * 24 * 60 * 60 * 1000);
                filteredEntries = relevantEntries.filter(entry => {
                    const entryTime = new Date(entry.timestamp || entry.clientTimestamp).getTime();
                    return entryTime >= cutoff;
                });
            }
            
            // Sort by date
            filteredEntries.sort((a, b) => 
                new Date(a.timestamp || a.clientTimestamp) - new Date(b.timestamp || b.clientTimestamp)
            );
            
            const labels = filteredEntries.map(entry => {
                const date = new Date(entry.timestamp || entry.clientTimestamp);
                return date.toLocaleDateString('nl-NL', { month: 'short', day: 'numeric' });
            });
            
            const beforeData = filteredEntries.map(entry => entry.intensiteitVoor);
            const afterData = filteredEntries.map(entry => entry.intensiteitNa);
            const improvementData = filteredEntries.map(entry => entry.intensiteitVoor - entry.intensiteitNa);
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Voor oefening',
                            data: beforeData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Na oefening',
                            data: afterData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Verbetering',
                            data: improvementData,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Datum'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Intensiteit (1-10)'
                            },
                            min: 0,
                            max: 10
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Verbetering'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Ademhaling Vooruitgang Over Tijd'
                        }
                    }
                }
            });
        }

        // Export function
        window.exportDagboek = function() {
            if (allJournalEntries.length === 0) {
                showUserMessage('Geen data om te exporteren.', 'warning');
                return;
            }
            
            const csvData = [
                ['Datum', 'Tijd', 'Techniek', 'Duur (min)', 'Voor', 'Na', 'Verbetering', 'CP Score', 'Notities']
            ];
            
            allJournalEntries.forEach(entry => {
                const date = new Date(entry.timestamp || entry.clientTimestamp);
                csvData.push([
                    date.toLocaleDateString('nl-NL'),
                    date.toLocaleTimeString('nl-NL'),
                    entry.techniekGebruikt,
                    entry.duur,
                    entry.intensiteitVoor,
                    entry.intensiteitNa,
                    entry.intensiteitVoor - entry.intensiteitNa,
                    entry.cpScore || '',
                    entry.notities || ''
                ]);
            });
            
            const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ademruimte_dagboek_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showUserMessage('üìä Dagboek ge√´xporteerd naar CSV bestand!', 'success');
        };

        // Load user data
        async function loadUserData() {
            if (!currentUser) {
                return;
            }
            
            try {
                // Load from Firebase for logged-in users
                const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                
                // Load journal entries
                const journalQuery = query(
                    collection(db, "journalEntries"), 
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                const journalSnapshot = await getDocs(journalQuery);
                allJournalEntries = journalSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date(doc.data().clientTimestamp)
                }));
                
                // Load CP measurements
                const cpQuery = query(
                    collection(db, "cpMeasurements"), 
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                const cpSnapshot = await getDocs(cpQuery);
                allCPMeasurements = cpSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date(doc.data().clientTimestamp)
                }));
                
                // Set last CP score for auto-fill
                if (allCPMeasurements.length > 0) {
                    lastCPScore = allCPMeasurements[0].score;
                }
                
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showUserMessage('Fout bij het laden van je gegevens. Probeer opnieuw in te loggen.', 'error');
            }
        }

        // Enhanced streak calculation function
        function calculateStreak() {
            const today = new Date();
            const todayStr = today.toDateString();
            
            // Combine all activities (journal entries and CP measurements)
            const allActivities = [
                ...allJournalEntries.map(entry => ({
                    date: new Date(entry.timestamp || entry.clientTimestamp).toDateString(),
                    type: 'journal'
                })),
                ...allCPMeasurements.map(cp => ({
                    date: new Date(cp.timestamp).toDateString(),
                    type: 'cp'
                }))
            ];
            
            // Get unique dates with activity
            const uniqueDates = [...new Set(allActivities.map(activity => activity.date))].sort((a, b) => new Date(b) - new Date(a));
            
            if (uniqueDates.length === 0) {
                return 0;
            }
            
            let streak = 0;
            let currentDate = new Date(today);
            
            // Check backwards from today
            while (true) {
                const dateStr = currentDate.toDateString();
                
                if (uniqueDates.includes(dateStr)) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
                
                // Prevent infinite loop
                if (streak > 365) break;
            }
            
            return streak;
        }

        // Message system
        function showUserMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">√ó</button>
            `;
            messageEl.style.cssText = `
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                gap: 1rem;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => messageEl.remove(), 300);
                }
            }, 5000);
        }

        // Logout function
        window.logout = async function() {
            if (!confirm('Weet je zeker dat je wilt uitloggen?')) {
                return;
            }
            
            try {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                await signOut(auth);
                showUserMessage('Je bent succesvol uitgelogd!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showUserMessage('Fout bij uitloggen. Probeer het opnieuw.', 'error');
            }
        };

        // Update user info display
        function updateUserInfo() {
            const userInfoEl = document.getElementById('user-info');
            
            if (!currentUser) {
                userInfoEl.innerHTML = '<div class="spinner"></div>';
                return;
            }
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Gebruiker';
            const avatar = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=06b6d4&color=fff`;
            
            userInfoEl.innerHTML = `
                <img src="${avatar}" alt="Avatar" class="user-avatar">
                <div>
                    <div style="font-weight: 600;">${displayName}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">
                        ${currentUser.email}
                    </div>
                </div>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 0.3rem; cursor: pointer; margin-left: auto;">
                    Uitloggen
                </button>
            `;
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // Update user info periodically
            setInterval(() => {
                if (currentUser) {
                    updateUserInfo();
                }
            }, 1000);
            
            // Update dashboard periodically
            setInterval(() => {
                if (currentUser && currentTab === 'dashboard') {
                    updateDashboard();
                }
            }, 30000);
        });

        // Export functions to global scope for onclick handlers
        window.updateRangeValue = updateRangeValue;
        window.openDagboekModal = openDagboekModal;
        window.closeDagboekModal = closeDagboekModal;
        window.startCPMeasurement = startCPMeasurement;
        window.stopCPMeasurement = stopCPMeasurement;
        window.resetCPMeasurement = resetCPMeasurement;
        window.startBreathingExercise = startBreathingExercise;
        window.stopBreathingExercise = stopBreathingExercise;
        window.updatePatternDescription = updatePatternDescription;
        window.startCrisisProtocol = startCrisisProtocol;
        window.stopCrisisProtocol = stopCrisisProtocol;
        window.nextCrisisStep = nextCrisisStep;
        window.updateChartFilter = updateChartFilter;
        window.exportDagboek = exportDagboek;

        // Initialize first update
        setTimeout(() => {
            updateUserInfo();
            if (currentUser) {
                userStats.streakDays = calculateStreak();
                updateDashboard();
            }
        }, 1000);

    </script>
</body>
</html>
