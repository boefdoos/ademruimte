<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
    }

    /* Reset en basis styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:before, *:after {
        box-sizing: border-box;
    }

    html {
        border: none;
        outline: none;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    /* Skip link voor toegankelijkheid */
    .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--text-dark);
        color: white;
        padding: 8px;
        text-decoration: none;
        border-radius: 4px;
        z-index: 1000;
    }
    
    .skip-link:focus {
        top: 6px;
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: clamp(1rem, 3vw, 2rem);
        text-align: center;
        position: relative;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
    }

    .logo-svg {
        height: clamp(100px, 12vw, 160px);
        width: auto;
        filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }

    header h1 {
        font-size: clamp(1.2rem, 4vw, 2rem);
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        letter-spacing: -0.02em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
        font-size: clamp(0.7rem, 2vw, 0.9rem);
        opacity: 0.95;
        margin: 0;
    }

    .user-info {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-size: 0.75rem;
        color: rgba(255,255,255,0.9);
        max-width: 120px;
        word-break: break-word;
        text-align: right;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        z-index: 2;
    }

    /* Navigation */
    .nav-tabs {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        padding: 0.75rem 0.5rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        box-shadow: var(--shadow-sm);
        scrollbar-width: none;
        -ms-overflow-style: none;
        display: flex;
        gap: 0.5rem;
    }

    .nav-tabs::-webkit-scrollbar {
        display: none;
    }

    .nav-tabs button {
        background: none;
        border: none;
        padding: 0.875rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: var(--transition-base);
        white-space: nowrap;
        min-height: var(--touch-target);
        min-width: 44px;
        touch-action: manipulation;
        color: var(--text-light);
        position: relative;
        outline: none;
        font-family: inherit;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
    }

    .nav-tabs button:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .nav-tabs button.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
        font-weight: 600;
    }

    .nav-tabs button:hover:not(.active) {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        transform: translateY(-1px);
    }

    /* Container */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: clamp(1rem, 3vw, 2rem);
        min-height: calc(100vh - 120px);
    }

    /* Cards */
    .card {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        padding: clamp(1rem, 3vw, 2rem);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition-base);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        font-weight: 700;
        background: linear-gradient(135deg, #06b6d4, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: clamp(1rem, 3vw, 1.25rem);
        font-weight: 600;
    }

    /* Buttons */
    .btn {
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: var(--transition-base);
        text-align: center;
        display: inline-block;
        text-decoration: none;
        min-height: var(--touch-target);
        touch-action: manipulation;
        user-select: none;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        outline: none;
        font-family: inherit;
    }

    .btn:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), var(--shadow-sm);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-green {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-cyan {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    .btn-orange {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .btn-purple {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
    }

    /* Grid layout */
    .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
    }

    .grid .card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border-radius: 1.2rem;
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .grid .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .grid .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 1.2rem 1.2rem 0 0;
    }

    .grid .card h3 {
        font-size: 1.375rem;
        margin-bottom: 1rem;
        font-weight: 700;
    }

    .grid .card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }

    /* Statistics specific grid for overview cards */
    .stats-overview-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(102, 126, 234, 0.2);
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease;
    }

    .stats-overview-card:hover {
        transform: translateY(-2px);
    }

    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #06b6d4, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stats-label {
        color: var(--text-light);
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Form styling */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        min-height: var(--touch-target);
        font-family: inherit;
        transition: border-color 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: #ffffff;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        background-color: #ffffff;
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
        line-height: 1.5;
    }

    /* Mobile-specific input improvements */
    @media (max-width: 768px) {
        .form-input, .form-select, .form-textarea {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 1rem;
            min-height: 48px;
        }
        
        .form-textarea {
            min-height: 100px;
        }
        
        .modal-content {
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal.show {
            align-items: flex-start;
            padding-top: 2rem;
        }
    }

    /* Range input styling */
    .range-input {
        width: 100%;
        margin: 0.75rem 0;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: #e5e7eb;
        border-radius: 5px;
        outline: none;
    }

    .range-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
    }

    .range-input::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    .range-value {
        text-align: center;
        font-weight: bold;
        font-size: 1.25rem;
        color: #3b82f6;
        margin: 0.5rem 0;
    }

    /* Alert styling */
    .alert {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        border: 1px solid;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(10px);
    }

    .alert-info {
        background: rgba(219, 234, 254, 0.95);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .alert-success {
        background: rgba(209, 250, 229, 0.95);
        border-color: #10b981;
        color: #065f46;
    }

    .alert-warning {
        background: rgba(254, 243, 199, 0.95);
        border-color: #f59e0b;
        color: #92400e;
    }

    .alert-danger, .alert-error {
        background: rgba(254, 226, 226, 0.95);
        border-color: #ef4444;
        color: #991b1b;
    }

    /* User message notifications */
    .user-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        max-width: 90vw;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(15px);
        animation: slideInDown 0.3s ease-out;
    }

    .user-message.alert-info {
        background: rgba(219, 234, 254, 0.98);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .user-message.alert-success {
        background: rgba(209, 250, 229, 0.98);
        border-color: #10b981;
        color: #065f46;
    }

    .user-message.alert-warning {
        background: rgba(254, 243, 199, 0.98);
        border-color: #f59e0b;
        color: #92400e;
    }

    .user-message.alert-error {
        background: rgba(254, 226, 226, 0.98);
        border-color: #ef4444;
        color: #991b1b;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        padding: 1rem;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
        min-width: 40px;
        min-height: 40px;
        border-radius: 50%;
        transition: var(--transition-base);
    }

    .close-btn:hover {
        background: rgba(0,0,0,0.1);
        color: var(--text-dark);
    }

    /* Google button styling */
    .google-btn {
        width: 100%;
        padding: 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        min-height: var(--touch-target);
    }

    .google-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    /* Divider styling */
    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e5e7eb;
        z-index: 1;
    }

    .divider span {
        background: white;
        padding: 0 1rem;
        position: relative;
        z-index: 2;
    }

    /* Breathing exercise styling */
    .breath-display {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        margin: 1.5rem 0;
        padding: 1.5rem;
        border-radius: 1rem;
        transition: all 0.3s ease;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .breath-display.inhale {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        transform: scale(1.02);
    }

    .breath-display.exhale {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        transform: scale(0.98);
    }

    .breath-display.hold {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        transform: scale(1.01);
    }

    .breath-display.rest {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        color: var(--text-light);
    }

    .breath-display.gentle-breath {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
    }

    .progress-bar {
        width: 100%;
        height: 0.75rem;
        background: #e5e7eb;
        border-radius: 0.375rem;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: #10b981;
        border-radius: 0.375rem;
        transition: width 0.3s ease;
    }

    .breath-progress {
        height: 100%;
        border-radius: 0.375rem;
        transition: width linear;
    }

    .breath-progress.inhale {
        background: #3b82f6;
    }

    .breath-progress.exhale {
        background: #10b981;
    }

    .breath-progress.gentle-breath {
        background: #06b6d4;
    }

    .breath-controls {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        margin: 1rem 0;
    }

    .breath-setting {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }

    .breath-setting label {
        display: block;
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }

    .breath-setting input {
        width: 80px;
        text-align: center;
        font-size: 1.125rem;
        font-weight: bold;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem;
        min-height: var(--touch-target);
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .button-group .btn {
        flex: 1;
        min-width: 120px;
    }

    /* Timer display */
    .timer-display {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        color: var(--text-dark);
        margin: 1.5rem 0;
        font-family: 'Courier New', monospace;
    }

    /* Technique cards */
    .technique-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .technique-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .technique-card h4 {
        color: #667eea;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .technique-card p {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    /* Step list styling */
    .step-list {
        list-style: none;
        margin: 1rem 0;
    }

    .step-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.9rem;
    }

    .step-list li:before {
        content: "✓ ";
        color: #10b981;
        font-weight: bold;
    }

    /* Settings sections */
    .settings-section {
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin: 2rem 0;
        border: 1px solid #e2e8f0;
    }

    .settings-section h3 {
        color: #374151;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    /* Entry cards for dagboek */
    .entry-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: var(--transition-base);
    }

    .entry-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        gap: 1rem;
    }

    .entry-title {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    .entry-result {
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .entry-result.zeer-goed { color: #059669; }
    .entry-result.goed { color: #10b981; }
    .entry-result.matig { color: #f59e0b; }
    .entry-result.geen-effect { color: var(--text-light); }
    .entry-result.slechter { color: #ef4444; }

    .intensity-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    /* Connection status */
    .status-connected {
        background: #059669 !important;
        opacity: 0.8 !important;
    }

    .status-disconnected {
        background: #f59e0b !important;
        opacity: 0.6 !important;
    }

    .status-error {
        background: #ef4444 !important;
        opacity: 0.7 !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }

    /* Chart styling */
    .chart-container {
        position: relative;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    .chart-legend {
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }

    /* Statistics table styling */
    .stats-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .stats-table th,
    .stats-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.9rem;
    }

    .stats-table th {
        background: #f8fafc;
        font-weight: 600;
        color: var(--text-dark);
    }

    .stats-table tr:hover {
        background: #f9fafb;
    }

    /* Utility classes */
    .hidden {
        display: none !important;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Responsive optimalisaties */
    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .modal-content {
            margin: 1rem;
            padding: 1rem;
        }
        
        .btn {
            padding: 1rem;
            font-size: 0.9rem;
        }

        .nav-tabs {
            padding: 0.5rem 0.25rem;
            gap: 0.25rem;
        }

        .nav-tabs button {
            padding: 0.75rem 0.875rem;
            font-size: 0.75rem;
            min-width: 40px;
            border-radius: 0.875rem;
        }

        header {
            min-height: 100px;
            padding: 1rem 0.75rem;
        }

        .user-info {
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.7rem;
            max-width: 100px;
            padding: 0.375rem 0.5rem;
        }

        .logo-svg {
            height: clamp(90px, 15vw, 140px);
        }

        .breath-display {
            font-size: 1.5rem;
            padding: 1rem;
            min-height: 80px;
        }

        .timer-display {
            font-size: 2rem;
        }

        .stats-table {
            font-size: 0.8rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .nav-tabs button {
            font-size: 0.7rem;
            padding: 0.625rem 0.75rem;
        }

        .user-info {
            font-size: 0.65rem;
            max-width: 90px;
            padding: 0.25rem 0.375rem;
        }

        header {
            min-height: 90px;
        }

        .logo-svg {
            height: clamp(80px, 18vw, 120px);
        }
    }

    @media (max-height: 600px) and (orientation: landscape) {
        header {
            padding: 0.5rem 1rem;
            min-height: 70px;
        }
        
        .logo-svg {
            height: clamp(60px, 10vw, 80px);
        }

        .user-info {
            top: 0.25rem;
            right: 0.5rem;
            font-size: 0.65rem;
            padding: 0.25rem 0.375rem;
        }
        
        .container {
            padding: 0.5rem;
        }

        .timer-display, .breath-display {
            font-size: 1.5rem;
            margin: 0.5rem 0;
            padding: 1rem;
        }

        .nav-tabs {
            padding: 0.375rem 0.25rem;
        }

        .nav-tabs button {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
        }
    }

    @media (min-width: 768px) {
        .breath-controls {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .breath-display {
            font-size: 2.5rem;
            padding: 2rem;
        }

        .timer-display {
            font-size: 3rem;
        }

        .nav-tabs {
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
        }

        .nav-tabs button {
            padding: 1rem 1.5rem;
            font-size: 0.9rem;
        }

        .user-info {
            font-size: 0.8rem;
            max-width: 150px;
            padding: 0.75rem 1rem;
        }
    }

    /* Print styling */
    @media print {
        body {
            background: white;
            color: black;
        }
        
        .nav-tabs, .btn, header {
            display: none;
        }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .card {
            border: 2px solid;
        }
        
        .btn {
            border: 2px solid;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* Dark mode preparation */
    @media (prefers-color-scheme: dark) {
        :root {
            --card-background: rgba(31, 41, 55, 0.95);
            --text-dark: #f9fafb;
            --text-light: #d1d5db;
        }
    }
</style>
</head>

<body>
    <!-- Skip link voor toegankelijkheid -->
    <a href="#main-content" class="skip-link">Spring naar hoofdinhoud</a>

    <header role="banner">
        <div class="user-info" id="user-info" aria-live="polite">
            <!-- Spinner should be shown by default until auth state is known -->
            <div class="spinner" id="auth-loading" aria-label="Bezig met inloggen..."></div>
        </div>
        
        <!-- Ademruimte Logo -->
        <div class="logo-container">
            <svg viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
              <defs>
                <radialGradient id="breathingGradient" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" style="stop-color:#FFE0E6;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#FF7F7F;stop-opacity:0.6"/>
                  <stop offset="100%" style="stop-color:#26A69A;stop-opacity:0.4"/>
                </radialGradient>
                
                <linearGradient id="textGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#FFFFFF"/>
                  <stop offset="50%" style="stop-color:#FFE0E6"/>
                  <stop offset="100%" style="stop-color:#FFFFFF"/>
                </linearGradient>
                
                <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#26A69A;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#4DB6AC;stop-opacity:0.5"/>
                  <stop offset="100%" style="stop-color:#FF7F7F;stop-opacity:0.3"/>
                </linearGradient>
              </defs>
              
              <circle cx="60" cy="60" r="30" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" opacity="0.7">
                <animate attributeName="r" values="30;33;30" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.5;0.8;0.5" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="stroke-width" values="1.5;2;1.5" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="20" fill="url(#breathingGradient)" opacity="0.8">
                <animate attributeName="r" values="20;22;20" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.7;0.9;0.7" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="4" fill="#FF6B6B" opacity="1">
                <animate attributeName="r" values="4;6;4" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.9;1;0.9" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <g transform="translate(60,60)">
                <path d="M-25,0 Q-15,-10 0,-8 Q15,-10 25,0" 
                      stroke="url(#flowGradient)" stroke-width="2" fill="none" opacity="0.7">
                  <animate attributeName="opacity" values="0.5;0.9;0.5" dur="12s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="0;360" dur="60s" repeatCount="indefinite"/>
                </path>
                
                <path d="M0,-25 Q10,-15 8,0 Q10,15 0,25" 
                      stroke="url(#flowGradient)" stroke-width="2" fill="none" opacity="0.6">
                  <animate attributeName="opacity" values="0.4;0.8;0.4" dur="10s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="90;450" dur="60s" repeatCount="indefinite"/>
                </path>
                
                <circle cx="15" cy="-5" r="1.2" fill="rgba(255,255,255,0.9)" opacity="0.8">
                  <animate attributeName="opacity" values="0.5;1;0.5" dur="6s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="0;360" dur="45s" repeatCount="indefinite"/>
                </circle>
                
                <circle cx="-8" cy="12" r="1" fill="#FF7F7F" opacity="0.7">
                  <animate attributeName="opacity" values="0.4;0.9;0.4" dur="7s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="180;540" dur="45s" repeatCount="indefinite"/>
                </circle>
              </g>
              
              <text x="140" y="45" font-family="Arial, sans-serif" font-size="28" font-weight="300" fill="url(#textGradient)">
                ademruimte
              </text>
              
              <text x="140" y="72" font-family="Arial, sans-serif" font-size="13" fill="rgba(255,255,255,0.9)" opacity="0.95">
                your safe breathing space
              </text>
              
              <g opacity="0.6">
                <circle cx="270" cy="25" r="2.5" fill="rgba(255,255,255,0.8)">
                  <animate attributeName="cy" values="25;20;25" dur="9s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.4;0.9;0.4" dur="9s" repeatCount="indefinite"/>
                </circle>
                <circle cx="280" cy="35" r="2" fill="#FF7F7F">
                  <animate attributeName="cy" values="35;30;35" dur="11s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.5;0.9;0.5" dur="11s" repeatCount="indefinite"/>
                </circle>
                <circle cx="275" cy="55" r="2.2" fill="rgba(255,255,255,0.7)">
                  <animate attributeName="cy" values="55;50;55" dur="13s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.4;0.7;0.4" dur="13s" repeatCount="indefinite"/>
                </circle>
              </g>
            </svg>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="login-screen" role="main">
        <div style="max-width: 400px; margin: 2rem auto; padding: 0 1rem;">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">
                    Welkom bij Ademruimte
                </h2>
                
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-light);">
                    <span id="login-description">Log in om je vooruitgang op te slaan en te synchroniseren tussen al je apparaten.</span>
                </p>

                <!-- Google Login -->
                <button id="google-login-btn" class="google-btn" aria-label="Inloggen met Google account">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="google-btn-text">Doorgaan met Google</span>
                </button>

                <div class="divider">
                    <span>of</span>
                </div>

                <!-- Email/Password Login -->
                <form id="login-form" novalidate>
                    <div class="form-group">
                        <label for="login-email" class="form-label">E-mail:</label>
                        <input type="email" 
                               id="login-email" 
                               class="form-input" 
                               placeholder="jouw@email.com" 
                               required 
                               autocomplete="email">
                    </div>

                    <div class="form-group">
                        <label for="login-password" class="form-label">Wachtwoord:</label>
                        <input type="password" 
                               id="login-password" 
                               class="form-input" 
                               placeholder="Wachtwoord" 
                               required 
                               autocomplete="current-password">
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="remember-me" checked aria-describedby="remember-help">
                        <label for="remember-me" style="margin: 0; cursor: pointer;">Ingelogd blijven</label>
                        <span id="remember-help" class="sr-only">Vink aan om ingelogd te blijven op dit apparaat</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Inloggen
                    </button>
                </form>

                <div style="text-align: center;">
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                        Nog geen account?
                    </p>
                    <button id="show-register-btn" class="btn btn-green" style="width: 100%;">
                        Account Aanmaken
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog" aria-labelledby="register-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="register-title">Account Aanmaken</h3>
                <button id="close-register-btn" class="close-btn" aria-label="Sluit registratie venster">&times;</button>
            </div>
            
            <form id="register-form" novalidate>
                <div class="form-group">
                    <label for="register-name" class="form-label">Naam:</label>
                    <input type="text" 
                           id="register-name" 
                           class="form-input" 
                           placeholder="Jouw naam" 
                           required 
                           autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="register-email" class="form-label">E-mail:</label>
                    <input type="email" 
                           id="register-email" 
                           class="form-input" 
                           placeholder="jouw@email.com" 
                           required 
                           autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="register-password" class="form-label">Wachtwoord:</label>
                    <input type="password" 
                           id="register-password" 
                           class="form-input" 
                           placeholder="Minimaal 6 karakters" 
                           required 
                           minlength="6" 
                           autocomplete="new-password">
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-green" style="flex: 1;">
                        Account Aanmaken
                    </button>
                    <button type="button" id="cancel-register-btn" class="btn" style="flex: 1;">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <nav class="nav-tabs" role="navigation" aria-label="Hoofdnavigatie">
            <button class="tab-btn active" data-tab="dashboard" aria-selected="true">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="crisis" aria-selected="false">🚨 Crisis</button>
            <button class="tab-btn" data-tab="buteyko" aria-selected="false">🌬️ Buteyko</button>
            <button class="tab-btn" data-tab="ritueel" aria-selected="false">🕐 Ritueel</button>
            <button class="tab-btn" data-tab="gapen" aria-selected="false">🥱 Gapen</button>
            <button class="tab-btn" data-tab="emdr" aria-selected="false">💜 EMDR</button>
            <button class="tab-btn" data-tab="dagboek" aria-selected="false">📖 Dagboek</button>
            <button class="tab-btn" data-tab="statistieken" aria-selected="false">📊 Statistieken</button>
        </nav>

        <main id="main-content" class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content" role="tabpanel" aria-labelledby="dashboard-tab">
                <!-- Hero Greeting Section -->
                <div class="card" style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); margin-bottom: 2rem;">
                    <h2 id="dashboard-greeting" style="font-size: clamp(1.5rem, 4vw, 2rem); margin-bottom: 1rem; background: linear-gradient(135deg, #06b6d4, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        Welkom bij Ademruimte
                    </h2>
                    
                    <p style="color: var(--text-light); font-size: 1rem; margin-top: 0.5rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                        Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding. 
                        Neem de tijd om te ontspannen en ontdek welke technieken het beste voor jou werken.
                    </p>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3>🚨 Crisis Hulp</h3>
                        <p>Voor wanneer je luchthonger voelt opkomen</p>
                        <button class="btn btn-red" onclick="showTab('crisis')">Open Crisis Hulp</button>
                    </div>

                    <div class="card">
                        <h3>🌬️ Buteyko Ademhaling</h3>
                        <p>CO2 tolerantie training</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>

                    <div class="card">
                        <h3>🕐 Afkoel Ritueel</h3>
                        <p>Na intensief denkwerk</p>
                        <button class="btn btn-green" onclick="showTab('ritueel')">Start Ritueel</button>
                    </div>

                    <div class="card">
                        <h3>🥱 Gaap Preventie</h3>
                        <p>Technieken voor gaapaanvallen</p>
                        <button class="btn btn-orange" onclick="showTab('gapen')">Bekijk Technieken</button>
                    </div>

                    <div class="card">
                        <h3>💜 EMDR Zelfhulp</h3>
                        <p>Voor luchthonger-gevoelens</p>
                        <button class="btn btn-purple" onclick="showTab('emdr')">Start EMDR</button>
                    </div>

                    <div class="card">
                        <h3>📖 Dagboek</h3>
                        <p>Bijhouden van patronen</p>
                        <button class="btn btn-primary" onclick="showTab('dagboek')">Open Dagboek</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Tip van de dag:</strong> 
                    <span id="daily-tip">Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.</span>
                    <button id="tip-refresh-btn" 
                            style="background: none; border: none; color: #0891b2; cursor: pointer; margin-left: 0.5rem; font-weight: 600; padding: 0.25rem; border-radius: 0.25rem; transition: var(--transition-base);" 
                            onmouseover="this.style.background='rgba(8,145,178,0.1)'" 
                            onmouseout="this.style.background='none'" 
                            aria-label="Nieuwe tip laden">🔄</button>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3>👤 Account</h3>
                    <div id="account-info" style="margin-bottom: 1rem;">
                        <!-- Account info wordt hier ingevuld -->
                    </div>
                    <button class="btn btn-red" onclick="performLogout()">
                        🚪 Uitloggen
                    </button>
                </div>
            </div>

            <!-- Crisis Tab -->
            <div id="crisis" class="tab-content hidden" role="tabpanel" aria-labelledby="crisis-tab">
                <div class="card">
                    <h2>🚨 Crisis Hulp - Luchthonger</h2>
                    <p>Voor wanneer je dat benauwde gevoel voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>1. Paradoxale Ademhaling</h4>
                    <p>Start met bewust zeer kleine, korte ademhalingen. Na 3-4 van deze mini-ademhalingen, probeer een iets langere uitademing.</p>
                </div>

                <div class="technique-card">
                    <h4>2. Purse-lip Ademhaling</h4>
                    <p>Tuut je lippen bij het uitademen om lichte weerstand te creëren. Dit helpt bij luchthonger en stabiliseert CO2-niveaus.</p>
                </div>

                <div class="technique-card">
                    <h4>3. IJswater Techniek</h4>
                    <p>Breng iets kouds tegen je gezicht (vooral rond wangen en ogen) om de duikreflex te activeren.</p>
                </div>

                <div class="technique-card">
                    <h4>4. Herframing</h4>
                    <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                </div>

                <div class="card">
                    <h3>5-4-3-2-1 Grounding</h3>
                    <ul class="step-list">
                        <li>5 dingen die je ZIET</li>
                        <li>4 dingen die je VOELT</li>
                        <li>3 dingen die je HOORT</li>
                        <li>2 dingen die je RUIKT</li>
                        <li>1 ding dat je PROEFT</li>
                    </ul>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Crisis Hulp Technieken')">
                        📝 Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content hidden" role="tabpanel" aria-labelledby="buteyko-tab">
                <div class="card">
                    <h2>🌬️ Buteyko Ademhaling</h2>
                    <p>Verbeter je CO2 tolerantie en verminder hyperventilatie neiging</p>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Hoe het werkt:</strong> Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus, wat hyperventilatie-episodes kan verminderen.
                </div>

                <div class="card">
                    <h3>Ademhalingsinstellingen</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Ademhalingspatroon:</label>
                        <select id="breathing-pattern" class="form-select" onchange="updateBreathingPattern()">
                            <option value="standard">Standaard (4-6-3)</option>
                            <option value="gentle">Zacht (2x ademhaling + pauze)</option>
                        </select>
                    </div>
                    
                    <div id="standard-controls" class="breath-controls">
                        <div class="breath-setting">
                            <label>Inademen (sec)</label>
                            <input type="number" id="inhale-duration" value="4" min="2" max="10">
                        </div>
                        <div class="breath-setting">
                            <label>Uitademen (sec)</label>
                            <input type="number" id="exhale-duration" value="6" min="3" max="15">
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="hold-duration" value="3" min="1" max="20">
                        </div>
                    </div>

                    <div id="gentle-controls" class="breath-controls hidden">
                        <div class="breath-setting">
                            <label>Cyclus Tijd (sec)</label>
                            <input type="number" id="gentle-cycle" value="10" min="8" max="15">
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="gentle-pause" value="4" min="2" max="8">
                        </div>
                        <div class="breath-setting">
                            <label>Ademhalingen</label>
                            <div style="font-weight: bold; color: #3b82f6; margin-top: 0.5rem;">2x per cyclus</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="breath-display rest" id="breath-display">
                        Klik op start om te beginnen
                    </div>

                    <div class="progress-bar">
                        <div class="breath-progress" id="breath-progress" style="width: 0%"></div>
                    </div>

                    <div style="text-align: center; margin: 1rem 0;">
                        <div id="breath-cycle-counter" style="font-size: 1.125rem; color: var(--text-light); margin-bottom: 1rem;">
                            Cyclus: 1/10
                        </div>
                        
                        <div class="button-group">
                            <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathExercise()">
                                ▶️ Start Buteyko
                            </button>
                            <button class="btn btn-orange" onclick="resetBreathExercise()">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Completion bericht buiten de hoofdkaart -->
                <div id="breath-complete" class="alert alert-success hidden">
                    <strong>✅ Buteyko Sessie Voltooid!</strong><br>
                    Geweldig! Je hebt 10 ademhalingscycli succesvol afgerond.
                    <br><br>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Buteyko Ademhaling - 10 Cycli Voltooid')">
                            📝 Maak Dagboek Entry
                        </button>
                        <button class="btn btn-orange" onclick="skipButeykoDagboek()">
                            ⏭️ Overslaan
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>Buteyko Principes</h3>
                    <div class="technique-card">
                        <h4>Zachte Ademhaling</h4>
                        <p>Adem zo zacht mogelijk - stel je voor dat je een veertje voor je neus niet wilt laten bewegen.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Langere Uitademing</h4>
                        <p>De uitademing is langer dan de inademing om CO2 te behouden en het autonome zenuwstelsel te kalmeren.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Comfortabele Pauze</h4>
                        <p>De adempauze na uitademing mag nooit geforceerd aanvoelen - stop als het oncomfortabel wordt.</p>
                    </div>
                </div>
            </div>

            <!-- Ritueel Tab -->
            <div id="ritueel" class="tab-content hidden" role="tabpanel" aria-labelledby="ritueel-tab">
                <div class="card">
                    <h2>🕐 Afkoel Ritueel</h2>
                    <p>Voor na periodes van intensief denkwerk (5-10 minuten)</p>
                </div>

                <div class="card">
                    <h3 id="ritual-title">Stap 1: Fysieke Mini-Reset</h3>
                    <div class="timer-display" id="timer-display">2:00</div>
                    
                    <div id="ritual-instructions">
                        <ul class="step-list">
                            <li>Sta op en strek je volledig uit</li>
                            <li>Schud je armen en benen los</li>
                            <li>Rol je schouders 5x naar achteren</li>
                            <li>Maak kleine cirkels met je hoofd (5x elke richting)</li>
                        </ul>
                    </div>

                    <div class="button-group">
                        <button id="timer-btn" class="btn btn-green" onclick="startTimer()">▶️ Start Timer</button>
                        <button class="btn btn-primary" onclick="nextRitualStep()" id="next-btn" style="display: none;">Volgende Stap</button>
                        <button class="btn btn-cyan" onclick="skipToNextStep()" id="skip-btn">⏭️ Overslaan</button>
                        <button class="btn btn-orange" onclick="resetRitual()">🔄 Reset</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="ritual-progress" style="width: 20%"></div>
                    </div>

                    <div id="ritual-complete" class="alert alert-success hidden">
                        <strong>✅ Afkoel Ritueel Voltooid!</strong><br>
                        Fantastisch! Je hebt alle 5 stappen van het afkoel ritueel doorlopen.
                        <br><br>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openDagboekModal('Afkoel Ritueel - 5 Stappen Voltooid')">
                                📝 Maak Dagboek Entry
                            </button>
                            <button class="btn btn-orange" onclick="skipRitualDagboek()">
                                ⏭️ Overslaan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gapen Tab -->
            <div id="gapen" class="tab-content hidden" role="tabpanel" aria-labelledby="gapen-tab">
                <div class="card">
                    <h2>🥱 Gaap Preventie Technieken</h2>
                    <p>Voor wanneer je die vervelende gaapaanvallen voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>Lipremming-techniek</h4>
                    <p>Druk je lippen zachtjes op elkaar wanneer je een gaapneiging voelt. Laat de lucht langzaam door je neus in en uit gaan.</p>
                </div>

                <div class="technique-card">
                    <h4>Mini-ademhalingen</h4>
                    <p>Neem bewust 3-4 zeer kleine, ondiepe ademhalingen door je neus. Hiermee voorkom je de grote 'zucht-ademhaling'.</p>
                </div>

                <div class="technique-card">
                    <h4>Tongpositie veranderen</h4>
                    <p>Plaats je tongpunt tegen je gehemelte (achter je voortanden). Dit vermindert de neiging tot gapen.</p>
                </div>

                <div class="technique-card">
                    <h4>Water drinken</h4>
                    <p>Neem kleine slokjes water wanneer je merkt dat je begint te gapen. Dit doorbreekt het ademhalingspatroon.</p>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Belangrijk om te onthouden:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Ze geven je de kans om preventief in te grijpen voordat een volledige hyperventilatie-episode begint.
                </div>

                <div class="card">
                    <h3>Gedachte-Breaking Technieken</h3>
                    <div class="technique-card">
                        <strong>Paradoxale intentie:</strong> "Oké hersenen, jullie willen dat ik ga gapen? Prima, ik ga nu heel bewust gapen"
                    </div>
                    <div class="technique-card">
                        <strong>Herframing:</strong> "Mijn brein probeert me te beschermen, maar ik hoef niet te reageren"
                    </div>
                    <div class="technique-card">
                        <strong>Aandacht verplaatsen:</strong> Tel 5 blauwe dingen die je kunt zien
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Gaap Preventie Technieken')">
                        📝 Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- EMDR Tab -->
            <div id="emdr" class="tab-content hidden" role="tabpanel" aria-labelledby="emdr-tab">
                <div class="card">
                    <h2>💜 EMDR Zelfhulp</h2>
                    <p>Voor luchthonger-gevoelens (dit is ondersteuning, geen vervanging voor professionele EMDR)</p>
                </div>

                <div class="alert alert-warning">
                    <strong>⚠️ Gebruik dit alleen voor milde tot matige gevoelens. Stop als je je overweldigd voelt.</strong>
                </div>

                <div class="alert alert-info">
                    <strong>🎧 Bilaterale Audio:</strong> Voor de beste ervaring, gebruik koptelefoon of oortjes. Zet het volume op een comfortabel niveau voordat je begint.
                </div>

                <!-- Audio Controls -->
                <div class="card">
                    <h3>🔊 Bilaterale Audio Stimulatie</h3>
                    <p style="margin-bottom: 1rem;">Een instelbare toon die van links naar rechts beweegt om bilaterale hersenstimulatie te ondersteunen.</p>
                    
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Volume (%)</label>
                            <input type="number" id="audio-volume" value="30" min="10" max="100" step="10">
                        </div>
                        <div class="breath-setting">
                            <label>Snelheid (sec)</label>
                            <input type="number" id="audio-speed" value="2" min="1" max="5" step="0.5">
                        </div>
                        <div class="breath-setting">
                            <label>Toonhoogte (Hz)</label>
                            <input type="number" id="audio-frequency" value="880" min="60" max="1000" step="10">
                            <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 0.25rem;">60-1000 Hz</div>
                        </div>
                        <div class="breath-setting">
                            <label>Status</label>
                            <div id="audio-status" style="font-weight: bold; color: var(--text-light); margin-top: 0.5rem;">Gestopt</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="audio-btn" class="btn btn-purple" onclick="toggleBilateralAudio()">
                            🔊 Start Audio
                        </button>
                    </div>
                </div>

                <!-- Eye Movement Controls - VERVANG DEZE HELE SECTIE -->

<div class="card" id="eye-movement-card">
    <h3>👁️ Oogbeweging Stimulatie</h3>
    <p style="margin-bottom: 1rem;">Volg de bewegende stip met je ogen zonder je hoofd te bewegen. Dit activeert beide hersenhelften.</p>

```
<div class="breath-controls">
    <div class="breath-setting">
        <label>Snelheid (bewegingen/min)</label>
        <input type="range" id="eye-speed" min="20" max="120" value="60" class="range-input">
        <div class="range-value" id="eye-speed-value">60</div>
    </div>
    <div class="breath-setting">
        <label>Patroon</label>
        <select id="eye-pattern" class="form-select">
            <option value="horizontal" selected>Horizontaal</option>
            <option value="vertical">Verticaal</option>
            <option value="diagonal">Diagonaal</option>
            <option value="figure8">Figuur 8</option>
            <option value="circle">Cirkel</option>
        </select>
    </div>
    <div class="breath-setting">
        <label>Amplitude</label>
        <input type="range" id="eye-amplitude" min="20" max="80" value="60" class="range-input">
        <div class="range-value" id="eye-amplitude-value">60%</div>
    </div>
    <div class="breath-setting">
        <label>Status</label>
        <div id="eye-status" style="font-weight: bold; color: var(--text-light); margin-top: 0.5rem;">Gestopt</div>
    </div>
</div>

<!-- Eye Movement Display -->
<div id="eye-movement-display" style="position: relative; height: 250px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 1rem; margin: 1rem 0; border: 2px solid #0ea5e9; overflow: hidden;">
    <div id="eye-dot" style="position: absolute; width: 16px; height: 16px; background: radial-gradient(circle, #ef4444, #dc2626); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4), 0 0 16px rgba(239, 68, 68, 0.2); transition: none; display: none; z-index: 10;">
        <div style="width: 6px; height: 6px; background: rgba(255,255,255,0.9); border-radius: 50%; position: absolute; top: 2px; left: 4px;"></div>
        <div style="width: 3px; height: 3px; background: rgba(255,255,255,0.6); border-radius: 50%; position: absolute; top: 8px; left: 9px;"></div>
    </div>
    <div id="eye-instructions" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #0ea5e9; font-weight: 600; font-size: 0.95rem;">
        Klik op start om oogbewegingen te beginnen<br>
        <span style="font-size: 0.8rem; opacity: 0.8;">Volg het rode bolletje alleen met je ogen</span>
    </div>
</div>

<div class="button-group">
    <button id="eye-btn" class="btn btn-cyan" onclick="toggleEyeMovements()">
        👁️ Start Oogbewegingen
    </button>
    <button class="btn btn-orange" onclick="resetEyeMovements()">
        🔄 Reset
    </button>
</div>

                    <!-- Eye Movement Display -->
                    <div id="eye-movement-display" style="position: relative; height: 200px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 1rem; margin: 1rem 0; border: 2px solid #0ea5e9; overflow: hidden;">
                        <div id="eye-dot" style="position: absolute; width: 20px; height: 20px; background: radial-gradient(circle, #ef4444, #dc2626); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); transition: all 0.1s ease-out; display: none;">
                            <div style="width: 8px; height: 8px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 6px; opacity: 0.9;"></div>
                        </div>
                        <div id="eye-instructions" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #0ea5e9; font-weight: 600;">
                            Klik op start om oogbewegingen te beginnen
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="eye-btn" class="btn btn-cyan" onclick="toggleEyeMovements()">
                            👁️ Start Oogbewegingen
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 id="emdr-title">Stap 1: Voorbereiding</h3>
                    <div id="emdr-content">
                        <p>Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.</p>
                    </div>

                    <div id="emdr-intensity" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Intensiteit van luchthonger-gevoel (1-10):</label>
                            <input type="range" min="1" max="10" value="5" class="range-input" id="emdr-intensity-slider">
                            <div class="range-value" id="emdr-intensity-value">5</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="emdr-prev-btn" class="btn btn-orange" onclick="prevEmdrStep()" style="display: none;">Vorige</button>
                        <button id="emdr-next-btn" class="btn btn-purple" onclick="nextEmdrStep()">Volgende</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="emdr-progress" style="width: 20%"></div>
                    </div>

                    <div id="emdr-complete" class="alert alert-success hidden">
                        <strong>✅ EMDR Zelfhulp Sessie Voltooid!</strong><br>
                        Goed gedaan! Je hebt alle 5 stappen van de EMDR zelfhulp doorlopen.
                        <br><br>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openDagboekModal('EMDR Zelfhulp - 5 Stappen Voltooid')">
                                📝 Maak Dagboek Entry
                            </button>
                            <button class="btn btn-orange" onclick="skipEmdrDagboek()">
                                ⏭️ Overslaan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content hidden" role="tabpanel" aria-labelledby="dagboek-tab">
                <div class="card">
                    <h2>📖 Dagboek</h2>
                    <p>Overzicht van je sessies en vooruitgang</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Handmatige Entry')">
                            ➕ Nieuwe Entry
                        </button>
                        <button class="btn btn-green" onclick="loadDagboekEntries()">
                            🔄 Vernieuw
                        </button>
                        <button class="btn btn-orange" onclick="exportDagboek()">
                            📥 Export Dagboek
                        </button>
                    </div>
                </div>

                <!-- Vooruitgang Grafiek -->
                <div class="card">
                    <h3>📊 Je Vooruitgang</h3>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Intensiteit scores over tijd - lagere scores betekenen meer verbetering</p>
                    
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="progress-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <div id="chart-legend" class="chart-legend" style="display: none; margin-top: 1rem;">
                        <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem;">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></div>
                                <span>Vóór oefening</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                                <span>Ná oefening</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chart-empty" class="alert alert-info" style="text-align: center;">
                        <strong>📈 Geen data beschikbaar</strong><br>
                        Maak een paar dagboek entries om je vooruitgang te zien!
                    </div>
                </div>

                <div id="dagboek-entries">
                    <!-- Entries worden hier geladen -->
                </div>

                <div class="card">
                    <h3>Patronen om naar uit te kijken</h3>
                    <ul class="step-list">
                        <li>Welke technieken het beste werken voor jou</li>
                        <li>Tijdstippen waarop klachten vaker voorkomen</li>
                        <li>Specifieke triggers (werk, stress, bepaalde gedachten)</li>
                        <li>Verband tussen maagklachten en ademhalingsproblemen</li>
                        <li>Verbetering in intensiteit scores over tijd</li>
                    </ul>
                </div>
            </div>

            <!-- Statistieken Tab -->
            <div id="statistieken" class="tab-content hidden" role="tabpanel" aria-labelledby="statistieken-tab">
                <div class="card">
                    <h2>📊 Statistieken & Inzichten</h2>
                    <p>Ontdek patronen in je ademhalingspraktijk en zie welke technieken het beste voor jou werken</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="loadStatistics()">
                            🔄 Statistieken Laden
                        </button>
                        <button class="btn btn-green" onclick="exportStatistics()">
                            📥 Export Rapport
                        </button>
                    </div>
                </div>

                <!-- Quick Stats Overview -->
                <div id="stats-overview" class="grid" style="margin-bottom: 2rem;">
                    <!-- Stats cards will be inserted here -->
                </div>

                <!-- Most Used Techniques -->
                <div class="card">
                    <h3>🏆 Meest Gebruikte Technieken</h3>
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="usage-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div id="usage-empty" class="alert alert-info" style="text-align: center;">
                        <strong>📈 Geen data beschikbaar</strong><br>
                        Maak een paar dagboek entries om te zien welke technieken je het meest gebruikt!
                    </div>
                </div>

                <!-- Effectiveness Analysis -->
                <div class="card">
                    <h3>⚡ Effectiviteit per Techniek</h3>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Gemiddelde verbetering in intensiteit score (hoger = beter)</p>
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="effectiveness-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div id="effectiveness-empty" class="alert alert-info" style="text-align: center;">
                        <strong>📈 Geen data beschikbaar</strong><br>
                        Voer meer sessies uit om effectiviteit te kunnen analyseren!
                    </div>
                </div>

                <!-- Results Distribution -->
                <div class="card">
                    <h3>🎯 Resultaten Verdeling</h3>
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="results-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div id="results-empty" class="alert alert-info" style="text-align: center;">
                        <strong>📈 Geen data beschikbaar</strong><br>
                        Vul resultaten in bij je dagboek entries om deze analyse te zien!
                    </div>
                </div>

                <!-- Intensity Improvement Trends -->
                <div class="card">
                    <h3>📈 Intensiteit Verbeteringen</h3>
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="improvement-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div id="improvement-empty" class="alert alert-info" style="text-align: center;">
                        <strong>📈 Geen data beschikbaar</strong><br>
                        Meer data nodig om verbeteringstrends te tonen!
                    </div>
                </div>

                <!-- Detailed Statistics Table -->
                <div class="card">
                    <h3>📋 Gedetailleerde Statistieken</h3>
                    <div id="detailed-stats" style="overflow-x: auto;">
                        <!-- Detailed stats table will be inserted here -->
                    </div>
                </div>

                <!-- Insights and Recommendations -->
                <div id="insights-section" class="card" style="display: none;">
                    <h3>💡 Persoonlijke Inzichten</h3>
                    <div id="insights-content">
                        <!-- AI-like insights will be generated here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Dagboek Modal -->
    <div id="dagboek-modal" class="modal" role="dialog" aria-labelledby="dagboek-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dagboek-modal-title">📝 Dagboek Entry</h3>
                <button class="close-btn" onclick="closeDagboekModal()" aria-label="Sluit dagboek venster">&times;</button>
            </div>
            
            <form id="dagboek-form" novalidate>
                <div class="form-group">
                    <label class="form-label" for="entry-trigger">Situatie/Trigger:</label>
                    <input type="text" id="entry-trigger" class="form-input" placeholder="Bijv. na intensief werken">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label class="form-label" for="entry-before">Intensiteit vóór oefening (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before">
                        <div class="range-value" id="entry-before-value">5</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="entry-after">Intensiteit ná oefening (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after">
                        <div class="range-value" id="entry-after-value">5</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="entry-result">Resultaat:</label>
                    <select id="entry-result" class="form-select">
                        <option value="">Selecteer resultaat...</option>
                        <option value="zeer-goed">Zeer goed - volledig opgelost</option>
                        <option value="goed">Goed - duidelijke verbetering</option>
                        <option value="matig">Matig - kleine verbetering</option>
                        <option value="geen-effect">Geen effect</option>
                        <option value="slechter">Iets slechter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="entry-notes">Notities:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op?"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="save-dagboek-entry-btn">
                        📁 Opslaan
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeDagboekModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">📞 In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <!-- Developer Credit -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8; color: rgba(255,255,255,0.9);">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>

<script type="module">
    // Enhanced error handling and logging
    const LOG_LEVELS = {
        INFO: 'ℹ️',
        SUCCESS: '✅', 
        WARNING: '⚠️',
        ERROR: '❌'
    };

    function log(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString('nl-NL');
        console.log(`${LOG_LEVELS[level]} [${timestamp}] ${message}`, data || '');
    }

    // Enhanced app state management
    class AppState {
        constructor() {
            this.currentUser = null;
            this.currentTab = 'dashboard';
            this.isOnline = navigator.onLine;
            this.isFirebaseConnected = false;
            this.authInitialized = false;
            this.authUnsubscribe = null;
            this.currentTechnique = '';
            this.tips = [
                "Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.",
                "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
                "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
                "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
                "Een koude kompres op je gezicht activeert de duikreflex en kalmeert het zenuwstelsel.",
                "Grounding technieken zoals 5-4-3-2-1 helpen je geest terug naar het hier en nu te brengen.",
                "Zachte ademhaling is effectiever dan diepe ademhaling bij hyperventilatie.",
                "Regelmatige oefening van ademhalingstechnieken vermindert de kans op episodes.",
                "Het bijhouden van patronen in je dagboek helpt je triggers te identificeren.",
                "Na intensief denkwerk heeft je lichaam een afkoel ritueel nodig om te ontspannen."
            ];
            // Initialize auth-loading spinner to be visible initially
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'inline-block';
            }
        }

        setUser(user) {
            this.currentUser = user;
            this.updateUI();
        }

        setConnectionStatus(isConnected) {
            this.isFirebaseConnected = isConnected;
            this.updateConnectionDisplay();
        }

        cleanup() {
            if (this.authUnsubscribe) {
                try {
                    this.authUnsubscribe();
                    this.authUnsubscribe = null;
                } catch (error) {
                    log('WARNING', 'Error unsubscribing from auth:', error);
                }
            }
        }

        updateUI() {
            const userInfo = document.getElementById('user-info');
            const accountInfo = document.getElementById('account-info');
            
            // Hide loading spinner regardless of auth state
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'none';
            }

            if (this.currentUser && userInfo) {
                const displayName = this.currentUser.displayName || this.currentUser.email;
                const shortName = displayName.length > 15 ? displayName.substring(0, 13) + '...' : displayName;
                userInfo.innerHTML = shortName;
            } else if (userInfo) {
                userInfo.innerHTML = '';
            }

            if (this.currentUser && accountInfo) {
                accountInfo.innerHTML = 
                    '<p style="color: var(--text-light); font-size: 0.9rem;">' +
                    '<strong>Ingelogd als:</strong><br>' + 
                    (this.currentUser.displayName || this.currentUser.email) + 
                    '</p>';
            } else if (accountInfo) {
                accountInfo.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Niet ingelogd</p>';
            }
            
            this.updateDashboardGreeting();
        }

        updateDashboardGreeting() {
            const greetingElement = document.getElementById('dashboard-greeting');
            if (greetingElement && this.currentUser) {
                const firstName = this.getFirstName();
                const timeOfDay = this.getTimeOfDay();
                greetingElement.textContent = `${timeOfDay}, ${firstName}!`;
            } else if (greetingElement) {
                greetingElement.textContent = `Welkom bij Ademruimte`;
            }
        }

        getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Goedemorgen';
            if (hour < 18) return 'Goedemiddag';
            return 'Goedenavond';
        }

        updateConnectionDisplay() {
            const statusDot = document.getElementById('firebase-status-dot');
            if (statusDot) {
                if (this.isFirebaseConnected) {
                    statusDot.className = 'status-connected';
                    statusDot.title = 'Firebase: Verbonden';
                } else if (this.isOnline) {
                    statusDot.className = 'status-disconnected'; 
                    statusDot.title = 'Firebase: Verbindingsprobleem of niet geïnitialiseerd';
                } else {
                    statusDot.className = 'status-error';
                    statusDot.title = 'Firebase: Geen internetverbinding';
                }
            }
        }

        getRandomTip() {
            return this.tips[Math.floor(Math.random() * this.tips.length)];
        }

        getFirstName() {
            if (!this.currentUser) return 'Gebruiker';
            
            const displayName = this.currentUser.displayName;
            if (displayName) {
                return displayName.split(' ')[0];
            }
            
            const email = this.currentUser.email;
            if (email) {
                const localPart = email.split('@')[0];
                return localPart.charAt(0).toUpperCase() + localPart.slice(1);
            }
            
            return 'Gebruiker';
        }
    }

    // Initialize app state
    const appState = new AppState();

    // Global variables voor verschillende functionaliteiten
    let app, db, auth;
    let timerInterval = null;
    let currentTime = 0;
    let ritualStep = 0;
    let emdrStep = 0;

    // Breath exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 1;
    let breathPhaseTime = 0;
    let breathCycleDuration = 0;
    let breathingPattern = 'standard';
    let gentleBreathCount = 0;

    // Audio variables for EMDR
    let audioContext = null;
    let oscillator = null;
    let gainNode = null;
    let pannerNode = null;
    let audioInterval = null;
    let isAudioPlaying = false;
    let panPosition = -1;

    // Eye movement variables
    let eyeMovementInterval = null;
    let isEyeMovementActive = false;
    let eyePosition = { x: 50, y: 50 };
    let eyeDirection = { x: 1, y: 0 };

    // Wake lock for keeping screen on
    let wakeLock = null;

    // Chart variables
    let progressChart = null;
    let usageChart = null;
    let effectivenessChart = null;
    let resultsChart = null;
    let improvementChart = null;

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte-12c09.firebaseapp.com", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Ritual step data
    const ritualSteps = [
        {
            title: "Stap 1: Fysieke Mini-Reset",
            duration: 120,
            instructions: [
                "Sta op en strek je volledig uit",
                "Schud je armen en benen los", 
                "Rol je schouders 5x naar achteren",
                "Maak kleine cirkels met je hoofd (5x elke richting)"
            ]
        },
        {
            title: "Stap 2: Ademhaling Reset",
            duration: 90,
            instructions: [
                "Ga comfortabel zitten of staan",
                "Adem 5x heel diep in door je neus",
                "Adem langzaam uit door je mond",
                "Let op de vertraging tussen gedachte en lichaam"
            ]
        },
        {
            title: "Stap 3: Mentale Overgang",
            duration: 120,
            instructions: [
                "Zeg hardop: 'Ik ben klaar met intensief denken'",
                "Denk aan 3 dingen waar je dankbaar voor bent",
                "Visualiseer je volgende activiteit",
                "Geef jezelf toestemming om te ontspannen"
            ]
        },
        {
            title: "Stap 4: Zintuiglijke Reset",
            duration: 90,
            instructions: [
                "Kijk bewust rond - wat zie je?",
                "Luister naar geluiden om je heen",
                "Voel de temperatuur op je huid",
                "Ruik bewust de lucht om je heen"
            ]
        },
        {
            title: "Stap 5: Intentie Zetten",
            duration: 60,
            instructions: [
                "Besluit bewust hoe je je volgende tijd wilt besteden",
                "Zeg tegen jezelf: 'Ik ga nu over naar [activiteit]'",
                "Neem één bewuste stap in die richting",
                "Feliciteer jezelf - je hebt een goede overgang gemaakt"
            ]
        }
    ];

    // EMDR Step data
    const emdrSteps = [
        {
            title: "Stap 1: Voorbereiding",
            content: "Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.",
            showIntensity: false
        },
        {
            title: "Stap 2: Identificeer het Gevoel",
            content: "Denk aan het luchthonger-gevoel. Waar voel je het in je lichaam? Geef het een intensiteit score van 1-10.",
            showIntensity: true
        },
        {
            title: "Stap 3: Bilaterale Stimulatie",
            content: "Start de bilaterale audio of oogbewegingen als je dit nog niet hebt gedaan. Focus op het gevoel terwijl je naar de stimulatie luistert/kijkt. Laat gedachten en gevoelens vrijelijk komen en gaan.",
            showIntensity: false
        },
        {
            title: "Stap 4: Check-in",
            content: "Stop de stimulatie. Hoe voelt het luchthonger-gevoel nu? Is de intensiteit veranderd? Geef een nieuwe score van 1-10.",
            showIntensity: true
        },
        {
            title: "Stap 5: Afsluiting",
            content: "Neem een paar diepe, langzame ademhalingen. Visualiseer een veilige, kalme plek. Je hebt goed werk gedaan. Drink wat water als je dat nodig hebt.",
            showIntensity: false
        }
    ];

    // Progress tracking functions
    let progressDataStore = {
        buteyko: { sessions: 0, totalTime: 0, lastSession: null },
        ritual: { sessions: 0, totalTime: 0, lastSession: null },
        emdr: { sessions: 0, totalTime: 0, lastSession: null },
        crisis: { sessions: 0, lastSession: null }
    };

    function loadProgressData() {
        try {
            if (typeof Storage !== "undefined" && window.localStorage) {
                const stored = localStorage.getItem('ademruimte-progress');
                if (stored) {
                    progressDataStore = { ...progressDataStore, ...JSON.parse(stored) };
                    log('SUCCESS', 'Progress data loaded from localStorage');
                    return;
                }
            }
        } catch (error) {
            log('WARNING', 'localStorage not available, using in-memory storage:', error.message);
        }
        
        log('INFO', 'Using in-memory progress storage');
    }

    function saveProgressData() {
        try {
            if (typeof Storage !== "undefined" && window.localStorage) {
                localStorage.setItem('ademruimte-progress', JSON.stringify(progressDataStore));
                log('SUCCESS', 'Progress data saved to localStorage');
                return;
            }
        } catch (error) {
            log('WARNING', 'localStorage not available, data will not persist between sessions:', error.message);
        }
    }

    function trackSession(type, duration = null) {
        if (!progressDataStore[type]) {
            progressDataStore[type] = { sessions: 0, totalTime: 0, lastSession: null };
        }
        
        progressDataStore[type].sessions++;
        if (duration) {
            progressDataStore[type].totalTime += duration;
        }
        progressDataStore[type].lastSession = new Date().toISOString();
        
        saveProgressData();
        log('SUCCESS', `Tracked ${type} session:`, progressDataStore[type]);
    }

    // Firebase initialization
    async function initializeFirebase() {
        if (appState.authInitialized) {
            log('INFO', 'Firebase already initialized.');
            return true;
        }

        try {
            log('INFO', 'Initializing Firebase...');
            
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            const { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithRedirect, getRedirectResult } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            await setPersistence(auth, browserLocalPersistence);

            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    log('SUCCESS', 'Google sign-in successful via redirect result:', result.user.email);
                    return true;
                }
            } catch (redirectError) {
                log('ERROR', 'Error getting redirect result:', redirectError);
                showUserMessage(`Fout bij Google login: ${redirectError.message}`, 'error');
            }

            setupAuthStateObserver(onAuthStateChanged);

            appState.setConnectionStatus(true);
            appState.authInitialized = true;
            
            log('SUCCESS', 'Firebase initialized successfully');
            return true;

        } catch (error) {
            log('ERROR', 'Firebase initialization failed:', error);
            appState.setConnectionStatus(false);
            appState.authInitialized = false;
            
            showUserMessage('Firebase kon niet worden geïnitialiseerd. Controleer je internetverbinding.', 'error');
            showLoginScreen();
            
            return false;
        }
    }

    function setupAuthStateObserver(onAuthStateChanged) {
        if (!auth) {
            log('ERROR', 'Auth not initialized - cannot setup observer');
            return;
        }
        
        appState.authUnsubscribe = onAuthStateChanged(auth, (user) => {
            appState.updateUI();
            
            if (user) {
                log('SUCCESS', 'User authenticated:', user.email);
                appState.setUser(user);
                showMainApp();
                
                setTimeout(() => {
                    loadDagboekEntries().catch(error => {
                        log('WARNING', 'Could not load entries on login:', error);
                    });
                }, 500);
            } else {
                log('INFO', 'User not authenticated');
                appState.setUser(null);
                showLoginScreen();
            }
        }, (error) => {
            log('ERROR', 'Auth state observer error:', error);
            appState.updateUI();
            showUserMessage('Authenticatie fout: ' + error.message, 'error');
            showLoginScreen();
        });
    }

    // Screen management
    function showLoginScreen() {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loginScreen && mainApp) {
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            
            setTimeout(() => {
                const emailField = document.getElementById('login-email');
                if (emailField) {
                    emailField.focus();
                }
            }, 100);
        }
        
        log('INFO', 'Switched to login screen');
    }

    function showMainApp() {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loginScreen && mainApp) {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            setTimeout(() => {
                appState.updateDashboardGreeting();
            }, 100);
            
            const dashboard = document.querySelector('[data-tab="dashboard"]');
            if (dashboard) dashboard.focus();
        }
        
        log('INFO', 'Switched to main app');
    }

    // Authentication functions
    window.signInWithGoogle = async function() {
        const googleBtn = document.getElementById('google-login-btn');
        const originalBtnText = googleBtn.querySelector('#google-btn-text').textContent;
        googleBtn.querySelector('#google-btn-text').textContent = 'Bezig...';
        googleBtn.disabled = true;
        
        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer email/wachtwoord login.', 'warning');
                googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
                googleBtn.disabled = false;
                return;
            }
        }

        try {
            log('INFO', 'Starting Google sign-in with redirect...');
            
            const { GoogleAuthProvider, signInWithRedirect } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ 
                prompt: 'select_account'
            });
            
            await signInWithRedirect(auth, provider);
            
        } catch (error) {
            log('ERROR', 'Google sign-in failed:', error);
            
            let message = 'Google inloggen mislukt';
            if (error.code === 'auth/popup-blocked') {
                message = 'Login werd geblokkeerd. Controleer popup instellingen of gebruik email/wachtwoord.';
            } else if (error.code === 'auth/network-request-failed') {
                message = 'Netwerkfout. Controleer je internetverbinding en probeer opnieuw.';
            } else if (error.code === 'auth/cancelled-popup-request') {
                message = 'Google inloggen geannuleerd.';
                showUserMessage(message, 'info');
                googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
                googleBtn.disabled = false;
                return; 
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Te veel inlogpogingen. Probeer het later opnieuw.';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
            googleBtn.disabled = false;
        }
    };

    window.performLogout = async function() {
        if (!confirm('Weet je zeker dat je wilt uitloggen?')) {
            return;
        }
        
        try {
            if (isAudioPlaying) toggleBilateralAudio();
            if (isEyeMovementActive) toggleEyeMovements();
            if (wakeLock) releaseWakeLock();
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (breathInterval) {
                clearInterval(breathInterval);
                breathInterval = null;
            }
            
            if (auth && auth.currentUser) {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                await signOut(auth);
                log('SUCCESS', 'User logged out successfully');
                showUserMessage('Je bent succesvol uitgelogd!', 'success');
            } else {
                log('INFO', 'No user logged in to log out.');
                showUserMessage('Je bent al uitgelogd.', 'info');
            }
            
        } catch (error) {
            log('ERROR', 'Logout failed:', error);
            showUserMessage('Uitloggen mislukt: ' + error.message, 'error');
        }
    };

    // Tab management
    window.showTab = function(tabName) {
        if (appState.currentTab === 'emdr' && tabName !== 'emdr') {
            if (isAudioPlaying) toggleBilateralAudio();
            if (isEyeMovementActive) toggleEyeMovements();
        }

        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        
        const selectedTab = document.getElementById(tabName);
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }
        
        if (selectedBtn) {
            selectedBtn.classList.add('active');
            selectedBtn.setAttribute('aria-selected', 'true');
        }
        
        appState.currentTab = tabName;
        
        if (tabName === 'dagboek') {
            loadDagboekEntries().catch(error => {
                log('WARNING', 'Could not load dagboek entries:', error);
            });
        } else if (tabName === 'statistieken') {
            loadStatistics();
        }
        
        log('INFO', `Switched to tab: ${tabName}`);
    };

    // User feedback system
    function showUserMessage(message, type = 'info') {
        const existing = document.querySelector('.user-message');
        if (existing) existing.remove();
        
        const messageEl = document.createElement('div');
        messageEl.className = `user-message alert-${type}`;
        messageEl.style.whiteSpace = 'pre-line';
        messageEl.textContent = message;
        messageEl.setAttribute('role', 'alert');
        messageEl.setAttribute('aria-live', 'polite');
        
        if (message.length > 50) {
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 0.5rem;
                right: 0.75rem;
                background: none;
                border: none;
                font-size: 1.25rem;
                cursor: pointer;
                color: inherit;
                opacity: 0.7;
                line-height: 1;
                padding: 0;
                width: 20px;
                height: 20px;
            `;
            closeBtn.onclick = () => messageEl.remove();
            messageEl.style.paddingRight = '3rem';
            messageEl.appendChild(closeBtn);
        }
        
        document.body.appendChild(messageEl);
        
        const delay = type === 'error' ? 8000 : 5000;
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.style.animation = 'slideInDown 0.3s ease-out reverse';
                setTimeout(() => messageEl.remove(), 300);
            }
        }, delay);
    }

    // Form handling
    function setupForms() {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
        }
        
        if (registerForm) {
            registerForm.addEventListener('submit', handleRegister);
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }

        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer het later opnieuw.', 'error');
                return;
            }
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Bezig met inloggen...';
            submitBtn.disabled = true;
            
            const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signInWithEmailAndPassword(auth, email, password);
            
            log('SUCCESS', 'Email sign-in successful');
            e.target.reset();
            
        } catch (error) {
            log('ERROR', 'Email sign-in failed:', error);
            
            let message = 'Inloggen mislukt';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                message = 'Geen account gevonden met deze gegevens';
            } else if (error.code === 'auth/wrong-password') {
                message = 'Verkeerd wachtwoord';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Te veel mislukte pogingen. Probeer het later opnieuw.';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        
        if (!name || !email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }
        
        if (password.length < 6) {
            showUserMessage('Wachtwoord moet minimaal 6 karakters zijn', 'warning');
            return;
        }

        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer het later opnieuw.', 'error');
                return;
            }
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Account aanmaken...';
            submitBtn.disabled = true;
            
            const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const result = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(result.user, { displayName: name });
            
            log('SUCCESS', 'Account created successfully');
            closeRegisterModal();
            showUserMessage('Account succesvol aangemaakt!', 'success');
            
        } catch (error) {
            log('ERROR', 'Registration failed:', error);
            
            let message = 'Account aanmaken mislukt';
            if (error.code === 'auth/email-already-in-use') {
                message = 'Dit email adres is al in gebruik. Probeer in te loggen.';
            } else if (error.code === 'auth/weak-password') {
                message = 'Wachtwoord is te zwak. Gebruik minimaal 6 karakters.';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // Modal management
    window.showRegisterForm = function() {
        document.getElementById('register-modal').classList.add('show');
        
        setTimeout(() => {
            const modal = document.getElementById('register-modal');
            const nameField = document.getElementById('register-name');
            if (nameField && modal) {
                modal.scrollTop = 0;
                nameField.focus();
                
                if (window.innerWidth <= 768) {
                    nameField.click();
                    setTimeout(() => {
                        nameField.focus();
                        nameField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }, 150);
    };

    window.closeRegisterModal = function() {
        document.getElementById('register-modal').classList.remove('show');
        document.getElementById('register-form').reset();
    };

    // Tip management
    function setRandomTip() {
        const tipElement = document.getElementById('daily-tip');
        if (tipElement) {
            tipElement.textContent = appState.getRandomTip();
        }
    }

    window.getNewTip = function() {
        setRandomTip();
        showUserMessage('Nieuwe tip geladen! 💡', 'success');
    };

    // Timer functionality for Ritual
    window.startTimer = function() {
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerBtn.innerHTML = '▶️ Start Timer';
            timerBtn.className = 'btn btn-green';
            nextBtn.style.display = 'block';
            log('INFO', 'Timer stopped manually');
            return;
        }
        
        currentTime = ritualSteps[ritualStep].duration;
        timerBtn.innerHTML = '⏸️ Stop Timer';
        timerBtn.className = 'btn btn-red';
        nextBtn.style.display = 'none';
        
        timerInterval = setInterval(() => {
            currentTime--;
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (currentTime <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.innerHTML = '▶️ Start Timer';
                timerBtn.className = 'btn btn-green';
                nextBtn.style.display = 'block';
                showUserMessage('⏰ Timer afgelopen! Tijd voor de volgende stap.', 'success');
                log('SUCCESS', 'Timer completed');
            }
        }, 1000);
    };

    window.nextRitualStep = function() {
        if (ritualStep < ritualSteps.length - 1) {
            ritualStep++;
            updateRitualDisplay();
        } else {
            document.getElementById('ritual-complete').classList.remove('hidden');
            appState.currentTechnique = 'Afkoel Ritueel - 5 Stappen Voltooid';
            trackSession('ritual', ritualSteps.reduce((sum, step) => sum + step.duration, 0));
            log('SUCCESS', 'Ritual completed');
        }
    };

    window.skipToNextStep = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
            document.getElementById('timer-btn').className = 'btn btn-green';
        }
        nextRitualStep();
    };

    window.resetRitual = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        ritualStep = 0;
        updateRitualDisplay();
        document.getElementById('ritual-complete').classList.add('hidden');
        document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
    };

    function updateRitualDisplay() {
        const step = ritualSteps[ritualStep];
        
        document.getElementById('ritual-title').textContent = step.title;
        
        const minutes = Math.floor(step.duration / 60);
        const seconds = step.duration % 60;
        document.getElementById('timer-display').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        currentTime = step.duration;
        
        const instructionsHtml = '<ul class="step-list">' + 
            step.instructions.map(instruction => `<li>${instruction}</li>`).join('') +
            '</ul>';
        document.getElementById('ritual-instructions').innerHTML = instructionsHtml;
        
        const progress = ((ritualStep + 1) / ritualSteps.length) * 100;
        document.getElementById('ritual-progress').style.width = progress + '%';
        
        document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        log('INFO', `Ritual step ${ritualStep + 1}/${ritualSteps.length}: ${step.title}`);
    }

    // Buteyko breathing exercise functions
    window.updateBreathingPattern = function() {
        breathingPattern = document.getElementById('breathing-pattern').value;
        const standardControls = document.getElementById('standard-controls');
        const gentleControls = document.getElementById('gentle-controls');
        
        if (breathingPattern === 'gentle') {
            standardControls.classList.add('hidden');
            gentleControls.classList.remove('hidden');
        } else {
            standardControls.classList.remove('hidden');
            gentleControls.classList.add('hidden');
        }
        
        if (breathInterval) {
            resetBreathExercise();
        }
    };

    window.toggleBreathExercise = function() {
        if (breathInterval) {
            stopBreathExercise();
        } else {
            startBreathExercise();
        }
    };

    window.resetBreathExercise = function() {
        stopBreathExercise();
        breathCycleCount = 1;
        gentleBreathCount = 0;
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
        document.getElementById('breath-complete').classList.add('hidden');
    };

    function startBreathExercise() {
        requestWakeLock();
        
        breathCycleCount = 1;
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
        
        if (breathingPattern === 'gentle') {
            startGentleBreathing();
        } else {
            startStandardBreathing();
        }
    }

    function startStandardBreathing() {
        const inhale = parseInt(document.getElementById('inhale-duration').value);
        const exhale = parseInt(document.getElementById('exhale-duration').value);
        const hold = parseInt(document.getElementById('hold-duration').value);
        
        breathCycleDuration = inhale + exhale + hold;
        breathPhase = 'inhale';
        breathPhaseTime = 0;
        
        document.getElementById('breath-btn').innerHTML = '⏸️ Stop Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-red';
        
        breathInterval = setInterval(() => {
            updateStandardBreathCycle();
        }, 100);
    }

    function startGentleBreathing() {
        const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
        const pauseTime = parseInt(document.getElementById('gentle-pause').value);
        
        breathPhase = 'gentle-breath';
        breathPhaseTime = 0;
        gentleBreathCount = 0;
        
        document.getElementById('breath-btn').innerHTML = '⏸️ Stop Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-red';
        
        breathInterval = setInterval(() => {
            updateGentleBreathCycle();
        }, 100);
    }

    function stopBreathExercise() {
        if (breathInterval) {
            clearInterval(breathInterval);
            breathInterval = null;
        }
        
        releaseWakeLock();
        
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        
        document.getElementById('breath-btn').innerHTML = '▶️ Start Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-cyan';
    }

    function updateStandardBreathCycle() {
        const inhale = parseInt(document.getElementById('inhale-duration').value);
        const exhale = parseInt(document.getElementById('exhale-duration').value);
        const hold = parseInt(document.getElementById('hold-duration').value);
        
        breathPhaseTime += 0.1;
        
        let progress = 0;
        
        if (breathPhase === 'inhale') {
            progress = (breathPhaseTime / inhale) * 100;
            if (breathPhaseTime >= inhale) {
                breathPhase = 'exhale';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'exhale') {
            progress = (breathPhaseTime / exhale) * 100;
            if (breathPhaseTime >= exhale) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / hold) * 100;
            if (breathPhaseTime >= hold) {
                breathPhase = 'inhale';
                breathPhaseTime = 0;
                breathCycleCount++;
                document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}/10`;
                
                if (breathCycleCount > 10) {
                    stopBreathExercise();
                    trackSession('buteyko', 10 * breathCycleDuration);
                    document.getElementById('breath-complete').classList.remove('hidden');
                    appState.currentTechnique = 'Buteyko Ademhaling - 10 Cycli Voltooid';
                    log('SUCCESS', 'Buteyko session completed');
                    return;
                }
            }
        }
        
        updateBreathDisplay();
        updateBreathProgress(Math.min(progress, 100));
    }

    function updateGentleBreathCycle() {
        const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
        const pauseTime = parseInt(document.getElementById('gentle-pause').value);
        
        breathPhaseTime += 0.1;
        let progress = 0;
        
        if (breathPhase === 'gentle-breath') {
            progress = (breathPhaseTime / cycleTime) * 100;
            if (breathPhaseTime >= cycleTime) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
                gentleBreathCount++;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / pauseTime) * 100;
            if (breathPhaseTime >= pauseTime) {
                breathPhase = 'gentle-breath';
                breathPhaseTime = 0;
                breathCycleCount++;
                document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}/10`;
                
                if (breathCycleCount > 10) {
                    stopBreathExercise();
                    trackSession('buteyko', 10 * (cycleTime + pauseTime));
                    document.getElementById('breath-complete').classList.remove('hidden');
                    appState.currentTechnique = 'Buteyko Ademhaling - 10 Cycli Voltooid';
                    log('SUCCESS', 'Buteyko gentle session completed');
                    return;
                }
            }
        }
        
        updateBreathDisplay();
        updateBreathProgress(Math.min(progress, 100));
    }

    function updateBreathDisplay() {
        const display = document.getElementById('breath-display');
        const progressBar = document.getElementById('breath-progress');
        
        display.className = `breath-display ${breathPhase}`;
        progressBar.className = `breath-progress ${breathPhase}`;
        
        switch (breathPhase) {
            case 'inhale':
                display.textContent = '🌬️ Inademen';
                break;
            case 'exhale':
                display.textContent = '💨 Uitademen';
                break;
            case 'hold':
                display.textContent = '⏸️ Pauze';
                break;
            case 'gentle-breath':
                display.textContent = `🌬️ Zachte Ademhaling`;
                break;
            case 'rest':
            default:
                display.textContent = 'Klik op start om te beginnen';
                break;
        }
    }

    function updateBreathProgress(percentage) {
        document.getElementById('breath-progress').style.width = percentage + '%';
    }

    function resetButeykoAfterCompletion() {
        document.getElementById('breath-complete').classList.add('hidden');
        breathCycleCount = 1;
        gentleBreathCount = 0;
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
    }

    // Wake Lock API for keeping screen on
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                log('SUCCESS', 'Wake lock activated - screen will stay on');
                
                wakeLock.addEventListener('release', () => {
                    log('INFO', 'Wake lock released');
                });
            }
        } catch (error) {
            log('WARNING', 'Wake lock not supported or failed:', error);
        }
    }

    async function releaseWakeLock() {
        if (wakeLock) {
            try {
                await wakeLock.release();
                wakeLock = null;
                log('SUCCESS', 'Wake lock released');
            } catch (error) {
                log('ERROR', 'Error releasing wake lock:', error);
            }
        }
    }

    // Audio functions for EMDR
    function initAudioContext() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                log('SUCCESS', 'Audio context initialized');
            } catch (error) {
                log('ERROR', 'Audio context initialization failed:', error);
                showUserMessage('Je browser ondersteunt geen Web Audio API.', 'error');
                return false;
            }
        }
        return true;
    }

    window.toggleBilateralAudio = function() {
        if (isAudioPlaying) {
            stopBilateralAudio();
        } else {
            startBilateralAudio();
        }
    };

    function startBilateralAudio() {
        if (!initAudioContext()) return;

        try {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            oscillator = audioContext.createOscillator();
            const frequency = parseInt(document.getElementById('audio-frequency').value);
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';

            gainNode = audioContext.createGain();
            const volume = parseInt(document.getElementById('audio-volume').value) / 100;
            gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);

            pannerNode = audioContext.createStereoPanner();
            pannerNode.pan.setValueAtTime(-1, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(pannerNode);
            pannerNode.connect(audioContext.destination);

            oscillator.start();
            startPanning();

            isAudioPlaying = true;
            document.getElementById('audio-btn').innerHTML = '⏸️ Stop Audio';
            document.getElementById('audio-btn').className = 'btn btn-red';
            document.getElementById('audio-status').textContent = `Actief - ${frequency}Hz`;
            document.getElementById('audio-status').style.color = '#059669';

            log('SUCCESS', `Bilateral audio started at ${frequency}Hz`);

        } catch (error) {
            log('ERROR', 'Error starting bilateral audio:', error);
            showUserMessage('Fout bij starten audio: ' + error.message, 'error');
        }
    }

    function stopBilateralAudio() {
        try {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }

            if (gainNode) {
                gainNode.disconnect();
                gainNode = null;
            }

            if (pannerNode) {
                pannerNode.disconnect();
                pannerNode = null;
            }

            if (audioInterval) {
                clearInterval(audioInterval);
                audioInterval = null;
            }

            isAudioPlaying = false;
            panPosition = -1;
            
            document.getElementById('audio-btn').innerHTML = '🔊 Start Audio';
            document.getElementById('audio-btn').className = 'btn btn-purple';
            document.getElementById('audio-status').textContent = 'Gestopt';
            document.getElementById('audio-status').style.color = 'var(--text-light)';

            log('SUCCESS', 'Bilateral audio stopped');

        } catch (error) {
            log('ERROR', 'Error stopping bilateral audio:', error);
        }
    }

    function startPanning() {
        const speed = parseFloat(document.getElementById('audio-speed').value) * 1000;
        const updateInterval = 50;
        const steps = speed / updateInterval;
        const panStep = 2 / steps;

        panPosition = -1;
        let direction = 1;

        audioInterval = setInterval(() => {
            if (!isAudioPlaying || !pannerNode) {
                clearInterval(audioInterval);
                return;
            }

            panPosition += (panStep * direction);

            if (panPosition >= 1) {
                panPosition = 1;
                direction = -1;
            } else if (panPosition <= -1) {
                panPosition = -1;
                direction = 1;
            }

            pannerNode.pan.setValueAtTime(panPosition, audioContext.currentTime);

            const frequency = parseInt(document.getElementById('audio-frequency').value);
            if (appState.currentTab === 'emdr') {
                const side = panPosition < -0.3 ? 'Links' : panPosition > 0.3 ? 'Rechts' : 'Midden';
                document.getElementById('audio-status').textContent = `Actief - ${frequency}Hz - ${side}`;
            }

        }, updateInterval);
    }

    // Eye movement functions for EMDR
    window.toggleEyeMovements = function() {
        if (isEyeMovementActive) {
            stopEyeMovements();
        } else {
            startEyeMovements();
        }
    };

    function startEyeMovements() {
        const display = document.getElementById('eye-movement-display');
        const dot = document.getElementById('eye-dot');
        const instructions = document.getElementById('eye-instructions');
        const speedSelect = document.getElementById('eye-speed');
        const patternSelect = document.getElementById('eye-pattern');
        
        if (!display || !dot) return;
        
        dot.style.display = 'block';
        instructions.style.display = 'none';
        
        const speed = speedSelect.value;
        const pattern = patternSelect.value;
        
        let duration;
        switch (speed) {
            case 'slow': duration = 4000; break;
            case 'fast': duration = 1000; break;
            default: duration = 2000; break;
        }
        
        eyePosition = { x: 50, y: 50 };
        eyeDirection = { x: 1, y: 0 };
        
        isEyeMovementActive = true;
        document.getElementById('eye-btn').innerHTML = '⏸️ Stop Oogbewegingen';
        document.getElementById('eye-btn').className = 'btn btn-red';
        document.getElementById('eye-status').textContent = 'Actief';
        document.getElementById('eye-status').style.color = '#059669';
        
        eyeMovementInterval = setInterval(() => {
            updateEyePosition(pattern, display);
        }, 50);
        
        log('SUCCESS', `Eye movements started with ${pattern} pattern at ${speed} speed`);
    }

    function stopEyeMovements() {
        if (eyeMovementInterval) {
            clearInterval(eyeMovementInterval);
            eyeMovementInterval = null;
        }
        
        const dot = document.getElementById('eye-dot');
        const instructions = document.getElementById('eye-instructions');
        
        if (dot && instructions) {
            dot.style.display = 'none';
            instructions.style.display = 'block';
        }
        
        isEyeMovementActive = false;
        document.getElementById('eye-btn').innerHTML = '👁️ Start Oogbewegingen';
        document.getElementById('eye-btn').className = 'btn btn-cyan';
        document.getElementById('eye-status').textContent = 'Gestopt';
        document.getElementById('eye-status').style.color = 'var(--text-light)';
        
        log('SUCCESS', 'Eye movements stopped');
    }

    function updateEyePosition(pattern, display) {
        const dot = document.getElementById('eye-dot');
        if (!dot || !isEyeMovementActive) return;
        
        const displayRect = display.getBoundingClientRect();
        const margin = 30; // pixels from edge
        
        switch (pattern) {
            case 'horizontal':
                eyePosition.x += eyeDirection.x * 2;
                if (eyePosition.x >= 90 || eyePosition.x <= 10) {
                    eyeDirection.x *= -1;
                }
                eyePosition.y = 50;
                break;
                
            case 'vertical':
                eyePosition.y += eyeDirection.y * 2;
                if (eyePosition.y >= 90 || eyePosition.y <= 10) {
                    eyeDirection.y *= -1;
                }
                eyePosition.x = 50;
                break;
                
            case 'diagonal':
                eyePosition.x += eyeDirection.x * 1.5;
                eyePosition.y += eyeDirection.y * 1.5;
                if (eyePosition.x >= 90 || eyePosition.x <= 10) {
                    eyeDirection.x *= -1;
                }
                if (eyePosition.y >= 90 || eyePosition.y <= 10) {
                    eyeDirection.y *= -1;
                }
                break;
                
            case 'figure8':
                const time = Date.now() / 1000;
                eyePosition.x = 50 + 35 * Math.sin(time);
                eyePosition.y = 50 + 20 * Math.sin(2 * time);
                break;
        }
        
        // Ensure position stays within bounds
        eyePosition.x = Math.max(10, Math.min(90, eyePosition.x));
        eyePosition.y = Math.max(10, Math.min(90, eyePosition.y));
        
        dot.style.left = eyePosition.x + '%';
        dot.style.top = eyePosition.y + '%';
    }

    // EMDR Step Management
    window.nextEmdrStep = function() {
        if (emdrStep < emdrSteps.length - 1) {
            emdrStep++;
            updateEmdrDisplay();
        } else {
            document.getElementById('emdr-complete').classList.remove('hidden');
            appState.currentTechnique = 'EMDR Zelfhulp - 5 Stappen Voltooid';
            trackSession('emdr', 25);
            log('SUCCESS', 'EMDR session completed');
        }
    };

    window.prevEmdrStep = function() {
        if (emdrStep > 0) {
            emdrStep--;
            updateEmdrDisplay();
        }
    };

    function updateEmdrDisplay() {
        const step = emdrSteps[emdrStep];
        
        document.getElementById('emdr-title').textContent = step.title;
        document.getElementById('emdr-content').innerHTML = '<p>' + step.content + '</p>';
        
        const intensityDiv = document.getElementById('emdr-intensity');
        if (step.showIntensity) {
            intensityDiv.classList.remove('hidden');
        } else {
            intensityDiv.classList.add('hidden');
        }
        
        const prevBtn = document.getElementById('emdr-prev-btn');
        const nextBtn = document.getElementById('emdr-next-btn');
        
        if (emdrStep === 0) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }
        
        if (emdrStep === emdrSteps.length - 1) {
            nextBtn.textContent = 'Voltooien';
        } else {
            nextBtn.textContent = 'Volgende';
        }
        
        const progress = ((emdrStep + 1) / emdrSteps.length) * 100;
        document.getElementById('emdr-progress').style.width = progress + '%';
        
        log('INFO', `EMDR step ${emdrStep + 1}/${emdrSteps.length}: ${step.title}`);
    }

    function resetEmdrSession() {
        emdrStep = 0;
        updateEmdrDisplay();
        document.getElementById('emdr-complete').classList.add('hidden');
        if (isAudioPlaying) {
            stopBilateralAudio();
        }
        if (isEyeMovementActive) {
            stopEyeMovements();
        }
    }

    // Firestore functions
    async function saveToFirestore(entry) {
        if (!appState.isFirebaseConnected) {
            throw new Error('Firebase niet verbonden. Controleer je internetverbinding.');
        }
        
        if (!appState.currentUser) {
            throw new Error('Je moet ingelogd zijn om entries op te slaan.');
        }

        try {
            log('INFO', 'Saving to Firestore...');

            const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            const docRef = await addDoc(collection(db, "dagboekEntries"), {
                ...entry,
                timestamp: serverTimestamp(),
                userId: appState.currentUser.uid,
                userEmail: appState.currentUser.email,
                version: 1
            });
            
            log('SUCCESS', 'Entry saved to Firestore with ID:', docRef.id);
            return { id: docRef.id, success: true };
            
        } catch (error) {
            log('ERROR', 'Firestore save error:', error);
            throw error;
        }
    }

    async function loadFromFirestore() {
        if (!appState.isFirebaseConnected || !appState.currentUser) {
            throw new Error('Je moet ingelogd zijn en verbonden met internet om entries te laden.');
        }

        try {
            log('INFO', 'Loading entries from Firestore for user:', appState.currentUser.email);
            
            const { getDocs, collection, query, where, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            const q = query(
                collection(db, "dagboekEntries"), 
                where("userId", "==", appState.currentUser.uid),
                orderBy("timestamp", "desc"),
                limit(100)
            );
            
            const querySnapshot = await getDocs(q);
            
            const entries = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                entries.push({
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp ? data.timestamp.toDate() : (data.clientTimestamp ? new Date(data.clientTimestamp) : new Date()),
                    tijdstempel: data.timestamp ? data.timestamp.toDate().toLocaleString('nl-BE') : (data.clientTimestamp ? new Date(data.clientTimestamp).toLocaleString('nl-BE') : 'Onbekend'),
                    bron: "Firebase"
                });
            });
            
            log('SUCCESS', `Loaded ${entries.length} entries from Firestore`);
            return entries;
            
        } catch (error) {
            log('ERROR', 'Firestore query error:', error);
            
            if (error.code === 'permission-denied') {
                throw new Error('Geen toestemming om data te laden. Log opnieuw in.');
            } else if (error.code === 'unavailable') {
                throw new Error('Firebase service tijdelijk niet beschikbaar. Probeer het later opnieuw.');
            } else {
                throw new Error('Fout bij laden van entries: ' + error.message);
            }
        }
    }

    // Dagboek functions
    window.saveDagboekEntry = async function() {
        try {
            const entry = {
                techniekGebruikt: appState.currentTechnique || 'Handmatige Entry',
                trigger: document.getElementById('entry-trigger').value,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                clientTimestamp: new Date().toISOString() 
            };

            if (!entry.resultaat) {
                showUserMessage('Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            const saveBtn = document.getElementById('save-dagboek-entry-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '💾 Opslaan...';
            saveBtn.disabled = true;

            await saveToFirestore(entry);
            
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            
            closeDagboekModal();
            resetCompletedExercise();
            
            if (appState.currentTab === 'dagboek') {
                await loadDagboekEntries();
            }
            
            showUserMessage('✅ Entry succesvol opgeslagen!', 'success');
            
        } catch (error) {
            const saveBtn = document.getElementById('save-dagboek-entry-btn');
            if (saveBtn) {
                saveBtn.textContent = '📁 Opslaan';
                saveBtn.disabled = false;
            }
            
            log('ERROR', 'Save error:', error);
            showUserMessage('❌ Opslaan mislukt: ' + error.message, 'error');
        }
    };

    function resetCompletedExercise() {
        if (appState.currentTechnique) {
            if (appState.currentTechnique.includes('Buteyko Ademhaling')) {
                resetButeykoAfterCompletion();
            }
        }
    }

    window.loadDagboekEntries = async function() {
        try {
            const entries = await loadFromFirestore();
            displayDagboekEntries(entries);
            
        } catch (error) {
            log('ERROR', 'Load entries failed:', error);
            const container = document.getElementById('dagboek-entries');
            container.innerHTML = 
                '<div class="alert alert-danger">' +
                    '<strong>❌ Fout bij laden entries:</strong><br>' + 
                    error.message +
                    '<br><br>' +
                    '<button id="retry-load-btn" class="btn btn-primary" style="margin-top: 1rem;">🔄 Opnieuw proberen</button>' +
                '</div>';
            
            setTimeout(() => {
                const retryBtn = document.getElementById('retry-load-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', loadDagboekEntries);
                }
            }, 100);

            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
        }
    };

    function displayDagboekEntries(entries) {
        const container = document.getElementById('dagboek-entries');
        
        createProgressChart(entries);
        
        if (!entries || entries.length === 0) {
            container.innerHTML = 
                '<div class="card">' +
                    '<h3>Nog geen entries</h3>' +
                    '<p>Maak een dagboekentry na het gebruiken van oefeningen om patronen bij te houden.</p>' +
                    '<button class="btn btn-primary" onclick="openDagboekModal(\'Eerste Entry\')">' +
                        'Maak je eerste entry' +
                    '</button>' +
                '</div>';
            return;
        }
        
        let entriesHtml = '<div class="card"><h3>📝 Alle Dagboek Entries</h3><p style="color: var(--text-light); margin-bottom: 1.5rem;">Chronologisch overzicht van je sessies</p></div>';
        
        entriesHtml += entries.map(entry => {
            const displayDate = entry.timestamp instanceof Date ? entry.timestamp : new Date(entry.clientTimestamp || 0);

            return '<div class="entry-card">' +
                '<div class="entry-header">' +
                    '<div>' +
                        '<div class="entry-title">' + entry.techniekGebruikt + '</div>' +
                        '<div style="font-size: 0.8rem; color: var(--text-light);">' +
                            displayDate.toLocaleString('nl-BE') + ' • ' +
                            '<span style="color: #0891b2; font-size: 0.75rem;">' + (entry.bron || 'Onbekend') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="entry-result ' + entry.resultaat + '">' +
                        getResultaatText(entry.resultaat) +
                    '</div>' +
                '</div>' +
                '<div class="intensity-grid">' +
                    '<div style="font-size: 0.85rem;">' +
                        '<span style="color: var(--text-light);">Vóór:</span>' +
                        '<span style="font-weight: 500; margin-left: 0.25rem; color: var(--text-dark);">' + entry.intensiteitVoor + '/10</span>' +
                    '</div>' +
                    '<div style="font-size: 0.85rem;">' +
                        '<span style="color: var(--text-light);">Ná:</span>' +
                        '<span style="font-weight: 500; margin-left: 0.25rem; color: var(--text-dark);">' + entry.intensiteitNa + '/10</span>' +
                    '</div>' +
                '</div>' +
                (entry.trigger ? '<p style="font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-dark);"><strong>Trigger:</strong> ' + entry.trigger + '</p>' : '') +
                (entry.notities ? '<p style="font-size: 0.85rem; color: var(--text-dark);"><strong>Notities:</strong> ' + entry.notities + '</p>' : '') +
            '</div>';
        }).join('');
        
        container.innerHTML = entriesHtml;
    }

    // Skip dagboek functions
    window.skipButeykoDagboek = function() { 
        resetButeykoAfterCompletion(); 
        showUserMessage('✅ Buteyko sessie afgerond!', 'success'); 
    };

    window.skipRitualDagboek = function() {
        document.getElementById('ritual-complete').classList.add('hidden');
        ritualStep = 0;
        updateRitualDisplay();
        showUserMessage('✅ Afkoel ritueel afgerond!', 'success');
    };

    window.skipEmdrDagboek = function() {
        resetEmdrSession();
        showUserMessage('✅ EMDR sessie afgerond!', 'success');
    };

    function getResultaatText(resultaat) {
        const mapping = {
            'zeer-goed': 'Zeer goed',
            'goed': 'Goed',
            'matig': 'Matig',
            'geen-effect': 'Geen effect',
            'slechter': 'Slechter'
        };
        return mapping[resultaat] || resultaat;
    }

    window.exportDagboek = async function() {
        try {
            const entries = await loadFromFirestore();
            
            if (!entries || entries.length === 0) {
                showUserMessage('📝 Geen entries om te exporteren', 'warning');
                return;
            }
            
            let exportText = 'ADEMRUIMTE DAGBOEK EXPORT\n';
            exportText += '================================\n';
            exportText += 'Gebruiker: ' + (appState.currentUser ? (appState.currentUser.displayName || appState.currentUser.email) : 'Onbekend') + '\n';
            exportText += 'Export datum: ' + new Date().toLocaleString('nl-BE') + '\n\n';
            
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const displayDate = entry.timestamp instanceof Date ? entry.timestamp : new Date(entry.clientTimestamp || 0);

                exportText += 'ENTRY ' + (i + 1) + '\n';
                exportText += 'Datum: ' + displayDate.toLocaleString('nl-BE') + '\n';
                exportText += 'Techniek: ' + entry.techniekGebruikt + '\n';
                exportText += 'Trigger: ' + (entry.trigger || 'Geen') + '\n';
                exportText += 'Intensiteit vóór: ' + entry.intensiteitVoor + '/10\n';
                exportText += 'Intensiteit ná: ' + entry.intensiteitNa + '/10\n';
                exportText += 'Resultaat: ' + getResultaatText(entry.resultaat) + '\n';
                exportText += 'Notities: ' + (entry.notities || 'Geen') + '\n';
                exportText += '\n---\n\n';
            }
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ademruimte-dagboek-' + new Date().toLocaleDateString('nl-BE') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showUserMessage('📁 Dagboek geëxporteerd als tekstbestand!', 'success');
            
        } catch (error) {
            showUserMessage('❌ Fout bij exporteren: ' + error.message, 'error');
        }
    };

    // Statistics functions
    window.loadStatistics = async function() {
        try {
            showUserMessage('📊 Statistieken worden geladen...', 'info');
            
            const entries = await loadFromFirestore();
            
            if (!entries || entries.length === 0) {
                showUserMessage('📈 Geen data beschikbaar voor statistieken. Maak eerst wat dagboek entries!', 'warning');
                return;
            }
            
            generateStatistics(entries);
            showUserMessage('✅ Statistieken geladen!', 'success');
            
        } catch (error) {
            log('ERROR', 'Load statistics failed:', error);
            showUserMessage('❌ Fout bij laden statistieken: ' + error.message, 'error');
        }
    };

    function generateStatistics(entries) {
        generateOverviewStats(entries);
        generateUsageChart(entries);
        generateEffectivenessChart(entries);
        generateResultsChart(entries);
        generateImprovementChart(entries);
        generateDetailedStats(entries);
        generateInsights(entries);
    }

    function generateOverviewStats(entries) {
        const totalSessions = entries.length;
        const totalImprovement = entries.reduce((sum, entry) => sum + (entry.intensiteitVoor - entry.intensiteitNa), 0);
        const avgImprovement = totalSessions > 0 ? (totalImprovement / totalSessions).toFixed(1) : 0;
        
        const techniques = [...new Set(entries.map(entry => entry.techniekGebruikt))];
        const uniqueTechniques = techniques.length;
        
        const avgBefore = totalSessions > 0 ? (entries.reduce((sum, entry) => sum + entry.intensiteitVoor, 0) / totalSessions).toFixed(1) : 0;
        const avgAfter = totalSessions > 0 ? (entries.reduce((sum, entry) => sum + entry.intensiteitNa, 0) / totalSessions).toFixed(1) : 0;
        
        const successfulSessions = entries.filter(entry => 
            entry.resultaat === 'zeer-goed' || entry.resultaat === 'goed'
        ).length;
        const successRate = totalSessions > 0 ? Math.round((successfulSessions / totalSessions) * 100) : 0;

        const overviewHtml = `
            <div class="stats-overview-card">
                <div class="stats-number">${totalSessions}</div>
                <div class="stats-label">Totaal Sessies</div>
            </div>
            <div class="stats-overview-card">
                <div class="stats-number">${avgImprovement}</div>
                <div class="stats-label">Gem. Verbetering</div>
            </div>
            <div class="stats-overview-card">
                <div class="stats-number">${successRate}%</div>
                <div class="stats-label">Succespercentage</div>
            </div>
            <div class="stats-overview-card">
                <div class="stats-number">${uniqueTechniques}</div>
                <div class="stats-label">Technieken Gebruikt</div>
            </div>
            <div class="stats-overview-card">
                <div class="stats-number">${avgBefore} → ${avgAfter}</div>
                <div class="stats-label">Gem. Voor → Na</div>
            </div>
        `;
        
        document.getElementById('stats-overview').innerHTML = overviewHtml;
    }

    async function generateUsageChart(entries) {
        const usageData = {};
        entries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            usageData[technique] = (usageData[technique] || 0) + 1;
        });

        const sortedUsage = Object.entries(usageData)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 8); // Top 8 techniques

        if (sortedUsage.length === 0) {
            document.getElementById('usage-empty').style.display = 'block';
            return;
        }

        document.getElementById('usage-empty').style.display = 'none';

        try {
            if (!window.Chart) {
                await loadChartJS();
            }

            if (usageChart) {
                usageChart.destroy();
            }

            const ctx = document.getElementById('usage-chart').getContext('2d');
            
            usageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedUsage.map(([technique]) => technique.split(' - ')[0]), // Shorten labels
                    datasets: [{
                        data: sortedUsage.map(([, count]) => count),
                        backgroundColor: [
                            '#06b6d4', '#10b981', '#8b5cf6', '#f59e0b',
                            '#ef4444', '#3b82f6', '#f97316', '#84cc16'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw} sessies (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            log('ERROR', 'Failed to create usage chart:', error);
            document.getElementById('usage-empty').style.display = 'block';
        }
    }

    async function generateEffectivenessChart(entries) {
        const effectivenessData = {};
        entries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            
            if (!effectivenessData[technique]) {
                effectivenessData[technique] = { total: 0, count: 0 };
            }
            effectivenessData[technique].total += improvement;
            effectivenessData[technique].count += 1;
        });

        const avgEffectiveness = Object.entries(effectivenessData)
            .map(([technique, data]) => ({
                technique: technique.split(' - ')[0], // Shorten labels
                fullTechnique: technique,
                avg: data.total / data.count
            }))
            .sort((a, b) => b.avg - a.avg)
            .slice(0, 8);

        if (avgEffectiveness.length === 0) {
            document.getElementById('effectiveness-empty').style.display = 'block';
            return;
        }

        document.getElementById('effectiveness-empty').style.display = 'none';

        try {
            if (!window.Chart) {
                await loadChartJS();
            }

            if (effectivenessChart) {
                effectivenessChart.destroy();
            }

            const ctx = document.getElementById('effectiveness-chart').getContext('2d');
            
            effectivenessChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: avgEffectiveness.map(item => item.technique),
                    datasets: [{
                        label: 'Gemiddelde Verbetering',
                        data: avgEffectiveness.map(item => item.avg.toFixed(1)),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return avgEffectiveness[index].fullTechnique;
                                },
                                label: function(context) {
                                    return `Gemiddelde verbetering: ${context.raw} punten`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            log('ERROR', 'Failed to create effectiveness chart:', error);
            document.getElementById('effectiveness-empty').style.display = 'block';
        }
    }

    async function generateResultsChart(entries) {
        const resultsData = {};
        entries.forEach(entry => {
            const result = entry.resultaat;
            if (result) {
                resultsData[result] = (resultsData[result] || 0) + 1;
            }
        });

        const sortedResults = Object.entries(resultsData)
            .sort(([,a], [,b]) => b - a);

        if (sortedResults.length === 0) {
            document.getElementById('results-empty').style.display = 'block';
            return;
        }

        document.getElementById('results-empty').style.display = 'none';

        try {
            if (!window.Chart) {
                await loadChartJS();
            }

            if (resultsChart) {
                resultsChart.destroy();
            }

            const ctx = document.getElementById('results-chart').getContext('2d');
            
            const resultColors = {
                'zeer-goed': '#059669',
                'goed': '#10b981',
                'matig': '#f59e0b',
                'geen-effect': '#6b7280',
                'slechter': '#ef4444'
            };
            
            resultsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sortedResults.map(([result]) => getResultaatText(result)),
                    datasets: [{
                        data: sortedResults.map(([, count]) => count),
                        backgroundColor: sortedResults.map(([result]) => resultColors[result] || '#6b7280'),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw} sessies (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            log('ERROR', 'Failed to create results chart:', error);
            document.getElementById('results-empty').style.display = 'block';
        }
    }

    async function generateImprovementChart(entries) {
        if (entries.length < 5) {
            document.getElementById('improvement-empty').style.display = 'block';
            return;
        }

        document.getElementById('improvement-empty').style.display = 'none';

        // Calculate rolling average of improvements
        const improvements = entries
            .slice(0, 30) // Last 30 entries
            .reverse() // Oldest first
            .map((entry, index) => ({
                index: index + 1,
                improvement: entry.intensiteitVoor - entry.intensiteitNa,
                date: entry.timestamp
            }));

        // Calculate 5-entry rolling average
        const rollingAverages = [];
        for (let i = 4; i < improvements.length; i++) {
            const window = improvements.slice(i - 4, i + 1);
            const avg = window.reduce((sum, item) => sum + item.improvement, 0) / 5;
            rollingAverages.push({
                index: i + 1,
                avg: avg,
                date: improvements[i].date
            });
        }

        try {
            if (!window.Chart) {
                await loadChartJS();
            }

            if (improvementChart) {
                improvementChart.destroy();
            }

            const ctx = document.getElementById('improvement-chart').getContext('2d');
            
            improvementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rollingAverages.map(item => `Sessie ${item.index}`),
                    datasets: [
                        {
                            label: 'Individuele Verbetering',
                            data: improvements.map(item => item.improvement),
                            borderColor: 'rgba(239, 68, 68, 0.5)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            borderWidth: 1
                        },
                        {
                            label: 'Trend (5-sessie gemiddelde)',
                            data: Array(4).fill(null).concat(rollingAverages.map(item => item.avg)),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 3,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    if (index < improvements.length) {
                                        const date = improvements[index].date;
                                        return date.toLocaleDateString('nl-BE', { 
                                            month: 'short', 
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: window.innerWidth <= 768 ? 6 : 10,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Verbetering (punten)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            log('ERROR', 'Failed to create improvement chart:', error);
            document.getElementById('improvement-empty').style.display = 'block';
        }
    }

    function generateDetailedStats(entries) {
        const techniques = {};
        
        entries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            if (!techniques[technique]) {
                techniques[technique] = {
                    count: 0,
                    totalImprovement: 0,
                    results: {}
                };
            }
            
            techniques[technique].count++;
            techniques[technique].totalImprovement += (entry.intensiteitVoor - entry.intensiteitNa);
            
            const result = entry.resultaat || 'geen-resultaat';
            techniques[technique].results[result] = (techniques[technique].results[result] || 0) + 1;
        });

        const tableRows = Object.entries(techniques)
            .sort(([,a], [,b]) => b.count - a.count)
            .map(([technique, data]) => {
                const avgImprovement = (data.totalImprovement / data.count).toFixed(1);
                const successfulSessions = (data.results['zeer-goed'] || 0) + (data.results['goed'] || 0);
                const successRate = Math.round((successfulSessions / data.count) * 100);
                
                return `
                    <tr>
                        <td>${technique}</td>
                        <td>${data.count}</td>
                        <td>${avgImprovement}</td>
                        <td>${successRate}%</td>
                    </tr>
                `;
            }).join('');

        const tableHtml = `
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Techniek</th>
                        <th>Sessies</th>
                        <th>Gem. Verbetering</th>
                        <th>Succespercentage</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;

        document.getElementById('detailed-stats').innerHTML = tableHtml;
    }

    function generateInsights(entries) {
        if (entries.length < 5) {
            return;
        }

        const insights = [];
        
        // Best performing technique
        const techniquePerformance = {};
        entries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            
            if (!techniquePerformance[technique]) {
                techniquePerformance[technique] = { total: 0, count: 0 };
            }
            techniquePerformance[technique].total += improvement;
            techniquePerformance[technique].count += 1;
        });

        const bestTechnique = Object.entries(techniquePerformance)
            .map(([technique, data]) => ({
                technique,
                avg: data.total / data.count
            }))
            .sort((a, b) => b.avg - a.avg)[0];

        if (bestTechnique && bestTechnique.avg > 1) {
            insights.push(`🏆 **${bestTechnique.technique}** is je meest effectieve techniek met een gemiddelde verbetering van ${bestTechnique.avg.toFixed(1)} punten.`);
        }

        // Improvement trend
        const recentEntries = entries.slice(0, 10);
        const olderEntries = entries.slice(-10);
        
        if (recentEntries.length >= 5 && olderEntries.length >= 5) {
            const recentAvg = recentEntries.reduce((sum, entry) => sum + (entry.intensiteitVoor - entry.intensiteitNa), 0) / recentEntries.length;
            const olderAvg = olderEntries.reduce((sum, entry) => sum + (entry.intensiteitVoor - entry.intensiteitNa), 0) / olderEntries.length;
            
            if (recentAvg > olderAvg + 0.5) {
                insights.push(`📈 **Positieve trend**: Je recente sessies tonen ${(recentAvg - olderAvg).toFixed(1)} punten meer verbetering dan eerder.`);
            } else if (recentAvg < olderAvg - 0.5) {
                insights.push(`📉 **Uitdaging gedetecteerd**: Je recente resultaten zijn minder effectief. Overweeg om terug te gaan naar technieken die eerder goed werkten.`);
            }
        }

        // Success rate insight
        const successfulSessions = entries.filter(entry => 
            entry.resultaat === 'zeer-goed' || entry.resultaat === 'goed'
        ).length;
        const successRate = (successfulSessions / entries.length) * 100;
        
        if (successRate >= 70) {
            insights.push(`✨ **Uitstekend**: ${Math.round(successRate)}% van je sessies zijn succesvol. Je hebt een goede routine ontwikkeld!`);
        } else if (successRate >= 50) {
            insights.push(`👍 **Goed bezig**: ${Math.round(successRate)}% succespercentage. Probeer meer te focussen op technieken die goed werken.`);
        } else {
            insights.push(`💪 **Ruimte voor verbetering**: ${Math.round(successRate)}% succespercentage. Experimenteer met verschillende technieken om te vinden wat het beste werkt.`);
        }

        // Frequency insight
        if (entries.length >= 10) {
            const daysSinceFirst = Math.floor((entries[0].timestamp - entries[entries.length - 1].timestamp) / (1000 * 60 * 60 * 24));
            const frequency = entries.length / Math.max(daysSinceFirst, 1);
            
            if (frequency >= 1) {
                insights.push(`🔥 **Consistentie**: Je oefent gemiddeld ${frequency.toFixed(1)} keer per dag. Geweldige discipline!`);
            } else if (frequency >= 0.5) {
                insights.push(`📅 **Regelmatig**: Je oefent ${(frequency * 7).toFixed(1)} keer per week. Probeer dagelijks te oefenen voor betere resultaten.`);
            }
        }

        if (insights.length > 0) {
            const insightsHtml = insights.map(insight => `<p style="margin-bottom: 1rem; line-height: 1.6;">${insight}</p>`).join('');
            document.getElementById('insights-content').innerHTML = insightsHtml;
            document.getElementById('insights-section').style.display = 'block';
        }
    }

    window.exportStatistics = async function() {
        try {
            const entries = await loadFromFirestore();
            
            if (!entries || entries.length === 0) {
                showUserMessage('📊 Geen data beschikbaar voor export', 'warning');
                return;
            }

            let reportText = 'ADEMRUIMTE STATISTIEKEN RAPPORT\n';
            reportText += '==================================\n';
            reportText += 'Gebruiker: ' + (appState.currentUser ? (appState.currentUser.displayName || appState.currentUser.email) : 'Onbekend') + '\n';
            reportText += 'Rapport datum: ' + new Date().toLocaleString('nl-BE') + '\n';
            reportText += 'Periode: ' + entries[entries.length - 1].timestamp.toLocaleDateString('nl-BE') + ' - ' + entries[0].timestamp.toLocaleDateString('nl-BE') + '\n\n';

            // Overview statistics
            const totalSessions = entries.length;
            const totalImprovement = entries.reduce((sum, entry) => sum + (entry.intensiteitVoor - entry.intensiteitNa), 0);
            const avgImprovement = totalSessions > 0 ? (totalImprovement / totalSessions).toFixed(1) : 0;
            const successfulSessions = entries.filter(entry => entry.resultaat === 'zeer-goed' || entry.resultaat === 'goed').length;
            const successRate = totalSessions > 0 ? Math.round((successfulSessions / totalSessions) * 100) : 0;

            reportText += 'OVERZICHT STATISTIEKEN\n';
            reportText += '----------------------\n';
            reportText += `Totaal aantal sessies: ${totalSessions}\n`;
            reportText += `Gemiddelde verbetering: ${avgImprovement} punten\n`;
            reportText += `Succespercentage: ${successRate}%\n`;
            reportText += `Succesvolle sessies: ${successfulSessions}\n\n`;

            // Technique usage
            const usageData = {};
            entries.forEach(entry => {
                const technique = entry.techniekGebruikt;
                usageData[technique] = (usageData[technique] || 0) + 1;
            });

            reportText += 'TECHNIEK GEBRUIK\n';
            reportText += '---------------\n';
            Object.entries(usageData)
                .sort(([,a], [,b]) => b - a)
                .forEach(([technique, count]) => {
                    const percentage = Math.round((count / totalSessions) * 100);
                    reportText += `${technique}: ${count} sessies (${percentage}%)\n`;
                });

            reportText += '\n';

            // Results distribution
            const resultsData = {};
            entries.forEach(entry => {
                const result = entry.resultaat || 'geen-resultaat';
                resultsData[result] = (resultsData[result] || 0) + 1;
            });

            reportText += 'RESULTATEN VERDELING\n';
            reportText += '-------------------\n';
            Object.entries(resultsData)
                .sort(([,a], [,b]) => b - a)
                .forEach(([result, count]) => {
                    const percentage = Math.round((count / totalSessions) * 100);
                    reportText += `${getResultaatText(result)}: ${count} sessies (${percentage}%)\n`;
                });

            reportText += '\n';

            // Recent trends
            if (entries.length >= 10) {
                const recentEntries = entries.slice(0, 5);
                const recentAvg = recentEntries.reduce((sum, entry) => sum + (entry.intensiteitVoor - entry.intensiteitNa), 0) / recentEntries.length;
                
                reportText += 'RECENTE TRENDS\n';
                reportText += '-------------\n';
                reportText += `Gemiddelde verbetering laatste 5 sessies: ${recentAvg.toFixed(1)} punten\n`;
                
                const mostRecentTechnique = recentEntries[0].techniekGebruikt;
                reportText += `Laatst gebruikte techniek: ${mostRecentTechnique}\n`;
            }

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ademruimte-statistieken-' + new Date().toLocaleDateString('nl-BE') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showUserMessage('📊 Statistieken rapport geëxporteerd!', 'success');
            
        } catch (error) {
            showUserMessage('❌ Fout bij exporteren statistieken: ' + error.message, 'error');
        }
    };

    async function loadChartJS() {
        if (window.Chart) return;
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
            script.async = false;
            script.onload = () => {
                log('SUCCESS', 'Chart.js loaded successfully');
                resolve();
            };
            script.onerror = () => {
                log('ERROR', 'Failed to load Chart.js');
                reject(new Error('Chart.js failed to load'));
            };
            document.head.appendChild(script);
        });
    }

    async function createProgressChart(entries) {
        const chartRelevantEntries = entries.filter(entry => 
            entry.intensiteitVoor !== undefined && entry.intensiteitNa !== undefined && 
            entry.intensiteitVoor !== null && entry.intensiteitNa !== null
        );

        if (!chartRelevantEntries || chartRelevantEntries.length === 0) {
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
            return;
        }

        document.getElementById('chart-empty').style.display = 'none';
        document.getElementById('chart-legend').style.display = 'block';

        try {
            if (!window.Chart) {
                await loadChartJS();
            }

            const recentEntries = chartRelevantEntries.slice(0, 10).reverse();

            const labels = recentEntries.map((entry, index) => {
                const date = entry.timestamp;
                const shortDate = date.toLocaleDateString('nl-BE', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: window.innerWidth <= 768 ? undefined : '2-digit',
                    minute: window.innerWidth <= 768 ? undefined : '2-digit'
                });
                return window.innerWidth <= 768 ? `${index + 1}` : shortDate;
            });

            const beforeData = recentEntries.map(entry => entry.intensiteitVoor);
            const afterData = recentEntries.map(entry => entry.intensiteitNa);

            if (progressChart) {
                progressChart.destroy();
            }

            const ctx = document.getElementById('progress-chart').getContext('2d');
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Vóór oefening',
                            data: beforeData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: window.innerWidth <= 768 ? 2 : 3,
                            pointRadius: window.innerWidth <= 768 ? 4 : 5,
                            pointHoverRadius: window.innerWidth <= 768 ? 6 : 8,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Ná oefening',
                            data: afterData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: window.innerWidth <= 768 ? 2 : 3,
                            pointRadius: window.innerWidth <= 768 ? 4 : 5,
                            pointHoverRadius: window.innerWidth <= 768 ? 6 : 8,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const entry = recentEntries[index];
                                    const date = entry.timestamp;
                                    return date.toLocaleDateString('nl-BE', { 
                                        weekday: 'short',
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const entry = recentEntries[index];
                                    return [
                                        '',
                                        `Techniek: ${entry.techniekGebruikt}`,
                                        `Resultaat: ${getResultaatText(entry.resultaat)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: window.innerWidth <= 768 ? 5 : 8
                            },
                            title: {
                                display: window.innerWidth > 768,
                                text: 'Sessies (meest recente)',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                }
                            }
                        },
                        y: {
                            min: 0,
                            max: 10,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                stepSize: 1,
                                callback: function(value) {
                                    return value + '/10';
                                }
                            },
                            title: {
                                display: window.innerWidth > 768,
                                text: 'Intensiteit Score',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                }
                            }
                        }
                    }
                }
            });

            log('SUCCESS', `Progress chart created with ${recentEntries.length} data points`);
        } catch (error) {
            log('ERROR', 'Failed to create chart:', error);
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
        }
    }

    // Dagboek modal functions
    window.openDagboekModal = function(technique) {
        appState.currentTechnique = technique;
        
        if (technique === 'Crisis Hulp Technieken') {
            trackSession('crisis');
        }
        
        let triggerText = '';
        if (technique) {
            if (technique.includes('Buteyko')) {
                triggerText = 'Na voltooiing van Buteyko ademhalingsoefening (10 cycli)';
            } else if (technique.includes('Afkoel Ritueel')) {
                triggerText = 'Na voltooiing van Afkoel Ritueel (5 stappen)';
            } else if (technique.includes('EMDR')) {
                triggerText = 'Na voltooiing van EMDR zelfhulp sessie (5 stappen)';
            } else if (technique.includes('Crisis Hulp')) {
                triggerText = 'Tijdens/na gebruik van crisis hulp technieken';
            } else {
                triggerText = `Tijdens/na ${technique}`;
            }
        }
        
        document.getElementById('entry-trigger').value = triggerText;
        
        if (technique && (technique.includes('Voltooid') || technique.includes('Crisis Hulp'))) {
            document.getElementById('entry-before').value = '7';
            document.getElementById('entry-before-value').textContent = '7';
            document.getElementById('entry-after').value = '3';
            document.getElementById('entry-after-value').textContent = '3';
        } else {
            document.getElementById('entry-before').value = '5';
            document.getElementById('entry-before-value').textContent = '5';
            document.getElementById('entry-after').value = '5';
            document.getElementById('entry-after-value').textContent = '5';
        }
        
        document.getElementById('dagboek-modal').classList.add('show');
        
        setTimeout(() => {
            const modal = document.getElementById('dagboek-modal');
            if (modal) {
                modal.scrollTop = 0;
                const firstInput = modal.querySelector('input[type="text"], textarea');
                if (firstInput) {
                    firstInput.focus();
                    if (window.innerWidth <= 768) {
                        firstInput.click();
                        setTimeout(() => {
                            firstInput.focus();
                            firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                }
            }
        }, 150);
    };

    window.closeDagboekModal = function() {
        document.getElementById('dagboek-modal').classList.remove('show');
        
        document.getElementById('entry-trigger').value = '';
        document.getElementById('entry-before').value = '5';
        document.getElementById('entry-after').value = '5';
        document.getElementById('entry-result').value = '';
        document.getElementById('entry-notes').value = '';
        
        document.getElementById('entry-before-value').textContent = '5';
        document.getElementById('entry-after-value').textContent = '5';
        
        appState.currentTechnique = '';
    };

    // Setup event listeners
    function setupEventListeners() {
        log('INFO', 'Setting up event listeners...');
        
        const googleLoginBtn = document.getElementById('google-login-btn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                log('INFO', 'Google login button clicked!');
                signInWithGoogle();
            });
            log('SUCCESS', 'Google login button event listener attached');
        } else {
            log('ERROR', 'Google login button not found!');
        }

        const showRegisterBtn = document.getElementById('show-register-btn');
        if (showRegisterBtn) {
            showRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterForm();
            });
        }

        const closeRegisterBtn = document.getElementById('close-register-btn');
        if (closeRegisterBtn) {
            closeRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeRegisterModal();
            });
        }

        const cancelRegisterBtn = document.getElementById('cancel-register-btn');
        if (cancelRegisterBtn) {
            cancelRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeRegisterModal();
            });
        }

        const tipRefreshBtn = document.getElementById('tip-refresh-btn');
        if (tipRefreshBtn) {
            tipRefreshBtn.addEventListener('click', getNewTip);
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        const saveDagboekBtn = document.getElementById('save-dagboek-entry-btn');
        if (saveDagboekBtn) {
            saveDagboekBtn.addEventListener('click', saveDagboekEntry);
        }

        // Audio controls
        const volumeControl = document.getElementById('audio-volume');
        if (volumeControl) {
            volumeControl.addEventListener('input', function() {
                if (isAudioPlaying && gainNode) {
                    const volume = parseInt(this.value) / 100;
                    gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
                }
            });
        }

        const frequencyControl = document.getElementById('audio-frequency');
        if (frequencyControl) {
            frequencyControl.addEventListener('input', function() {
                if (isAudioPlaying && oscillator) {
                    const frequency = parseInt(this.value);
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                }
            });
        }

        const speedControl = document.getElementById('audio-speed');
        if (speedControl) {
            speedControl.addEventListener('change', function() {
                if (isAudioPlaying) {
                    stopBilateralAudio();
                    setTimeout(() => startBilateralAudio(), 100);
                }
            });
        }
    }

    // Network status monitoring
    function setupNetworkMonitoring() {
        window.addEventListener('online', () => {
            appState.isOnline = true;
            appState.updateConnectionDisplay();
            log('INFO', 'Network connection restored');
            if (!appState.isFirebaseConnected && appState.authInitialized) {
                initializeFirebase();
            }
        });

        window.addEventListener('offline', () => {
            appState.isOnline = false;
            appState.setConnectionStatus(false);
            log('WARNING', 'Network connection lost');
            showUserMessage('Internetverbinding verloren.', 'warning');
        });
    }

    // Keyboard navigation enhancements
    function setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && document.activeElement === activeTab) {
                    e.preventDefault();
                    
                    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
                    const currentIndex = tabs.indexOf(activeTab);
                    
                    let nextIndex;
                    if (e.key === 'ArrowLeft') {
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    } else {
                        nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    }
                    
                    tabs[nextIndex].focus();
                    tabs[nextIndex].click();
                }
            }
            
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
        });
    }

    // Range slider updates
    function setupRangeSliders() {
        const sliders = [
            { input: 'emdr-intensity-slider', output: 'emdr-intensity-value' },
            { input: 'entry-before', output: 'entry-before-value' },
            { input: 'entry-after', output: 'entry-after-value' }
        ];

        sliders.forEach(slider => {
            const input = document.getElementById(slider.input);
            const output = document.getElementById(slider.output);
            
            if (input && output) {
                input.addEventListener('input', function() {
                    output.textContent = this.value;
                });
                output.textContent = input.value;
            }
        });
    }

    // Enhanced mobile focus handling
    function setupMobileFocusHandling() {
        document.addEventListener('touchstart', function(e) {
            if (e.target.matches('.form-input, .form-textarea')) {
                setTimeout(() => {
                    e.target.focus();
                }, 50);
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.matches('.form-input, .form-textarea')) {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        e.target.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center',
                            inline: 'nearest'
                        });
                    }, 300);
                }
            }
        });
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async function() {
        log('INFO', 'Starting Ademruimte app initialization');
        
        try {
            appState.updateConnectionDisplay();
            appState.updateUI();

            setupForms();
            setupNetworkMonitoring();
            setupKeyboardNavigation();
            setupRangeSliders();
            setupMobileFocusHandling();
            setRandomTip();
            
            loadProgressData();
            
            updateBreathDisplay();
            updateRitualDisplay();
            updateEmdrDisplay();
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    showTab(tab);
                });
            });
            
            setupEventListeners();

            window.addEventListener('resize', () => {
                if (progressChart && appState.currentTab === 'dagboek') {
                    setTimeout(() => {
                        progressChart.resize();
                    }, 100);
                }
            });
            
            log('INFO', 'Attempting Firebase initialization...');
            const success = await initializeFirebase();
            
            if (!success) {
                log('WARNING', 'Firebase initialization failed during DOMContentLoaded. Showing login screen.');
                showLoginScreen();
            }
            
            log('SUCCESS', 'App initialization completed');
            
        } catch (error) {
            log('ERROR', 'App initialization failed at a critical stage', error);
            
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'none';
            }
            
            showUserMessage('Er is een kritieke fout opgetreden bij het laden van de app. Herlaad de pagina om het opnieuw te proberen.', 'error');
            showLoginScreen();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (isAudioPlaying) stopBilateralAudio();
        if (isEyeMovementActive) stopEyeMovements();
        if (wakeLock) releaseWakeLock();
        if (timerInterval) clearInterval(timerInterval);
        if (breathInterval) clearInterval(breathInterval);
        if (progressChart) progressChart.destroy();
        if (usageChart) usageChart.destroy();
        if (effectivenessChart) effectivenessChart.destroy();
        if (resultsChart) resultsChart.destroy();
        if (improvementChart) improvementChart.destroy();
        
        appState.cleanup();
        
        log('INFO', 'App shutting down');
    });
</script>

</body>
</html>
