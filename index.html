<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
    }

    /* Reset en basis styling - geen ongewenste borders */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:before, *:after {
        box-sizing: border-box;
    }

    html {
        border: none;
        outline: none;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    /* Skip link voor toegankelijkheid */
    .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--text-dark);
        color: white;
        padding: 8px;
        text-decoration: none;
        border-radius: 4px;
        z-index: 1000;
    }
    
    .skip-link:focus {
        top: 6px;
    }

    /* Verbeterde header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: clamp(1rem, 3vw, 2rem);
        text-align: center;
        position: relative;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    /* SVG Logo styling */
    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
    }

    .logo-svg {
        height: clamp(100px, 12vw, 160px);
        width: auto;
        filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }

    header h1 {
        font-size: clamp(1.2rem, 4vw, 2rem);
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        letter-spacing: -0.02em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
        font-size: clamp(0.7rem, 2vw, 0.9rem);
        opacity: 0.95;
        margin: 0;
    }

    .user-info {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-size: 0.75rem;
        color: rgba(255,255,255,0.9);
        max-width: 120px;
        word-break: break-word;
        text-align: right;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        z-index: 2;
    }

    /* Geoptimaliseerde navigatie */
    .nav-tabs {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        padding: 0.75rem 0.5rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        box-shadow: var(--shadow-sm);
        scrollbar-width: none;
        -ms-overflow-style: none;
        display: flex;
        gap: 0.5rem;
    }

    .nav-tabs::-webkit-scrollbar {
        display: none;
    }

    .nav-tabs button {
        background: none;
        border: none;
        padding: 0.875rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: var(--transition-base);
        white-space: nowrap;
        min-height: var(--touch-target);
        min-width: 44px;
        touch-action: manipulation;
        color: var(--text-light);
        position: relative;
        outline: none;
        font-family: inherit;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
    }

    .nav-tabs button:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .nav-tabs button.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
        font-weight: 600;
    }

    .nav-tabs button:hover:not(.active) {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        transform: translateY(-1px);
    }

    /* Container optimalisaties */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: clamp(1rem, 3vw, 2rem);
        min-height: calc(100vh - 120px);
    }

    /* Verbeterde card styling */
    .card {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        padding: clamp(1rem, 3vw, 2rem);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition-base);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        font-weight: 700;
        background: linear-gradient(135deg, #06b6d4, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: clamp(1rem, 3vw, 1.25rem);
        font-weight: 600;
    }

    /* Toegankelijke button styling */
    .btn {
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: var(--transition-base);
        text-align: center;
        display: inline-block;
        text-decoration: none;
        min-height: var(--touch-target);
        touch-action: manipulation;
        user-select: none;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        outline: none;
        font-family: inherit;
    }

    .btn:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), var(--shadow-sm);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-green {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-cyan {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    .btn-orange {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .btn-purple {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
    }

    /* Verbeterde grid layout */
    .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
    }

    .grid .card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border-radius: 1.2rem;
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .grid .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .grid .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 1.2rem 1.2rem 0 0;
    }

    .grid .card h3 {
        font-size: 1.375rem;
        margin-bottom: 1rem;
        font-weight: 700;
    }

    .grid .card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Verbeterde form styling met mobiele focus support */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        min-height: var(--touch-target);
        font-family: inherit;
        transition: border-color 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: #ffffff;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        background-color: #ffffff;
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
        line-height: 1.5;
    }

    /* Mobile-specific input improvements */
    @media (max-width: 768px) {
        .form-input, .form-select, .form-textarea {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 1rem;
            min-height: 48px;
        }
        
        .form-textarea {
            min-height: 100px;
        }
        
        /* Ensure inputs are visible when keyboard opens */
        .modal-content {
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal.show {
            align-items: flex-start;
            padding-top: 2rem;
        }
    }

    /* Range input styling */
    .range-input {
        width: 100%;
        margin: 0.75rem 0;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: #e5e7eb;
        border-radius: 5px;
        outline: none;
    }

    .range-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
    }

    .range-input::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    .range-value {
        text-align: center;
        font-weight: bold;
        font-size: 1.25rem;
        color: #3b82f6;
        margin: 0.5rem 0;
    }

    /* Alert verbeteringen */
    .alert {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        border: 1px solid;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(10px);
    }

    .alert-info {
        background: rgba(219, 234, 254, 0.95);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .alert-success {
        background: rgba(209, 250, 229, 0.95);
        border-color: #10b981;
        color: #065f46;
    }

    .alert-warning {
        background: rgba(254, 243, 199, 0.95);
        border-color: #f59e0b;
        color: #92400e;
    }

    .alert-danger, .alert-error {
        background: rgba(254, 226, 226, 0.95);
        border-color: #ef4444;
        color: #991b1b;
    }

    /* User message notifications */
    .user-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        max-width: 90vw;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(15px);
        animation: slideInDown 0.3s ease-out;
    }

    .user-message.alert-info {
        background: rgba(219, 234, 254, 0.98);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .user-message.alert-success {
        background: rgba(209, 250, 229, 0.98);
        border-color: #10b981;
        color: #065f46;
    }

    .user-message.alert-warning {
        background: rgba(254, 243, 199, 0.98);
        border-color: #f59e0b;
        color: #92400e;
    }

    .user-message.alert-error {
        background: rgba(254, 226, 226, 0.98);
        border-color: #ef4444;
        color: #991b1b;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        padding: 1rem;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
        min-width: 40px;
        min-height: 40px;
        border-radius: 50%;
        transition: var(--transition-base);
    }

    .close-btn:hover {
        background: rgba(0,0,0,0.1);
        color: var(--text-dark);
    }

    /* Google button styling */
    .google-btn {
        width: 100%;
        padding: 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        min-height: var(--touch-target);
    }

    .google-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    /* Divider styling */
    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e5e7eb;
        z-index: 1;
    }

    .divider span {
        background: white;
        padding: 0 1rem;
        position: relative;
        z-index: 2;
    }

    /* Breathing exercise styling */
    .breath-display {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        margin: 1.5rem 0;
        padding: 1.5rem;
        border-radius: 1rem;
        transition: all 0.3s ease;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .breath-display.inhale {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        transform: scale(1.02);
    }

    .breath-display.exhale {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        transform: scale(0.98);
    }

    .breath-display.hold {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        transform: scale(1.01);
    }

    .breath-display.rest {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        color: var(--text-light);
    }

    .breath-display.gentle-breath {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
    }

    .progress-bar {
        width: 100%;
        height: 0.75rem;
        background: #e5e7eb;
        border-radius: 0.375rem;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: #10b981;
        border-radius: 0.375rem;
        transition: width 0.3s ease;
    }

    .breath-progress {
        height: 100%;
        border-radius: 0.375rem;
        transition: width linear;
    }

    .breath-progress.inhale {
        background: #3b82f6;
    }

    .breath-progress.exhale {
        background: #10b981;
    }

    .breath-progress.gentle-breath {
        background: #06b6d4;
    }

    .breath-controls {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        margin: 1rem 0;
    }

    .breath-setting {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }

    .breath-setting label {
        display: block;
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }

    .breath-setting input {
        width: 80px;
        text-align: center;
        font-size: 1.125rem;
        font-weight: bold;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem;
        min-height: var(--touch-target);
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .button-group .btn {
        flex: 1;
        min-width: 120px;
    }

    /* Timer display */
    .timer-display {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        color: var(--text-dark);
        margin: 1.5rem 0;
        font-family: 'Courier New', monospace;
    }

    /* Technique cards */
    .technique-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .technique-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .technique-card h4 {
        color: #667eea;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .technique-card p {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    /* Step list styling */
    .step-list {
        list-style: none;
        margin: 1rem 0;
    }

    .step-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.9rem;
    }

    .step-list li:before {
        content: "‚úì ";
        color: #10b981;
        font-weight: bold;
    }

    /* Settings sections */
    .settings-section {
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin: 2rem 0;
        border: 1px solid #e2e8f0;
    }

    .settings-section h3 {
        color: #374151;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    /* Entry cards for dagboek */
    .entry-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: var(--transition-base);
    }

    .entry-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        gap: 1rem;
    }

    .entry-title {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    .entry-result {
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .entry-result.zeer-goed { color: #059669; }
    .entry-result.goed { color: #10b981; }
    .entry-result.matig { color: #f59e0b; }
    .entry-result.geen-effect { color: var(--text-light); }
    .entry-result.slechter { color: #ef4444; }

    .intensity-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    /* Connection status */
    .status-connected {
        background: #059669 !important;
        opacity: 0.8 !important;
    }

    .status-disconnected {
        background: #f59e0b !important;
        opacity: 0.6 !important;
    }

    .status-error {
        background: #ef4444 !important;
        opacity: 0.7 !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }

    /* Chart styling */
    .chart-container {
        position: relative;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    .chart-legend {
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }

    /* EMDR Eye Movement Display */
    .eye-movement-display {
        position: relative;
        height: 200px;
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border-radius: 1rem;
        margin: 1rem 0;
        border: 2px solid #0ea5e9;
        overflow: hidden;
    }

    .eye-dot {
        position: absolute;
        width: 20px;
        height: 20px;
        background: radial-gradient(circle, #ef4444, #dc2626);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        transition: all 0.1s ease-out;
        display: none;
    }

    .eye-dot::after {
        content: '';
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 3px;
        left: 6px;
        opacity: 0.9;
    }

    .eye-instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #0ea5e9;
        font-weight: 600;
    }

    /* EMDR Status indicators */
    .emdr-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .emdr-status.active {
        background: rgba(16, 185, 129, 0.1);
        color: #065f46;
        border: 1px solid #10b981;
    }

    .emdr-status.inactive {
        background: rgba(107, 114, 128, 0.1);
        color: var(--text-light);
        border: 1px solid #d1d5db;
    }

    /* Fullscreen EMDR Eye Movement Styles */
    .eye-movement-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #1e1b4b, #0f172a);
        z-index: 9999;
        display: none;
        overflow: hidden;
    }

    .eye-movement-fullscreen.show {
        display: block;
    }

    .fullscreen-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        gap: 10px;
    }

    .fullscreen-controls button {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .fullscreen-controls button:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.1);
    }

    .fullscreen-eye-dot {
        position: absolute;
        width: 40px;
        height: 40px;
        background: radial-gradient(circle, #ff6b6b, #e74c3c);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 8px 24px rgba(255, 107, 107, 0.5);
        transition: all 0.1s ease-out;
        display: none;
    }

    .fullscreen-eye-dot::after {
        content: '';
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 6px;
        left: 12px;
        opacity: 0.9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .fullscreen-instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    /* Buteyko CP (Control Pause) Styles */
    .cp-measurement {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
        border: 2px solid rgba(59, 130, 246, 0.2);
        border-radius: 1rem;
        padding: 1.5rem;
        margin: 1rem 0;
        text-align: center;
    }

    .cp-timer {
        font-size: 3rem;
        font-weight: bold;
        color: #3b82f6;
        margin: 1rem 0;
        font-family: 'Courier New', monospace;
        text-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .cp-instructions {
        font-size: 0.9rem;
        color: #4b5563;
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    .cp-result {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .cp-result.show {
        display: block;
    }

    .cp-score {
        font-size: 1.5rem;
        font-weight: bold;
        color: #059669;
        margin-bottom: 0.5rem;
    }

    .cp-interpretation {
        font-size: 0.875rem;
        color: #065f46;
    }

    /* CP Statistics in dagboek */
    .cp-stats {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        font-size: 0.85rem;
    }

    .cp-stats strong {
        color: #3b82f6;
    }

    /* Utility classes */
    .hidden {
        display: none !important;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Responsive optimalisaties */
    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .modal-content {
            margin: 1rem;
            padding: 1rem;
        }
        
        .btn {
            padding: 1rem;
            font-size: 0.9rem;
        }

        /* Verbeterde nav voor mobiel */
        .nav-tabs {
            padding: 0.5rem 0.25rem;
            gap: 0.25rem;
        }

        .nav-tabs button {
            padding: 0.75rem 0.875rem;
            font-size: 0.75rem;
            min-width: 40px;
            border-radius: 0.875rem;
        }

        /* Header aanpassingen voor mobiel */
        header {
            min-height: 100px;
            padding: 1rem 0.75rem;
        }

        .user-info {
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.7rem;
            max-width: 100px;
            padding: 0.375rem 0.5rem;
        }

        .logo-svg {
            height: clamp(90px, 15vw, 140px);
        }

        .breath-display {
            font-size: 1.5rem;
            padding: 1rem;
            min-height: 80px;
        }

        .timer-display {
            font-size: 2rem;
        }

        /* EMDR mobile optimizations */
        .eye-movement-display {
            height: 150px;
        }
        
        .breath-controls {
            grid-template-columns: 1fr 1fr;
        }

        /* CP Timer mobile */
        .cp-timer {
            font-size: 2rem;
        }

        /* Fullscreen controls mobile */
        .fullscreen-controls {
            top: 10px;
            right: 10px;
        }

        .fullscreen-controls button {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }

        .fullscreen-eye-dot {
            width: 30px;
            height: 30px;
        }

        .fullscreen-eye-dot::after {
            width: 12px;
            height: 12px;
            top: 4px;
            left: 9px;
        }

        .fullscreen-instructions {
            font-size: 1.2rem;
        }
    }

    @media (max-width: 480px) {
        /* Extra kleine schermen */
        .nav-tabs button {
            font-size: 0.7rem;
            padding: 0.625rem 0.75rem;
        }

        .user-info {
            font-size: 0.65rem;
            max-width: 90px;
            padding: 0.25rem 0.375rem;
        }

        header {
            min-height: 90px;
        }

        .logo-svg {
            height: clamp(80px, 18vw, 120px);
        }
    }

    @media (max-height: 600px) and (orientation: landscape) {
        header {
            padding: 0.5rem 1rem;
            min-height: 70px;
        }
        
        .logo-svg {
            height: clamp(60px, 10vw, 80px);
        }

        .user-info {
            top: 0.25rem;
            right: 0.5rem;
            font-size: 0.65rem;
            padding: 0.25rem 0.375rem;
        }
        
        .container {
            padding: 0.5rem;
        }

        .timer-display, .breath-display {
            font-size: 1.5rem;
            margin: 0.5rem 0;
            padding: 1rem;
        }

        .nav-tabs {
            padding: 0.375rem 0.25rem;
        }

        .nav-tabs button {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
        }
    }

    @media (min-width: 768px) {
        .breath-controls {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .breath-display {
            font-size: 2.5rem;
            padding: 2rem;
        }

        .timer-display {
            font-size: 3rem;
        }

        /* Betere nav spacing op desktop */
        .nav-tabs {
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
        }

        .nav-tabs button {
            padding: 1rem 1.5rem;
            font-size: 0.9rem;
        }

        .user-info {
            font-size: 0.8rem;
            max-width: 150px;
            padding: 0.75rem 1rem;
        }
    }

    /* Print styling */
    @media print {
        body {
            background: white;
            color: black;
        }
        
        .nav-tabs, .btn, header {
            display: none;
        }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .card {
            border: 2px solid;
        }
        
        .btn {
            border: 2px solid;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* Dark mode preparation */
    @media (prefers-color-scheme: dark) {
        :root {
            --card-background: rgba(31, 41, 55, 0.95);
            --text-dark: #f9fafb;
            --text-light: #d1d5db;
        }
    }
</style>
</head>

<body>
    <!-- Skip link voor toegankelijkheid -->
    <a href="#main-content" class="skip-link">Spring naar hoofdinhoud</a>

    <header role="banner">
        <div class="user-info" id="user-info" aria-live="polite">
            <!-- Spinner should be shown by default until auth state is known -->
            <div class="spinner" id="auth-loading" aria-label="Bezig met inloggen..."></div>
        </div>
        
        <!-- Ademruimte Logo -->
        <div class="logo-container">
            <svg viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
              <defs>
                <radialGradient id="breathingGradient" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" style="stop-color:#FFE0E6;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#FF7F7F;stop-opacity:0.6"/>
                  <stop offset="100%" style="stop-color:#26A69A;stop-opacity:0.4"/>
                </radialGradient>
                
                <linearGradient id="textGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#FFFFFF"/>
                  <stop offset="50%" style="stop-color:#FFE0E6"/>
                  <stop offset="100%" style="stop-color:#FFFFFF"/>
                </linearGradient>
                
                <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#26A69A;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#4DB6AC;stop-opacity:0.5"/>
                  <stop offset="100%" style="stop-color:#FF7F7F;stop-opacity:0.3"/>
                </linearGradient>
              </defs>
              
              <circle cx="60" cy="60" r="30" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" opacity="0.7">
                <animate attributeName="r" values="30;33;30" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.5;0.8;0.5" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="stroke-width" values="1.5;2;1.5" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="20" fill="url(#breathingGradient)" opacity="0.8">
                <animate attributeName="r" values="20;22;20" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.7;0.9;0.7" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="4" fill="#FF6B6B" opacity="1">
                <animate attributeName="r" values="4;6;4" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.9;1;0.9" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <g transform="translate(60,60)">
                <path d="M-25,0 Q-15,-10 0,-8 Q15,-10 25,0" 
                      stroke="url(#flowGradient)" stroke-width="2" fill="none" opacity="0.7">
                  <animate attributeName="opacity" values="0.5;0.9;0.5" dur="12s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="0;360" dur="60s" repeatCount="indefinite"/>
                </path>
                
                <path d="M0,-25 Q10,-15 8,0 Q10,15 0,25" 
                      stroke="url(#flowGradient)" stroke-width="2" fill="none" opacity="0.6">
                  <animate attributeName="opacity" values="0.4;0.8;0.4" dur="10s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="90;450" dur="60s" repeatCount="indefinite"/>
                </path>
                
                <circle cx="15" cy="-5" r="1.2" fill="rgba(255,255,255,0.9)" opacity="0.8">
                  <animate attributeName="opacity" values="0.5;1;0.5" dur="6s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="0;360" dur="45s" repeatCount="indefinite"/>
                </circle>
                
                <circle cx="-8" cy="12" r="1" fill="#FF7F7F" opacity="0.7">
                  <animate attributeName="opacity" values="0.4;0.9;0.4" dur="7s" repeatCount="indefinite"/>
                  <animateTransform attributeName="transform" type="rotate" values="180;540" dur="45s" repeatCount="indefinite"/>
                </circle>
              </g>
              
              <text x="140" y="45" font-family="Arial, sans-serif" font-size="28" font-weight="300" fill="url(#textGradient)">
                ademruimte
              </text>
              
              <text x="140" y="72" font-family="Arial, sans-serif" font-size="13" fill="rgba(255,255,255,0.9)" opacity="0.95">
                your safe breathing space
              </text>
              
              <g opacity="0.6">
                <circle cx="270" cy="25" r="2.5" fill="rgba(255,255,255,0.8)">
                  <animate attributeName="cy" values="25;20;25" dur="9s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.4;0.9;0.4" dur="9s" repeatCount="indefinite"/>
                </circle>
                <circle cx="280" cy="35" r="2" fill="#FF7F7F">
                  <animate attributeName="cy" values="35;30;35" dur="11s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.5;0.9;0.5" dur="11s" repeatCount="indefinite"/>
                </circle>
                <circle cx="275" cy="55" r="2.2" fill="rgba(255,255,255,0.7)">
                  <animate attributeName="cy" values="55;50;55" dur="13s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" values="0.4;0.7;0.4" dur="13s" repeatCount="indefinite"/>
                </circle>
              </g>
            </svg>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="login-screen" role="main">
        <div style="max-width: 400px; margin: 2rem auto; padding: 0 1rem;">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">
                    Welkom bij Ademruimte
                </h2>
                
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-light);">
                    <span id="login-description">Log in om je vooruitgang op te slaan en te synchroniseren tussen al je apparaten.</span>
                </p>

                <!-- Google Login -->
                <button id="google-login-btn" class="google-btn" aria-label="Inloggen met Google account">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="google-btn-text">Doorgaan met Google</span>
                </button>

                <div class="divider">
                    <span>of</span>
                </div>

                <!-- Email/Password Login -->
                <form id="login-form" novalidate>
                    <div class="form-group">
                        <label for="login-email" class="form-label">E-mail:</label>
                        <input type="email" 
                               id="login-email" 
                               class="form-input" 
                               placeholder="jouw@email.com" 
                               required 
                               autocomplete="email">
                    </div>

                    <div class="form-group">
                        <label for="login-password" class="form-label">Wachtwoord:</label>
                        <input type="password" 
                               id="login-password" 
                               class="form-input" 
                               placeholder="Wachtwoord" 
                               required 
                               autocomplete="current-password">
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="remember-me" checked aria-describedby="remember-help">
                        <label for="remember-me" style="margin: 0; cursor: pointer;">Ingelogd blijven</label>
                        <span id="remember-help" class="sr-only">Vink aan om ingelogd te blijven op dit apparaat</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Inloggen
                    </button>
                </form>

                <div style="text-align: center;">
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                        Nog geen account?
                    </p>
                    <button id="show-register-btn" class="btn btn-green" style="width: 100%;">
                        Account Aanmaken
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog" aria-labelledby="register-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="register-title">Account Aanmaken</h3>
                <button id="close-register-btn" class="close-btn" aria-label="Sluit registratie venster">&times;</button>
            </div>
            
            <form id="register-form" novalidate>
                <div class="form-group">
                    <label for="register-name" class="form-label">Naam:</label>
                    <input type="text" 
                           id="register-name" 
                           class="form-input" 
                           placeholder="Jouw naam" 
                           required 
                           autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="register-email" class="form-label">E-mail:</label>
                    <input type="email" 
                           id="register-email" 
                           class="form-input" 
                           placeholder="jouw@email.com" 
                           required 
                           autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="register-password" class="form-label">Wachtwoord:</label>
                    <input type="password" 
                           id="register-password" 
                           class="form-input" 
                           placeholder="Minimaal 6 karakters" 
                           required 
                           minlength="6" 
                           autocomplete="new-password">
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-green" style="flex: 1;">
                        Account Aanmaken
                    </button>
                    <button type="button" id="cancel-register-btn" class="btn" style="flex: 1;">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <nav class="nav-tabs" role="navigation" aria-label="Hoofdnavigatie">
            <button class="tab-btn active" data-tab="dashboard" aria-selected="true">üè† Dashboard</button>
            <button class="tab-btn" data-tab="crisis" aria-selected="false">üö® Crisis</button>
            <button class="tab-btn" data-tab="buteyko" aria-selected="false">üå¨Ô∏è Buteyko</button>
            <button class="tab-btn" data-tab="ritueel" aria-selected="false">üçÉ Maag-Ademhaling</button>
            <button class="tab-btn" data-tab="gapen" aria-selected="false">ü•± Gapen</button>
            <button class="tab-btn" data-tab="emdr" aria-selected="false">üíú EMDR</button>
            <button class="tab-btn" data-tab="dagboek" aria-selected="false">üìñ Dagboek</button>
        </nav>

        <main id="main-content" class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content" role="tabpanel" aria-labelledby="dashboard-tab">
                <!-- Hero Greeting Section -->
                <div class="card" style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); margin-bottom: 2rem;">
                    <h2 id="dashboard-greeting" style="font-size: clamp(1.5rem, 4vw, 2rem); margin-bottom: 1rem; background: linear-gradient(135deg, #06b6d4, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        Welkom bij Ademruimte
                    </h2>
                    
                    <p style="color: var(--text-light); font-size: 1rem; margin-top: 0.5rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                        Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding. 
                        Neem de tijd om te ontspannen en ontdek welke technieken het beste voor jou werken.
                    </p>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3>üö® Crisis Hulp</h3>
                        <p>Voor wanneer je luchthonger voelt opkomen</p>
                        <button class="btn btn-red" onclick="showTab('crisis')">Open Crisis Hulp</button>
                    </div>

                    <div class="card">
                        <h3>üå¨Ô∏è Buteyko Ademhaling</h3>
                        <p>CO2 tolerantie training</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>

                    <div class="card">
                        <h3>üçÉ Maag-Ademhaling Reset</h3>
                        <p>Voor maag-ademhaling verbindingen</p>
                        <button class="btn btn-green" onclick="showTab('ritueel')">Start Reset</button>
                    </div>

                    <div class="card">
                        <h3>ü•± Gaap Preventie</h3>
                        <p>Technieken voor gaapaanvallen</p>
                        <button class="btn btn-orange" onclick="showTab('gapen')">Bekijk Technieken</button>
                    </div>

                    <div class="card">
                        <h3>üíú EMDR Zelfhulp</h3>
                        <p>Voor luchthonger-gevoelens</p>
                        <button class="btn btn-purple" onclick="showTab('emdr')">Start EMDR</button>
                    </div>

                    <div class="card">
                        <h3>üìñ Dagboek</h3>
                        <p>Bijhouden van patronen</p>
                        <button class="btn btn-primary" onclick="showTab('dagboek')">Open Dagboek</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Tip van de dag:</strong> 
                    <span id="daily-tip">Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.</span>
                    <button id="tip-refresh-btn" 
                            type="button"
                            style="background: none; border: none; color: #0891b2; cursor: pointer; margin-left: 0.5rem; font-weight: 600; padding: 0.25rem; border-radius: 0.25rem; transition: var(--transition-base);" 
                            onmouseover="this.style.background='rgba(8,145,178,0.1)'" 
                            onmouseout="this.style.background='none'" 
                            aria-label="Nieuwe tip laden"
                            title="Klik voor een nieuwe tip">üîÑ</button>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3>üë§ Account</h3>
                    <div id="account-info" style="margin-bottom: 1rem;">
                        <!-- Account info wordt hier ingevuld -->
                    </div>
                    <button class="btn btn-red" onclick="performLogout()">
                        üö™ Uitloggen
                    </button>
                </div>
            </div>

            <!-- Crisis Tab -->
            <div id="crisis" class="tab-content hidden" role="tabpanel" aria-labelledby="crisis-tab">
                <div class="card">
                    <h2>üö® Crisis Hulp - Luchthonger</h2>
                    <p>Voor wanneer je dat benauwde gevoel voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>1. Paradoxale Ademhaling</h4>
                    <p>Start met bewust zeer kleine, korte ademhalingen. Na 3-4 van deze mini-ademhalingen, probeer een iets langere uitademing.</p>
                </div>

                <div class="technique-card">
                    <h4>2. Purse-lip Ademhaling</h4>
                    <p>Tuut je lippen bij het uitademen om lichte weerstand te cre√´ren. Dit helpt bij luchthonger en stabiliseert CO2-niveaus.</p>
                </div>

                <div class="technique-card">
                    <h4>3. IJswater Techniek</h4>
                    <p>Breng iets kouds tegen je gezicht (vooral rond wangen en ogen) om de duikreflex te activeren.</p>
                </div>

                <div class="technique-card">
                    <h4>4. Herframing</h4>
                    <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                </div>

                <div class="card">
                    <h3>5-4-3-2-1 Grounding</h3>
                    <ul class="step-list">
                        <li>5 dingen die je ZIET</li>
                        <li>4 dingen die je VOELT</li>
                        <li>3 dingen die je HOORT</li>
                        <li>2 dingen die je RUIKT</li>
                        <li>1 ding dat je PROEFT</li>
                    </ul>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Crisis Hulp Technieken')">
                        üìù Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content hidden" role="tabpanel" aria-labelledby="buteyko-tab">
                <div class="card">
                    <h2>üå¨Ô∏è Buteyko Ademhaling</h2>
                    <p>Verbeter je CO2 tolerantie en verminder hyperventilatie neiging</p>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Hoe het werkt:</strong> Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus, wat hyperventilatie-episodes kan verminderen.
                </div>

                <!-- Control Pause Measurement -->
                <div class="card">
                    <h3>üéØ Controle Pauze (CP) Meting</h3>
                    <div class="cp-measurement">
                        <div class="cp-instructions">
                            Zit rechtop en adem normaal. Na een normale uitademing, houd je adem in tot je de eerste neiging voelt om te ademen. Stop dan direct.
                        </div>
                        
                        <div class="cp-timer" id="cp-timer">00:00</div>
                        
                        <div class="button-group">
                            <button id="cp-start-btn" class="btn btn-cyan" onclick="startCPMeasurement()">
                                ‚è±Ô∏è Start CP Meting
                            </button>
                            <button id="cp-stop-btn" class="btn btn-red" onclick="stopCPMeasurement()" style="display: none;">
                                ‚èπÔ∏è Stop
                            </button>
                            <button class="btn btn-orange" onclick="resetCPMeasurement()">
                                üîÑ Reset
                            </button>
                        </div>
                        
                        <div class="cp-result" id="cp-result">
                            <div class="cp-score" id="cp-score">20 seconden</div>
                            <div class="cp-interpretation" id="cp-interpretation">
                                Gemiddelde CO2 tolerantie. Doorgaan met oefenen kan dit verbeteren.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Ademhalingsinstellingen</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Ademhalingspatroon:</label>
                        <select id="breathing-pattern" class="form-select" onchange="updateBreathingPattern()">
                            <option value="standard">Standaard (4-6-3)</option>
                            <option value="gentle">Zacht (2x ademhaling + pauze)</option>
                        </select>
                    </div>
                    
                    <div id="standard-controls" class="breath-controls">
                        <div class="breath-setting">
                            <label>Inademen (sec)</label>
                            <input type="number" id="inhale-duration" value="4" min="2" max="10">
                        </div>
                        <div class="breath-setting">
                            <label>Uitademen (sec)</label>
                            <input type="number" id="exhale-duration" value="6" min="3" max="15">
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="hold-duration" value="3" min="1" max="20">
                        </div>
                    </div>

                    <div id="gentle-controls" class="breath-controls hidden">
                        <div class="breath-setting">
                            <label>Cyclus Tijd (sec)</label>
                            <input type="number" id="gentle-cycle" value="10" min="8" max="15" readonly>
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="gentle-pause" value="4" min="2" max="8">
                        </div>
                        <div class="breath-setting">
                            <label>Ademhalingen</label>
                            <div style="font-weight: bold; color: #3b82f6; margin-top: 0.5rem;">2x per cyclus</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="breath-display rest" id="breath-display">
                        Klik op start om te beginnen
                    </div>

                    <div class="progress-bar">
                        <div class="breath-progress" id="breath-progress" style="width: 0%"></div>
                    </div>

                    <div style="text-align: center; margin: 1rem 0;">
                        <div id="breath-cycle-counter" style="font-size: 1.125rem; color: var(--text-light); margin-bottom: 1rem;">
                            Cyclus: 1/10
                        </div>
                        
                        <div class="button-group">
                            <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathExercise()">
                                ‚ñ∂Ô∏è Start Buteyko
                            </button>
                            <button class="btn btn-orange" onclick="resetBreathExercise()">
                                üîÑ Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Completion bericht buiten de hoofdkaart -->
                <div id="breath-complete" class="alert alert-success hidden">
                    <strong>‚úÖ Buteyko Sessie Voltooid!</strong><br>
                    Geweldig! Je hebt 10 ademhalingscycli succesvol afgerond.
                    <br><br>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Buteyko Ademhaling - 10 Cycli Voltooid')">
                            üìù Maak Dagboek Entry
                        </button>
                        <button class="btn btn-orange" onclick="skipButeykoDagboek()">
                            ‚è≠Ô∏è Overslaan
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>Buteyko Principes</h3>
                    <div class="technique-card">
                        <h4>Zachte Ademhaling</h4>
                        <p>Adem zo zacht mogelijk - stel je voor dat je een veertje voor je neus niet wilt laten bewegen.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Langere Uitademing</h4>
                        <p>De uitademing is langer dan de inademing om CO2 te behouden en het autonome zenuwstelsel te kalmeren.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Comfortabele Pauze</h4>
                        <p>De adempauze na uitademing mag nooit geforceerd aanvoelen - stop als het oncomfortabel wordt.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Controle Pauze Interpretatie</h4>
                        <p><strong>10-20 sec:</strong> Lage CO2 tolerantie, meer oefening nodig<br>
                        <strong>20-40 sec:</strong> Gemiddelde tolerantie, goede basis voor verbetering<br>
                        <strong>40+ sec:</strong> Goede CO2 tolerantie, houd dit niveau vast</p>
                    </div>
                </div>
            </div>

            <!-- Maag-Ademhaling Reset Tab (voorheen Ritueel) -->
            <div id="ritueel" class="tab-content hidden" role="tabpanel" aria-labelledby="ritueel-tab">
                <div class="card">
                    <h2>üçÉ Maag-Ademhaling Reset Protocol</h2>
                    <p>Gebaseerd op wetenschappelijk onderzoek naar de darm-brein-as en nervus vagus verbindingen</p>
                </div>

                <div class="alert alert-info">
                    <strong>üî¨ Wetenschappelijke basis:</strong> Dit protocol is gebaseerd op onderzoek naar de bidirectionele communicatie tussen het maag-darmstelsel en ademhalingssysteem via de nervus vagus en darm-brein-as.
                </div>

                <div class="card">
                    <h3 id="ritual-title">Stap 1: Vagus Zenuw Activatie</h3>
                    <div class="timer-display" id="timer-display">3:00</div>
                    
                    <div id="ritual-instructions">
                        <ul class="step-list">
                            <li>Leg je hand op je buik en voel je ademhaling</li>
                            <li>Neurie zachtjes (activeert vagale toon)</li>
                            <li>Maak langzame keel-klanken: "Ahhhh" bij uitademing</li>
                            <li>Voel hoe je maag en ademhaling samenwerken</li>
                        </ul>
                    </div>

                    <div class="button-group">
                        <button id="timer-btn" class="btn btn-green" onclick="startTimer()">‚ñ∂Ô∏è Start Timer</button>
                        <button class="btn btn-primary" onclick="nextRitualStep()" id="next-btn" style="display: none;">Volgende Stap</button>
                        <button class="btn btn-cyan" onclick="skipToNextStep()" id="skip-btn">‚è≠Ô∏è Overslaan</button>
                        <button class="btn btn-orange" onclick="resetRitual()">üîÑ Reset</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="ritual-progress" style="width: 20%"></div>
                    </div>

                    <div id="ritual-complete" class="alert alert-success hidden">
                        <strong>‚úÖ Maag-Ademhaling Reset Voltooid!</strong><br>
                        Uitstekend! Je hebt het volledige protocol doorlopen voor het herstellen van de maag-ademhaling verbinding.
                        <br><br>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openDagboekModal('Maag-Ademhaling Reset - 5 Stappen Voltooid')">
                                üìù Maak Dagboek Entry
                            </button>
                            <button class="btn btn-orange" onclick="skipRitualDagboek()">
                                ‚è≠Ô∏è Overslaan
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üß† Wetenschappelijke Achtergrond</h3>
                    <div class="technique-card">
                        <h4>Nervus Vagus Verbinding</h4>
                        <p>De nervus vagus verbindt je hersenstam met maag en longen. Het draagt 75% van de parasympathische zenuwvezels en be√Ønvloedt zowel maagfunctie als ademhalingspatronen.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Darm-Brein-As</h4>
                        <p>Bidirectionele communicatie tussen je maag-darmstelsel en centrale zenuwstelsel. Maagklachten kunnen ademhalingsproblemen triggeren en omgekeerd.</p>
                    </div>
                    <div class="technique-card">
                        <h4>CO2 Balans</h4>
                        <p>Hyperventilatie verstoort de CO2/H2CO3/HCO3- buffer die belangrijk is voor maagzuurproductie. Dit protocol helpt beide systemen re-balanceren.</p>
                    </div>
                </div>
            </div>

            <!-- Gapen Tab -->
            <div id="gapen" class="tab-content hidden" role="tabpanel" aria-labelledby="gapen-tab">
                <div class="card">
                    <h2>ü•± Gaap Preventie Technieken</h2>
                    <p>Voor wanneer je die vervelende gaapaanvallen voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>Lipremming-techniek</h4>
                    <p>Druk je lippen zachtjes op elkaar wanneer je een gaapneiging voelt. Laat de lucht langzaam door je neus in en uit gaan.</p>
                </div>

                <div class="technique-card">
                    <h4>Mini-ademhalingen</h4>
                    <p>Neem bewust 3-4 zeer kleine, ondiepe ademhalingen door je neus. Hiermee voorkom je de grote 'zucht-ademhaling'.</p>
                </div>

                <div class="technique-card">
                    <h4>Tongpositie veranderen</h4>
                    <p>Plaats je tongpunt tegen je gehemelte (achter je voortanden). Dit vermindert de neiging tot gapen.</p>
                </div>

                <div class="technique-card">
                    <h4>Water drinken</h4>
                    <p>Neem kleine slokjes water wanneer je merkt dat je begint te gapen. Dit doorbreekt het ademhalingspatroon.</p>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Belangrijk om te onthouden:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Ze geven je de kans om preventief in te grijpen voordat een volledige hyperventilatie-episode begint.
                </div>

                <div class="card">
                    <h3>Gedachte-Breaking Technieken</h3>
                    <div class="technique-card">
                        <strong>Paradoxale intentie:</strong> "Ok√© hersenen, jullie willen dat ik ga gapen? Prima, ik ga nu heel bewust gapen"
                    </div>
                    <div class="technique-card">
                        <strong>Herframing:</strong> "Mijn brein probeert me te beschermen, maar ik hoef niet te reageren"
                    </div>
                    <div class="technique-card">
                        <strong>Aandacht verplaatsen:</strong> Tel 5 blauwe dingen die je kunt zien
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Gaap Preventie Technieken')">
                        üìù Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- EMDR Tab - Volledig Verbeterd -->
            <div id="emdr" class="tab-content hidden" role="tabpanel" aria-labelledby="emdr-tab">
                <div class="card">
                    <h2>üíú EMDR Zelfhulp</h2>
                    <p>Voor luchthonger-gevoelens (dit is ondersteuning, geen vervanging voor professionele EMDR)</p>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Gebruik dit alleen voor milde tot matige gevoelens. Stop als je je overweldigd voelt.</strong>
                </div>

                <div class="alert alert-info">
                    <strong>üéß Bilaterale Stimulatie:</strong> Voor de beste ervaring, gebruik koptelefoon of oortjes. Zet het volume op een comfortabel niveau voordat je begint.
                </div>

                <!-- Bilaterale Audio Controls -->
                <div class="card">
                    <h3>üîä Bilaterale Audio Stimulatie</h3>
                    <p style="margin-bottom: 1rem;">Een instelbare toon die van links naar rechts beweegt om bilaterale hersenstimulatie te ondersteunen.</p>
                    
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Volume (%)</label>
                            <input type="number" id="audio-volume" value="30" min="10" max="100" step="10">
                        </div>
                        <div class="breath-setting">
                            <label>Snelheid (sec)</label>
                            <input type="range" id="audio-speed" value="2" min="0.5" max="5" step="0.1" class="range-input">
                            <div class="range-value" id="audio-speed-value">2.0s</div>
                        </div>
                        <div class="breath-setting">
                            <label>Toonhoogte (Hz)</label>
                            <input type="number" id="audio-frequency" value="440" min="60" max="1000" step="10">
                            <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 0.25rem;">60-1000 Hz</div>
                        </div>
                        <div class="breath-setting">
                            <label>Status</label>
                            <div id="audio-status" class="emdr-status inactive">
                                <span>‚è∏Ô∏è Gestopt</span>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="audio-btn" class="btn btn-purple" onclick="toggleBilateralAudio()">
                            üîä Start Audio
                        </button>
                    </div>
                </div>

                <!-- Oogbeweging Controls -->
                <div class="card">
                    <h3>üëÅÔ∏è Oogbeweging Stimulatie</h3>
                    <p style="margin-bottom: 1rem;">Volg de bewegende stip met je ogen zonder je hoofd te bewegen. Dit activeert beide hersenhelften.</p>
                    
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Snelheid</label>
                            <select id="eye-speed" class="form-select">
                                <option value="slow">Langzaam (4 sec)</option>
                                <option value="medium" selected>Gemiddeld (2 sec)</option>
                                <option value="fast">Snel (1 sec)</option>
                            </select>
                        </div>
                        <div class="breath-setting">
                            <label>Patroon</label>
                            <select id="eye-pattern" class="form-select">
                                <option value="horizontal" selected>Horizontaal</option>
                                <option value="vertical">Verticaal</option>
                                <option value="diagonal">Diagonaal</option>
                                <option value="figure8">Figuur 8</option>
                            </select>
                        </div>
                        <div class="breath-setting">
                            <label>Status</label>
                            <div id="eye-status" class="emdr-status inactive">
                                <span>‚è∏Ô∏è Gestopt</span>
                            </div>
                        </div>
                    </div>

                    <!-- Oogbeweging Display -->
                    <div class="eye-movement-display" id="eye-movement-display">
                        <div class="eye-dot" id="eye-dot"></div>
                        <div class="eye-instructions" id="eye-instructions">
                            Klik op start om oogbewegingen te beginnen
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="eye-btn" class="btn btn-cyan" onclick="toggleEyeMovements()">
                            üëÅÔ∏è Start Oogbewegingen
                        </button>
                        <button id="fullscreen-btn" class="btn btn-purple" onclick="toggleFullscreenEMDR()">
                            üñ•Ô∏è Volledig Scherm
                        </button>
                    </div>
                </div>

                <!-- EMDR Sessie Stappen -->
                <div class="card">
                    <h3 id="emdr-title">Stap 1: Voorbereiding</h3>
                    <div id="emdr-content">
                        <p>Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.</p>
                    </div>

                    <div id="emdr-intensity" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Intensiteit van luchthonger-gevoel (1-10):</label>
                            <input type="range" min="1" max="10" value="5" class="range-input" id="emdr-intensity-slider">
                            <div class="range-value" id="emdr-intensity-value">5</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="emdr-prev-btn" class="btn btn-orange" onclick="prevEmdrStep()" style="display: none;">Vorige</button>
                        <button id="emdr-next-btn" class="btn btn-purple" onclick="nextEmdrStep()">Volgende</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="emdr-progress" style="width: 20%"></div>
                    </div>

                    <div id="emdr-complete" class="alert alert-success hidden">
                        <strong>‚úÖ EMDR Zelfhulp Sessie Voltooid!</strong><br>
                        Goed gedaan! Je hebt alle 5 stappen van de EMDR zelfhulp doorlopen.
                        <br><br>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openDagboekModal('EMDR Zelfhulp - 5 Stappen Voltooid')">
                                üìù Maak Dagboek Entry
                            </button>
                            <button class="btn btn-orange" onclick="skipEmdrDagboek()">
                                ‚è≠Ô∏è Overslaan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content hidden" role="tabpanel" aria-labelledby="dagboek-tab">
                <div class="card">
                    <h2>üìñ Dagboek</h2>
                    <p>Overzicht van je sessies en vooruitgang</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Handmatige Entry')">
                            ‚ûï Nieuwe Entry
                        </button>
                        <button class="btn btn-green" onclick="loadDagboekEntries()">
                            üîÑ Vernieuw
                        </button>
                        <button class="btn btn-orange" onclick="exportDagboek()">
                            üì• Export Dagboek
                        </button>
                    </div>
                </div>

                <!-- Vooruitgang Grafiek -->
                <div class="card">
                    <h3>üìä Je Vooruitgang</h3>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Intensiteit scores over tijd - lagere scores betekenen meer verbetering</p>
                    
                    <div class="chart-container" style="position: relative; height: 300px; margin: 1rem 0;">
                        <canvas id="progress-chart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <div id="chart-legend" class="chart-legend" style="display: none; margin-top: 1rem;">
                        <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem;">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></div>
                                <span>V√≥√≥r oefening</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                                <span>N√° oefening</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chart-empty" class="alert alert-info" style="text-align: center;">
                        <strong>üìà Geen data beschikbaar</strong><br>
                        Maak een paar dagboek entries om je vooruitgang te zien!
                    </div>
                </div>

                <!-- CP Statistics Section -->
                <div class="card" id="cp-statistics" style="display: none;">
                    <h3>üéØ Controle Pauze Statistieken</h3>
                    <div id="cp-stats-content">
                        <!-- CP statistics will be populated here -->
                    </div>
                </div>

                <div id="dagboek-entries">
                    <!-- Entries worden hier geladen -->
                </div>

                <div class="card">
                    <h3>Patronen om naar uit te kijken</h3>
                    <ul class="step-list">
                        <li>Welke technieken het beste werken voor jou</li>
                        <li>Tijdstippen waarop klachten vaker voorkomen</li>
                        <li>Verbanden tussen maagklachten en ademhalingsproblemen</li>
                        <li>Specifieke triggers (werk, stress, bepaalde gedachten)</li>
                        <li>Verbetering in intensiteit scores over tijd</li>
                        <li>Verbetering in Controle Pauze metingen</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Fullscreen EMDR Eye Movement Modal -->
    <div id="fullscreen-emdr" class="eye-movement-fullscreen">
        <div class="fullscreen-controls">
            <button onclick="toggleFullscreenEMDR()" title="Sluit volledig scherm">
                ‚úï
            </button>
        </div>
        <div class="fullscreen-eye-dot" id="fullscreen-eye-dot"></div>
        <div class="fullscreen-instructions" id="fullscreen-instructions">
            Druk op start om de oogbewegingen in volledig scherm te beginnen
        </div>
    </div>

    <!-- Dagboek Modal -->
    <div id="dagboek-modal" class="modal" role="dialog" aria-labelledby="dagboek-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dagboek-modal-title">üìù Dagboek Entry</h3>
                <button class="close-btn" onclick="closeDagboekModal()" aria-label="Sluit dagboek venster">&times;</button>
            </div>
            
            <form id="dagboek-form" novalidate>
                <div class="form-group">
                    <label class="form-label" for="entry-trigger">Situatie/Trigger:</label>
                    <input type="text" id="entry-trigger" class="form-input" placeholder="Bijv. na intensief werken">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label class="form-label" for="entry-before">Intensiteit v√≥√≥r oefening (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before">
                        <div class="range-value" id="entry-before-value">5</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="entry-after">Intensiteit n√° oefening (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after">
                        <div class="range-value" id="entry-after-value">5</div>
                    </div>
                </div>

                <!-- CP Score field (only shown for Buteyko entries) -->
                <div class="form-group" id="cp-score-group" style="display: none;">
                    <label class="form-label" for="entry-cp-score">Controle Pauze Score (seconden):</label>
                    <input type="number" id="entry-cp-score" class="form-input" placeholder="bijv. 25" min="1" max="300">
                </div>

                <div class="form-group">
                    <label class="form-label" for="entry-result">Resultaat:</label>
                    <select id="entry-result" class="form-select">
                        <option value="">Selecteer resultaat...</option>
                        <option value="zeer-goed">Zeer goed - volledig opgelost</option>
                        <option value="goed">Goed - duidelijke verbetering</option>
                        <option value="matig">Matig - kleine verbetering</option>
                        <option value="geen-effect">Geen effect</option>
                        <option value="slechter">Iets slechter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="entry-notes">Notities:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op?"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="save-dagboek-entry-btn">
                        üìÅ Opslaan
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeDagboekModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">üìû In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <!-- Developer Credit -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8; color: rgba(255,255,255,0.9);">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>

<script type="module">
    // Enhanced error handling and logging
    const LOG_LEVELS = {
        INFO: '‚ÑπÔ∏è',
        SUCCESS: '‚úÖ', 
        WARNING: '‚ö†Ô∏è',
        ERROR: '‚ùå'
    };

    function log(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString('nl-NL');
        console.log(`${LOG_LEVELS[level]} [${timestamp}] ${message}`, data || '');
    }

    // Enhanced app state management
    class AppState {
        constructor() {
            this.currentUser = null;
            this.currentTab = 'dashboard';
            this.isOnline = navigator.onLine;
            this.isFirebaseConnected = false;
            this.authInitialized = false;
            this.authUnsubscribe = null;
            this.currentTechnique = '';
            this.tips = [
                "Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.",
                "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
                "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
                "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
                "Een koude kompres op je gezicht activeert de duikreflex en kalmeert het zenuwstelsel.",
                "Grounding technieken zoals 5-4-3-2-1 helpen je geest terug naar het hier en nu te brengen.",
                "Zachte ademhaling is effectiever dan diepe ademhaling bij hyperventilatie.",
                "De nervus vagus verbindt je maag met je ademhaling - activeer beide voor optimaal effect.",
                "Het bijhouden van patronen in je dagboek helpt je triggers te identificeren.",
                "Hyperventilatie kan maagzuurproductie verstoren via CO2-dysbalans.",
                "Een controle pauze van 40+ seconden duidt op goede CO2 tolerantie.",
                "Regelmatige Buteyko oefening kan je controle pauze significant verbeteren."
            ];
            // Initialize auth-loading spinner to be visible initially
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'inline-block';
            }
        }

        setUser(user) {
            this.currentUser = user;
            this.updateUI();
        }

        setConnectionStatus(isConnected) {
            this.isFirebaseConnected = isConnected;
            this.updateConnectionDisplay();
        }

        cleanup() {
            if (this.authUnsubscribe) {
                try {
                    this.authUnsubscribe();
                    this.authUnsubscribe = null;
                } catch (error) {
                    log('WARNING', 'Error unsubscribing from auth:', error);
                }
            }
        }

        updateUI() {
            const userInfo = document.getElementById('user-info');
            const accountInfo = document.getElementById('account-info');
            
            // Hide loading spinner regardless of auth state
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'none';
            }

            if (this.currentUser && userInfo) {
                const displayName = this.currentUser.displayName || this.currentUser.email;
                const shortName = displayName.length > 15 ? displayName.substring(0, 13) + '...' : displayName;
                userInfo.innerHTML = shortName;
            } else if (userInfo) {
                userInfo.innerHTML = ''; // Clear user info if not logged in
            }

            if (this.currentUser && accountInfo) {
                accountInfo.innerHTML = 
                    '<p style="color: var(--text-light); font-size: 0.9rem;">' +
                    '<strong>Ingelogd als:</strong><br>' + 
                    (this.currentUser.displayName || this.currentUser.email) + 
                    '</p>';
            } else if (accountInfo) {
                accountInfo.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Niet ingelogd</p>';
            }
            
            // Update dashboard greeting
            this.updateDashboardGreeting();
        }

        updateDashboardGreeting() {
            const greetingElement = document.getElementById('dashboard-greeting');
            if (greetingElement && this.currentUser) {
                const firstName = this.getFirstName();
                const timeOfDay = this.getTimeOfDay();
                greetingElement.textContent = `${timeOfDay}, ${firstName}!`;
            } else if (greetingElement) {
                greetingElement.textContent = `Welkom bij Ademruimte`;
            }
        }

        getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Goedemorgen';
            if (hour < 18) return 'Goedemiddag';
            return 'Goedenavond';
        }

        updateConnectionDisplay() {
            const statusDot = document.getElementById('firebase-status-dot');
            if (statusDot) {
                if (this.isFirebaseConnected) {
                    statusDot.className = 'status-connected';
                    statusDot.title = 'Firebase: Verbonden';
                } else if (this.isOnline) {
                    statusDot.className = 'status-disconnected'; 
                    statusDot.title = 'Firebase: Verbindingsprobleem of niet ge√Ønitialiseerd';
                } else {
                    statusDot.className = 'status-error';
                    statusDot.title = 'Firebase: Geen internetverbinding';
                }
            }
        }

        getRandomTip() {
            return this.tips[Math.floor(Math.random() * this.tips.length)];
        }

        getFirstName() {
            if (!this.currentUser) return 'Gebruiker';
            
            const displayName = this.currentUser.displayName;
            if (displayName) {
                return displayName.split(' ')[0];
            }
            
            const email = this.currentUser.email;
            if (email) {
                const localPart = email.split('@')[0];
                return localPart.charAt(0).toUpperCase() + localPart.slice(1);
            }
            
            return 'Gebruiker';
        }
    }

    // Initialize app state
    const appState = new AppState();

    // Global variables voor verschillende functionaliteiten
    let app, db, auth;
    let timerInterval = null;
    let currentTime = 0;
    let ritualStep = 0;
    let emdrStep = 0;

    // Breath exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 1;
    let breathPhaseTime = 0;
    let breathCycleDuration = 0;
    let breathingPattern = 'standard';
    let gentleBreathCount = 0;

    // Control Pause (CP) variables
    let cpInterval = null;
    let cpStartTime = 0;
    let cpCurrentTime = 0;
    let cpIsRunning = false;

    // EMDR Audio variables - Enhanced for live updates
    let audioContext = null;
    let oscillator = null;
    let gainNode = null;
    let pannerNode = null;
    let audioInterval = null;
    let isAudioPlaying = false;
    let panPosition = -1;
    let audioWakeLock = null;

    // EMDR Eye movement variables
    let eyeMovementInterval = null;
    let isEyeMovementActive = false;
    let eyePosition = { x: 50, y: 50 };
    let eyeDirection = 1;
    let eyeStep = 0;
    let isFullscreenMode = false;

    // Wake lock for keeping screen on
    let wakeLock = null;

    // Progress tracking
    let progressData = {
        buteyko: { sessions: 0, totalTime: 0, lastSession: null },
        ritual: { sessions: 0, totalTime: 0, lastSession: null },
        emdr: { sessions: 0, totalTime: 0, lastSession: null },
        crisis: { sessions: 0, lastSession: null }
    };

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte-12c09.firebaseapp.com", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Enhanced Maag-Ademhaling Reset step data
    const ritualSteps = [
        {
            title: "Stap 1: Vagus Zenuw Activatie",
            duration: 180, // 3 minutes
            instructions: [
                "Leg je hand op je buik en voel je ademhaling",
                "Neurie zachtjes (activeert vagale toon)",
                "Maak langzame keel-klanken: 'Ahhhh' bij uitademing",
                "Voel hoe je maag en ademhaling samenwerken"
            ]
        },
        {
            title: "Stap 2: CO2 Balans Herstel",
            duration: 240, // 4 minutes
            instructions: [
                "Adem zeer langzaam uit (8 seconden)",
                "Korte pauze na uitademing (2 seconden)",
                "Normale inademing door de neus (4 seconden)",
                "Focus op het herstellen van je CO2 balans"
            ]
        },
        {
            title: "Stap 3: Maag-Ademhaling Synchronisatie",
            duration: 300, // 5 minutes
            instructions: [
                "Een hand op borst, een hand op buik",
                "Buik beweegt meer dan borst bij ademhaling",
                "Visualiseer hoe je maag en longen samenwerken",
                "Voel de verbinding via de nervus vagus"
            ]
        },
        {
            title: "Stap 4: Darm-Brein-As Activatie",
            duration: 180, // 3 minutes
            instructions: [
                "Massage zachtjes je buik met cirkelbewegingen",
                "Denk aan positieve herinneringen aan eten",
                "Activeer je 'rust en verteer' systeem",
                "Voel hoe spanning in maag en ademhaling wegvloeit"
            ]
        },
        {
            title: "Stap 5: Integratie en Verankering",
            duration: 120, // 2 minutes
            instructions: [
                "Neem 5 zeer bewuste, volledige ademhalingen",
                "Zeg tegen jezelf: 'Mijn maag en ademhaling zijn in balans'",
                "Visualiseer jezelf kalm en ontspannen",
                "Be√´indig met dankbaarheid voor je lichaam"
            ]
        }
    ];

    // EMDR step data - Enhanced for better mobile support
    const emdrSteps = [
        {
            title: "Stap 1: Voorbereiding en Veiligheid",
            content: "Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt. Test je audio of oogbeweging stimulatie.",
            showIntensity: false
        },
        {
            title: "Stap 2: Identificeer het Gevoel",
            content: "Denk aan het luchthonger-gevoel. Waar voel je het in je lichaam? Borst, keel, buik? Geef het een intensiteit score van 1-10. Onthoud deze score.",
            showIntensity: true
        },
        {
            title: "Stap 3: Bilaterale Stimulatie",
            content: "Start je gekozen stimulatie (audio of oogbewegingen). Focus op het gevoel terwijl je de stimulatie volgt. Laat gedachten en gevoelens vrijelijk komen en gaan. Forceer niets.",
            showIntensity: false
        },
        {
            title: "Stap 4: Check-in en Evaluatie",
            content: "Stop de stimulatie. Hoe voelt het luchthonger-gevoel nu? Is de intensiteit veranderd? Geef een nieuwe score van 1-10. Wat voor gedachten of beelden kwamen er op?",
            showIntensity: true
        },
        {
            title: "Stap 5: Afsluiting en Verankering",
            content: "Neem een paar diepe, langzame ademhalingen. Visualiseer een veilige, kalme plek. Drink wat water. Je hebt goed werk gedaan. Noteer eventuele inzichten.",
            showIntensity: false
        }
    ];

    // Firebase initialization
    async function initializeFirebase() {
        if (appState.authInitialized) {
            log('INFO', 'Firebase already initialized.');
            return true;
        }

        try {
            log('INFO', 'Initializing Firebase...');
            
            // Firebase v9+ modular imports
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            const { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithRedirect, getRedirectResult } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");

            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set authentication persistence
            await setPersistence(auth, browserLocalPersistence);

            // Handle redirect result ON PAGE LOAD for Google Auth
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    log('SUCCESS', 'Google sign-in successful via redirect result:', result.user.email);
                    return true;
                }
            } catch (redirectError) {
                log('ERROR', 'Error getting redirect result:', redirectError);
                showUserMessage(`Fout bij Google login: ${redirectError.message}`, 'error');
            }

            // Setup auth state observer AFTER trying to get redirect result
            setupAuthStateObserver(onAuthStateChanged);

            appState.setConnectionStatus(true);
            appState.authInitialized = true;
            
            log('SUCCESS', 'Firebase initialized successfully');
            return true;

        } catch (error) {
            log('ERROR', 'Firebase initialization failed:', error);
            appState.setConnectionStatus(false);
            appState.authInitialized = false;
            
            showUserMessage('Firebase kon niet worden ge√Ønitialiseerd. Controleer je internetverbinding.', 'error');
            showLoginScreen();
            
            return false;
        }
    }

    function setupAuthStateObserver(onAuthStateChanged) {
        if (!auth) {
            log('ERROR', 'Auth not initialized - cannot setup observer');
            return;
        }
        
        // Auth state observer
        appState.authUnsubscribe = onAuthStateChanged(auth, (user) => {
            appState.updateUI();
            
            if (user) {
                log('SUCCESS', 'User authenticated:', user.email);
                appState.setUser(user);
                showMainApp();
                
                setTimeout(() => {
                    loadDagboekEntries().catch(error => {
                        log('WARNING', 'Could not load entries on login:', error);
                    });
                }, 500);
            } else {
                log('INFO', 'User not authenticated');
                appState.setUser(null);
                showLoginScreen();
            }
        }, (error) => {
            log('ERROR', 'Auth state observer error:', error);
            appState.updateUI();
            showUserMessage('Authenticatie fout: ' + error.message, 'error');
            showLoginScreen();
        });
    }

    // Enhanced screen management
    function showLoginScreen() {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loginScreen && mainApp) {
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            
            setTimeout(() => {
                const emailField = document.getElementById('login-email');
                if (emailField) {
                    emailField.focus();
                }
            }, 100);
        }
        
        log('INFO', 'Switched to login screen');
    }

    function showMainApp() {
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loginScreen && mainApp) {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            setTimeout(() => {
                appState.updateDashboardGreeting();
            }, 100);
            
            const dashboard = document.querySelector('[data-tab="dashboard"]');
            if (dashboard) dashboard.focus();
        }
        
        log('INFO', 'Switched to main app');
    }

    // Enhanced authentication functions
    window.signInWithGoogle = async function() {
        const googleBtn = document.getElementById('google-login-btn');
        const originalBtnText = googleBtn.querySelector('#google-btn-text').textContent;
        googleBtn.querySelector('#google-btn-text').textContent = 'Bezig...';
        googleBtn.disabled = true;
        
        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer email/wachtwoord login.', 'warning');
                googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
                googleBtn.disabled = false;
                return;
            }
        }

        try {
            log('INFO', 'Starting Google sign-in with redirect...');
            
            const { GoogleAuthProvider, signInWithRedirect } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ 
                prompt: 'select_account'
            });
            
            await signInWithRedirect(auth, provider);
            
        } catch (error) {
            log('ERROR', 'Google sign-in failed:', error);
            
            let message = 'Google inloggen mislukt';
            if (error.code === 'auth/popup-blocked') {
                message = 'Login werd geblokkeerd. Controleer popup instellingen of gebruik email/wachtwoord.';
            } else if (error.code === 'auth/network-request-failed') {
                message = 'Netwerkfout. Controleer je internetverbinding en probeer opnieuw.';
            } else if (error.code === 'auth/cancelled-popup-request') {
                log('INFO', 'Google sign-in cancelled by user');
                message = 'Google inloggen geannuleerd.';
                showUserMessage(message, 'info');
                googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
                googleBtn.disabled = false;
                return; 
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Te veel inlogpogingen. Probeer het later opnieuw.';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            googleBtn.querySelector('#google-btn-text').textContent = originalBtnText;
            googleBtn.disabled = false;
        }
    };

    window.performLogout = async function() {
        if (!confirm('Weet je zeker dat je wilt uitloggen?')) {
            return;
        }
        
        try {
            // Stop any running services immediately
            if (isAudioPlaying) toggleBilateralAudio();
            if (isEyeMovementActive) toggleEyeMovements();
            if (isFullscreenMode) toggleFullscreenEMDR();
            if (cpIsRunning) stopCPMeasurement();
            if (wakeLock) releaseWakeLock();
            if (audioWakeLock) releaseAudioWakeLock();
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (breathInterval) {
                clearInterval(breathInterval);
                breathInterval = null;
            }
            
            if (auth && auth.currentUser) {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                await signOut(auth);
                log('SUCCESS', 'User logged out successfully');
                showUserMessage('Je bent succesvol uitgelogd!', 'success');
            } else {
                log('INFO', 'No user logged in to log out.');
                showUserMessage('Je bent al uitgelogd.', 'info');
            }
            
        } catch (error) {
            log('ERROR', 'Logout failed:', error);
            showUserMessage('Uitloggen mislukt: ' + error.message, 'error');
        }
    };

    // Enhanced tab management
    window.showTab = function(tabName) {
        // Stop EMDR services when leaving EMDR tab
        if (appState.currentTab === 'emdr' && tabName !== 'emdr') {
            if (isAudioPlaying) toggleBilateralAudio();
            if (isEyeMovementActive) toggleEyeMovements();
            if (isFullscreenMode) toggleFullscreenEMDR();
        }

        // Stop CP measurement when leaving Buteyko tab
        if (appState.currentTab === 'buteyko' && tabName !== 'buteyko') {
            if (cpIsRunning) stopCPMeasurement();
        }

        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        
        // Show selected tab
        const selectedTab = document.getElementById(tabName);
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }
        
        if (selectedBtn) {
            selectedBtn.classList.add('active');
            selectedBtn.setAttribute('aria-selected', 'true');
        }
        
        appState.currentTab = tabName;
        
        // Load content if needed
        if (tabName === 'dagboek') {
            loadDagboekEntries().catch(error => {
                log('WARNING', 'Could not load dagboek entries:', error);
            });
        }
        
        log('INFO', `Switched to tab: ${tabName}`);
    };

    // Enhanced user feedback system
    function showUserMessage(message, type = 'info') {
        const existing = document.querySelector('.user-message');
        if (existing) existing.remove();
        
        const messageEl = document.createElement('div');
        messageEl.className = `user-message alert-${type}`;
        messageEl.style.whiteSpace = 'pre-line';
        messageEl.textContent = message;
        messageEl.setAttribute('role', 'alert');
        messageEl.setAttribute('aria-live', 'polite');
        
        if (message.length > 50) {
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '√ó';
            closeBtn.style.cssText = `
                position: absolute;
                top: 0.5rem;
                right: 0.75rem;
                background: none;
                border: none;
                font-size: 1.25rem;
                cursor: pointer;
                color: inherit;
                opacity: 0.7;
                line-height: 1;
                padding: 0;
                width: 20px;
                height: 20px;
            `;
            closeBtn.onclick = () => messageEl.remove();
            messageEl.style.paddingRight = '3rem';
            messageEl.appendChild(closeBtn);
        }
        
        document.body.appendChild(messageEl);
        
        const delay = type === 'error' ? 8000 : 5000;
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.style.animation = 'slideInDown 0.3s ease-out reverse';
                setTimeout(() => messageEl.remove(), 300);
            }
        }, delay);
    }

    // Control Pause (CP) Measurement Functions
    window.startCPMeasurement = function() {
        cpStartTime = Date.now();
        cpCurrentTime = 0;
        cpIsRunning = true;
        
        const startBtn = document.getElementById('cp-start-btn');
        const stopBtn = document.getElementById('cp-stop-btn');
        const result = document.getElementById('cp-result');
        
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        result.classList.remove('show');
        
        cpInterval = setInterval(() => {
            cpCurrentTime = Math.floor((Date.now() - cpStartTime) / 1000);
            updateCPTimer();
        }, 100);
        
        log('INFO', 'CP measurement started');
    };

    window.stopCPMeasurement = function() {
        if (!cpIsRunning) return;
        
        const finalTime = Math.floor((Date.now() - cpStartTime) / 1000);
        cpIsRunning = false;
        
        if (cpInterval) {
            clearInterval(cpInterval);
            cpInterval = null;
        }
        
        const startBtn = document.getElementById('cp-start-btn');
        const stopBtn = document.getElementById('cp-stop-btn');
        const result = document.getElementById('cp-result');
        
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        
        displayCPResult(finalTime);
        result.classList.add('show');
        
        // Store CP score for potential dagboek entry
        window.lastCPScore = finalTime;
        
        log('SUCCESS', `CP measurement completed: ${finalTime} seconds`);
    };

    window.resetCPMeasurement = function() {
        if (cpInterval) {
            clearInterval(cpInterval);
            cpInterval = null;
        }
        
        cpIsRunning = false;
        cpCurrentTime = 0;
        cpStartTime = 0;
        
        const startBtn = document.getElementById('cp-start-btn');
        const stopBtn = document.getElementById('cp-stop-btn');
        const result = document.getElementById('cp-result');
        const timer = document.getElementById('cp-timer');
        
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        result.classList.remove('show');
        timer.textContent = '00:00';
        
        window.lastCPScore = null;
        
        log('INFO', 'CP measurement reset');
    };

    function updateCPTimer() {
        const timer = document.getElementById('cp-timer');
        const minutes = Math.floor(cpCurrentTime / 60);
        const seconds = cpCurrentTime % 60;
        timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function displayCPResult(seconds) {
        const scoreEl = document.getElementById('cp-score');
        const interpretationEl = document.getElementById('cp-interpretation');
        
        scoreEl.textContent = `${seconds} seconden`;
        
        let interpretation;
        if (seconds < 10) {
            interpretation = 'Zeer lage CO2 tolerantie. Regelmatige Buteyko oefening wordt sterk aangeraden.';
        } else if (seconds < 20) {
            interpretation = 'Lage CO2 tolerantie. Meer oefening kan dit verbeteren.';
        } else if (seconds < 40) {
            interpretation = 'Gemiddelde CO2 tolerantie. Doorgaan met oefenen kan dit verbeteren.';
        } else if (seconds < 60) {
            interpretation = 'Goede CO2 tolerantie. Houd dit niveau vast met regelmatige oefening.';
        } else {
            interpretation = 'Uitstekende CO2 tolerantie! Dit is een zeer goede score.';
        }
        
        interpretationEl.textContent = interpretation;
    }

    // Enhanced form handling
    function setupForms() {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
        }
        
        if (registerForm) {
            registerForm.addEventListener('submit', handleRegister);
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }

        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer het later opnieuw.', 'error');
                return;
            }
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Bezig met inloggen...';
            submitBtn.disabled = true;
            
            const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signInWithEmailAndPassword(auth, email, password);
            
            log('SUCCESS', 'Email sign-in successful');
            e.target.reset();
            
        } catch (error) {
            log('ERROR', 'Email sign-in failed:', error);
            
            let message = 'Inloggen mislukt';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                message = 'Geen account gevonden met deze gegevens';
            } else if (error.code === 'auth/wrong-password') {
                message = 'Verkeerd wachtwoord';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Te veel mislukte pogingen. Probeer het later opnieuw.';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        
        if (!name || !email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }
        
        if (password.length < 6) {
            showUserMessage('Wachtwoord moet minimaal 6 karakters zijn', 'warning');
            return;
        }

        if (!appState.authInitialized || !auth) {
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase is niet beschikbaar. Probeer het later opnieuw.', 'error');
                return;
            }
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Account aanmaken...';
            submitBtn.disabled = true;
            
            const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const result = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(result.user, { displayName: name });
            
            log('SUCCESS', 'Account created successfully');
            closeRegisterModal();
            showUserMessage('Account succesvol aangemaakt!', 'success');
            
        } catch (error) {
            log('ERROR', 'Registration failed:', error);
            
            let message = 'Account aanmaken mislukt';
            if (error.code === 'auth/email-already-in-use') {
                message = 'Dit email adres is al in gebruik. Probeer in te loggen.';
            } else if (error.code === 'auth/weak-password') {
                message = 'Wachtwoord is te zwak. Gebruik minimaal 6 karakters.';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // Modal management
    window.showRegisterForm = function() {
        document.getElementById('register-modal').classList.add('show');
        
        setTimeout(() => {
            const modal = document.getElementById('register-modal');
            const nameField = document.getElementById('register-name');
            if (nameField && modal) {
                modal.scrollTop = 0;
                nameField.focus();
                
                if (window.innerWidth <= 768) {
                    nameField.click();
                    setTimeout(() => {
                        nameField.focus();
                        nameField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }, 150);
    };

    window.closeRegisterModal = function() {
        document.getElementById('register-modal').classList.remove('show');
        document.getElementById('register-form').reset();
    };

    // Tip management
    function setRandomTip() {
        const tipElement = document.getElementById('daily-tip');
        if (tipElement) {
            tipElement.textContent = appState.getRandomTip();
        }
    }

    // Firebase Firestore functions
    async function saveToFirestore(entry) {
        if (!appState.isFirebaseConnected) {
            throw new Error('Firebase niet verbonden. Controleer je internetverbinding.');
        }
        
        if (!appState.currentUser) {
            throw new Error('Je moet ingelogd zijn om entries op te slaan.');
        }

        try {
            log('INFO', 'Saving to Firestore...');

            const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            const docRef = await addDoc(collection(db, "dagboekEntries"), {
                ...entry,
                timestamp: serverTimestamp(),
                userId: appState.currentUser.uid,
                userEmail: appState.currentUser.email,
                version: 1
            });
            
            log('SUCCESS', 'Entry saved to Firestore with ID:', docRef.id);
            return { id: docRef.id, success: true };
            
        } catch (error) {
            log('ERROR', 'Firestore save error:', error);
            throw error;
        }
    }

    async function loadFromFirestore() {
        if (!appState.isFirebaseConnected || !appState.currentUser) {
            throw new Error('Je moet ingelogd zijn en verbonden met internet om entries te laden.');
        }

        try {
            log('INFO', 'Loading entries from Firestore for user:', appState.currentUser.email);
            
            const { getDocs, collection, query, where, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            const q = query(
                collection(db, "dagboekEntries"), 
                where("userId", "==", appState.currentUser.uid),
                orderBy("timestamp", "desc"),
                limit(100)
            );
            
            const querySnapshot = await getDocs(q);
            
            const entries = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                entries.push({
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp ? data.timestamp.toDate() : (data.clientTimestamp ? new Date(data.clientTimestamp) : new Date()),
                    tijdstempel: data.timestamp ? data.timestamp.toDate().toLocaleString('nl-BE') : (data.clientTimestamp ? new Date(data.clientTimestamp).toLocaleString('nl-BE') : 'Onbekend'),
                    bron: "Firebase"
                });
            });
            
            log('SUCCESS', `Loaded ${entries.length} entries from Firestore`);
            return entries;
            
        } catch (error) {
            log('ERROR', 'Firestore query error:', error);
            
            if (error.code === 'permission-denied') {
                throw new Error('Geen toestemming om data te laden. Log opnieuw in.');
            } else if (error.code === 'unavailable') {
                throw new Error('Firebase service tijdelijk niet beschikbaar. Probeer het later opnieuw.');
            } else {
                throw new Error('Fout bij laden van entries: ' + error.message);
            }
        }
    }

    // Dagboek functions
    window.saveDagboekEntry = async function() {
        try {
            const entry = {
                techniekGebruikt: appState.currentTechnique || 'Handmatige Entry',
                trigger: document.getElementById('entry-trigger').value,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                clientTimestamp: new Date().toISOString()
            };

            // Add CP score if available
            const cpScoreInput = document.getElementById('entry-cp-score');
            if (cpScoreInput.value && !isNaN(parseInt(cpScoreInput.value))) {
                entry.cpScore = parseInt(cpScoreInput.value);
            }

            if (!entry.resultaat) {
                showUserMessage('Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            const saveBtn = document.getElementById('save-dagboek-entry-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'üíæ Opslaan...';
            saveBtn.disabled = true;

            await saveToFirestore(entry);
            
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            
            closeDagboekModal();
            resetCompletedExercise();
            
            if (appState.currentTab === 'dagboek') {
                await loadDagboekEntries();
            }
            
            showUserMessage('‚úÖ Entry succesvol opgeslagen!', 'success');
            
        } catch (error) {
            const saveBtn = document.getElementById('save-dagboek-entry-btn');
            if (saveBtn) {
                saveBtn.textContent = 'üìÅ Opslaan';
                saveBtn.disabled = false;
            }
            
            log('ERROR', 'Save error:', error);
            showUserMessage('‚ùå Opslaan mislukt: ' + error.message, 'error');
        }
    };

    function resetCompletedExercise() {
        if (appState.currentTechnique) {
            if (appState.currentTechnique.includes('Buteyko Ademhaling')) {
                resetButeykoAfterCompletion();
            }
        }
    }

    window.loadDagboekEntries = async function() {
        try {
            const entries = await loadFromFirestore();
            displayDagboekEntries(entries);
            
        } catch (error) {
            log('ERROR', 'Load entries failed:', error);
            const container = document.getElementById('dagboek-entries');
            container.innerHTML = 
                '<div class="alert alert-danger">' +
                    '<strong>‚ùå Fout bij laden entries:</strong><br>' + 
                    error.message +
                    '<br><br>' +
                    '<button id="retry-load-btn" class="btn btn-primary" style="margin-top: 1rem;">üîÑ Opnieuw proberen</button>' +
                '</div>';
            
            setTimeout(() => {
                const retryBtn = document.getElementById('retry-load-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', loadDagboekEntries);
                }
            }, 100);

            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
            
            // Hide CP statistics
            document.getElementById('cp-statistics').style.display = 'none';
        }
    };

    function displayDagboekEntries(entries) {
        const container = document.getElementById('dagboek-entries');
        
        createProgressChart(entries);
        displayCPStatistics(entries);
        
        if (!entries || entries.length === 0) {
            container.innerHTML = 
                '<div class="card">' +
                    '<h3>Nog geen entries</h3>' +
                    '<p>Maak een dagboekentry na het gebruiken van oefeningen om patronen bij te houden.</p>' +
                    '<button class="btn btn-primary" onclick="openDagboekModal(\'Eerste Entry\')">' +
                        'Maak je eerste entry' +
                    '</button>' +
                '</div>';
            return;
        }
        
        let entriesHtml = '<div class="card"><h3>üìù Alle Dagboek Entries</h3><p style="color: var(--text-light); margin-bottom: 1.5rem;">Chronologisch overzicht van je sessies</p></div>';
        
        entriesHtml += entries.map(entry => {
            const displayDate = entry.timestamp instanceof Date ? entry.timestamp : new Date(entry.clientTimestamp || 0);

            return '<div class="entry-card">' +
                '<div class="entry-header">' +
                    '<div>' +
                        '<div class="entry-title">' + entry.techniekGebruikt + '</div>' +
                        '<div style="font-size: 0.8rem; color: var(--text-light);">' +
                            displayDate.toLocaleString('nl-BE') + ' ‚Ä¢ ' +
                            '<span style="color: #0891b2; font-size: 0.75rem;">' + (entry.bron || 'Onbekend') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="entry-result ' + entry.resultaat + '">' +
                        getResultaatText(entry.resultaat) +
                    '</div>' +
                '</div>' +
                '<div class="intensity-grid">' +
                    '<div style="font-size: 0.85rem;">' +
                        '<span style="color: var(--text-light);">V√≥√≥r:</span>' +
                        '<span style="font-weight: 500; margin-left: 0.25rem; color: var(--text-dark);">' + entry.intensiteitVoor + '/10</span>' +
                    '</div>' +
                    '<div style="font-size: 0.85rem;">' +
                        '<span style="color: var(--text-light);">N√°:</span>' +
                        '<span style="font-weight: 500; margin-left: 0.25rem; color: var(--text-dark);">' + entry.intensiteitNa + '/10</span>' +
                    '</div>' +
                '</div>' +
                (entry.cpScore ? '<div class="cp-stats"><strong>CP Score:</strong> ' + entry.cpScore + ' seconden</div>' : '') +
                (entry.trigger ? '<p style="font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-dark);"><strong>Trigger:</strong> ' + entry.trigger + '</p>' : '') +
                (entry.notities ? '<p style="font-size: 0.85rem; color: var(--text-dark);"><strong>Notities:</strong> ' + entry.notities + '</p>' : '') +
            '</div>';
        }).join('');
        
        container.innerHTML = entriesHtml;
    }

    function displayCPStatistics(entries) {
        const cpEntries = entries.filter(entry => entry.cpScore && entry.cpScore > 0);
        const cpStatsContainer = document.getElementById('cp-statistics');
        const cpStatsContent = document.getElementById('cp-stats-content');
        
        if (cpEntries.length === 0) {
            cpStatsContainer.style.display = 'none';
            return;
        }
        
        cpStatsContainer.style.display = 'block';
        
        // Calculate statistics
        const cpScores = cpEntries.map(entry => entry.cpScore);
        const latestCP = cpScores[0];
        const averageCP = Math.round(cpScores.reduce((sum, score) => sum + score, 0) / cpScores.length);
        const bestCP = Math.max(...cpScores);
        const improvement = cpScores.length > 1 ? latestCP - cpScores[cpScores.length - 1] : 0;
        
        // Trend calculation (last 5 measurements)
        const recentScores = cpScores.slice(0, 5);
        let trend = 'stabiel';
        if (recentScores.length > 1) {
            const firstHalf = recentScores.slice(0, Math.ceil(recentScores.length / 2));
            const secondHalf = recentScores.slice(Math.ceil(recentScores.length / 2));
            const firstAvg = firstHalf.reduce((sum, score) => sum + score, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((sum, score) => sum + score, 0) / secondHalf.length;
            
            if (firstAvg > secondAvg + 2) trend = 'stijgend üìà';
            else if (secondAvg > firstAvg + 2) trend = 'dalend üìâ';
            else trend = 'stabiel ‚û°Ô∏è';
        }
        
        cpStatsContent.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div class="cp-stats">
                    <strong>Laatste CP:</strong> ${latestCP} sec
                </div>
                <div class="cp-stats">
                    <strong>Gemiddelde:</strong> ${averageCP} sec
                </div>
                <div class="cp-stats">
                    <strong>Beste Score:</strong> ${bestCP} sec
                </div>
                <div class="cp-stats">
                    <strong>Trend:</strong> ${trend}
                </div>
            </div>
            <div class="cp-stats">
                <strong>Totaal metingen:</strong> ${cpEntries.length} ‚Ä¢ 
                <strong>Verbetering sinds start:</strong> ${improvement > 0 ? '+' : ''}${improvement} sec
            </div>
        `;
    }

    // Skip dagboek functions
    window.skipButeykoDagboek = function() { 
        resetButeykoAfterCompletion(); 
        showUserMessage('‚úÖ Buteyko sessie afgerond!', 'success'); 
    };

    window.skipRitualDagboek = function() {
        document.getElementById('ritual-complete').classList.add('hidden');
        ritualStep = 0;
        updateRitualDisplay();
        showUserMessage('‚úÖ Maag-Ademhaling reset afgerond!', 'success');
    };

    window.skipEmdrDagboek = function() {
        resetEmdrSession();
        showUserMessage('‚úÖ EMDR sessie afgerond!', 'success');
    };

    function getResultaatText(resultaat) {
        const mapping = {
            'zeer-goed': 'Zeer goed',
            'goed': 'Goed',
            'matig': 'Matig',
            'geen-effect': 'Geen effect',
            'slechter': 'Slechter'
        };
        return mapping[resultaat] || resultaat;
    }

    window.exportDagboek = async function() {
        try {
            const entries = await loadFromFirestore();
            
            if (!entries || entries.length === 0) {
                showUserMessage('üìù Geen entries om te exporteren', 'warning');
                return;
            }
            
            let exportText = 'ADEMRUIMTE DAGBOEK EXPORT\n';
            exportText += '================================\n';
            exportText += 'Gebruiker: ' + (appState.currentUser ? (appState.currentUser.displayName || appState.currentUser.email) : 'Onbekend') + '\n';
            exportText += 'Export datum: ' + new Date().toLocaleString('nl-BE') + '\n\n';
            
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const displayDate = entry.timestamp instanceof Date ? entry.timestamp : new Date(entry.clientTimestamp || 0);

                exportText += 'ENTRY ' + (i + 1) + '\n';
                exportText += 'Datum: ' + displayDate.toLocaleString('nl-BE') + '\n';
                exportText += 'Techniek: ' + entry.techniekGebruikt + '\n';
                exportText += 'Trigger: ' + (entry.trigger || 'Geen') + '\n';
                exportText += 'Intensiteit v√≥√≥r: ' + entry.intensiteitVoor + '/10\n';
                exportText += 'Intensiteit n√°: ' + entry.intensiteitNa + '/10\n';
                if (entry.cpScore) {
                    exportText += 'CP Score: ' + entry.cpScore + ' seconden\n';
                }
                exportText += 'Resultaat: ' + getResultaatText(entry.resultaat) + '\n';
                exportText += 'Notities: ' + (entry.notities || 'Geen') + '\n';
                exportText += '\n---\n\n';
            }
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ademruimte-dagboek-' + new Date().toLocaleDateString('nl-BE') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showUserMessage('üìÅ Dagboek ge√´xporteerd als tekstbestand!', 'success');
            
        } catch (error) {
            showUserMessage('‚ùå Fout bij exporteren: ' + error.message, 'error');
        }
    };

    // Timer functionality for Maag-Ademhaling Reset
    window.startTimer = function() {
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerBtn.innerHTML = '‚ñ∂Ô∏è Start Timer';
            timerBtn.className = 'btn btn-green';
            nextBtn.style.display = 'block';
            log('INFO', 'Timer stopped manually');
            return;
        }
        
        currentTime = ritualSteps[ritualStep].duration;
        timerBtn.innerHTML = '‚è∏Ô∏è Stop Timer';
        timerBtn.className = 'btn btn-red';
        nextBtn.style.display = 'none';
        
        timerInterval = setInterval(() => {
            currentTime--;
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (currentTime <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.innerHTML = '‚ñ∂Ô∏è Start Timer';
                timerBtn.className = 'btn btn-green';
                nextBtn.style.display = 'block';
                showUserMessage('‚è∞ Timer afgelopen! Tijd voor de volgende stap.', 'success');
                log('SUCCESS', 'Timer completed');
            }
        }, 1000);
    };

    window.nextRitualStep = function() {
        if (ritualStep < ritualSteps.length - 1) {
            ritualStep++;
            updateRitualDisplay();
        } else {
            document.getElementById('ritual-complete').classList.remove('hidden');
            appState.currentTechnique = 'Maag-Ademhaling Reset - 5 Stappen Voltooid';
            trackSession('ritual', ritualSteps.reduce((sum, step) => sum + step.duration, 0));
            log('SUCCESS', 'Maag-Ademhaling reset completed');
        }
    };

    window.skipToNextStep = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
            document.getElementById('timer-btn').className = 'btn btn-green';
        }
        nextRitualStep();
    };

    window.resetRitual = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        ritualStep = 0;
        updateRitualDisplay();
        document.getElementById('ritual-complete').classList.add('hidden');
        document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
    };

    function updateRitualDisplay() {
        const step = ritualSteps[ritualStep];
        
        document.getElementById('ritual-title').textContent = step.title;
        
        const minutes = Math.floor(step.duration / 60);
        const seconds = step.duration % 60;
        document.getElementById('timer-display').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        currentTime = step.duration;
        
        const instructionsHtml = '<ul class="step-list">' + 
            step.instructions.map(instruction => `<li>${instruction}</li>`).join('') +
            '</ul>';
        document.getElementById('ritual-instructions').innerHTML = instructionsHtml;
        
        const progress = ((ritualStep + 1) / ritualSteps.length) * 100;
        document.getElementById('ritual-progress').style.width = progress + '%';
        
        document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        log('INFO', `Maag-Ademhaling reset step ${ritualStep + 1}/${ritualSteps.length}: ${step.title}`);
    }

    // Wake Lock API for keeping screen on
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                log('SUCCESS', 'Wake lock activated - screen will stay on');
                
                wakeLock.addEventListener('release', () => {
                    log('INFO', 'Wake lock released');
                });
            }
        } catch (error) {
            log('WARNING', 'Wake lock not supported or failed:', error);
        }
    }

    async function releaseWakeLock() {
        if (wakeLock) {
            try {
                await wakeLock.release();
                wakeLock = null;
                log('SUCCESS', 'Wake lock released');
            } catch (error) {
                log('ERROR', 'Error releasing wake lock:', error);
            }
        }
    }

    // Audio Wake Lock specifically for EMDR
    async function requestAudioWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                audioWakeLock = await navigator.wakeLock.request('screen');
                log('SUCCESS', 'Audio wake lock activated - screen will stay on during EMDR audio');
                
                audioWakeLock.addEventListener('release', () => {
                    log('INFO', 'Audio wake lock released');
                });
            }
        } catch (error) {
            log('WARNING', 'Audio wake lock not supported or failed:', error);
        }
    }

    async function releaseAudioWakeLock() {
        if (audioWakeLock) {
            try {
                await audioWakeLock.release();
                audioWakeLock = null;
                log('SUCCESS', 'Audio wake lock released');
            } catch (error) {
                log('ERROR', 'Error releasing audio wake lock:', error);
            }
        }
    }

    // Progress tracking functions
    let progressDataStore = {
        buteyko: { sessions: 0, totalTime: 0, lastSession: null },
        ritual: { sessions: 0, totalTime: 0, lastSession: null },
        emdr: { sessions: 0, totalTime: 0, lastSession: null },
        crisis: { sessions: 0, lastSession: null }
    };

    function loadProgressData() {
        try {
            if (typeof Storage !== "undefined" && window.localStorage) {
                const stored = localStorage.getItem('ademruimte-progress');
                if (stored) {
                    progressData = { ...progressDataStore, ...JSON.parse(stored) };
                    log('SUCCESS', 'Progress data loaded from localStorage');
                    return;
                }
            }
        } catch (error) {
            log('WARNING', 'localStorage not available, using in-memory storage:', error.message);
        }
        
        progressData = { ...progressDataStore };
        log('INFO', 'Using in-memory progress storage (or initial values)');
    }

    function saveProgressData() {
        try {
            if (typeof Storage !== "undefined" && window.localStorage) {
                localStorage.setItem('ademruimte-progress', JSON.stringify(progressData));
                log('SUCCESS', 'Progress data saved to localStorage');
                return;
            }
        } catch (error) {
            log('WARNING', 'localStorage not available, data will not persist between sessions:', error.message);
        }
    }

    function trackSession(type, duration = null) {
        if (!progressData[type]) {
            progressData[type] = { sessions: 0, totalTime: 0, lastSession: null };
        }
        
        progressData[type].sessions++;
        if (duration) {
            progressData[type].totalTime += duration;
        }
        progressData[type].lastSession = new Date().toISOString();
        
        saveProgressData();
        log('SUCCESS', `Tracked ${type} session:`, progressData[type]);
    }

    // Buteyko breathing exercise functions
    window.updateBreathingPattern = function() {
        breathingPattern = document.getElementById('breathing-pattern').value;
        const standardControls = document.getElementById('standard-controls');
        const gentleControls = document.getElementById('gentle-controls');
        
        if (breathingPattern === 'gentle') {
            standardControls.classList.add('hidden');
            gentleControls.classList.remove('hidden');
        } else {
            standardControls.classList.remove('hidden');
            gentleControls.classList.add('hidden');
        }
        
        if (breathInterval) {
            resetBreathExercise();
        }
    };

    window.toggleBreathExercise = function() {
        if (breathInterval) {
            stopBreathExercise();
        } else {
            startBreathExercise();
        }
    };

    window.resetBreathExercise = function() {
        stopBreathExercise();
        breathCycleCount = 1;
        gentleBreathCount = 0;
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
        document.getElementById('breath-complete').classList.add('hidden');
    };

    function startBreathExercise() {
        requestWakeLock();
        
        breathCycleCount = 1;
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
        
        if (breathingPattern === 'gentle') {
            startGentleBreathing();
        } else {
            startStandardBreathing();
        }
    }

    function startStandardBreathing() {
        const inhale = parseInt(document.getElementById('inhale-duration').value);
        const exhale = parseInt(document.getElementById('exhale-duration').value);
        const hold = parseInt(document.getElementById('hold-duration').value);
        
        breathCycleDuration = inhale + exhale + hold;
        breathPhase = 'inhale';
        breathPhaseTime = 0;
        
        document.getElementById('breath-btn').innerHTML = '‚è∏Ô∏è Stop Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-red';
        
        breathInterval = setInterval(() => {
            updateStandardBreathCycle();
        }, 100);
    }

    function startGentleBreathing() {
        const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
        const pauseTime = parseInt(document.getElementById('gentle-pause').value);
        
        breathPhase = 'gentle-breath';
        breathPhaseTime = 0;
        gentleBreathCount = 0;
        
        document.getElementById('breath-btn').innerHTML = '‚è∏Ô∏è Stop Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-red';
        
        breathInterval = setInterval(() => {
            updateGentleBreathCycle();
        }, 100);
    }

    function stopBreathExercise() {
        if (breathInterval) {
            clearInterval(breathInterval);
            breathInterval = null;
        }
        
        releaseWakeLock();
        
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        
        document.getElementById('breath-btn').innerHTML = '‚ñ∂Ô∏è Start Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-cyan';
    }

    function updateStandardBreathCycle() {
        const inhale = parseInt(document.getElementById('inhale-duration').value);
        const exhale = parseInt(document.getElementById('exhale-duration').value);
        const hold = parseInt(document.getElementById('hold-duration').value);
        
        breathPhaseTime += 0.1;
        
        let progress = 0;
        
        if (breathPhase === 'inhale') {
            progress = (breathPhaseTime / inhale) * 100;
            if (breathPhaseTime >= inhale) {
                breathPhase = 'exhale';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'exhale') {
            progress = (breathPhaseTime / exhale) * 100;
            if (breathPhaseTime >= exhale) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / hold) * 100;
            if (breathPhaseTime >= hold) {
                breathPhase = 'inhale';
                breathPhaseTime = 0;
                breathCycleCount++;
                document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}/10`;
                
                if (breathCycleCount > 10) {
                    stopBreathExercise();
                    trackSession('buteyko', 10 * breathCycleDuration);
                    document.getElementById('breath-complete').classList.remove('hidden');
                    appState.currentTechnique = 'Buteyko Ademhaling - 10 Cycli Voltooid';
                    log('SUCCESS', 'Buteyko session completed');
                    return;
                }
            }
        }
        
        updateBreathDisplay();
        updateBreathProgress(Math.min(progress, 100));
    }

    function updateGentleBreathCycle() {
        const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
        const pauseTime = parseInt(document.getElementById('gentle-pause').value);
        
        breathPhaseTime += 0.1;
        let progress = 0;
        
        if (breathPhase === 'gentle-breath') {
            progress = (breathPhaseTime / cycleTime) * 100;
            if (breathPhaseTime >= cycleTime) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
                gentleBreathCount++;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / pauseTime) * 100;
            if (breathPhaseTime >= pauseTime) {
                breathPhase = 'gentle-breath';
                breathPhaseTime = 0;
                breathCycleCount++;
                document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}/10`;
                
                if (breathCycleCount > 10) {
                    stopBreathExercise();
                    trackSession('buteyko', 10 * (cycleTime + pauseTime));
                    document.getElementById('breath-complete').classList.remove('hidden');
                    appState.currentTechnique = 'Buteyko Ademhaling - 10 Cycli Voltooid';
                    log('SUCCESS', 'Buteyko gentle session completed');
                    return;
                }
            }
        }
        
        updateBreathDisplay();
        updateBreathProgress(Math.min(progress, 100));
    }

    function updateBreathDisplay() {
        const display = document.getElementById('breath-display');
        const progressBar = document.getElementById('breath-progress');
        
        display.className = `breath-display ${breathPhase}`;
        progressBar.className = `breath-progress ${breathPhase}`;
        
        switch (breathPhase) {
            case 'inhale':
                display.textContent = 'üå¨Ô∏è Inademen';
                break;
            case 'exhale':
                display.textContent = 'üí® Uitademen';
                break;
            case 'hold':
                display.textContent = '‚è∏Ô∏è Pauze';
                break;
            case 'gentle-breath':
                display.textContent = `üå¨Ô∏è Zachte Ademhaling`;
                break;
            case 'rest':
            default:
                display.textContent = 'Klik op start om te beginnen';
                break;
        }
    }

    function updateBreathProgress(percentage) {
        document.getElementById('breath-progress').style.width = percentage + '%';
    }

    function resetButeykoAfterCompletion() {
        document.getElementById('breath-complete').classList.add('hidden');
        breathCycleCount = 1;
        gentleBreathCount = 0;
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
    }

    // Enhanced EMDR Audio functions with live updates and wake lock
    function initAudioContext() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                log('SUCCESS', 'Audio context initialized');
            } catch (error) {
                log('ERROR', 'Audio context initialization failed:', error);
                showUserMessage('Je browser ondersteunt geen Web Audio API.', 'error');
                return false;
            }
        }
        return true;
    }

    window.toggleBilateralAudio = function() {
        if (isAudioPlaying) {
            stopBilateralAudio();
        } else {
            startBilateralAudio();
        }
    };

    function startBilateralAudio() {
        if (!initAudioContext()) return;

        try {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            oscillator = audioContext.createOscillator();
            const frequency = parseInt(document.getElementById('audio-frequency').value);
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';

            gainNode = audioContext.createGain();
            const volume = parseInt(document.getElementById('audio-volume').value) / 100;
            gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);

            pannerNode = audioContext.createStereoPanner();
            pannerNode.pan.setValueAtTime(-1, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(pannerNode);
            pannerNode.connect(audioContext.destination);

            oscillator.start();
            startPanning();

            isAudioPlaying = true;
            
            // Request wake lock to prevent sleep during audio
            requestAudioWakeLock();
            
            document.getElementById('audio-btn').innerHTML = '‚è∏Ô∏è Stop Audio';
            document.getElementById('audio-btn').className = 'btn btn-red';
            
            const statusEl = document.getElementById('audio-status');
            statusEl.className = 'emdr-status active';
            statusEl.innerHTML = `<span>üîä Actief - ${frequency}Hz</span>`;

            log('SUCCESS', `Bilateral audio started at ${frequency}Hz`);

        } catch (error) {
            log('ERROR', 'Error starting bilateral audio:', error);
            showUserMessage('Fout bij starten audio: ' + error.message, 'error');
        }
    }

    function stopBilateralAudio() {
        try {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }

            if (gainNode) {
                gainNode.disconnect();
                gainNode = null;
            }

            if (pannerNode) {
                pannerNode.disconnect();
                pannerNode = null;
            }

            if (audioInterval) {
                clearInterval(audioInterval);
                audioInterval = null;
            }

            isAudioPlaying = false;
            panPosition = -1;
            
            // Release audio wake lock
            releaseAudioWakeLock();
            
            document.getElementById('audio-btn').innerHTML = 'üîä Start Audio';
            document.getElementById('audio-btn').className = 'btn btn-purple';
            
            const statusEl = document.getElementById('audio-status');
            statusEl.className = 'emdr-status inactive';
            statusEl.innerHTML = '<span>‚è∏Ô∏è Gestopt</span>';

            log('SUCCESS', 'Bilateral audio stopped');

        } catch (error) {
            log('ERROR', 'Error stopping bilateral audio:', error);
        }
    }

    function startPanning() {
        const speed = parseFloat(document.getElementById('audio-speed').value) * 1000;
        const updateInterval = 50;
        const steps = speed / updateInterval;
        const panStep = 2 / steps;

        panPosition = -1;
        let direction = 1;

        audioInterval = setInterval(() => {
            if (!isAudioPlaying || !pannerNode) {
                clearInterval(audioInterval);
                return;
            }

            panPosition += (panStep * direction);

            if (panPosition >= 1) {
                panPosition = 1;
                direction = -1;
            } else if (panPosition <= -1) {
                panPosition = -1;
                direction = 1;
            }

            pannerNode.pan.setValueAtTime(panPosition, audioContext.currentTime);

            // Update status with current position
            if (appState.currentTab === 'emdr') {
                const frequency = parseInt(document.getElementById('audio-frequency').value);
                const side = panPosition < -0.3 ? 'Links' : panPosition > 0.3 ? 'Rechts' : 'Midden';
                const statusEl = document.getElementById('audio-status');
                statusEl.innerHTML = `<span>üîä ${frequency}Hz - ${side}</span>`;
            }

        }, updateInterval);
    }

    // Live update functions for EMDR audio
    function updateAudioSpeed() {
        if (isAudioPlaying) {
            // Restart panning with new speed
            if (audioInterval) {
                clearInterval(audioInterval);
            }
            startPanning();
        }
    }

    function updateAudioVolume() {
        if (isAudioPlaying && gainNode) {
            const volume = parseInt(document.getElementById('audio-volume').value) / 100;
            gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
        }
    }

    function updateAudioFrequency() {
        if (isAudioPlaying && oscillator) {
            const frequency = parseInt(document.getElementById('audio-frequency').value);
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        }
    }

    // EMDR Eye Movement functions
    window.toggleEyeMovements = function() {
        if (isEyeMovementActive) {
            stopEyeMovements();
        } else {
            startEyeMovements();
        }
    };

    // Fullscreen EMDR functionality
    window.toggleFullscreenEMDR = function() {
        const fullscreenModal = document.getElementById('fullscreen-emdr');
        
        if (isFullscreenMode) {
            // Exit fullscreen
            fullscreenModal.classList.remove('show');
            isFullscreenMode = false;
            
            // Stop eye movements in fullscreen
            stopFullscreenEyeMovements();
            
            log('INFO', 'Exited fullscreen EMDR mode');
        } else {
            // Enter fullscreen
            fullscreenModal.classList.add('show');
            isFullscreenMode = true;
            
            // Automatically start eye movements in fullscreen if regular eye movements were active
            if (isEyeMovementActive) {
                stopEyeMovements(); // Stop regular mode
                startFullscreenEyeMovements(); // Start fullscreen mode
            } else {
                // Update instructions
                document.getElementById('fullscreen-instructions').textContent = 
                    'Start eerst de oogbewegingen in de normale weergave, dan schakel naar volledig scherm';
            }
            
            log('INFO', 'Entered fullscreen EMDR mode');
        }
    };

    function startEyeMovements() {
        const eyeDot = document.getElementById('eye-dot');
        const eyeInstructions = document.getElementById('eye-instructions');
        const eyeBtn = document.getElementById('eye-btn');
        const statusEl = document.getElementById('eye-status');
        
        eyeDot.style.display = 'block';
        eyeInstructions.style.display = 'none';
        eyeBtn.innerHTML = '‚è∏Ô∏è Stop Oogbewegingen';
        eyeBtn.className = 'btn btn-red';
        
        statusEl.className = 'emdr-status active';
        statusEl.innerHTML = '<span>üëÅÔ∏è Actief</span>';
        
        isEyeMovementActive = true;
        eyeStep = 0;
        
        updateEyeMovementPattern();
        
        log('SUCCESS', 'Eye movements started');
    }

    function stopEyeMovements() {
        const eyeDot = document.getElementById('eye-dot');
        const eyeInstructions = document.getElementById('eye-instructions');
        const eyeBtn = document.getElementById('eye-btn');
        const statusEl = document.getElementById('eye-status');
        
        if (eyeMovementInterval) {
            clearInterval(eyeMovementInterval);
            eyeMovementInterval = null;
        }
        
        eyeDot.style.display = 'none';
        eyeInstructions.style.display = 'block';
        eyeInstructions.textContent = 'Klik op start om oogbewegingen te beginnen';
        eyeBtn.innerHTML = 'üëÅÔ∏è Start Oogbewegingen';
        eyeBtn.className = 'btn btn-cyan';
        
        statusEl.className = 'emdr-status inactive';
        statusEl.innerHTML = '<span>‚è∏Ô∏è Gestopt</span>';
        
        isEyeMovementActive = false;
        
        log('SUCCESS', 'Eye movements stopped');
    }

    function startFullscreenEyeMovements() {
        const fullscreenDot = document.getElementById('fullscreen-eye-dot');
        const fullscreenInstructions = document.getElementById('fullscreen-instructions');
        
        fullscreenDot.style.display = 'block';
        fullscreenInstructions.style.display = 'none';
        
        isEyeMovementActive = true;
        eyeStep = 0;
        
        updateFullscreenEyeMovementPattern();
        
        log('SUCCESS', 'Fullscreen eye movements started');
    }

    function stopFullscreenEyeMovements() {
        const fullscreenDot = document.getElementById('fullscreen-eye-dot');
        const fullscreenInstructions = document.getElementById('fullscreen-instructions');
        
        if (eyeMovementInterval) {
            clearInterval(eyeMovementInterval);
            eyeMovementInterval = null;
        }
        
        fullscreenDot.style.display = 'none';
        fullscreenInstructions.style.display = 'block';
        fullscreenInstructions.textContent = 'Druk op start om de oogbewegingen in volledig scherm te beginnen';
        
        isEyeMovementActive = false;
        
        log('SUCCESS', 'Fullscreen eye movements stopped');
    }

    function updateEyeMovementPattern() {
        if (eyeMovementInterval) {
            clearInterval(eyeMovementInterval);
        }
        
        const speed = document.getElementById('eye-speed').value;
        const pattern = document.getElementById('eye-pattern').value;
        
        let duration;
        switch (speed) {
            case 'slow': duration = 4000; break;
            case 'fast': duration = 1000; break;
            default: duration = 2000; break;
        }
        
        const steps = duration / 50; // 50ms intervals
        let currentStep = 0;
        
        eyeMovementInterval = setInterval(() => {
            if (!isEyeMovementActive) {
                clearInterval(eyeMovementInterval);
                return;
            }
            
            const progress = currentStep / steps;
            const position = calculateEyePosition(pattern, progress);
            
            if (isFullscreenMode) {
                updateFullscreenEyePosition(position);
            } else {
                updateRegularEyePosition(position);
            }
            
            currentStep++;
            if (currentStep >= steps) {
                currentStep = 0; // Loop the pattern
            }
        }, 50);
    }

    function updateFullscreenEyeMovementPattern() {
        updateEyeMovementPattern(); // Use the same pattern logic
    }

    function updateRegularEyePosition(position) {
        const eyeDot = document.getElementById('eye-dot');
        const container = document.getElementById('eye-movement-display');
        const containerRect = container.getBoundingClientRect();
        
        // Calculate position with smaller margins for full width usage
        const margin = 10; // Reduced from 20px to 10px
        const maxX = containerRect.width - margin * 2;
        const maxY = containerRect.height - margin * 2;
        
        const x = margin + (position.x / 100) * maxX;
        const y = margin + (position.y / 100) * maxY;
        
        eyeDot.style.left = x + 'px';
        eyeDot.style.top = y + 'px';
        eyeDot.style.transform = 'none'; // Override center transform
    }

    function updateFullscreenEyePosition(position) {
        const fullscreenDot = document.getElementById('fullscreen-eye-dot');
        
        // For fullscreen, use almost full viewport dimensions
        const margin = 50; // Reduced from 100px to 50px
        const maxX = window.innerWidth - margin * 2;
        const maxY = window.innerHeight - margin * 2;
        
        const x = margin + (position.x / 100) * maxX;
        const y = margin + (position.y / 100) * maxY;
        
        fullscreenDot.style.left = x + 'px';
        fullscreenDot.style.top = y + 'px';
        fullscreenDot.style.transform = 'none'; // Override center transform
    }

    function calculateEyePosition(pattern, progress) {
        // progress is from 0 to 1
        const t = progress * 2 * Math.PI; // Convert to radians for smooth motion
        
        switch (pattern) {
            case 'horizontal':
                return {
                    x: 50 + 45 * Math.sin(t), // Increased from 40 to 45 for more range
                    y: 50 // Stay in middle vertically
                };
            case 'vertical':
                return {
                    x: 50, // Stay in middle horizontally
                    y: 50 + 45 * Math.sin(t) // Increased from 40 to 45 for more range
                };
            case 'diagonal':
                return {
                    x: 50 + 45 * Math.sin(t), // Increased range
                    y: 50 + 45 * Math.sin(t) // Increased range
                };
            case 'figure8':
                return {
                    x: 50 + 35 * Math.sin(t), // Increased from 30 to 35
                    y: 50 + 25 * Math.sin(2 * t) // Increased from 20 to 25
                };
            default:
                return { x: 50, y: 50 };
        }
    }

    // EMDR Step Management
    window.nextEmdrStep = function() {
        if (emdrStep < emdrSteps.length - 1) {
            emdrStep++;
            updateEmdrDisplay();
        } else {
            document.getElementById('emdr-complete').classList.remove('hidden');
            appState.currentTechnique = 'EMDR Zelfhulp - 5 Stappen Voltooid';
            trackSession('emdr', 25);
            log('SUCCESS', 'EMDR session completed');
        }
    };

    window.prevEmdrStep = function() {
        if (emdrStep > 0) {
            emdrStep--;
            updateEmdrDisplay();
        }
    };

    function updateEmdrDisplay() {
        const step = emdrSteps[emdrStep];
        
        document.getElementById('emdr-title').textContent = step.title;
        document.getElementById('emdr-content').innerHTML = '<p>' + step.content + '</p>';
        
        const intensityDiv = document.getElementById('emdr-intensity');
        if (step.showIntensity) {
            intensityDiv.classList.remove('hidden');
        } else {
            intensityDiv.classList.add('hidden');
        }
        
        const prevBtn = document.getElementById('emdr-prev-btn');
        const nextBtn = document.getElementById('emdr-next-btn');
        
        if (emdrStep === 0) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }
        
        if (emdrStep === emdrSteps.length - 1) {
            nextBtn.textContent = 'Voltooien';
        } else {
            nextBtn.textContent = 'Volgende';
        }
        
        const progress = ((emdrStep + 1) / emdrSteps.length) * 100;
        document.getElementById('emdr-progress').style.width = progress + '%';
        
        log('INFO', `EMDR step ${emdrStep + 1}/${emdrSteps.length}: ${step.title}`);
    }

    function resetEmdrSession() {
        emdrStep = 0;
        updateEmdrDisplay();
        document.getElementById('emdr-complete').classList.add('hidden');
        
        if (isAudioPlaying) {
            stopBilateralAudio();
        }
        if (isEyeMovementActive) {
            stopEyeMovements();
        }
        if (isFullscreenMode) {
            toggleFullscreenEMDR();
        }
    }

    // Network status monitoring
    function setupNetworkMonitoring() {
        window.addEventListener('online', () => {
            appState.isOnline = true;
            appState.updateConnectionDisplay();
            log('INFO', 'Network connection restored');
            if (!appState.isFirebaseConnected && appState.authInitialized) {
                initializeFirebase();
            }
        });

        window.addEventListener('offline', () => {
            appState.isOnline = false;
            appState.setConnectionStatus(false);
            log('WARNING', 'Network connection lost');
            showUserMessage('Internetverbinding verloren.', 'warning');
        });
    }

    // Keyboard navigation enhancements
    function setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            // Handle fullscreen EMDR escape
            if (e.key === 'Escape' && isFullscreenMode) {
                e.preventDefault();
                toggleFullscreenEMDR();
                return;
            }
            
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && document.activeElement === activeTab) {
                    e.preventDefault();
                    
                    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
                    const currentIndex = tabs.indexOf(activeTab);
                    
                    let nextIndex;
                    if (e.key === 'ArrowLeft') {
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    } else {
                        nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    }
                    
                    tabs[nextIndex].focus();
                    tabs[nextIndex].click();
                }
            }
            
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
            
            // CP measurement shortcuts
            if (e.key === ' ' && appState.currentTab === 'buteyko') {
                if (cpIsRunning) {
                    e.preventDefault();
                    stopCPMeasurement();
                } else if (!cpIsRunning && document.getElementById('cp-start-btn').style.display !== 'none') {
                    e.preventDefault();
                    startCPMeasurement();
                }
            }
        });
    }

    // Range slider updates
    function setupRangeSliders() {
        const sliders = [
            { input: 'emdr-intensity-slider', output: 'emdr-intensity-value' },
            { input: 'entry-before', output: 'entry-before-value' },
            { input: 'entry-after', output: 'entry-after-value' },
            { input: 'audio-speed', output: 'audio-speed-value' }
        ];

        sliders.forEach(slider => {
            const input = document.getElementById(slider.input);
            const output = document.getElementById(slider.output);
            
            if (input && output) {
                input.addEventListener('input', function() {
                    if (slider.input === 'audio-speed') {
                        output.textContent = this.value + 's';
                        updateAudioSpeed();
                    } else {
                        output.textContent = this.value;
                    }
                });
                
                // Set initial value display
                if (slider.input === 'audio-speed') {
                    output.textContent = input.value + 's';
                } else {
                    output.textContent = input.value;
                }
            }
        });
    }

    // Enhanced mobile focus handling
    function setupMobileFocusHandling() {
        document.addEventListener('touchstart', function(e) {
            if (e.target.matches('.form-input, .form-textarea')) {
                setTimeout(() => {
                    e.target.focus();
                }, 50);
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.matches('.form-input, .form-textarea')) {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        e.target.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center',
                            inline: 'nearest'
                        });
                    }, 300);
                }
            }
        });
    }

    // Dagboek modal functions
    window.openDagboekModal = function(technique) {
        appState.currentTechnique = technique;
        
        if (technique === 'Crisis Hulp Technieken') {
            trackSession('crisis');
        }
        
        let triggerText = '';
        if (technique) {
            if (technique.includes('Buteyko')) {
                triggerText = 'Na voltooiing van Buteyko ademhalingsoefening (10 cycli)';
            } else if (technique.includes('Maag-Ademhaling Reset')) {
                triggerText = 'Na voltooiing van Maag-Ademhaling Reset Protocol (5 stappen)';
            } else if (technique.includes('EMDR')) {
                triggerText = 'Na voltooiing van EMDR zelfhulp sessie (5 stappen)';
            } else if (technique.includes('Crisis Hulp')) {
                triggerText = 'Tijdens/na gebruik van crisis hulp technieken';
            } else {
                triggerText = `Tijdens/na ${technique}`;
            }
        }
        
        document.getElementById('entry-trigger').value = triggerText;
        
        // Show/hide CP score field based on technique
        const cpScoreGroup = document.getElementById('cp-score-group');
        if (technique && technique.includes('Buteyko')) {
            cpScoreGroup.style.display = 'block';
            // Pre-fill with last CP score if available
            if (window.lastCPScore) {
                document.getElementById('entry-cp-score').value = window.lastCPScore;
            }
        } else {
            cpScoreGroup.style.display = 'none';
            document.getElementById('entry-cp-score').value = '';
        }
        
        if (technique && (technique.includes('Voltooid') || technique.includes('Crisis Hulp'))) {
            document.getElementById('entry-before').value = '7';
            document.getElementById('entry-before-value').textContent = '7';
            document.getElementById('entry-after').value = '3';
            document.getElementById('entry-after-value').textContent = '3';
        } else {
            document.getElementById('entry-before').value = '5';
            document.getElementById('entry-before-value').textContent = '5';
            document.getElementById('entry-after').value = '5';
            document.getElementById('entry-after-value').textContent = '5';
        }
        
        document.getElementById('dagboek-modal').classList.add('show');
        
        // Re-attach event listeners to ensure they work
        setTimeout(() => {
            const modal = document.getElementById('dagboek-modal');
            if (modal) {
                modal.scrollTop = 0;
                
                // Ensure save button event listener is attached
                const saveBtn = document.getElementById('save-dagboek-entry-btn');
                if (saveBtn) {
                    // Remove any existing listeners and add fresh one
                    saveBtn.replaceWith(saveBtn.cloneNode(true));
                    const newSaveBtn = document.getElementById('save-dagboek-entry-btn');
                    newSaveBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        saveDagboekEntry();
                    });
                }
                
                // Ensure text inputs work properly - more aggressive fix for spaces
                const textInputs = modal.querySelectorAll('input[type="text"], textarea');
                textInputs.forEach(input => {
                    // Reset all CSS that might interfere with text input
                    input.style.whiteSpace = 'pre-wrap';
                    input.style.wordSpacing = 'normal';
                    input.style.letterSpacing = 'normal';
                    input.style.textTransform = 'none';
                    
                    // Remove all existing event listeners by cloning
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    
                    // Add fresh event handlers that explicitly allow spaces
                    newInput.addEventListener('keydown', function(e) {
                        // Explicitly allow space key
                        if (e.code === 'Space' || e.keyCode === 32) {
                            e.stopPropagation();
                            return true;
                        }
                    });
                    
                    newInput.addEventListener('keypress', function(e) {
                        // Explicitly allow space character
                        if (e.code === 'Space' || e.keyCode === 32 || e.char === ' ') {
                            e.stopPropagation();
                            return true;
                        }
                    });
                    
                    newInput.addEventListener('input', function(e) {
                        // Allow all input including spaces
                        e.stopPropagation();
                        // Force the value to stay as entered
                        const cursorPos = this.selectionStart;
                        const val = this.value;
                        setTimeout(() => {
                            this.value = val;
                            this.setSelectionRange(cursorPos, cursorPos);
                        }, 0);
                    });
                });
                
                const firstInput = modal.querySelector('input[type="text"], textarea');
                if (firstInput) {
                    firstInput.focus();
                    if (window.innerWidth <= 768) {
                        firstInput.click();
                        setTimeout(() => {
                            firstInput.focus();
                            firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                }
            }
        }, 150);
    };

    window.closeDagboekModal = function() {
        document.getElementById('dagboek-modal').classList.remove('show');
        
        document.getElementById('entry-trigger').value = '';
        document.getElementById('entry-before').value = '5';
        document.getElementById('entry-after').value = '5';
        document.getElementById('entry-result').value = '';
        document.getElementById('entry-notes').value = '';
        document.getElementById('entry-cp-score').value = '';
        
        document.getElementById('entry-before-value').textContent = '5';
        document.getElementById('entry-after-value').textContent = '5';
        
        // Hide CP score field
        document.getElementById('cp-score-group').style.display = 'none';
        
        appState.currentTechnique = '';
    };

    // Chart management with Chart.js
    let progressChart = null;

    async function createProgressChart(entries) {
        const chartRelevantEntries = entries.filter(entry => 
            entry.intensiteitVoor !== undefined && entry.intensiteitNa !== undefined && 
            entry.intensiteitVoor !== null && entry.intensiteitNa !== null
        );

        if (!chartRelevantEntries || chartRelevantEntries.length === 0) {
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
            return;
        }

        document.getElementById('chart-empty').style.display = 'none';
        document.getElementById('chart-legend').style.display = 'block';

        try {
            if (!window.Chart) {
                log('INFO', 'Loading Chart.js...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.async = false;
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = () => { log('SUCCESS', 'Chart.js loaded.'); resolve(); };
                    script.onerror = () => { log('ERROR', 'Failed to load Chart.js'); reject(new Error('Chart.js failed to load.')); };
                });
            }

            const recentEntries = chartRelevantEntries.slice(0, 10).reverse();

            const labels = recentEntries.map((entry, index) => {
                const date = entry.timestamp;
                const shortDate = date.toLocaleDateString('nl-BE', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: window.innerWidth <= 768 ? undefined : '2-digit',
                    minute: window.innerWidth <= 768 ? undefined : '2-digit'
                });
                return window.innerWidth <= 768 ? `${index + 1}` : shortDate;
            });

            const beforeData = recentEntries.map(entry => entry.intensiteitVoor);
            const afterData = recentEntries.map(entry => entry.intensiteitNa);

            if (progressChart) {
                progressChart.destroy();
            }

            const ctx = document.getElementById('progress-chart').getContext('2d');
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'V√≥√≥r oefening',
                            data: beforeData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: window.innerWidth <= 768 ? 2 : 3,
                            pointRadius: window.innerWidth <= 768 ? 4 : 5,
                            pointHoverRadius: window.innerWidth <= 768 ? 6 : 8,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'N√° oefening',
                            data: afterData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: window.innerWidth <= 768 ? 2 : 3,
                            pointRadius: window.innerWidth <= 768 ? 4 : 5,
                            pointHoverRadius: window.innerWidth <= 768 ? 6 : 8,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const entry = recentEntries[index];
                                    const date = entry.timestamp;
                                    return date.toLocaleDateString('nl-BE', { 
                                        weekday: 'short',
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const entry = recentEntries[index];
                                    let result = [
                                        '',
                                        `Techniek: ${entry.techniekGebruikt}`,
                                        `Resultaat: ${getResultaatText(entry.resultaat)}`
                                    ];
                                    
                                    if (entry.cpScore) {
                                        result.push(`CP Score: ${entry.cpScore} sec`);
                                    }
                                    
                                    return result;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: window.innerWidth <= 768 ? 5 : 8
                            },
                            title: {
                                display: window.innerWidth > 768,
                                text: 'Sessies (meest recente)',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                }
                            }
                        },
                        y: {
                            min: 0,
                            max: 10,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                stepSize: 1,
                                callback: function(value) {
                                    return value + '/10';
                                }
                            },
                            title: {
                                display: window.innerWidth > 768,
                                text: 'Intensiteit Score',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'normal'
                                }
                            }
                        }
                    }
                }
            });

            log('SUCCESS', `Progress chart created with ${recentEntries.length} data points`);
        } catch (error) {
            log('ERROR', 'Failed to create chart:', error);
            document.getElementById('chart-empty').style.display = 'block';
            document.getElementById('chart-legend').style.display = 'none';
        }
    }

    // Comprehensive event listener setup
    function setupEventListeners() {
        log('INFO', 'Setting up event listeners...');
        
        // Google login button
        const googleLoginBtn = document.getElementById('google-login-btn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                log('INFO', 'Google login button clicked!');
                signInWithGoogle();
            });
            log('SUCCESS', 'Google login button event listener attached');
        } else {
            log('ERROR', 'Google login button not found!');
        }

        // Register modal buttons
        const showRegisterBtn = document.getElementById('show-register-btn');
        if (showRegisterBtn) {
            showRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterForm();
            });
        }

        const closeRegisterBtn = document.getElementById('close-register-btn');
        if (closeRegisterBtn) {
            closeRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeRegisterModal();
            });
        }

        const cancelRegisterBtn = document.getElementById('cancel-register-btn');
        if (cancelRegisterBtn) {
            cancelRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeRegisterModal();
            });
        }

        // Tip refresh button
        const tipRefreshBtn = document.getElementById('tip-refresh-btn');
        if (tipRefreshBtn) {
            tipRefreshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                getNewTip();
            });
            log('SUCCESS', 'Tip refresh button event listener attached');
        } else {
            log('WARNING', 'Tip refresh button not found');
        }

        // Modal close on background click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Dagboek modal buttons
        const saveDagboekBtn = document.getElementById('save-dagboek-entry-btn');
        if (saveDagboekBtn) {
            saveDagboekBtn.addEventListener('click', saveDagboekEntry);
        }

        // EMDR Audio control event listeners - Enhanced for live updates
        const volumeControl = document.getElementById('audio-volume');
        if (volumeControl) {
            volumeControl.addEventListener('input', updateAudioVolume);
        }

        const frequencyControl = document.getElementById('audio-frequency');
        if (frequencyControl) {
            frequencyControl.addEventListener('input', updateAudioFrequency);
        }

        // Eye movement controls
        const eyeSpeedControl = document.getElementById('eye-speed');
        if (eyeSpeedControl) {
            eyeSpeedControl.addEventListener('change', function() {
                if (isEyeMovementActive) {
                    updateEyeMovementPattern();
                }
            });
        }

        const eyePatternControl = document.getElementById('eye-pattern');
        if (eyePatternControl) {
            eyePatternControl.addEventListener('change', function() {
                if (isEyeMovementActive) {
                    updateEyeMovementPattern();
                }
            });
        }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async function() {
        log('INFO', 'Starting Ademruimte app initialization');
        
        // Initial UI setup before Firebase is ready
        appState.updateConnectionDisplay();
        appState.updateUI();

        // Initialize general components with individual error handling
        try {
            setupForms();
            log('SUCCESS', 'Forms initialized');
        } catch (error) {
            log('WARNING', 'Forms setup failed:', error);
        }

        try {
            setupNetworkMonitoring();
            log('SUCCESS', 'Network monitoring initialized');
        } catch (error) {
            log('WARNING', 'Network monitoring setup failed:', error);
        }

        try {
            setupKeyboardNavigation();
            log('SUCCESS', 'Keyboard navigation initialized');
        } catch (error) {
            log('WARNING', 'Keyboard navigation setup failed:', error);
        }

        try {
            setupRangeSliders();
            log('SUCCESS', 'Range sliders initialized');
        } catch (error) {
            log('WARNING', 'Range sliders setup failed:', error);
        }

        try {
            setupMobileFocusHandling();
            log('SUCCESS', 'Mobile focus handling initialized');
        } catch (error) {
            log('WARNING', 'Mobile focus handling setup failed:', error);
        }

        try {
            setRandomTip();
            log('SUCCESS', 'Random tip set');
        } catch (error) {
            log('WARNING', 'Random tip setup failed:', error);
        }
        
        // Load progress data (from localStorage or default)
        try {
            loadProgressData();
            log('SUCCESS', 'Progress data loaded');
        } catch (error) {
            log('WARNING', 'Progress data loading failed:', error);
        }
        
        // Initialize tab displays
        try {
            updateBreathDisplay();
            updateRitualDisplay();
            updateEmdrDisplay();
            log('SUCCESS', 'Tab displays initialized');
        } catch (error) {
            log('WARNING', 'Tab displays setup failed:', error);
        }
        
        // Setup tab navigation
        try {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    showTab(tab);
                });
            });
            log('SUCCESS', 'Tab navigation initialized');
        } catch (error) {
            log('WARNING', 'Tab navigation setup failed:', error);
        }
        
        // Setup all event listeners
        try {
            setupEventListeners();
            log('SUCCESS', 'Event listeners initialized');
        } catch (error) {
            log('WARNING', 'Event listeners setup failed:', error);
        }

        // Chart responsiveness - redraw on window resize
        try {
            window.addEventListener('resize', () => {
                if (progressChart && appState.currentTab === 'dagboek') {
                    setTimeout(() => {
                        progressChart.resize();
                    }, 100);
                }
            });
            log('SUCCESS', 'Chart responsiveness initialized');
        } catch (error) {
            log('WARNING', 'Chart responsiveness setup failed:', error);
        }
        
        // Initialize Firebase - this is the only truly critical part
        try {
            log('INFO', 'Attempting Firebase initialization...');
            const success = await initializeFirebase();
            
            if (!success) {
                log('WARNING', 'Firebase initialization failed during DOMContentLoaded. Showing login screen.');
                showLoginScreen();
            }
            
            log('SUCCESS', 'App initialization completed successfully');
            
        } catch (error) {
            log('ERROR', 'Firebase initialization failed:', error);
            
            // Hide loading spinner
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'none';
            }
            
            // Only show critical error for Firebase failures
            showUserMessage('Verbinding met de server mislukt. Controleer je internetverbinding en herlaad de pagina.', 'error');
            showLoginScreen();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (isAudioPlaying) stopBilateralAudio();
        if (isEyeMovementActive) stopEyeMovements();
        if (isFullscreenMode) toggleFullscreenEMDR();
        if (cpIsRunning) stopCPMeasurement();
        if (wakeLock) releaseWakeLock();
        if (audioWakeLock) releaseAudioWakeLock();
        if (timerInterval) clearInterval(timerInterval);
        if (breathInterval) clearInterval(breathInterval);
        if (progressChart) progressChart.destroy();
        
        // Clean up Firebase subscriptions
        appState.cleanup();
        
        log('INFO', 'App shutting down');
    });
</script>

</body>
</html>
