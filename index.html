<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Chart.js voor statistieken -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
        --buteyko-primary: #06b6d4;
        --buteyko-secondary: #0891b2;
        --success-gradient: linear-gradient(135deg, #10b981, #059669);
        --warning-gradient: linear-gradient(135deg, #f59e0b, #d97706);
        --danger-gradient: linear-gradient(135deg, #ef4444, #dc2626);
        --primary-color: #06b6d4;
    }

    /* Reset en basis styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:before, *:after {
        box-sizing: border-box;
    }

    html {
        border: none;
        outline: none;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    .hidden { display: none !important; }
    
    /* Container */
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    .header-title h1 {
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-title p {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        opacity: 0.9;
        font-weight: 400;
    }

    .user-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 0.9rem;
        min-height: 44px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .logout-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.85rem;
        transition: var(--transition-base);
    }

    .logout-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Navigation Tabs */
    .nav-tabs {
        background: rgba(255,255,255,0.1);
        padding: 1rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .tab-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
        white-space: nowrap;
    }

    .tab-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: translateY(-1px);
    }

    .tab-btn.active {
        background: rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        font-weight: 600;
    }

    /* Cards */
    .card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        position: relative;
        overflow: hidden;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.3);
    }

    .btn-primary.active {
        background: linear-gradient(135deg, #0891b2, #0e7490);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        transform: none;
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-warning {
        background: var(--warning-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-warning:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-danger {
        background: var(--danger-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
    }

    .btn-orange {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-orange:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(234, 88, 12, 0.3);
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition-base);
        background: white;
        min-height: var(--touch-target);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    select.form-control {
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    /* Range Slider */
    .range-container {
        position: relative;
        margin: 1rem 0;
    }

    .range-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        outline: none;
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    .range-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
    }

    .range-value {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .stat-card {
        background: rgba(255,255,255,0.5);
        padding: 1.5rem 1rem;
        border-radius: var(--border-radius);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        transition: var(--transition-base);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-light);
        font-weight: 500;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Breathing Circle */
    .breathing-circle {
        width: 200px;
        height: 200px;
        border: 4px solid var(--primary-color);
        border-radius: 50%;
        margin: 2rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
        position: relative;
        background: rgba(6, 182, 212, 0.1);
        transform: scale(1);
        text-align: center;
        line-height: 1.2;
        padding: 1rem;
        box-sizing: border-box;
    }

    .breathing-circle.inhale {
        background: rgba(6, 182, 212, 0.2);
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
    }

    .breathing-circle.exhale {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
        color: #10b981;
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
    }

    .breathing-circle.hold {
        background: rgba(245, 158, 11, 0.2);
        border-color: #f59e0b;
        color: #f59e0b;
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.4);
    }

    /* CP Measurement */
    .cp-display {
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        color: var(--primary-color);
        margin: 1rem 0;
        font-family: 'Monaco', 'Menlo', monospace;
    }

    .cp-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    /* Progress Chart */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 2rem 0;
        background: rgba(255,255,255,0.1);
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    /* Messages */
    .message {
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        animation: slideInDown 0.3s ease;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 350px;
        box-shadow: var(--shadow-md);
    }

    .message.success {
        background: rgba(16, 185, 129, 0.9);
        color: white;
        border: 1px solid #059669;
    }

    .message.warning {
        background: rgba(245, 158, 11, 0.9);
        color: white;
        border: 1px solid #d97706;
    }

    .message.danger, .message.error {
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: 1px solid #dc2626;
    }

    .message.info {
        background: rgba(6, 182, 212, 0.9);
        color: white;
        border: 1px solid #0891b2;
    }

    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Loading States */
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--card-background);
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-md);
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 1rem;
        top: 1rem;
    }

    .close:hover {
        color: #000;
    }

    /* Button Groups */
    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .container {
            padding: 0.5rem;
        }
        
        .card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .user-info {
            position: static;
            justify-content: center;
            margin-bottom: 1rem;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-tabs {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .tab-btn {
            width: 100%;
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            font-size: 1.25rem;
        }
        
        .cp-display {
            font-size: 2rem;
        }
        
        .message {
            position: relative;
            top: auto;
            right: auto;
            max-width: none;
            margin: 1rem 0;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        .button-group {
            flex-direction: column;
        }
    }

    /* Auth Screen Styles */
    #auth-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .auth-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        width: 100%;
        max-width: 400px;
        text-align: center;
    }

    .auth-card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
    }

    .auth-card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
    }

    /* Crisis Help Styles */
    .crisis-card {
        background: linear-gradient(135deg, #D23030, #D23030);
        color: white;
        border: none;
    }

    .crisis-card h3 {
        color: white;
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
    }

    .loading-text {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Status Indicators */
    .status-connected {
        background: #10b981 !important;
        box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    }

    .status-disconnected {
        background: #f59e0b !important;
        box-shadow: 0 0 6px rgba(245, 158, 11, 0.5);
    }

    .status-error {
        background: #ef4444 !important;
        box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
    }

    /* Symptom Checkboxes */
    .symptom-checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .symptom-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: var(--transition-base);
        background: rgba(255,255,255,0.5);
    }

    .symptom-checkbox-item:hover {
        background: rgba(6, 182, 212, 0.1);
    }

    .symptom-checkbox-item.selected {
        background: rgba(6, 182, 212, 0.2);
        border: 1px solid var(--primary-color);
    }

    .symptom-checkbox {
        margin-right: 0.5rem;
    }
</style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="auth-loading" class="hidden">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; color: white;">
            <div style="text-align: center;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p class="loading-text">Ademruimte wordt geladen...</p>
            </div>
        </div>
    </div>

    <div id="g_id_onload"
    data-client_id="744941871331-bdj0it4hic5kghtumutk5i6djctn9rht.apps.googleusercontent.com"
    data-callback="handleCredentialResponse">
</div>
<div class="g_id_signin"
    data-type="standard">
</div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-card">
            <h2>Welkom bij Ademruimte</h2>
            <p>Log in om je persoonlijke ademhalingsreis te beginnen</p>
            
            <div class="button-group">
                <button class="btn btn-primary" id="google-login">
                    <span>🔑 Inloggen met Google</span>
                </button>
            </div>
            
            <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                Nieuw hier? 
                <button id="show-register" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Registreren</button>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header>
            <div class="user-info" id="user-info">
                <div class="spinner"></div>
            </div>
            <!-- Voeg deze CSS toe in je <style> sectie -->
<style>
    /* Logo container styling - voeg dit toe aan je bestaande CSS */
    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .logo-svg {
        height: clamp(80px, 10vw, 100px);
        width: auto;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    /* Eventueel aanpassen van bestaande header styling */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
</style>

<!-- In je header HTML, vervang de <div class="header-title"> door dit: -->
<div class="logo-container">
    <svg viewBox="0 0 320 100" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
      <defs>
        <!-- Breathing gradient - matches app colors -->
        <radialGradient id="breathingCenter" cx="50%" cy="50%" r="50%">
          <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9">
            <animate attributeName="stop-opacity" values="0.9;0.4;0.9" dur="4s" repeatCount="indefinite"/>
          </stop>
          <stop offset="30%" style="stop-color:#10b981;stop-opacity:0.7">
            <animate attributeName="stop-opacity" values="0.7;0.3;0.7" dur="4s" repeatCount="indefinite"/>
          </stop>
          <stop offset="70%" style="stop-color:#06b6d4;stop-opacity:0.5">
            <animate attributeName="stop-opacity" values="0.5;0.2;0.5" dur="4s" repeatCount="indefinite"/>
          </stop>
          <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.3">
            <animate attributeName="stop-opacity" values="0.3;0.1;0.3" dur="4s" repeatCount="indefinite"/>
          </stop>
        </radialGradient>
        
        <!-- Text gradient -->
        <linearGradient id="textGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#ffffff"/>
          <stop offset="50%" style="stop-color:#f0f9ff"/>
          <stop offset="100%" style="stop-color:#e0f2fe"/>
        </linearGradient>
        
        <!-- Subtle shadow for depth -->
        <filter id="softGlow">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/> 
          </feMerge>
        </filter>
      </defs>
      
      <!-- Main breathing circle - represents lungs/breath -->
      <circle cx="50" cy="50" r="35" fill="url(#breathingCenter)" opacity="0.4">
        <animate attributeName="r" values="35;42;35" dur="4s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0.4;0.7;0.4" dur="4s" repeatCount="indefinite"/>
      </circle>
      
      <!-- Inner breathing ring -->
      <circle cx="50" cy="50" r="20" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1">
        <animate attributeName="r" values="20;25;20" dur="4s" repeatCount="indefinite"/>
        <animate attributeName="stroke-opacity" values="0.6;0.9;0.6" dur="4s" repeatCount="indefinite"/>
      </circle>
      
      <!-- Floating breath particles - slow, calming movement -->
      <g opacity="0.8">
        <circle cx="25" cy="25" r="2" fill="#ffffff">
          <animateTransform attributeName="transform" type="translate" values="0,0; 2,3; 0,0" dur="6s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.8;0.4;0.8" dur="6s" repeatCount="indefinite"/>
        </circle>
        
        <circle cx="75" cy="30" r="1.5" fill="#10b981">
          <animateTransform attributeName="transform" type="translate" values="0,0; -1,2; 0,0" dur="5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.7;0.3;0.7" dur="5s" repeatCount="indefinite"/>
        </circle>
        
        <circle cx="30" cy="75" r="1.8" fill="#06b6d4">
          <animateTransform attributeName="transform" type="translate" values="0,0; 3,-1; 0,0" dur="7s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.6;0.9;0.6" dur="7s" repeatCount="indefinite"/>
        </circle>
        
        <circle cx="70" cy="70" r="2.2" fill="rgba(255,255,255,0.8)">
          <animateTransform attributeName="transform" type="translate" values="0,0; -2,-2; 0,0" dur="5.5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.8;0.3;0.8" dur="5.5s" repeatCount="indefinite"/>
        </circle>
      </g>
      
      <!-- Wave lines representing breath flow -->
      <g stroke="rgba(255,255,255,0.5)" stroke-width="1.5" fill="none" opacity="0.7">
        <path d="M 15 45 Q 25 40 35 45 Q 45 50 55 45" stroke-dasharray="2,4">
          <animate attributeName="opacity" values="0.7;0.3;0.7" dur="3s" repeatCount="indefinite"/>
          <animateTransform attributeName="transform" type="translate" values="0,0; 5,0; 0,0" dur="3s" repeatCount="indefinite"/>
        </path>
        
        <path d="M 15 55 Q 25 60 35 55 Q 45 50 55 55" stroke-dasharray="3,3">
          <animate attributeName="opacity" values="0.5;0.8;0.5" dur="3.5s" repeatCount="indefinite"/>
          <animateTransform attributeName="transform" type="translate" values="0,0; -3,0; 0,0" dur="3.5s" repeatCount="indefinite"/>
        </path>
      </g>
      
      <!-- Main text -->
      <text x="110" y="45" font-family="system-ui, -apple-system, sans-serif" font-size="24" font-weight="300" fill="url(#textGrad)" filter="url(#softGlow)">
        ademruimte
      </text>
      
      <!-- Subtitle -->
      <text x="110" y="65" font-family="system-ui, -apple-system, sans-serif" font-size="11" fill="rgba(255,255,255,0.85)">
        your safe breathing space
      </text>
      
      <!-- Accent dots with synchronized breathing -->
      <g opacity="0.6">
        <circle cx="290" cy="25" r="2.5" fill="rgba(255,255,255,0.9)">
          <animate attributeName="cy" values="25;22;25" dur="4s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.6;1;0.6" dur="4s" repeatCount="indefinite"/>
        </circle>
        
        <circle cx="300" cy="40" r="2" fill="#10b981">
          <animate attributeName="cy" values="40;37;40" dur="4s" begin="1s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.7;1;0.7" dur="4s" begin="1s" repeatCount="indefinite"/>
        </circle>
        
        <circle cx="295" cy="60" r="2.2" fill="#06b6d4">
          <animate attributeName="cy" values="60;57;60" dur="4s" begin="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.5;0.9;0.5" dur="4s" begin="2s" repeatCount="indefinite"/>
        </circle>
      </g>
      
      <!-- Subtle pulsing outline -->
      <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="0.5">
        <animate attributeName="r" values="45;48;45" dur="8s" repeatCount="indefinite"/>
        <animate attributeName="stroke-opacity" values="0.2;0.4;0.2" dur="8s" repeatCount="indefinite"/>
      </circle>
  </svg>
</div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="buteyko">💨 Buteyko</button>
            <button class="tab-btn" data-tab="dagboek">📊 Dagboek</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis Hulp</button>
        </nav>

        <main class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 id="dashboard-greeting">Welkom bij Ademruimte</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Op basis van wetenschappelijk onderzoek biedt Ademruimte effectieve hulp bij hyperventilatie en gerelateerde maagklachten. 
                        <strong>70-80% van de patiënten</strong> behaalt significante verbetering met de juiste technieken.
                    </p>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">-</div>
                            <div class="stat-label">Gem. verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="last-cp">-</div>
                            <div class="stat-label">Laatste CP</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>🎯 Slimme Inzichten</h3>
                    <div id="insights-content">
                        <p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>
                    </div>
                </div>

                <div class="card">
                    <h3>💡 Tip van de dag</h3>
                    <div id="tip-content">
                        <p>Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.</p>
                    </div>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content">
                <div class="card">
                    <h2>💨 Buteyko Ademhaling</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        De Buteyko methode helpt je CO2-tolerantie te verbeteren en hyperventilatie te reduceren.
                    </p>

                    <!-- Control Pause Measurement -->
                    <div class="card" style="background: rgba(6, 182, 212, 0.1); border: 2px solid rgba(6, 182, 212, 0.2);">
                        <h3>⏱️ Control Pause (CP) Meting</h3>
                        <p style="margin-bottom: 1rem;">Meet je CO2-tolerantie. Normale waarden: 20-40 seconden.</p>
                        
                        <div class="cp-display" id="cp-timer">00</div>
                        
                        <div class="cp-controls">
                            <button class="btn btn-primary" id="start-cp" onclick="startCPMeasurement()">Start CP Meting</button>
                            <button class="btn btn-danger" id="stop-cp" onclick="stopCPMeasurement()" disabled>Stop</button>
                            <button class="btn btn-warning" id="reset-cp" onclick="resetCPMeasurement()">Reset</button>
                        </div>
                        
                        <div id="cp-instructions" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 0.5rem;">
                            <strong>Instructies:</strong>
                            <ol style="margin-top: 0.5rem;">
                                <li>Adem normaal in en uit</li>
                                <li>Na een normale uitademing, houd je adem in</li>
                                <li>Klik "Start CP Meting" en stop zodra je de eerste drang voelt om te ademen</li>
                                <li>Dit is je Control Pause score</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Breathing Exercise -->
                    <div class="card">
                        <h3>🫁 Ademhalingsoefening</h3>
                        
                        <div class="form-group">
                            <label for="breathing-pattern">Selecteer patroon:</label>
                            <select class="form-control" id="breathing-pattern" onchange="updateBreathingPattern()">
                                <option value="gentle" selected>Mini breath holds</option>
                                <option value="standard">4-7-8 Standaard</option>
                                <option value="advanced">6-8-10 Gevorderd</option>
                            </select>
                        </div>

                        <div class="breathing-circle" id="breathing-circle">
                            Bereid je voor
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" id="start-breathing" onclick="startBreathing()">Start Oefening</button>
                            <button class="btn btn-danger" id="stop-breathing" onclick="stopBreathing()" disabled>Stop</button>
                        </div>

                        <div id="breathing-info" style="text-align: center; margin-top: 1rem;">
                            <p><strong>Cyclus:</strong> <span id="cycle-count">0</span> <span id="cycle-target">van 20 (zachte oefening)</span></p>
                            <p><strong>Fase:</strong> <span id="current-phase">Rust</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content">
                <div class="card">
                    <h2>📊 Dagboek & Statistieken</h2>
                    
                    <div class="button-group" style="margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="openJournalModal()">📝 Nieuwe Entry</button>
                        <button class="btn btn-success" onclick="exportDagboek()">💾 Exporteer</button>
                    </div>

                    <div class="form-group">
                        <label for="journal-filter">Filter dagboek entries:</label>
                        <select class="form-control" id="journal-filter" onchange="filterJournalEntries()">
                            <option value="last7" selected>Laatste 7 dagen</option>
                            <option value="last30">Laatste 30 dagen</option>
                            <option value="all">Alle entries</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">📈 Statistiek periode:</label>
                        <div class="button-group">
                            <button class="btn btn-primary" id="chart-30days" onclick="updateChartFilter('30days')">Laatste 30 dagen</button>
                            <button class="btn btn-primary" id="chart-all" onclick="updateChartFilter('all')">Alle data</button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>

                    <div id="journal-entries">
                        <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                            <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crisis Help Tab -->
            <div id="crisis" class="tab-content">
                <div class="card crisis-card">
                    <h2>🚨 Crisis Hulp</h2>
                    <p style="margin-bottom: 2rem;">Directe hulp bij acute hyperventilatie of paniekaanvallen.</p>

                    <div class="button-group">
                        <button class="btn btn-warning" onclick="startCrisisBreathing()">🫁 Nood Ademhaling</button>
                    </div>

                    <div id="crisis-breathing" class="hidden" style="margin-top: 2rem;">
                        <div class="breathing-circle" id="crisis-circle">
                            Volg de cirkel
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-danger" onclick="stopCrisisBreathing()">Stop</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>📞 Noodhulp</h3>
                    <p><strong>Bij acute noodsituaties:</strong></p>
                    <ul style="margin: 1rem 0;">
                        <li>🚑 Spoeddiensten: 112</li>
                        <li>🩺 Huisarts: Contacteer je eigen huisarts</li>
                        <li>🧠 Zelfmoordlijn: 1813 of 0800 32 123</li>
                        <li>💬 Tele-onthaal: 106</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journal-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJournalModal()">&times;</span>
            <h2>📝 Nieuwe Dagboek Entry</h2>
            
            <div class="form-group">
                <label for="entry-technique">Techniek gebruikt:</label>
                <select class="form-control" id="entry-technique">
                    <option value="Buteyko Ademhaling">Buteyko Ademhaling</option>
                    <option value="4-7-8 Ademhaling">4-7-8 Ademhaling</option>
                    <option value="Crisis Ademhaling">Crisis Ademhaling</option>
                    <option value="Handmatige Entry">Handmatige Entry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entry-trigger">Trigger/Oorzaak:</label>
                <input type="text" class="form-control" id="entry-trigger" placeholder="Wat triggerde de symptomen?">
            </div>

            <div class="form-group">
                <label for="entry-before">Intensiteit vóór (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-before" min="1" max="10" value="5" oninput="updateRangeValue('entry-before', 'before-value')">
                    <div class="range-value" id="before-value">5</div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-after">Intensiteit na (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-after" min="1" max="10" value="5" oninput="updateRangeValue('entry-after', 'after-value')">
                    <div class="range-value" id="after-value">5</div>
                </div>
            </div>

            <div class="form-group" id="cp-score-group" style="display: none;">
                <label for="entry-cp-score">CP Score (seconden):</label>
                <input type="number" class="form-control" id="entry-cp-score" min="1" max="120">
            </div>

            <div class="form-group">
                <label>Symptomen (selecteer van toepassing):</label>
                <div class="symptom-checkbox-container">
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Kortademigheid">
                        <label>Kortademigheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Maagpijn">
                        <label>Maagpijn</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Hartkloppingen">
                        <label>Hartkloppingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Duizeligheid">
                        <label>Duizeligheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Tintelingen">
                        <label>Tintelingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Angst">
                        <label>Angst</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-result">Resultaat:</label>
                <select class="form-control" id="entry-result">
                    <option value="">Selecteer resultaat</option>
                    <option value="Veel beter">Veel beter</option>
                    <option value="Beter">Beter</option>
                    <option value="Iets beter">Iets beter</option>
                    <option value="Geen verandering">Geen verandering</option>
                    <option value="Slechter">Slechter</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entry-notes">Notities:</label>
                <textarea class="form-control" id="entry-notes" placeholder="Extra opmerkingen..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="saveJournalEntry()">💾 Opslaan</button>
                <button class="btn btn-orange" onclick="closeJournalModal()">Annuleren</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: rgba(255,255,255,0.8); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">📞 In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <!-- Developer Credit -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8;">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script type="module">
    // Firebase configuration (exact same credentials)
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte.vercel.app", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Global variables
    let app, auth, db, currentUser = null;
    let currentTab = 'dashboard';
    let allJournalEntries = [];
    let allCPMeasurements = [];
    let progressChart = null;
    let chartFilter = 'all'; // New variable to track chart filter

    // Breathing exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 0;
    let breathingPattern = 'gentle';
    let isBreathing = false;

    // CP measurement variables
    let cpInterval = null;
    let cpStartTime = 0;
    let cpIsRunning = false;

    // Crisis variables
    let crisisInterval = null;

    // User stats
    let userStats = {
        totalSessions: 0,
        streakDays: 0,
        lastSessionDate: null,
        cpMeasurements: [],
        achievements: []
    };

    // Tips array
    const tips = [
        "Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.",
        "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
        "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
        "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
        "Een normale Control Pause is tussen de 20-40 seconden. Begin laag en bouw langzaam op.",
        "Regelmatige CP metingen helpen je voortgang te volgen en patronen te herkennen."
    ];

    // ============================================
    // FIREBASE INITIALIZATION & AUTH
    // ============================================

    function handleCredentialResponse(response) {
  // Decode the ID token to get the user's information.
  const idToken = response.credential;
  const decodedToken = jwt_decode(idToken); // Je hebt een JWT-bibliotheek nodig zoals jwt-decode
  console.log('Ingelogde gebruiker:', decodedToken);
  // Nu kun je de gebruikersinformatie gebruiken om de UI aan te passen.
  // Bijvoorbeeld: verander een "Inloggen"-knop in "Uitloggen".
  document.getElementById('profile-info').innerHTML = `
    <h3>Welkom, ${decodedToken.name}</h3>
    <img src="${decodedToken.picture}" alt="Profielafbeelding">
  `;
}
    async function initFirebase() {
        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getAuth, onAuthStateChanged, signInWithRedirect, GoogleAuthProvider, getRedirectResult } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Check for redirect result
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    console.log('Google sign-in successful:', result.user.email);
                }
            } catch (error) {
                console.log('Redirect result error:', error);
            }

            // Auth state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    updateUserInfo();
                    updateStatusIndicator('connected');
                    
                    // Load data immediately when user logs in
                    try {
                        await loadJournalEntries();
                        updateDashboard();
                        generateInsights();
                    } catch (error) {
                        console.error('Error loading data on login:', error);
                        showUserMessage('Gegevens laden mislukt, probeer te verversen', 'warning');
                    }
                } else {
                    currentUser = null;
                    showLoginScreen();
                    updateStatusIndicator('disconnected');
                }
            });

            return true;
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('Firebase kon niet worden geladen. Controleer je internetverbinding.', 'error');
            return false;
        }
    }

    // ============================================
    // UI STATE MANAGEMENT
    // ============================================

    function showMainApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function showLoginScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
    }

    function showLoadingScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.remove('hidden');
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        if (currentUser) {
            const displayName = currentUser.displayName || currentUser.email || 'Gebruiker';
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            
            userInfo.innerHTML = `
                <div class="user-avatar">${initials}</div>
                <button class="logout-btn" onclick="logout()">Uitloggen</button>
            `;
        } else {
            userInfo.innerHTML = '<div class="spinner"></div>';
        }
    }

    function updateStatusIndicator(status) {
        const dot = document.getElementById('firebase-status-dot');
        if (dot) {
            dot.className = `status-${status}`;
        }
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================

    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active to selected button
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        currentTab = tabName;
        
        // Load data based on tab
        if (tabName === 'dagboek') {
            createProgressChart();
            // Set default active state for chart filter
            setTimeout(() => {
                document.getElementById('chart-all').classList.add('active');
            }, 100);
        }
    }

    // ============================================
    // AUTHENTICATION
    // ============================================

    window.loginWithGoogle = async function() {
        try {
            const { GoogleAuthProvider, signInWithRedirect } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const provider = new GoogleAuthProvider();
            await signInWithRedirect(auth, provider);
        } catch (error) {
            console.error('Google login error:', error);
            showUserMessage('Inloggen mislukt: ' + error.message, 'error');
        }
    };

    window.logout = async function() {
        try {
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signOut(auth);
            showUserMessage('Je bent uitgelogd', 'info');
        } catch (error) {
            console.error('Logout error:', error);
            showUserMessage('Uitloggen mislukt', 'error');
        }
    };

    // ============================================
    // BUTEYKO FUNCTIONS
    // ============================================

    window.startCPMeasurement = function() {
        if (cpIsRunning) return;
        
        cpStartTime = Date.now();
        cpIsRunning = true;
        
        document.getElementById('start-cp').disabled = true;
        document.getElementById('stop-cp').disabled = false;
        
        cpInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - cpStartTime) / 1000);
            document.getElementById('cp-timer').textContent = elapsed.toString().padStart(2, '0');
        }, 1000);
    };

    window.stopCPMeasurement = function() {
        if (!cpIsRunning) return;
        
        clearInterval(cpInterval);
        const cpScore = Math.floor((Date.now() - cpStartTime) / 1000);
        
        cpIsRunning = false;
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
        
        // Save CP measurement
        const cpMeasurement = {
            score: cpScore,
            timestamp: new Date(),
            userId: currentUser?.uid,
            userEmail: currentUser?.email
        };
        
        allCPMeasurements.push(cpMeasurement);
        userStats.cpMeasurements.push(cpMeasurement);
        
        // Save to Firebase
        if (currentUser) {
            saveCPMeasurement(cpMeasurement);
        }
        
        updateDashboard();
        showUserMessage(`CP Score: ${cpScore} seconden geregistreerd!`, 'success');
    };

    window.resetCPMeasurement = function() {
        clearInterval(cpInterval);
        cpIsRunning = false;
        
        document.getElementById('cp-timer').textContent = '00';
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
    };

    async function saveCPMeasurement(measurement) {
        try {
            const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            await addDoc(collection(db, "cpMeasurements"), measurement);
        } catch (error) {
            console.error('Save CP error:', error);
        }
    }

    // ============================================
    // BREATHING EXERCISES
    // ============================================

    const breathingPatterns = {
        gentle: { freeBreathing: 10, hold: 3, cycles: 20, description: "10 sec vrij ademhalen (2x in/uit) + 3 sec vasthouden" },
        standard: { inhale: 4, hold: 7, exhale: 8, cycles: 10, description: "4-7-8 standaard patroon" },
        advanced: { inhale: 6, hold: 8, exhale: 10, cycles: 10, description: "6-8-10 gevorderd patroon" }
    };

    window.updateBreathingPattern = function() {
        breathingPattern = document.getElementById('breathing-pattern').value;
        const pattern = breathingPatterns[breathingPattern];
        const targetElement = document.getElementById('cycle-target');
        
        if (targetElement) {
            if (breathingPattern === 'gentle') {
                targetElement.textContent = 'van 20 (zachte oefening)';
            } else {
                targetElement.textContent = `van ${pattern.cycles || 10}`;
            }
        }
    };

    window.startBreathing = function() {
        if (isBreathing) return;
        
        isBreathing = true;
        breathCycleCount = 0;
        breathPhase = 'prepare';
        
        const circle = document.getElementById('breathing-circle');
        const pattern = breathingPatterns[breathingPattern];
        
        document.getElementById('start-breathing').disabled = true;
        document.getElementById('stop-breathing').disabled = false;
        document.getElementById('cycle-count').textContent = '0';
        
        // Preparation phase
        circle.textContent = "Bereid je voor...";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        setTimeout(() => {
            if (!isBreathing) return;
            startBreathingCycle(pattern);
        }, 2000);
    };

    function startBreathingCycle(pattern) {
        if (!isBreathing) return;
        
        const circle = document.getElementById('breathing-circle');
        let phaseTime = 0;
        let currentPhase = breathingPattern === 'gentle' ? 'freeBreathing' : 'inhale';
        let completedCycles = 0;
        let totalCycles = pattern.cycles || 10;
        
        breathInterval = setInterval(() => {
            if (!isBreathing) return;
            
            phaseTime++;
            
            switch(currentPhase) {
                case 'freeBreathing':
                    circle.textContent = `Adem vrij (2x in/uit) - ${phaseTime}s`;
                    circle.className = "breathing-circle";
                    document.getElementById('current-phase').textContent = 'Vrij ademhalen';
                    
                    // Subtle breathing animation - gentle pulsing
                    const breathingPhase = Math.sin((phaseTime * Math.PI * 4) / 10); // 4 breaths in 10 seconds
                    const gentleScale = 1 + (0.1 * breathingPhase);
                    circle.style.transform = `scale(${gentleScale})`;
                    
                    if (phaseTime >= (pattern.freeBreathing || 10)) {
                        phaseTime = 0;
                        currentPhase = 'hold';
                    }
                    break;
                    
                case 'inhale':
                    circle.textContent = `Inademen (${phaseTime})`;
                    circle.className = "breathing-circle inhale";
                    document.getElementById('current-phase').textContent = 'Inademen';
                    
                    // Smooth scaling animation
                    const inhaleProgress = phaseTime / pattern.inhale;
                    const inhaleScale = 1 + (0.2 * Math.min(inhaleProgress, 1));
                    circle.style.transform = `scale(${inhaleScale})`;
                    
                    if (phaseTime >= pattern.inhale) {
                        phaseTime = 0;
                        currentPhase = pattern.hold > 0 ? 'hold' : 'exhale';
                    }
                    break;
                    
                case 'hold':
                    if (breathingPattern === 'gentle') {
                        circle.textContent = `Vasthouden (${phaseTime})`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.1)';
                    } else {
                        circle.textContent = `Vasthouden (${phaseTime})`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.2)';
                    }
                    
                    const holdDuration = breathingPattern === 'gentle' ? pattern.hold : pattern.hold;
                    if (phaseTime >= holdDuration) {
                        phaseTime = 0;
                        
                        if (breathingPattern === 'gentle') {
                            // For gentle pattern, complete the cycle after hold
                            completedCycles++;
                            document.getElementById('cycle-count').textContent = completedCycles;
                            
                            if (completedCycles >= totalCycles) {
                                stopBreathing();
                                return;
                            } else {
                                currentPhase = 'freeBreathing';
                            }
                        } else {
                            currentPhase = 'exhale';
                        }
                    }
                    break;
                    
                case 'exhale':
                    circle.textContent = `Uitademen (${phaseTime})`;
                    circle.className = "breathing-circle exhale";
                    document.getElementById('current-phase').textContent = 'Uitademen';
                    
                    // Smooth scaling animation
                    const exhaleProgress = phaseTime / pattern.exhale;
                    const exhaleScale = 1.2 - (0.4 * Math.min(exhaleProgress, 1));
                    circle.style.transform = `scale(${exhaleScale})`;
                    
                    if (phaseTime >= pattern.exhale) {
                        phaseTime = 0;
                        completedCycles++;
                        document.getElementById('cycle-count').textContent = completedCycles;
                        
                        if (completedCycles >= totalCycles) {
                            stopBreathing();
                            return;
                        } else {
                            currentPhase = 'inhale';
                        }
                    }
                    break;
            }
        }, 1000);
    }

    window.stopBreathing = function() {
        isBreathing = false;
        clearInterval(breathInterval);
        
        const circle = document.getElementById('breathing-circle');
        circle.textContent = "Goed gedaan!";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        document.getElementById('start-breathing').disabled = false;
        document.getElementById('stop-breathing').disabled = true;
        document.getElementById('current-phase').textContent = 'Voltooid';
        
        // Update stats
        userStats.totalSessions++;
        updateStreak();
        
        // Get completed cycles from the display
        const completedCycles = parseInt(document.getElementById('cycle-count').textContent);
        const pattern = breathingPatterns[breathingPattern];
        const targetCycles = pattern.cycles || 10;
        
        // Auto-open journal modal if session completed
        if (completedCycles >= targetCycles) {
            setTimeout(() => {
                openJournalModal('Buteyko Ademhaling');
            }, 1000);
        }
        
        updateDashboard();
    };

    // ============================================
    // CRISIS HELP FUNCTIONS
    // ============================================

    window.startCrisisBreathing = function() {
        document.getElementById('crisis-breathing').classList.remove('hidden');
        
        const circle = document.getElementById('crisis-circle');
        let phase = 'inhale';
        let count = 0;
        
        crisisInterval = setInterval(() => {
            count++;
            
            if (phase === 'inhale') {
                circle.textContent = `Adem langzaam in (${count})`;
                circle.className = "breathing-circle inhale";
                
                // Smooth inhale animation
                const inhaleProgress = count / 4;
                const inhaleScale = 1 + (0.2 * Math.min(inhaleProgress, 1));
                circle.style.transform = `scale(${inhaleScale})`;
                
                if (count >= 4) {
                    count = 0;
                    phase = 'exhale';
                }
            } else {
                circle.textContent = `Adem langzaam uit (${count})`;
                circle.className = "breathing-circle exhale";
                
                // Smooth exhale animation
                const exhaleProgress = count / 6;
                const exhaleScale = 1.2 - (0.4 * Math.min(exhaleProgress, 1));
                circle.style.transform = `scale(${exhaleScale})`;
                
                if (count >= 6) {
                    count = 0;
                    phase = 'inhale';
                }
            }
        }, 1000);
    };

    window.stopCrisisBreathing = function() {
        clearInterval(crisisInterval);
        document.getElementById('crisis-breathing').classList.add('hidden');
        
        // Reset circle
        const circle = document.getElementById('crisis-circle');
        circle.style.transform = 'scale(1)';
        circle.className = "breathing-circle";
        
        // Auto-open journal modal
        setTimeout(() => {
            openJournalModal('Crisis Ademhaling');
        }, 500);
    };

    // ============================================
    // JOURNAL FUNCTIONS
    // ============================================

    window.openJournalModal = function(technique = '') {
        document.getElementById('journal-modal').style.display = 'block';
        
        if (technique) {
            document.getElementById('entry-technique').value = technique;
            
            // Show CP score field for Buteyko
            if (technique === 'Buteyko Ademhaling') {
                document.getElementById('cp-score-group').style.display = 'block';
            }
        }
        
        // Focus first input
        setTimeout(() => {
            document.getElementById('entry-technique').focus();
        }, 100);
    };

    window.closeJournalModal = function() {
        document.getElementById('journal-modal').style.display = 'none';
        
        // Reset form
        document.getElementById('entry-technique').selectedIndex = 0;
        document.getElementById('entry-trigger').value = '';
        document.getElementById('entry-before').value = '5';
        document.getElementById('entry-after').value = '5';
        document.getElementById('before-value').textContent = '5';
        document.getElementById('after-value').textContent = '5';
        document.getElementById('entry-result').selectedIndex = 0;
        document.getElementById('entry-notes').value = '';
        document.getElementById('entry-cp-score').value = '';
        document.getElementById('cp-score-group').style.display = 'none';
        
        // Reset symptom checkboxes
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    };

    window.saveJournalEntry = async function() {
        try {
            // Collect form data
            const symptoms = Array.from(document.querySelectorAll('.symptom-checkbox:checked'))
                                .map(cb => cb.dataset.symptom);
            
            const entry = {
                techniekGebruikt: document.getElementById('entry-technique').value,
                trigger: document.getElementById('entry-trigger').value,
                symptomen: symptoms,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                timestamp: new Date(),
                userId: currentUser?.uid,
                userEmail: currentUser?.email
            };

            // Add CP score if available
            const cpScore = document.getElementById('entry-cp-score').value;
            if (cpScore && !isNaN(parseInt(cpScore))) {
                entry.cpScore = parseInt(cpScore);
            }

            if (!entry.resultaat) {
                showUserMessage('Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            // Add to local array
            allJournalEntries.unshift(entry);
            
            // Save to Firebase
            if (currentUser) {
                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                await addDoc(collection(db, "dagboekEntries"), entry);
            }
            
            closeJournalModal();
            displayJournalEntries();
            updateDashboard();
            generateInsights();
            
            showUserMessage('✅ Dagboek entry opgeslagen!', 'success');
            
        } catch (error) {
            console.error('Save error:', error);
            showUserMessage('❌ Opslaan mislukt: ' + error.message, 'error');
        }
    };

    async function loadJournalEntries() {
        if (!currentUser) return;
        
        try {
            const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            // Load journal entries
            try {
                const journalQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const journalSnapshot = await getDocs(journalQuery);
                allJournalEntries = [];
                
                journalSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (orderError) {
                // Fallback without orderBy
                const simpleQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid)
                );
                
                const simpleSnapshot = await getDocs(simpleQuery);
                allJournalEntries = [];
                
                simpleSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // Sort manually
                allJournalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            // Load CP measurements
            try {
                const cpQuery = query(
                    collection(db, "cpMeasurements"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const cpSnapshot = await getDocs(cpQuery);
                allCPMeasurements = [];
                
                cpSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allCPMeasurements.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (cpError) {
                console.warn('CP measurements loading failed:', cpError);
                allCPMeasurements = [];
            }
            
            displayJournalEntries();
            generateInsights();
            createProgressChart();
            
            // Set default chart filter state
            if (currentTab === 'dagboek') {
                setTimeout(() => {
                    document.getElementById('chart-all').classList.add('active');
                }, 100);
            }
            
        } catch (error) {
            console.error('Load entries failed:', error);
            showUserMessage('❌ Laden van entries mislukt: ' + error.message, 'error');
        }
    }

    function displayJournalEntries() {
        const container = document.getElementById('journal-entries');
        
        if (allJournalEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                </div>
            `;
            return;
        }

        // Apply default filter (last 7 days) on first load
        const filterSelect = document.getElementById('journal-filter');
        const currentFilter = filterSelect ? filterSelect.value : 'last7';
        
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        switch(currentFilter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
            case 'all':
            default:
                filteredEntries = [...allJournalEntries];
                break;
        }

        if (filteredEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Geen entries gevonden voor de geselecteerde periode.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('journal-filter').value='all'; filterJournalEntries();">Toon alle entries</button>
                </div>
            `;
            return;
        }

        // Group entries by month for display
        const entriesByMonth = {};
        filteredEntries.forEach(entry => {
            const monthKey = entry.timestamp.toLocaleDateString('nl-BE', { 
                year: 'numeric', 
                month: 'long' 
            });
            
            if (!entriesByMonth[monthKey]) {
                entriesByMonth[monthKey] = [];
            }
            entriesByMonth[monthKey].push(entry);
        });

        let html = '';
        
        Object.keys(entriesByMonth).forEach(month => {
            const entries = entriesByMonth[month];
            
            html += `
                <div class="card">
                    <h3>📅 ${month}</h3>
                    <div style="display: grid; gap: 1rem;">
            `;
            
            entries.forEach(entry => {
                const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                const improvementColor = improvement > 0 ? '#10b981' : improvement < 0 ? '#ef4444' : '#6b7280';
                
                html += `
                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${improvementColor};">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <strong>${entry.techniekGebruikt}</strong>
                            <small style="color: var(--text-light);">${entry.timestamp.toLocaleDateString('nl-BE')}</small>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin: 0.5rem 0;">
                            <div><small>Voor: ${entry.intensiteitVoor}/10</small></div>
                            <div><small>Na: ${entry.intensiteitNa}/10</small></div>
                            <div><small>Verschil: ${improvement > 0 ? '+' : ''}${improvement}</small></div>
                            ${entry.cpScore ? `<div><small>CP: ${entry.cpScore}s</small></div>` : ''}
                        </div>
                        
                        ${entry.trigger ? `<div style="margin: 0.5rem 0;"><small><strong>Trigger:</strong> ${entry.trigger}</small></div>` : ''}
                        ${entry.symptomen && entry.symptomen.length ? `<div style="margin: 0.5rem 0;"><small><strong>Symptomen:</strong> ${entry.symptomen.join(', ')}</small></div>` : ''}
                        
                        <div style="margin: 0.5rem 0;">
                            <span style="background: ${improvementColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                ${entry.resultaat}
                            </span>
                        </div>
                        
                        ${entry.notities ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-light);"><small>${entry.notities}</small></div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    window.filterJournalEntries = function() {
        const filter = document.getElementById('journal-filter').value;
        let filteredEntries = [...allJournalEntries];
        
        const now = new Date();
        
        switch(filter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
        }
        
        // Update display with filtered entries
        const originalEntries = allJournalEntries;
        allJournalEntries = filteredEntries;
        displayJournalEntries();
        allJournalEntries = originalEntries;
    };

    window.exportDagboek = function() {
        let text = 'Ademruimte Dagboek Export\n';
        text += '==========================\n\n';
        
        allJournalEntries.forEach(entry => {
            text += `Datum: ${entry.timestamp.toLocaleString('nl-BE')}\n`;
            text += `Techniek: ${entry.techniekGebruikt}\n`;
            text += `Trigger: ${entry.trigger || 'Geen'}\n`;
            text += `Intensiteit vóór: ${entry.intensiteitVoor}/10\n`;
            text += `Intensiteit ná: ${entry.intensiteitNa}/10\n`;
            if (entry.cpScore) text += `CP Score: ${entry.cpScore} seconden\n`;
            if (entry.symptomen?.length) text += `Symptomen: ${entry.symptomen.join(', ')}\n`;
            text += `Resultaat: ${entry.resultaat}\n`;
            text += `Notities: ${entry.notities || 'Geen'}\n`;
            text += '\n---\n\n';
        });

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ademruimte-dagboek-${new Date().toLocaleDateString('nl-BE')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showUserMessage('📁 Dagboek geëxporteerd!', 'success');
    };

    // ============================================
    // DASHBOARD & STATISTICS
    // ============================================

    function updateDashboard() {
        if (!currentUser) return;
        
        // Update greeting
        const greeting = document.getElementById('dashboard-greeting');
        const hour = new Date().getHours();
        let timeGreeting = 'Goedemorgen';
        if (hour >= 12) timeGreeting = 'Goedemiddag';
        if (hour >= 18) timeGreeting = 'Goedenavond';
        
        const name = currentUser.displayName ? currentUser.displayName.split(' ')[0] : 'daar';
        greeting.textContent = `${timeGreeting}, ${name}!`;
        
        // Calculate stats
        const allCPData = [...userStats.cpMeasurements, ...allCPMeasurements]
            .filter(cp => cp.score !== undefined)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const avgImprovement = allJournalEntries.length > 0 ? 
            allJournalEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / allJournalEntries.length : 0;
        
        const lastCP = allCPData.length > 0 ? allCPData[0].score : null;
        
        // Update stats display
        document.getElementById('total-sessions').textContent = userStats.totalSessions + allJournalEntries.length;
        document.getElementById('streak-days').textContent = userStats.streakDays;
        document.getElementById('avg-improvement').textContent = avgImprovement > 0 ? 
            `+${avgImprovement.toFixed(1)}` : avgImprovement.toFixed(1);
        document.getElementById('last-cp').textContent = lastCP ? `${lastCP}s` : '-';
        
        // Update tip of the day
        const tipIndex = new Date().getDate() % tips.length;
        document.getElementById('tip-content').innerHTML = `<p>${tips[tipIndex]}</p>`;
    }

    function generateInsights() {
        const insightsContainer = document.getElementById('insights-content');
        
        if (allJournalEntries.length === 0) {
            insightsContainer.innerHTML = '<p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>';
            return;
        }
        
        let insights = [];
        
        // Technique effectiveness
        const techniqueStats = {};
        allJournalEntries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            if (!techniqueStats[technique]) {
                techniqueStats[technique] = { total: 0, improvement: 0 };
            }
            techniqueStats[technique].total++;
            techniqueStats[technique].improvement += (entry.intensiteitVoor - entry.intensiteitNa);
        });
        
        const bestTechnique = Object.keys(techniqueStats).reduce((best, technique) => {
            const avgImprovement = techniqueStats[technique].improvement / techniqueStats[technique].total;
            const bestAvg = techniqueStats[best] ? techniqueStats[best].improvement / techniqueStats[best].total : -999;
            return avgImprovement > bestAvg ? technique : best;
        });
        
        if (bestTechnique) {
            insights.push(`🏆 <strong>${bestTechnique}</strong> werkt het beste voor jou met gemiddeld ${(techniqueStats[bestTechnique].improvement / techniqueStats[bestTechnique].total).toFixed(1)} punten verbetering.`);
        }
        
        // Time pattern analysis
        const recentEntries = allJournalEntries.slice(0, 10);
        const avgRecent = recentEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / recentEntries.length;
        
        if (avgRecent > 2) {
            insights.push(`📈 Je laatste sessies tonen gemiddeld ${avgRecent.toFixed(1)} punten verbetering - je maakt goede vooruitgang!`);
        } else if (avgRecent < 1) {
            insights.push(`💡 Je laatste sessies tonen minder verbetering. Probeer een andere techniek of spreek met een professional.`);
        }
        
        // CP progression
        const cpData = allCPMeasurements.slice(0, 5);
        if (cpData.length >= 2) {
            const recent = cpData[0].score;
            const older = cpData[cpData.length - 1].score;
            const cpImprovement = recent - older;
            
            if (cpImprovement > 0) {
                insights.push(`💨 Je Control Pause is verbeterd met ${cpImprovement} seconden in je laatste metingen!`);
            }
        }
        
        if (insights.length === 0) {
            insights.push('📊 Blijf regelmatig oefenen om meer persoonlijke inzichten te ontdekken.');
        }
        
        insightsContainer.innerHTML = insights.map(insight => `<p>${insight}</p>`).join('');
    }

    function createProgressChart() {
        if (!currentUser || allJournalEntries.length === 0) return;
        
        const ctx = document.getElementById('progress-chart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (progressChart) {
            progressChart.destroy();
        }
        
        // Filter data based on current chart filter
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        if (chartFilter === '30days') {
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= thirtyDaysAgo);
        }
        
        // Sort by timestamp (oldest first for chart)
        filteredEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Take last 50 entries to keep chart readable
        const chartEntries = filteredEntries.slice(-50);
        
        // Prepare data with actual dates
        const chartData = chartEntries.map((entry) => ({
            date: entry.timestamp.toLocaleDateString('nl-BE', { 
                day: '2-digit', 
                month: '2-digit' 
            }),
            fullDate: entry.timestamp.toLocaleDateString('nl-BE'),
            voor: entry.intensiteitVoor,
            na: entry.intensiteitNa,
            verbetering: entry.intensiteitVoor - entry.intensiteitNa,
            technique: entry.techniekGebruikt
        }));
        
        progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => d.date),
                datasets: [
                    {
                        label: 'Voor sessie',
                        data: chartData.map(d => d.voor),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Na sessie',
                        data: chartData.map(d => d.na),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Verbetering',
                        data: chartData.map(d => d.verbetering),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        type: 'bar',
                        yAxisID: 'y1',
                        barThickness: 20
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartFilter === '30days' ? 'Voortgang Laatste 30 Dagen' : 'Voortgang Over Tijd',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return chartData[index].fullDate;
                            },
                            afterTitle: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return `Techniek: ${chartData[index].technique}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Datum'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Intensiteit (1-10)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Verbetering'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });
        
        // Update button active states
        document.getElementById('chart-30days').classList.remove('active');
        document.getElementById('chart-all').classList.remove('active');
        document.getElementById(`chart-${chartFilter}`).classList.add('active');
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function updateStreak() {
        const today = new Date().toDateString();
        
        if (userStats.lastSessionDate !== today) {
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (userStats.lastSessionDate === yesterday || !userStats.lastSessionDate) {
                userStats.streakDays = (userStats.streakDays || 0) + 1;
            } else {
                userStats.streakDays = 1;
            }
            
            userStats.lastSessionDate = today;
        }
    }

    window.updateChartFilter = function(filter) {
        chartFilter = filter;
        createProgressChart();
    };

    window.updateRangeValue = function(sliderId, valueId) {
        const slider = document.getElementById(sliderId);
        const valueElement = document.getElementById(valueId);
        valueElement.textContent = slider.value;
        
        // Update position of value indicator
        const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        valueElement.style.left = percent + '%';
    };

    window.toggleSymptom = function(element) {
        const checkbox = element.querySelector('.symptom-checkbox');
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('selected', checkbox.checked);
    };

    function showUserMessage(message, type = 'info') {
        // Remove existing messages
        document.querySelectorAll('.message').forEach(msg => msg.remove());
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.textContent = message;
        
        document.body.appendChild(messageEl);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            messageEl.remove();
        }, 5000);
    }

    // ============================================
    // EVENT LISTENERS & INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Initializing Ademruimte app...');
        
        showLoadingScreen();
        
        // Setup tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                showTab(tab);
            });
        });
        
        // Setup Google login
        document.getElementById('google-login').addEventListener('click', loginWithGoogle);
        
        // Setup range sliders
        document.getElementById('entry-before').addEventListener('input', (e) => {
            updateRangeValue('entry-before', 'before-value');
        });
        
        document.getElementById('entry-after').addEventListener('input', (e) => {
            updateRangeValue('entry-after', 'after-value');
        });
        
        // Setup technique selector for CP score field
        document.getElementById('entry-technique').addEventListener('change', (e) => {
            const cpGroup = document.getElementById('cp-score-group');
            if (e.target.value === 'Buteyko Ademhaling') {
                cpGroup.style.display = 'block';
            } else {
                cpGroup.style.display = 'none';
            }
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('journal-modal');
            if (e.target === modal) {
                closeJournalModal();
            }
        });
        
        // Initialize Firebase
        try {
            await initFirebase();
            console.log('✅ Ademruimte app initialization completed successfully');
        } catch (error) {
            console.error('❌ App initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('App initialisatie mislukt. Herlaad de pagina.', 'error');
            showLoginScreen();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (breathInterval) clearInterval(breathInterval);
        if (cpInterval) clearInterval(cpInterval);
        if (crisisInterval) clearInterval(crisisInterval);
        if (progressChart) progressChart.destroy();
    });

    console.log('📱 Ademruimte app loaded successfully');
</script>
</body>
</html>
