<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Chart.js voor statistieken -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
        --buteyko-primary: #06b6d4;
        --buteyko-secondary: #0891b2;
        --success-gradient: linear-gradient(135deg, #10b981, #059669);
        --warning-gradient: linear-gradient(135deg, #f59e0b, #d97706);
        --danger-gradient: linear-gradient(135deg, #ef4444, #dc2626);
        --primary-color: #06b6d4;
    }

    /* Reset en basis styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:before, *:after {
        box-sizing: border-box;
    }

    html {
        border: none;
        outline: none;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    .hidden { display: none !important; }
    
    /* Container */
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    .header-title h1 {
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-title p {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        opacity: 0.9;
        font-weight: 400;
    }

    .user-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 0.9rem;
        min-height: 44px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .logout-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.85rem;
        transition: var(--transition-base);
    }

    .logout-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Navigation Tabs */
    .nav-tabs {
        background: rgba(255,255,255,0.1);
        padding: 1rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .tab-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
        white-space: nowrap;
    }

    .tab-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: translateY(-1px);
    }

    .tab-btn.active {
        background: rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        font-weight: 600;
    }

    /* Cards */
    .card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        position: relative;
        overflow: hidden;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.3);
    }

    .btn-primary.active {
        background: linear-gradient(135deg, #0891b2, #0e7490);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        transform: none;
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-warning {
        background: var(--warning-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-warning:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-danger {
        background: var(--danger-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
    }

    .btn-orange {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-orange:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(234, 88, 12, 0.3);
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition-base);
        background: white;
        min-height: var(--touch-target);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    select.form-control {
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    /* Range Slider */
    .range-container {
        position: relative;
        margin: 1rem 0;
    }

    .range-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        outline: none;
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    .range-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
    }

    .range-value {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .stat-card {
        background: rgba(255,255,255,0.5);
        padding: 1.5rem 1rem;
        border-radius: var(--border-radius);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        transition: var(--transition-base);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-light);
        font-weight: 500;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Breathing Circle */
    .breathing-circle {
        width: 200px;
        height: 200px;
        border: 4px solid var(--primary-color);
        border-radius: 50%;
        margin: 2rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
        position: relative;
        background: rgba(6, 182, 212, 0.1);
        transform: scale(1);
        text-align: center;
        line-height: 1.3;
        padding: 2rem;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    .breathing-circle.inhale {
        background: rgba(6, 182, 212, 0.2);
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
    }

    .breathing-circle.exhale {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
        color: #10b981;
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
    }

    .breathing-circle.hold {
        background: rgba(245, 158, 11, 0.2);
        border-color: #f59e0b;
        color: #f59e0b;
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.4);
    }

    /* CP Measurement */
    .cp-display {
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        color: var(--primary-color);
        margin: 1rem 0;
        font-family: 'Monaco', 'Menlo', monospace;
    }

    .cp-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    /* Progress Chart */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 2rem 0;
        background: rgba(255,255,255,0.1);
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    /* Messages */
    .message {
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        animation: slideInDown 0.3s ease;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 350px;
        box-shadow: var(--shadow-md);
        border: 2px solid transparent;
        font-size: 0.9rem;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .message.success {
        background: rgba(16, 185, 129, 0.95);
        color: white;
        border-color: #059669;
        backdrop-filter: blur(10px);
    }

    .message.warning {
        background: rgba(245, 158, 11, 0.95);
        color: white;
        border-color: #d97706;
        backdrop-filter: blur(10px);
    }

    .message.danger, .message.error {
        background: rgba(239, 68, 68, 0.95);
        color: white;
        border-color: #dc2626;
        backdrop-filter: blur(10px);
        font-weight: 600;
    }

    .message.info {
        background: rgba(6, 182, 212, 0.95);
        color: white;
        border-color: #0891b2;
        backdrop-filter: blur(10px);
    }

    .message:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md), 0 4px 20px rgba(0,0,0,0.1);
    }

    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Loading States */
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--card-background);
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-md);
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 1rem;
        top: 1rem;
    }

    .close:hover {
        color: #000;
    }

    /* Button Groups */
    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .container {
            padding: 0.5rem;
        }
        
        .card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .user-info {
            position: static;
            justify-content: center;
            margin-bottom: 1rem;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-tabs {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .tab-btn {
            width: 100%;
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            font-size: 1rem;
            padding: 1.5rem;
        }
        
        .cp-display {
            font-size: 2rem;
        }
        
        .message {
            position: relative;
            top: auto;
            right: auto;
            max-width: none;
            margin: 1rem 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        .button-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .button-group .btn {
            width: 100%;
        }
    }

    /* Auth Screen Styles */
    #auth-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .auth-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        width: 100%;
        max-width: 450px;
        text-align: center;
    }

    .auth-card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
    }

    .auth-card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
    }

    /* Crisis Help Styles */
    .crisis-card {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
    }

    .crisis-card h3 {
        color: white;
    }

    /* Crisis Protocol Specific Styles */
    #crisis-protocol .card {
        animation: slideInUp 0.4s ease-out;
        border: 2px solid var(--primary-color);
    }

    #crisis-protocol .breathing-circle {
        width: 150px;
        height: 150px;
        font-size: 1.1rem;
        padding: 1.5rem;
    }

    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    #protocol-timer {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 1.1rem;
        letter-spacing: 1px;
    }

    #protocol-progress {
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
    }

    .loading-text {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Status Indicators */
    .status-connected {
        background: #10b981 !important;
        box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    }

    .status-disconnected {
        background: #f59e0b !important;
        box-shadow: 0 0 6px rgba(245, 158, 11, 0.5);
    }

    .status-error {
        background: #ef4444 !important;
        box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
    }

    /* Sensatie Checkboxes */
    .symptom-checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .symptom-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: var(--transition-base);
        background: rgba(255,255,255,0.5);
    }

    .symptom-checkbox-item:hover {
        background: rgba(6, 182, 212, 0.1);
    }

    .symptom-checkbox-item.selected {
        background: rgba(6, 182, 212, 0.2);
        border: 1px solid var(--primary-color);
    }

    .symptom-checkbox {
        margin-right: 0.5rem;
    }

    /* Checkbox Styling */
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
        cursor: pointer;
    }
</style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="auth-loading" class="hidden">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; color: white;">
            <div style="text-align: center;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p class="loading-text">Ademruimte wordt geladen...</p>
            </div>
        </div>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-card">
            <div id="login-form">
                <h2>Inloggen bij Ademruimte</h2>
                <p>Vul je gegevens in om door te gaan</p>
                
                <div class="form-group">
                    <label for="login-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="login-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Wachtwoord" required>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <input type="checkbox" id="remember-me" style="margin: 0; flex-shrink: 0;">
                    <label for="remember-me" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Onthoud mij</label>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="login-btn" onclick="loginUser()">
                        <span>🔑 Inloggen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1rem; font-size: 0.875rem;">
                    <button onclick="showPasswordResetForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; text-decoration: underline;">Wachtwoord vergeten?</button>
                </p>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Nog geen account? 
                    <button id="show-register" onclick="showRegisterForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Registreren</button>
                </p>
            </div>
            
            <div id="register-form" class="hidden">
                <h2>Account Aanmaken</h2>
                <p>Maak een nieuw account aan voor Ademruimte</p>
                
                <div class="form-group">
                    <label for="register-name">Volledige naam:</label>
                    <input type="text" class="form-control" id="register-name" placeholder="Je naam" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="register-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password" placeholder="Minimaal 6 karakters" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password-confirm">Bevestig wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password-confirm" placeholder="Herhaal wachtwoord" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="register-btn" onclick="registerUser()">
                        <span>✅ Account Aanmaken</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Al een account? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
            
            <div id="password-reset-form" class="hidden">
                <h2>Wachtwoord Resetten</h2>
                <p>Vul je e-mailadres in om een reset link te ontvangen</p>
                
                <div class="form-group">
                    <label for="reset-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="reset-email" placeholder="je@email.com" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-warning" id="reset-btn" onclick="resetPassword()">
                        <span>📧 Reset Link Versturen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Weet je je wachtwoord weer? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header>
            <div class="user-info" id="user-info">
                <div class="spinner"></div>
            </div>
            <div class="header-title">
                <h1>Ademruimte</h1>
                <p>Evidence-based hulp bij hyperventilatie en maagklachten</p>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="buteyko">💨 Buteyko</button>
            <button class="tab-btn" data-tab="dagboek">📊 Dagboek</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis Hulp</button>
        </nav>

        <main class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 id="dashboard-greeting">Welkom bij Ademruimte</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Op basis van wetenschappelijk onderzoek biedt Ademruimte effectieve hulp bij hyperventilatie en gerelateerde maagklachten. 
                        <strong>70-80% van de patiënten</strong> behaalt significante verbetering met de juiste technieken.
                    </p>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">-</div>
                            <div class="stat-label">Gem. verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="last-cp">-</div>
                            <div class="stat-label">Laatste CP</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>🎯 Jouw Persoonlijke Inzichten</h3>
                    <div id="insights-content">
                        <p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>
                    </div>
                </div>

                <div class="card">
                    <h3>💡 Jouw Persoonlijke Tip</h3>
                    <div id="tip-content">
                        <p>Start met je eerste oefening om persoonlijke tips te ontvangen!</p>
                    </div>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content">
                <div class="card">
                    <h2>💨 Buteyko Ademhaling</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        De Buteyko methode helpt je CO2-tolerantie te verbeteren en hyperventilatie te reduceren.
                    </p>

                    <!-- Control Pause Measurement -->
                    <div class="card" style="background: rgba(6, 182, 212, 0.1); border: 2px solid rgba(6, 182, 212, 0.2);">
                        <h3>⏱️ Control Pause (CP) Meting</h3>
                        <p style="margin-bottom: 1rem;">Meet je CO2-tolerantie. Normale waarden: 20-40 seconden.</p>
                        
                        <div class="cp-display" id="cp-timer">00</div>
                        
                        <div class="cp-controls">
                            <button class="btn btn-primary" id="start-cp" onclick="startCPMeasurement()">Start CP Meting</button>
                            <button class="btn btn-danger" id="stop-cp" onclick="stopCPMeasurement()" disabled>Stop</button>
                            <button class="btn btn-warning" id="reset-cp" onclick="resetCPMeasurement()">Reset</button>
                        </div>
                        
                        <div id="cp-instructions" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 0.5rem;">
                            <strong>Instructies:</strong>
                            <ol style="margin-top: 0.5rem;">
                                <li>Adem normaal in en uit</li>
                                <li>Na een normale uitademing, houd je adem in</li>
                                <li>Klik "Start CP Meting" en stop zodra je de eerste drang voelt om te ademen</li>
                                <li>Dit is je Control Pause score</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Breathing Exercise -->
                    <div class="card">
                        <h3>🫁 Ademhalingsoefening</h3>
                        
                        <div class="form-group">
                            <label for="breathing-pattern">Selecteer patroon:</label>
                            <select class="form-control" id="breathing-pattern" onchange="updateBreathingPattern()">
                                <option value="gentle" selected>Zachte oefening (10 sec vrij ademhalen + 3 sec vasthouden)</option>
                                <option value="standard">4-7-8 Standaard</option>
                                <option value="advanced">6-8-10 Gevorderd</option>
                            </select>
                        </div>

                        <div class="breathing-circle" id="breathing-circle">
                            Bereid je voor
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" id="start-breathing" onclick="startBreathing()">Start Oefening</button>
                            <button class="btn btn-danger" id="stop-breathing" onclick="stopBreathing()" disabled>Stop</button>
                        </div>

                        <div id="breathing-info" style="text-align: center; margin-top: 1rem;">
                            <p><strong>Cyclus:</strong> <span id="cycle-count">0</span> <span id="cycle-target">van 20 (zachte oefening)</span></p>
                            <p><strong>Fase:</strong> <span id="current-phase">Rust</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content">
                <div class="card">
                    <h2>📊 Dagboek & Statistieken</h2>
                    
                    <div class="button-group" style="margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="openJournalModal()">📝 Nieuwe Entry</button>
                        <button class="btn btn-success" onclick="exportDagboek()">💾 Exporteer</button>
                    </div>

                    <div class="form-group">
                        <label for="journal-filter">Filter dagboek entries:</label>
                        <select class="form-control" id="journal-filter" onchange="filterJournalEntries()">
                            <option value="last7" selected>Laatste 7 dagen</option>
                            <option value="last30">Laatste 30 dagen</option>
                            <option value="all">Alle entries</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">📈 Statistiek periode:</label>
                        <div class="button-group">
                            <button class="btn btn-primary" id="chart-10days" onclick="updateChartFilter('10days')">Laatste 10 dagen</button>
                            <button class="btn btn-primary" id="chart-30days" onclick="updateChartFilter('30days')">Laatste 30 dagen</button>
                            <button class="btn btn-primary" id="chart-all" onclick="updateChartFilter('all')">Alle data</button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>

                    <div id="journal-entries">
                        <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                            <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crisis Help Tab -->
            <div id="crisis" class="tab-content">
                <div class="card crisis-card">
                    <h2>🚨 Crisis Hulp</h2>
                    <p style="margin-bottom: 2rem;">Directe hulp bij acute hyperventilatie of paniekaanvallen.</p>

                    <div class="button-group">
                        <button class="btn btn-warning" onclick="startCrisisProtocol()">🆘 Start Noodprotocol</button>
                        <button class="btn btn-primary" onclick="startCrisisBreathing()">🫁 Simpele Nood Ademhaling</button>
                    </div>

                    <!-- Crisis Protocol Interface -->
                    <div id="crisis-protocol" class="hidden" style="margin-top: 2rem; text-align: center;">
                        <div class="card" style="background: rgba(255,255,255,0.95); color: var(--text-dark); margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 id="protocol-step-title">🛑 STOP - Je bent veilig</h3>
                                <div style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 2rem; font-weight: bold; min-width: 80px;">
                                    <span id="protocol-timer">00:30</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--primary-color);">
                                    <p id="protocol-instructions" style="font-size: 1.1rem; font-weight: 500; margin: 0;">
                                        Dit is hyperventilatie en het gaat voorbij. Leg je hand op je buik en voel je ademhaling.
                                    </p>
                                </div>
                            </div>

                            <div class="breathing-circle" id="protocol-circle" style="width: 150px; height: 150px; margin: 1rem auto;">
                                Voel je ademhaling...
                            </div>

                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                                <p id="protocol-encouragement" style="margin: 0; font-weight: 500; color: #059669;">
                                    Je bent veilig. Dit gevoel is tijdelijk.
                                </p>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <div style="background: rgba(0,0,0,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="protocol-progress" style="background: var(--primary-color); height: 100%; width: 0%; transition: width 1s linear;"></div>
                                </div>
                                <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                                    Stap <span id="protocol-current-step">1</span> van <span id="protocol-total-steps">5</span>
                                </small>
                            </div>

                            <button class="btn btn-danger" onclick="stopCrisisProtocol()" style="margin-top: 1rem;">
                                Stoppen
                            </button>
                        </div>
                    </div>

                    <!-- Simple Crisis Breathing -->
                    <div id="crisis-breathing" class="hidden" style="margin-top: 2rem;">
                        <div class="breathing-circle" id="crisis-circle">
                            Volg de cirkel
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-danger" onclick="stopCrisisBreathing()">Stop</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>📞 Noodhulp</h3>
                    <p><strong>Bij acute noodsituaties:</strong></p>
                    <ul style="margin: 1rem 0;">
                        <li>🚑 Spoeddiensten: 112</li>
                        <li>🩺 Huisarts: Contacteer je eigen huisarts</li>
                        <li>🧠 Zelfmoordlijn: 1813 of 0800 32 123</li>
                        <li>💬 Tele-onthaal: 106</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journal-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJournalModal()">&times;</span>
            <h2>📝 Nieuwe Dagboek Entry</h2>
            
            <div class="form-group">
                <label for="entry-technique">Techniek gebruikt:</label>
                <select class="form-control" id="entry-technique">
                    <option value="Buteyko Ademhaling">Buteyko Ademhaling</option>
                    <option value="4-7-8 Ademhaling">4-7-8 Ademhaling</option>
                    <option value="Crisis Ademhaling">Crisis Ademhaling</option>
                    <option value="Noodprotocol">Noodprotocol</option>
                    <option value="Handmatige Entry">Handmatige Entry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entry-trigger">Trigger/Oorzaak:</label>
                <input type="text" class="form-control" id="entry-trigger" placeholder="Wat triggerde de symptomen?">
            </div>

            <div class="form-group">
                <label for="entry-before">Intensiteit vóór (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-before" min="1" max="10" value="5" oninput="updateRangeValue('entry-before', 'before-value')">
                    <div class="range-value" id="before-value">5</div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-after">Intensiteit na (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-after" min="1" max="10" value="5" oninput="updateRangeValue('entry-after', 'after-value')">
                    <div class="range-value" id="after-value">5</div>
                </div>
            </div>

            <div class="form-group" id="cp-score-group" style="display: none;">
                <label for="entry-cp-score">CP Score (seconden):</label>
                <input type="number" class="form-control" id="entry-cp-score" min="1" max="120">
            </div>

            <div class="form-group">
                <label>Sensaties (selecteer van toepassing):</label>
                <div class="symptom-checkbox-container">
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Kortademigheid">
                        <label>Kortademigheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Luchthonger">
                        <label>Luchthonger</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Maagpijn">
                        <label>Maagpijn</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Hartkloppingen">
                        <label>Hartkloppingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Duizeligheid">
                        <label>Duizeligheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Tintelingen">
                        <label>Tintelingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Geforceerd gapen">
                        <label>Geforceerd gapen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Neus optrekken">
                        <label>Neus optrekken</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Piekergedachten">
                        <label>Piekergedachten</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Frustratie">
                        <label>Frustratie</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Onwerkelijke gevoelens">
                        <label>Onwerkelijke gevoelens</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Vermoeidheid">
                        <label>Vermoeidheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Paniek">
                        <label>Paniek</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Angst">
                        <label>Angst</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-result">Resultaat:</label>
                <select class="form-control" id="entry-result">
                    <option value="">Selecteer resultaat</option>
                    <option value="Veel beter">Veel beter</option>
                    <option value="Beter">Beter</option>
                    <option value="Iets beter">Iets beter</option>
                    <option value="Geen verandering">Geen verandering</option>
                    <option value="Slechter">Slechter</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entry-notes">Notities:</label>
                <textarea class="form-control" id="entry-notes" placeholder="Extra opmerkingen..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="saveJournalEntry()">💾 Opslaan</button>
                <button class="btn btn-orange" onclick="closeJournalModal()">Annuleren</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: rgba(255,255,255,0.8); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">📞 In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <!-- Developer Credit -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8;">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>

<script type="module">
    // Firebase configuration (exact same credentials)
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte.vercel.app", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Global variables
    let app, auth, db, currentUser = null;
    let currentTab = 'dashboard';
    let allJournalEntries = [];
    let allCPMeasurements = [];
    let progressChart = null;
    let chartFilter = '10days'; // New default: last 10 days

    // Breathing exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 0;
    let breathingPattern = 'gentle';
    let isBreathing = false;

    // CP measurement variables
    let cpInterval = null;
    let cpStartTime = 0;
    let cpIsRunning = false;

    // Crisis variables
    let crisisInterval = null;
    let crisisProtocolActive = false;
    let crisisStep = 0;
    let crisisTimer = 0;
    let crisisStepDuration = 0;

    // Wake lock variables
    let wakeLock = null;

    // User stats
    let userStats = {
        totalSessions: 0,
        streakDays: 0,
        lastSessionDate: null,
        cpMeasurements: [],
        achievements: []
    };

    // Crisis protocol steps
    const crisisProtocolSteps = [
        {
            name: "Stop & Erken",
            duration: 30,
            title: "🛑 STOP - Je bent veilig",
            instructions: "Dit is hyperventilatie en het gaat voorbij. Leg je hand op je buik en voel je ademhaling.",
            breathingText: "Voel je buik...",
            encouragement: "Je bent veilig. Dit gevoel is tijdelijk."
        },
        {
            name: "Paradoxale Ademhaling", 
            duration: 90,
            title: "🫁 Minder Ademhalen",
            instructions: "NIET diep ademen! Neem kleine, ondiepe ademhalingen. Houd je adem 2-3 seconden vast tussen elke ademhaling.",
            breathingText: "Klein inademen...",
            encouragement: "Perfect! Minder ademen helpt je CO2 te herstellen."
        },
        {
            name: "Grounding 5-4-3-2-1",
            duration: 60, 
            title: "👁️ Focus naar Buiten",
            instructions: "Kijk om je heen en benoem: 5 dingen die je ZIET, 4 dingen die je VOELT, 3 dingen die je HOORT.",
            breathingText: "Kijk om je heen...",
            encouragement: "Je hersenen komen terug in balans. Goed bezig!"
        },
        {
            name: "Rustgevende Ademhaling",
            duration: 60,
            title: "🌊 Natuurlijke Ademhaling", 
            instructions: "Laat je ademhaling nu natuurlijk worden. Adem rustig in door je neus, langzaam uit door je mond.",
            breathingText: "Natuurlijk...",
            encouragement: "Je lichaam herstelt zich. De paniek neemt af."
        },
        {
            name: "Bevestiging",
            duration: 30,
            title: "✅ Je hebt het Overwonnen",
            instructions: "Het ergste is voorbij. Je hebt controle teruggekregen. Je bent sterker dan je angst.",
            breathingText: "Je bent sterk! 💪",
            encouragement: "🎉 Geweldig gedaan! Je hebt de crisis doorstaan."
        }
    ];

    // All tips array
    const appTips = [
        "Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.",
        "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
        "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
        "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
        "Een normale Control Pause is tussen de 20-40 seconden. Begin laag en bouw langzaam op.",
        "Regelmatige CP metingen helpen je voortgang te volgen en patronen te herkennen.",
        "Het noodprotocol doorbreekt de vicieuze cirkel van hyperventilatie → paniek → meer hyperventilatie.",
        "Paradoxale ademhaling: MINDER ademen bij hyperventilatie, niet meer!"
    ];
    const tips = [
        "Maagklachten en ademhalingsproblemen zijn vaak verbonden via de nervus vagus - behandel ze samen voor betere resultaten.",
        "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
        "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
        "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
        "Een normale Control Pause is tussen de 20-40 seconden. Begin laag en bouw langzaam op.",
        "Regelmatige CP metingen helpen je voortgang te volgen en patronen te herkennen."
    ];

    // ============================================
    // WAKE LOCK FUNCTIONS
    // ============================================

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('📱 Wake lock activated - scherm blijft aan');
                
                // Show visual indicator
                showUserMessage('📱 Scherm blijft aan tijdens oefening', 'info');
                
                wakeLock.addEventListener('release', () => {
                    console.log('📱 Wake lock released - scherm mag uitgaan');
                });
                
                return true;
            } else {
                console.warn('⚠️ Wake Lock API not supported');
                showUserMessage('⚠️ Scherm wake lock niet ondersteund door deze browser', 'warning');
                return false;
            }
        } catch (error) {
            console.error('❌ Wake lock request failed:', error);
            return false;
        }
    }

    async function releaseWakeLock() {
        try {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('📱 Wake lock manually released');
                
                // Show visual confirmation (optional, can be subtle)
                // showUserMessage('📱 Scherm kan nu uitgaan', 'info');
            }
        } catch (error) {
            console.error('❌ Wake lock release failed:', error);
        }
    }

    // Handle page visibility changes (when user switches tabs/apps)
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            // Reacquire wake lock when returning to the page during active exercises
            if (isBreathing || crisisProtocolActive || cpIsRunning || crisisInterval) {
                await requestWakeLock();
            }
        }
    });

    // ============================================
    // FIREBASE INITIALIZATION & AUTH
    // ============================================

    async function initFirebase() {
        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Set persistence based on remember me (default to session)
            await setPersistence(auth, browserSessionPersistence);

            // Auth state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    updateUserInfo();
                    updateStatusIndicator('connected');
                    
                    // Load data immediately when user logs in
                    try {
                        await loadJournalEntries();
                        updateDashboard();
                        generateInsights();
                    } catch (error) {
                        console.error('Error loading data on login:', error);
                        showUserMessage('Gegevens laden mislukt, probeer te verversen', 'warning');
                    }
                } else {
                    currentUser = null;
                    showLoginScreen();
                    updateStatusIndicator('disconnected');
                }
            });

            return true;
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('Firebase kon niet worden geladen. Controleer je internetverbinding.', 'error');
            return false;
        }
    }

    // ============================================
    // UI STATE MANAGEMENT
    // ============================================

    function showMainApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function showLoginScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
    }

    function showLoadingScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.remove('hidden');
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        if (currentUser) {
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Gebruiker';
            const initials = displayName.includes('@') ? 
                displayName.split('@')[0].substring(0, 2).toUpperCase() :
                displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            
            userInfo.innerHTML = `
                <div class="user-avatar">${initials}</div>
                <span style="font-weight: 500;">${initials}</span>
                <button class="logout-btn" onclick="logout()">Uitloggen</button>
            `;
        } else {
            userInfo.innerHTML = '<div class="spinner"></div>';
        }
    }

    function updateStatusIndicator(status) {
        const dot = document.getElementById('firebase-status-dot');
        if (dot) {
            dot.className = `status-${status}`;
        }
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================

    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active to selected button
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        currentTab = tabName;
        
        // Load data based on tab
        if (tabName === 'dagboek') {
            createProgressChart();
            // Set default active state for chart filter (10 days)
            setTimeout(() => {
                document.getElementById('chart-10days').classList.add('active');
            }, 100);
        }
    }

    // ============================================
    // AUTHENTICATION FUNCTIONS
    // ============================================

    window.showLoginForm = function() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('password-reset-form').classList.add('hidden');
        
        // Reset other forms
        document.getElementById('register-name').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-password-confirm').value = '';
        document.getElementById('reset-email').value = '';
    };

    window.showRegisterForm = function() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('password-reset-form').classList.add('hidden');
        
        // Reset other forms
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('remember-me').checked = false;
        document.getElementById('reset-email').value = '';
    };

    window.showPasswordResetForm = function() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('password-reset-form').classList.remove('hidden');
        
        // Reset other forms
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('remember-me').checked = false;
        document.getElementById('register-name').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-password-confirm').value = '';
    };

    window.loginUser = async function() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;

        if (!email || !password) {
            showUserMessage('⚠️ Vul alle velden in', 'warning');
            return;
        }

        const loginBtn = document.getElementById('login-btn');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Inloggen...';
        loginBtn.disabled = true;

        try {
            const { signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            // Set persistence based on remember me checkbox
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            
            await signInWithEmailAndPassword(auth, email, password);
            showUserMessage('✅ Succesvol ingelogd!', 'success');
            
        } catch (error) {
            console.error('Login error:', error);
            let errorMessage = '❌ Inloggen mislukt. Controleer je gegevens.';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = '⚠️ Ongeldig e-mailadres.';
                    break;
                case 'auth/user-disabled':
                    errorMessage = '🚫 Dit account is uitgeschakeld.';
                    break;
                case 'auth/user-not-found':
                    errorMessage = '❓ Geen account gevonden met dit e-mailadres.';
                    break;
                case 'auth/wrong-password':
                    errorMessage = '🔐 Onjuist wachtwoord. Probeer opnieuw.';
                    break;
                case 'auth/invalid-credential':
                    errorMessage = '❌ Ongeldige inloggegevens. Controleer email en wachtwoord.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = '⏱️ Te veel pogingen. Probeer het later opnieuw.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = '📡 Netwerkfout. Controleer je internetverbinding.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
    };

    window.registerUser = async function() {
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;

        if (!name || !email || !password || !passwordConfirm) {
            showUserMessage('⚠️ Vul alle velden in', 'warning');
            return;
        }

        if (password !== passwordConfirm) {
            showUserMessage('🔐 Wachtwoorden komen niet overeen', 'warning');
            return;
        }

        if (password.length < 6) {
            showUserMessage('🔒 Wachtwoord moet minimaal 6 karakters bevatten', 'warning');
            return;
        }

        const registerBtn = document.getElementById('register-btn');
        const originalText = registerBtn.innerHTML;
        registerBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Account aanmaken...';
        registerBtn.disabled = true;

        try {
            const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Update user profile with display name
            await updateProfile(userCredential.user, {
                displayName: name
            });

            showUserMessage('✅ Account succesvol aangemaakt!', 'success');
            
        } catch (error) {
            console.error('Registration error:', error);
            let errorMessage = '❌ Registratie mislukt. Probeer het opnieuw.';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = '📧 Dit e-mailadres is al in gebruik.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = '⚠️ Ongeldig e-mailadres.';
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = '🚫 E-mail/wachtwoord accounts zijn uitgeschakeld.';
                    break;
                case 'auth/weak-password':
                    errorMessage = '🔒 Wachtwoord is te zwak. Kies een sterker wachtwoord.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = '📡 Netwerkfout. Controleer je internetverbinding.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
    };

    window.resetPassword = async function() {
        const email = document.getElementById('reset-email').value.trim();

        if (!email) {
            showUserMessage('⚠️ Vul je e-mailadres in', 'warning');
            return;
        }

        const resetBtn = document.getElementById('reset-btn');
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Versturen...';
        resetBtn.disabled = true;

        try {
            const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            await sendPasswordResetEmail(auth, email);
            
            showUserMessage('📧 Wachtwoord reset link verstuurd! Controleer je e-mail.', 'success');
            
            // Auto-switch back to login form after successful reset
            setTimeout(() => {
                showLoginForm();
            }, 3000);
            
        } catch (error) {
            console.error('Password reset error:', error);
            let errorMessage = '❌ Reset mislukt. Probeer het opnieuw.';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = '⚠️ Ongeldig e-mailadres.';
                    break;
                case 'auth/user-not-found':
                    errorMessage = '❓ Geen account gevonden met dit e-mailadres.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = '📡 Netwerkfout. Controleer je internetverbinding.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = '⏱️ Te veel pogingen. Probeer het later opnieuw.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        resetBtn.innerHTML = originalText;
        resetBtn.disabled = false;
    };

    window.logout = async function() {
        try {
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signOut(auth);
            showUserMessage('👋 Je bent uitgelogd', 'info');
        } catch (error) {
            console.error('Logout error:', error);
            showUserMessage('❌ Uitloggen mislukt', 'error');
        }
    };

    // ============================================
    // BUTEYKO FUNCTIONS
    // ============================================

    window.startCPMeasurement = function() {
        if (cpIsRunning) return;
        
        cpStartTime = Date.now();
        cpIsRunning = true;
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        document.getElementById('start-cp').disabled = true;
        document.getElementById('stop-cp').disabled = false;
        
        cpInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - cpStartTime) / 1000);
            document.getElementById('cp-timer').textContent = elapsed.toString().padStart(2, '0');
        }, 1000);
    };

    window.stopCPMeasurement = function() {
        if (!cpIsRunning) return;
        
        clearInterval(cpInterval);
        const cpScore = Math.floor((Date.now() - cpStartTime) / 1000);
        
        cpIsRunning = false;
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
        
        // Save CP measurement
        const cpMeasurement = {
            score: cpScore,
            timestamp: new Date(),
            userId: currentUser?.uid,
            userEmail: currentUser?.email
        };
        
        allCPMeasurements.push(cpMeasurement);
        userStats.cpMeasurements.push(cpMeasurement);
        
        // Save to Firebase
        if (currentUser) {
            saveCPMeasurement(cpMeasurement);
        }
        
        updateDashboard();
        showUserMessage(`CP Score: ${cpScore} seconden geregistreerd!`, 'success');
    };

    window.resetCPMeasurement = function() {
        clearInterval(cpInterval);
        
        // Release wake lock if CP was running
        if (cpIsRunning) {
            releaseWakeLock();
        }
        
        cpIsRunning = false;
        
        document.getElementById('cp-timer').textContent = '00';
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
    };

    async function saveCPMeasurement(measurement) {
        try {
            const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            await addDoc(collection(db, "cpMeasurements"), measurement);
        } catch (error) {
            console.error('Save CP error:', error);
        }
    }

    // ============================================
    // BREATHING EXERCISES
    // ============================================

    const breathingPatterns = {
        gentle: { freeBreathing: 10, hold: 3, cycles: 20, description: "10 sec vrij ademhalen (2x in/uit) + 3 sec vasthouden" },
        standard: { inhale: 4, hold: 7, exhale: 8, cycles: 10, description: "4-7-8 standaard patroon" },
        advanced: { inhale: 6, hold: 8, exhale: 10, cycles: 10, description: "6-8-10 gevorderd patroon" }
    };

    window.updateBreathingPattern = function() {
        breathingPattern = document.getElementById('breathing-pattern').value;
        const pattern = breathingPatterns[breathingPattern];
        const targetElement = document.getElementById('cycle-target');
        
        if (targetElement) {
            if (breathingPattern === 'gentle') {
                targetElement.textContent = 'van 20 (zachte oefening)';
            } else {
                targetElement.textContent = `van ${pattern.cycles || 10}`;
            }
        }
    };

    window.startBreathing = function() {
        if (isBreathing) return;
        
        isBreathing = true;
        breathCycleCount = 0;
        breathPhase = 'prepare';
        
        const circle = document.getElementById('breathing-circle');
        const pattern = breathingPatterns[breathingPattern];
        
        document.getElementById('start-breathing').disabled = true;
        document.getElementById('stop-breathing').disabled = false;
        document.getElementById('cycle-count').textContent = '0';
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        // Preparation phase
        circle.textContent = "Bereid je voor... 🧘";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        setTimeout(() => {
            if (!isBreathing) return;
            startBreathingCycle(pattern);
        }, 2000);
    };

    function startBreathingCycle(pattern) {
        if (!isBreathing) return;
        
        const circle = document.getElementById('breathing-circle');
        let phaseTime = 0;
        let currentPhase = breathingPattern === 'gentle' ? 'freeBreathing' : 'inhale';
        let completedCycles = 0;
        let totalCycles = pattern.cycles || 10;
        
        breathInterval = setInterval(() => {
            if (!isBreathing) return;
            
            phaseTime++;
            
            switch(currentPhase) {
                case 'freeBreathing':
                    circle.textContent = `Vrij ademen - ${phaseTime}s`;
                    circle.className = "breathing-circle";
                    document.getElementById('current-phase').textContent = 'Vrij ademhalen';
                    
                    // Subtle breathing animation - gentle pulsing
                    const breathingPhase = Math.sin((phaseTime * Math.PI * 4) / 10); // 4 breaths in 10 seconds
                    const gentleScale = 1 + (0.08 * breathingPhase);
                    circle.style.transform = `scale(${gentleScale})`;
                    
                    if (phaseTime >= (pattern.freeBreathing || 10)) {
                        phaseTime = 0;
                        currentPhase = 'hold';
                    }
                    break;
                    
                case 'inhale':
                    circle.textContent = `Inademen (${phaseTime}s)`;
                    circle.className = "breathing-circle inhale";
                    document.getElementById('current-phase').textContent = 'Inademen';
                    
                    // Smooth scaling animation
                    const inhaleProgress = phaseTime / pattern.inhale;
                    const inhaleScale = 1 + (0.15 * Math.min(inhaleProgress, 1));
                    circle.style.transform = `scale(${inhaleScale})`;
                    
                    if (phaseTime >= pattern.inhale) {
                        phaseTime = 0;
                        currentPhase = pattern.hold > 0 ? 'hold' : 'exhale';
                    }
                    break;
                    
                case 'hold':
                    if (breathingPattern === 'gentle') {
                        circle.textContent = `Vasthouden (${phaseTime}s)`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.1)';
                    } else {
                        circle.textContent = `Vasthouden (${phaseTime}s)`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.15)';
                    }
                    
                    const holdDuration = breathingPattern === 'gentle' ? pattern.hold : pattern.hold;
                    if (phaseTime >= holdDuration) {
                        phaseTime = 0;
                        
                        if (breathingPattern === 'gentle') {
                            // For gentle pattern, complete the cycle after hold
                            completedCycles++;
                            document.getElementById('cycle-count').textContent = completedCycles;
                            
                            if (completedCycles >= totalCycles) {
                                stopBreathing();
                                return;
                            } else {
                                currentPhase = 'freeBreathing';
                            }
                        } else {
                            currentPhase = 'exhale';
                        }
                    }
                    break;
                    
                case 'exhale':
                    circle.textContent = `Uitademen (${phaseTime}s)`;
                    circle.className = "breathing-circle exhale";
                    document.getElementById('current-phase').textContent = 'Uitademen';
                    
                    // Smooth scaling animation
                    const exhaleProgress = phaseTime / pattern.exhale;
                    const exhaleScale = 1.15 - (0.3 * Math.min(exhaleProgress, 1));
                    circle.style.transform = `scale(${exhaleScale})`;
                    
                    if (phaseTime >= pattern.exhale) {
                        phaseTime = 0;
                        completedCycles++;
                        document.getElementById('cycle-count').textContent = completedCycles;
                        
                        if (completedCycles >= totalCycles) {
                            stopBreathing();
                            return;
                        } else {
                            currentPhase = 'inhale';
                        }
                    }
                    break;
            }
        }, 1000);
    }

    window.stopBreathing = function() {
        isBreathing = false;
        clearInterval(breathInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        const circle = document.getElementById('breathing-circle');
        circle.textContent = "Goed gedaan! 🎉";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        document.getElementById('start-breathing').disabled = false;
        document.getElementById('stop-breathing').disabled = true;
        document.getElementById('current-phase').textContent = 'Voltooid';
        
        // Update stats
        userStats.totalSessions++;
        updateStreak();
        
        // Get completed cycles from the display
        const completedCycles = parseInt(document.getElementById('cycle-count').textContent);
        const pattern = breathingPatterns[breathingPattern];
        const targetCycles = pattern.cycles || 10;
        
        // Auto-open journal modal if session completed
        if (completedCycles >= targetCycles) {
            setTimeout(() => {
                openJournalModal('Buteyko Ademhaling');
            }, 1000);
        }
        
        updateDashboard();
    };

    // ============================================
    // CRISIS HELP FUNCTIONS
    // ============================================

    window.startCrisisProtocol = function() {
        document.getElementById('crisis-protocol').classList.remove('hidden');
        document.getElementById('crisis-breathing').classList.add('hidden');
        
        crisisProtocolActive = true;
        crisisStep = 0;
        crisisTimer = 0;
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        // Update total steps display
        document.getElementById('protocol-total-steps').textContent = crisisProtocolSteps.length;
        
        runCrisisProtocolStep();
    };

    function runCrisisProtocolStep() {
        if (!crisisProtocolActive || crisisStep >= crisisProtocolSteps.length) return;
        
        const step = crisisProtocolSteps[crisisStep];
        crisisStepDuration = step.duration;
        crisisTimer = crisisStepDuration;
        
        // Update UI for current step
        document.getElementById('protocol-step-title').textContent = step.title;
        document.getElementById('protocol-instructions').textContent = step.instructions;
        document.getElementById('protocol-encouragement').textContent = step.encouragement;
        document.getElementById('protocol-current-step').textContent = crisisStep + 1;
        
        // Update circle
        const circle = document.getElementById('protocol-circle');
        circle.textContent = step.breathingText;
        
        // Set circle style based on step
        switch(crisisStep) {
            case 0: // Stop & Erken
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1)';
                break;
            case 1: // Paradoxale Ademhaling
                circle.className = "breathing-circle hold";
                startParadoxicalBreathing(circle);
                break;
            case 2: // Grounding
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1.05)';
                startGroundingAnimation(circle);
                break;
            case 3: // Rustgevende Ademhaling
                circle.className = "breathing-circle inhale";
                startGentleBreathing(circle);
                break;
            case 4: // Bevestiging
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1)';
                break;
        }
        
        // Start timer for this step
        crisisInterval = setInterval(updateCrisisTimer, 1000);
    }

    function updateCrisisTimer() {
        if (!crisisProtocolActive) return;
        
        crisisTimer--;
        
        // Update timer display
        const minutes = Math.floor(crisisTimer / 60);
        const seconds = crisisTimer % 60;
        document.getElementById('protocol-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress bar
        const progress = ((crisisStepDuration - crisisTimer) / crisisStepDuration) * 100;
        document.getElementById('protocol-progress').style.width = progress + '%';
        
        // Move to next step when timer reaches 0
        if (crisisTimer <= 0) {
            clearInterval(crisisInterval);
            crisisStep++;
            
            if (crisisStep < crisisProtocolSteps.length) {
                // Small pause between steps
                setTimeout(runCrisisProtocolStep, 1000);
            } else {
                // Protocol completed
                completeCrisisProtocol();
            }
        }
    }

    function startParadoxicalBreathing(circle) {
        let phase = 'small-inhale';
        let phaseTimer = 0;
        
        const breathingInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 1) {
                clearInterval(breathingInterval);
                return;
            }
            
            phaseTimer++;
            
            switch(phase) {
                case 'small-inhale':
                    circle.textContent = "Klein inademen...";
                    circle.className = "breathing-circle inhale";
                    circle.style.transform = 'scale(1.05)';
                    if (phaseTimer >= 2) {
                        phase = 'hold';
                        phaseTimer = 0;
                    }
                    break;
                case 'hold':
                    circle.textContent = "Vasthouden...";
                    circle.className = "breathing-circle hold";
                    circle.style.transform = 'scale(1.05)';
                    if (phaseTimer >= 3) {
                        phase = 'small-exhale';
                        phaseTimer = 0;
                    }
                    break;
                case 'small-exhale':
                    circle.textContent = "Klein uitademen...";
                    circle.className = "breathing-circle exhale";
                    circle.style.transform = 'scale(0.95)';
                    if (phaseTimer >= 2) {
                        phase = 'small-inhale';
                        phaseTimer = 0;
                    }
                    break;
            }
        }, 1000);
    }

    function startGroundingAnimation(circle) {
        let colorIndex = 0;
        const colors = ['#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
        const texts = [
            "Zoek 5 dingen die je ziet...",
            "Voel 4 verschillende texturen...", 
            "Luister naar 3 geluiden...",
            "Focus op je omgeving...",
            "Je bent hier en nu..."
        ];
        let textIndex = 0;
        
        const groundingInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 2) {
                clearInterval(groundingInterval);
                return;
            }
            
            circle.style.borderColor = colors[colorIndex];
            circle.textContent = texts[textIndex];
            colorIndex = (colorIndex + 1) % colors.length;
            textIndex = (textIndex + 1) % texts.length;
        }, 3000);
    }

    function startGentleBreathing(circle) {
        let phase = 'inhale';
        let phaseTimer = 0;
        
        const gentleInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 3) {
                clearInterval(gentleInterval);
                return;
            }
            
            phaseTimer++;
            
            if (phase === 'inhale') {
                circle.textContent = "Rustig inademen...";
                circle.className = "breathing-circle inhale";
                const progress = phaseTimer / 4;
                const scale = 1 + (0.08 * Math.min(progress, 1));
                circle.style.transform = `scale(${scale})`;
                
                if (phaseTimer >= 4) {
                    phase = 'exhale';
                    phaseTimer = 0;
                }
            } else {
                circle.textContent = "Langzaam uitademen...";
                circle.className = "breathing-circle exhale";
                const progress = phaseTimer / 6;
                const scale = 1.08 - (0.08 * Math.min(progress, 1));
                circle.style.transform = `scale(${scale})`;
                
                if (phaseTimer >= 6) {
                    phase = 'inhale';
                    phaseTimer = 0;
                }
            }
        }, 1000);
    }

    function completeCrisisProtocol() {
        // Update UI to show completion
        document.getElementById('protocol-step-title').textContent = "🎉 Protocol Voltooid";
        document.getElementById('protocol-instructions').textContent = "Je hebt het noodprotocol succesvol doorlopen. Je bent weer in controle.";
        document.getElementById('protocol-encouragement').textContent = "Je bent sterk! Overweeg om deze ervaring in je dagboek te noteren.";
        
        const circle = document.getElementById('protocol-circle');
        circle.textContent = "Voltooid! 🎉";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        // Release wake lock
        releaseWakeLock();
        
        // Auto-close after 5 seconds and offer journal entry
        setTimeout(() => {
            stopCrisisProtocol();
            setTimeout(() => {
                openJournalModal('Noodprotocol');
            }, 1000);
        }, 5000);
    }

    window.stopCrisisProtocol = function() {
        crisisProtocolActive = false;
        clearInterval(crisisInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('crisis-protocol').classList.add('hidden');
        
        // Reset variables
        crisisStep = 0;
        crisisTimer = 0;
        crisisStepDuration = 0;
    };

    window.startCrisisBreathing = function() {
        document.getElementById('crisis-breathing').classList.remove('hidden');
        document.getElementById('crisis-protocol').classList.add('hidden');
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        const circle = document.getElementById('crisis-circle');
        let phase = 'inhale';
        let phaseCount = 0;
        
        // Reset circle to initial state
        circle.style.transform = 'scale(1)';
        circle.className = "breathing-circle";
        
        crisisInterval = setInterval(() => {
            phaseCount++;
            
            if (phase === 'inhale') {
                circle.textContent = `Adem in (${phaseCount})`;
                circle.className = "breathing-circle inhale";
                
                // Smooth inhale animation
                const inhaleProgress = phaseCount / 4;
                const inhaleScale = 1 + (0.15 * Math.min(inhaleProgress, 1));
                circle.style.transform = `scale(${inhaleScale})`;
                
                if (phaseCount >= 4) {
                    phaseCount = 0;
                    phase = 'exhale';
                }
            } else {
                circle.textContent = `Adem uit (${phaseCount})`;
                circle.className = "breathing-circle exhale";
                
                // Smooth exhale animation
                const exhaleProgress = phaseCount / 6;
                const exhaleScale = 1.15 - (0.25 * Math.min(exhaleProgress, 1));
                circle.style.transform = `scale(${exhaleScale})`;
                
                if (phaseCount >= 6) {
                    phaseCount = 0;
                    phase = 'inhale';
                }
            }
        }, 1000);
    };

    window.stopCrisisBreathing = function() {
        clearInterval(crisisInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('crisis-breathing').classList.add('hidden');
        
        // Reset circle to original state
        const circle = document.getElementById('crisis-circle');
        circle.style.transform = 'scale(1)';
        circle.className = "breathing-circle";
        circle.textContent = "Volg de cirkel";
        
        // Auto-open journal modal
        setTimeout(() => {
            openJournalModal('Crisis Ademhaling');
        }, 500);
    };

    // ============================================
    // JOURNAL FUNCTIONS
    // ============================================

    window.openJournalModal = function(technique = '') {
        document.getElementById('journal-modal').style.display = 'block';
        
        if (technique) {
            document.getElementById('entry-technique').value = technique;
            
            // Show CP score field for Buteyko
            if (technique === 'Buteyko Ademhaling') {
                document.getElementById('cp-score-group').style.display = 'block';
            }
        }
        
        // Focus first input
        setTimeout(() => {
            document.getElementById('entry-technique').focus();
        }, 100);
    };

    window.closeJournalModal = function() {
        document.getElementById('journal-modal').style.display = 'none';
        
        // Reset form
        document.getElementById('entry-technique').selectedIndex = 0;
        document.getElementById('entry-trigger').value = '';
        document.getElementById('entry-before').value = '5';
        document.getElementById('entry-after').value = '5';
        document.getElementById('before-value').textContent = '5';
        document.getElementById('after-value').textContent = '5';
        document.getElementById('entry-result').selectedIndex = 0;
        document.getElementById('entry-notes').value = '';
        document.getElementById('entry-cp-score').value = '';
        document.getElementById('cp-score-group').style.display = 'none';
        
        // Reset symptom checkboxes
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    };

    window.saveJournalEntry = async function() {
        try {
            // Collect form data
            const sensations = Array.from(document.querySelectorAll('.symptom-checkbox:checked'))
                                .map(cb => cb.dataset.symptom);
            
            const entry = {
                techniekGebruikt: document.getElementById('entry-technique').value,
                trigger: document.getElementById('entry-trigger').value,
                sensaties: sensations,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                timestamp: new Date(),
                userId: currentUser?.uid,
                userEmail: currentUser?.email
            };

            // Add CP score if available
            const cpScore = document.getElementById('entry-cp-score').value;
            if (cpScore && !isNaN(parseInt(cpScore))) {
                entry.cpScore = parseInt(cpScore);
            }

            if (!entry.resultaat) {
                showUserMessage('⚠️ Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            // Add to local array
            allJournalEntries.unshift(entry);
            
            // Save to Firebase
            if (currentUser) {
                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                await addDoc(collection(db, "dagboekEntries"), entry);
            }
            
            closeJournalModal();
            displayJournalEntries();
            updateDashboard();
            generateInsights();
            
            showUserMessage('✅ Dagboek entry opgeslagen!', 'success');
            
        } catch (error) {
            console.error('Save error:', error);
            showUserMessage('❌ Opslaan mislukt: ' + error.message, 'error');
        }
    };

    async function loadJournalEntries() {
        if (!currentUser) return;
        
        try {
            const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            // Load journal entries
            try {
                const journalQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const journalSnapshot = await getDocs(journalQuery);
                allJournalEntries = [];
                
                journalSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (orderError) {
                // Fallback without orderBy
                const simpleQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid)
                );
                
                const simpleSnapshot = await getDocs(simpleQuery);
                allJournalEntries = [];
                
                simpleSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // Sort manually
                allJournalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            // Load CP measurements
            try {
                const cpQuery = query(
                    collection(db, "cpMeasurements"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const cpSnapshot = await getDocs(cpQuery);
                allCPMeasurements = [];
                
                cpSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allCPMeasurements.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (cpError) {
                console.warn('CP measurements loading failed:', cpError);
                allCPMeasurements = [];
            }
            
            displayJournalEntries();
            generateInsights();
            createProgressChart();
            
            // Set default chart filter state (10 days)
            if (currentTab === 'dagboek') {
                setTimeout(() => {
                    document.getElementById('chart-10days').classList.add('active');
                }, 100);
            }
            
        } catch (error) {
            console.error('Load entries failed:', error);
            showUserMessage('❌ Laden van entries mislukt: ' + error.message, 'error');
        }
    }

    function displayJournalEntries() {
        const container = document.getElementById('journal-entries');
        
        if (allJournalEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                </div>
            `;
            return;
        }

        // Apply default filter (last 7 days) on first load
        const filterSelect = document.getElementById('journal-filter');
        const currentFilter = filterSelect ? filterSelect.value : 'last7';
        
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        switch(currentFilter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
            case 'all':
            default:
                filteredEntries = [...allJournalEntries];
                break;
        }

        if (filteredEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Geen entries gevonden voor de geselecteerde periode.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('journal-filter').value='all'; filterJournalEntries();">Toon alle entries</button>
                </div>
            `;
            return;
        }

        // Group entries by month for display
        const entriesByMonth = {};
        filteredEntries.forEach(entry => {
            const monthKey = entry.timestamp.toLocaleDateString('nl-BE', { 
                year: 'numeric', 
                month: 'long' 
            });
            
            if (!entriesByMonth[monthKey]) {
                entriesByMonth[monthKey] = [];
            }
            entriesByMonth[monthKey].push(entry);
        });

        let html = '';
        
        Object.keys(entriesByMonth).forEach(month => {
            const entries = entriesByMonth[month];
            
            html += `
                <div class="card">
                    <h3>📅 ${month}</h3>
                    <div style="display: grid; gap: 1rem;">
            `;
            
            entries.forEach(entry => {
                const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                const improvementColor = improvement > 0 ? '#10b981' : improvement < 0 ? '#ef4444' : '#6b7280';
                
                html += `
                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${improvementColor};">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <strong>${entry.techniekGebruikt}</strong>
                            <small style="color: var(--text-light);">${entry.timestamp.toLocaleDateString('nl-BE')}</small>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin: 0.5rem 0;">
                            <div><small>Voor: ${entry.intensiteitVoor}/10</small></div>
                            <div><small>Na: ${entry.intensiteitNa}/10</small></div>
                            <div><small>Verschil: ${improvement > 0 ? '+' : ''}${improvement}</small></div>
                            ${entry.cpScore ? `<div><small>CP: ${entry.cpScore}s</small></div>` : ''}
                        </div>
                        
                        ${entry.trigger ? `<div style="margin: 0.5rem 0;"><small><strong>Trigger:</strong> ${entry.trigger}</small></div>` : ''}
                        ${entry.sensaties && entry.sensaties.length ? `<div style="margin: 0.5rem 0;"><small><strong>Sensaties:</strong> ${entry.sensaties.join(', ')}</small></div>` : ''}
                        ${entry.symptomen && entry.symptomen.length ? `<div style="margin: 0.5rem 0;"><small><strong>Sensaties:</strong> ${entry.symptomen.join(', ')}</small></div>` : ''}
                        
                        <div style="margin: 0.5rem 0;">
                            <span style="background: ${improvementColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                ${entry.resultaat}
                            </span>
                        </div>
                        
                        ${entry.notities ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-light);"><small>${entry.notities}</small></div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    window.filterJournalEntries = function() {
        const filter = document.getElementById('journal-filter').value;
        let filteredEntries = [...allJournalEntries];
        
        const now = new Date();
        
        switch(filter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
        }
        
        // Update display with filtered entries
        const originalEntries = allJournalEntries;
        allJournalEntries = filteredEntries;
        displayJournalEntries();
        allJournalEntries = originalEntries;
    };

    window.exportDagboek = function() {
        let text = 'Ademruimte Dagboek Export\n';
        text += '==========================\n\n';
        
        allJournalEntries.forEach(entry => {
            text += `Datum: ${entry.timestamp.toLocaleString('nl-BE')}\n`;
            text += `Techniek: ${entry.techniekGebruikt}\n`;
            text += `Trigger: ${entry.trigger || 'Geen'}\n`;
            text += `Intensiteit vóór: ${entry.intensiteitVoor}/10\n`;
            text += `Intensiteit ná: ${entry.intensiteitNa}/10\n`;
            if (entry.cpScore) text += `CP Score: ${entry.cpScore} seconden\n`;
            // Support both old (symptomen) and new (sensaties) entries
            const sensations = entry.sensaties || entry.symptomen;
            if (sensations?.length) text += `Sensaties: ${sensations.join(', ')}\n`;
            text += `Resultaat: ${entry.resultaat}\n`;
            text += `Notities: ${entry.notities || 'Geen'}\n`;
            text += '\n---\n\n';
        });

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ademruimte-dagboek-${new Date().toLocaleDateString('nl-BE')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showUserMessage('📁 Dagboek geëxporteerd!', 'success');
    };

    // ============================================
    // DASHBOARD & STATISTICS
    // ============================================

    function updateDashboard() {
        if (!currentUser) return;
        
        // Update greeting
        const greeting = document.getElementById('dashboard-greeting');
        const hour = new Date().getHours();
        let timeGreeting = 'Goedemorgen';
        if (hour >= 12) timeGreeting = 'Goedemiddag';
        if (hour >= 18) timeGreeting = 'Goedenavond';
        
        const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'daar';
        const firstName = displayName.includes(' ') ? displayName.split(' ')[0] : displayName;
        
        greeting.textContent = `${timeGreeting}, ${firstName}!`;
        
        // Calculate stats
        const allCPData = [...userStats.cpMeasurements, ...allCPMeasurements]
            .filter(cp => cp.score !== undefined)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const avgImprovement = allJournalEntries.length > 0 ? 
            allJournalEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / allJournalEntries.length : 0;
        
        const lastCP = allCPData.length > 0 ? allCPData[0].score : null;
        
        // Update stats display
        document.getElementById('total-sessions').textContent = userStats.totalSessions + allJournalEntries.length;
        document.getElementById('streak-days').textContent = userStats.streakDays;
        document.getElementById('avg-improvement').textContent = avgImprovement > 0 ? 
            `+${avgImprovement.toFixed(1)}` : avgImprovement.toFixed(1);
        document.getElementById('last-cp').textContent = lastCP ? `${lastCP}s` : '-';
        
        // Update personalized tip
        updatePersonalizedTip();
    }

    function updatePersonalizedTip() {
        const tipContainer = document.getElementById('tip-content');
        
        if (allJournalEntries.length === 0) {
            // Fallback to general tips when no data
            const tipIndex = new Date().getDate() % appTips.length;
            tipContainer.innerHTML = `<p>${appTips[tipIndex]}</p>`;
            return;
        }
        
        const personalizedTip = generatePersonalizedTip();
        tipContainer.innerHTML = personalizedTip;
    }

    function generatePersonalizedTip() {
        const recentEntries = allJournalEntries.slice(0, 10);
        const allTimeEntries = allJournalEntries;
        
        // Focus on meaningful notes analysis
        const meaningfulNotes = allTimeEntries.filter(e => e.notities && e.notities.trim().length > 10);
        
        if (meaningfulNotes.length === 0) {
            // Fallback to general tips when no meaningful notes
            const tipIndex = new Date().getDate() % appTips.length;
            return `<p>${appTips[tipIndex]}</p>`;
        }
        
        const personalInsights = analyzeUserNotes(meaningfulNotes, allTimeEntries);
        
        if (personalInsights.length === 0) {
            // Fallback if no insights found
            const tipIndex = new Date().getDate() % appTips.length;
            return `<p>${appTips[tipIndex]}</p>`;
        }
        
        // Rotate through insights based on day
        const insightIndex = new Date().getDate() % personalInsights.length;
        const selectedInsight = personalInsights[insightIndex];
        
        return `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 1.5rem; margin-top: 0.1rem;">${selectedInsight.icon}</div>
                <div>
                    <p style="margin: 0; font-weight: 500;">${selectedInsight.text}</p>
                    <small style="color: var(--text-light); font-size: 0.8rem; margin-top: 0.5rem; display: block;">
                        Gebaseerd op jouw notities van ${meaningfulNotes.length} sessies
                    </small>
                </div>
            </div>
        `;
    }

    function analyzeUserNotes(meaningfulNotes, allEntries) {
        const insights = [];
        const allNotesText = meaningfulNotes.map(e => e.notities.toLowerCase()).join(' ');
        const noteWords = allNotesText.split(/\s+/).filter(word => word.length > 2);
        
        // Word frequency analysis (excluding common words)
        const commonWords = ['het', 'een', 'de', 'van', 'en', 'in', 'op', 'is', 'was', 'met', 'voor', 'had', 'dat', 'maar', 'als', 'ook', 'aan', 'bij', 'nog', 'naar', 'kan', 'wel', 'niet', 'te', 'om', 'zo', 'dit', 'hij', 'zij', 'mij', 'me', 'ik', 'je', 'er', 'nu', 'dan', 'heel', 'veel', 'weer', 'ging', 'heb', 'hebben', 'zijn', 'werd', 'komt'];
        const meaningfulWords = noteWords.filter(word => !commonWords.includes(word) && word.length > 3);
        
        const wordFreq = {};
        meaningfulWords.forEach(word => {
            wordFreq[word] = (wordFreq[word] || 0) + 1;
        });
        
        // Get most frequent meaningful words
        const frequentWords = Object.keys(wordFreq)
            .filter(word => wordFreq[word] >= 2)
            .sort((a, b) => wordFreq[b] - wordFreq[a])
            .slice(0, 5);
        
        // Emotional pattern analysis
        const emotionalPatterns = {
            positive: {
                words: ['goed', 'beter', 'fijn', 'prettig', 'rustig', 'ontspannen', 'kalm', 'tevreden', 'gelukkig', 'opgelucht', 'succesvol', 'effectief', 'helpt', 'werkt', 'gemakkelijk', 'natuurlijk'],
                count: 0,
                entries: []
            },
            struggle: {
                words: ['moeilijk', 'zwaar', 'lastig', 'vermoeiend', 'uitputtend', 'frustrerend', 'lukt', 'concentreren', 'focus', 'afleiden', 'onrustig', 'gespannen'],
                count: 0,
                entries: []
            },
            physical: {
                words: ['pijn', 'benauwd', 'druk', 'spanning', 'strak', 'verkrampt', 'trillen', 'duizelig', 'misselijk', 'hoofdpijn', 'hartkloppingen'],
                count: 0,
                entries: []
            },
            context: {
                words: ['werk', 'thuis', 'bed', 'kantoor', 'auto', 'trein', 'familie', 'collega', 'partner', 'kind', 'kinderen', 'school'],
                count: 0,
                entries: []
            },
            timing: {
                words: ['ochtend', 'morgen', 'middag', 'avond', 'nacht', 'slapen', 'opstaan', 'pauze', 'lunch', 'weekend', 'maandag', 'dinsdag', 'woensdag', 'donderdag', 'vrijdag'],
                count: 0,
                entries: []
            }
        };
        
        // Analyze each note for emotional patterns
        meaningfulNotes.forEach(entry => {
            const noteText = entry.notities.toLowerCase();
            
            Object.keys(emotionalPatterns).forEach(pattern => {
                emotionalPatterns[pattern].words.forEach(word => {
                    if (noteText.includes(word)) {
                        emotionalPatterns[pattern].count++;
                        if (!emotionalPatterns[pattern].entries.includes(entry)) {
                            emotionalPatterns[pattern].entries.push(entry);
                        }
                    }
                });
            });
        });
        
        // Generate insights based on patterns
        
        // Positive experience insight
        if (emotionalPatterns.positive.count >= 3) {
            const positiveWords = emotionalPatterns.positive.words.filter(word => allNotesText.includes(word));
            insights.push({
                icon: '✨',
                text: `Je notities tonen veel positieve ervaringen. Woorden als "${positiveWords.slice(0, 3).join('", "')}" komen regelmatig voor. Dit toont dat je goed bezig bent met je ademhalingspraktijk.`
            });
        }
        
        // Struggle pattern insight
        if (emotionalPatterns.struggle.count >= 2) {
            const struggleWords = emotionalPatterns.struggle.words.filter(word => allNotesText.includes(word));
            const avgImprovementInStruggleSessions = emotionalPatterns.struggle.entries.reduce((sum, e) => 
                sum + (e.intensiteitVoor - e.intensiteitNa), 0) / emotionalPatterns.struggle.entries.length;
            
            if (avgImprovementInStruggleSessions > 1) {
                insights.push({
                    icon: '💪',
                    text: `Ook als je schrijft over "${struggleWords[0]}" of vergelijkbare uitdagingen, bereik je nog steeds verbetering. Je doorzettingsvermogen werkt!`
                });
            } else {
                insights.push({
                    icon: '🌱',
                    text: `Je notities tonen soms uitdagingen met "${struggleWords[0]}" en vergelijkbare ervaringen. Onthoud dat oefening tijd nodig heeft - iedere sessie telt.`
                });
            }
        }
        
        // Context pattern insight
        if (emotionalPatterns.context.count >= 3) {
            const contextWords = emotionalPatterns.context.words.filter(word => allNotesText.includes(word));
            const mostMentionedContext = contextWords.reduce((a, b) => 
                (allNotesText.split(a).length - 1) > (allNotesText.split(b).length - 1) ? a : b);
            
            insights.push({
                icon: '🏠',
                text: `Je notities vermelden vaak "${mostMentionedContext}" - dit lijkt een belangrijke context voor jouw oefeningen. Let op hoe verschillende omgevingen je ervaringen beïnvloeden.`
            });
        }
        
        // Physical sensation insight
        if (emotionalPatterns.physical.count >= 2) {
            const physicalWords = emotionalPatterns.physical.words.filter(word => allNotesText.includes(word));
            insights.push({
                icon: '🎯',
                text: `Je beschrijft vaak fysieke sensaties zoals "${physicalWords[0]}". Het lijkt erop dat je goed in contact bent met je lichamelijke signalen - dit is waardevol voor je praktijk.`
            });
        }
        
        // Timing pattern insight
        if (emotionalPatterns.timing.count >= 2) {
            const timingWords = emotionalPatterns.timing.words.filter(word => allNotesText.includes(word));
            insights.push({
                icon: '⏰',
                text: `Je notities bevatten vaak tijdsaanduidingen zoals "${timingWords[0]}". Het lijkt erop dat timing belangrijk is in jouw ervaring van symptomen.`
            });
        }
        
        // Frequent word insight
        if (frequentWords.length > 0) {
            const topWord = frequentWords[0];
            const wordCount = wordFreq[topWord];
            
            if (wordCount >= 3) {
                insights.push({
                    icon: '🔍',
                    text: `Het woord "${topWord}" komt ${wordCount} keer voor in je notities. Dit lijkt een belangrijk thema in jouw ademhalingservaring te zijn.`
                });
            }
        }
        
        // Progress narrative insight
        const progressWords = ['vooruitgang', 'beter', 'verbeterd', 'verbetering', 'gegroeid', 'geleerd', 'ontwikkeld'];
        const progressMentions = progressWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (progressMentions >= 2) {
            insights.push({
                icon: '📈',
                text: `Je schrijft regelmatig over je vooruitgang en ontwikkeling. Het is mooi om te zien hoe bewust je bent van je groei in de ademhalingspraktijk.`
            });
        }
        
        // Technique preference based on notes
        const techniqueNotes = {};
        meaningfulNotes.forEach(entry => {
            const technique = entry.techniekGebruikt;
            if (!techniqueNotes[technique]) {
                techniqueNotes[technique] = [];
            }
            techniqueNotes[technique].push(entry.notities.toLowerCase());
        });
        
        Object.keys(techniqueNotes).forEach(technique => {
            const notes = techniqueNotes[technique].join(' ');
            const positiveCount = emotionalPatterns.positive.words.reduce((count, word) => 
                count + (notes.split(word).length - 1), 0);
            
            if (positiveCount >= 2 && techniqueNotes[technique].length >= 3) {
                insights.push({
                    icon: '🎯',
                    text: `Je notities over ${technique} zijn vaak positief. Je lijkt deze techniek niet alleen effectief te vinden, maar ook prettig om te doen.`
                });
            }
        });
        
        // Personal language patterns
        const personalPronouns = ['ik', 'mij', 'me', 'mijn'];
        const personalReflections = meaningfulNotes.filter(entry => {
            const noteText = entry.notities.toLowerCase();
            return personalPronouns.some(pronoun => noteText.includes(pronoun + ' voel')) ||
                   noteText.includes('voor mij') || noteText.includes('ik merk');
        });
        
        if (personalReflections.length >= 3) {
            insights.push({
                icon: '🪞',
                text: `Je notities tonen veel zelfrefectie en bewustwording. Deze introspectieve houding is heel waardevol voor je groei in ademhalingswerk.`
            });
        }
        
        return insights;
    }

    function generateInsights() {
        const insightsContainer = document.getElementById('insights-content');
        
        if (allJournalEntries.length === 0) {
            insightsContainer.innerHTML = '<p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>';
            return;
        }
        
        const insights = generateDetailedInsights();
        insightsContainer.innerHTML = insights;
    }

    function generateDetailedInsights() {
        const recentEntries = allJournalEntries.slice(0, 20);
        const allTimeEntries = allJournalEntries;
        let insights = [];
        
        // Technique effectiveness analysis
        const techniqueStats = {};
        allTimeEntries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            
            if (!techniqueStats[technique]) {
                techniqueStats[technique] = { 
                    total: 0, 
                    totalImprovement: 0, 
                    successes: 0,
                    avgBefore: 0,
                    avgAfter: 0
                };
            }
            
            techniqueStats[technique].total++;
            techniqueStats[technique].totalImprovement += improvement;
            techniqueStats[technique].avgBefore += entry.intensiteitVoor;
            techniqueStats[technique].avgAfter += entry.intensiteitNa;
            if (improvement > 0) techniqueStats[technique].successes++;
        });
        
        // Calculate averages
        Object.keys(techniqueStats).forEach(technique => {
            const stats = techniqueStats[technique];
            stats.avgImprovement = stats.totalImprovement / stats.total;
            stats.successRate = stats.successes / stats.total;
            stats.avgBefore = stats.avgBefore / stats.total;
            stats.avgAfter = stats.avgAfter / stats.total;
        });
        
        // Find best and worst performing techniques
        const techniques = Object.keys(techniqueStats).filter(t => techniqueStats[t].total >= 2);
        if (techniques.length > 0) {
            const bestTechnique = techniques.reduce((a, b) => 
                techniqueStats[a].avgImprovement > techniqueStats[b].avgImprovement ? a : b);
            
            insights.push(`🏆 <strong>${bestTechnique}</strong> is jouw meest effectieve techniek met gemiddeld <strong>${techniqueStats[bestTechnique].avgImprovement.toFixed(1)} punten verbetering</strong> per sessie.`);
            
            if (techniques.length > 1) {
                const leastEffective = techniques.reduce((a, b) => 
                    techniqueStats[a].avgImprovement < techniqueStats[b].avgImprovement ? a : b);
                
                if (bestTechnique !== leastEffective && techniqueStats[leastEffective].avgImprovement < 1) {
                    insights.push(`💡 <strong>${leastEffective}</strong> toont minder verbetering (${techniqueStats[leastEffective].avgImprovement.toFixed(1)} punten). Probeer deze techniek te verfijnen of focus meer op ${bestTechnique}.`);
                }
            }
        }
        
        // Recent performance trends
        const last10 = recentEntries.slice(0, 10);
        const previous10 = recentEntries.slice(10, 20);
        
        if (last10.length >= 5 && previous10.length >= 5) {
            const recentAvgImprovement = last10.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / last10.length;
            const previousAvgImprovement = previous10.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / previous10.length;
            const trend = recentAvgImprovement - previousAvgImprovement;
            
            if (trend > 0.5) {
                insights.push(`📈 Je bent de laatste tijd aan het verbeteren! Je recente sessies tonen ${Math.abs(trend).toFixed(1)} punten meer verbetering dan daarvoor.`);
            } else if (trend < -0.5) {
                insights.push(`📊 Je resultaten zijn wat afgenomen de laatste tijd. Probeer terug te gaan naar technieken die eerder goed werkten voor je.`);
            }
        }
        
        // Trigger pattern analysis
        const triggerAnalysis = {};
        allTimeEntries.filter(e => e.trigger && e.trigger.trim()).forEach(entry => {
            const trigger = entry.trigger.toLowerCase().trim();
            if (!triggerAnalysis[trigger]) {
                triggerAnalysis[trigger] = {
                    count: 0,
                    totalImprovement: 0,
                    avgBefore: 0
                };
            }
            triggerAnalysis[trigger].count++;
            triggerAnalysis[trigger].totalImprovement += (entry.intensiteitVoor - entry.intensiteitNa);
            triggerAnalysis[trigger].avgBefore += entry.intensiteitVoor;
        });
        
        const significantTriggers = Object.keys(triggerAnalysis).filter(t => triggerAnalysis[t].count >= 3);
        if (significantTriggers.length > 0) {
            const mostFrequentTrigger = significantTriggers.reduce((a, b) => 
                triggerAnalysis[a].count > triggerAnalysis[b].count ? a : b);
            
            const avgBeforeForTrigger = triggerAnalysis[mostFrequentTrigger].avgBefore / triggerAnalysis[mostFrequentTrigger].count;
            const avgImprovementForTrigger = triggerAnalysis[mostFrequentTrigger].totalImprovement / triggerAnalysis[mostFrequentTrigger].count;
            
            insights.push(`🎯 Je meest voorkomende trigger is "<strong>${mostFrequentTrigger}</strong>" (${triggerAnalysis[mostFrequentTrigger].count}x). Bij deze trigger start je gemiddeld op ${avgBeforeForTrigger.toFixed(1)}/10 en verbeter je met ${avgImprovementForTrigger.toFixed(1)} punten.`);
        }
        
        // Time pattern analysis
        const hourlyPattern = {};
        allTimeEntries.forEach(entry => {
            const hour = entry.timestamp.getHours();
            const timeSlot = hour < 6 ? 'nacht' : 
                           hour < 12 ? 'ochtend' : 
                           hour < 18 ? 'middag' : 
                           hour < 22 ? 'avond' : 'nacht';
            
            if (!hourlyPattern[timeSlot]) {
                hourlyPattern[timeSlot] = {
                    count: 0,
                    totalBefore: 0
                };
            }
            hourlyPattern[timeSlot].count++;
            hourlyPattern[timeSlot].totalBefore += entry.intensiteitVoor;
        });
        
        const significantTimes = Object.keys(hourlyPattern).filter(t => hourlyPattern[t].count >= 3);
        if (significantTimes.length > 0) {
            const peakTime = significantTimes.reduce((a, b) => 
                hourlyPattern[a].count > hourlyPattern[b].count ? a : b);
            
            const avgIntensityAtPeak = hourlyPattern[peakTime].totalBefore / hourlyPattern[peakTime].count;
            
            if (hourlyPattern[peakTime].count > allTimeEntries.length * 0.3) {
                insights.push(`⏰ Je ervaart het vaakst symptomen in de <strong>${peakTime}</strong> (${hourlyPattern[peakTime].count}x) met gemiddeld ${avgIntensityAtPeak.toFixed(1)}/10 intensiteit. Overweeg preventieve oefeningen rond deze tijd.`);
            }
        }
        
        // Sensation insights  
        const sensationAnalysis = {};
        allTimeEntries.forEach(entry => {
            const sensations = entry.sensaties || entry.symptomen || [];
            sensations.forEach(sensation => {
                if (!sensationAnalysis[sensation]) {
                    sensationAnalysis[sensation] = {
                        count: 0,
                        totalBefore: 0,
                        totalImprovement: 0
                    };
                }
                sensationAnalysis[sensation].count++;
                sensationAnalysis[sensation].totalBefore += entry.intensiteitVoor;
                sensationAnalysis[sensation].totalImprovement += (entry.intensiteitVoor - entry.intensiteitNa);
            });
        });
        
        const frequentSensations = Object.keys(sensationAnalysis).filter(s => sensationAnalysis[s].count >= 3);
        if (frequentSensations.length > 0) {
            const topSensation = frequentSensations.reduce((a, b) => 
                sensationAnalysis[a].count > sensationAnalysis[b].count ? a : b);
            
            const avgImprovementForSensation = sensationAnalysis[topSensation].totalImprovement / sensationAnalysis[topSensation].count;
            
            insights.push(`🔍 "<strong>${topSensation}</strong>" is jouw meest voorkomende sensatie (${sensationAnalysis[topSensation].count}x). Bij deze sensatie verbeter je gemiddeld met ${avgImprovementForSensation.toFixed(1)} punten.`);
        }
        
        // CP progression insight
        if (allCPMeasurements.length >= 5) {
            const sortedCP = [...allCPMeasurements].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const firstCP = sortedCP[0].score;
            const lastCP = sortedCP[sortedCP.length - 1].score;
            const cpProgress = lastCP - firstCP;
            
            if (Math.abs(cpProgress) >= 3) {
                const trend = cpProgress > 0 ? 'verbeterd' : 'afgenomen';
                insights.push(`💨 Je Control Pause is ${trend} met ${Math.abs(cpProgress)} seconden sinds je eerste meting (van ${firstCP}s naar ${lastCP}s).`);
            }
        }
        
        // Notes-based insights
        const meaningfulNotes = allTimeEntries.filter(e => e.notities && e.notities.trim().length > 15);
        if (meaningfulNotes.length >= 3) {
            const allNotes = meaningfulNotes.map(e => e.notities.toLowerCase()).join(' ');
            
            // Look for common themes in notes
            const stressWords = ['stress', 'werk', 'druk', 'spanning', 'bezorgd', 'onrust'];
            const physicalWords = ['moe', 'vermoeid', 'pijn', 'zwaar', 'benauwd'];
            const positiveWords = ['beter', 'goed', 'rustig', 'ontspannen', 'fijn', 'gelukt'];
            
            const stressCount = stressWords.reduce((count, word) => count + (allNotes.split(word).length - 1), 0);
            const physicalCount = physicalWords.reduce((count, word) => count + (allNotes.split(word).length - 1), 0);
            const positiveCount = positiveWords.reduce((count, word) => count + (allNotes.split(word).length - 1), 0);
            
            if (stressCount > physicalCount && stressCount > positiveCount) {
                insights.push(`📝 Je notities tonen vaak stress-gerelateerde triggers. Focus op stressmanagement technieken naast ademhalingsoefeningen.`);
            } else if (positiveCount > stressCount && positiveCount > physicalCount) {
                insights.push(`✨ Je notities zijn overwegend positief - je bent duidelijk op de goede weg met je ademhalingspraktijk!`);
            }
        }
        
        // Consistency insight
        const uniqueDays = new Set(allTimeEntries.map(e => e.timestamp.toDateString())).size;
        const daysSinceFirst = allTimeEntries.length > 0 ? 
            Math.ceil((new Date() - allTimeEntries[allTimeEntries.length - 1].timestamp) / (1000 * 60 * 60 * 24)) : 0;
        
        if (daysSinceFirst > 14) {
            const consistencyRate = uniqueDays / daysSinceFirst;
            if (consistencyRate > 0.5) {
                insights.push(`⭐ Geweldige consistentie! Je hebt ${uniqueDays} van de laatste ${daysSinceFirst} dagen geoefend (${(consistencyRate * 100).toFixed(0)}%).`);
            } else if (consistencyRate < 0.2) {
                insights.push(`🌟 Meer regelmatige oefening kan je resultaten verbeteren. Probeer dagelijks 5 minuten te reserveren voor ademhaling.`);
            }
        }
        
        if (insights.length === 0) {
            insights.push('📊 Blijf regelmatig je ervaringen bijhouden om meer persoonlijke inzichten te ontdekken.');
        }
        
        // Limit to 4 most relevant insights
        const selectedInsights = insights.slice(0, 4);
        
        return selectedInsights.map(insight => `<p>${insight}</p>`).join('');
    }

    function createProgressChart() {
        if (!currentUser || allJournalEntries.length === 0) return;
        
        const ctx = document.getElementById('progress-chart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (progressChart) {
            progressChart.destroy();
        }
        
        // Filter data based on current chart filter
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        if (chartFilter === '10days') {
            const tenDaysAgo = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000);
            filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= tenDaysAgo);
        } else if (chartFilter === '30days') {
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= thirtyDaysAgo);
        }
        
        // Sort by timestamp (oldest first for chart)
        filteredEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Take last 50 entries to keep chart readable (for 'all' filter)
        const chartEntries = chartFilter === 'all' ? filteredEntries.slice(-50) : filteredEntries;
        
        // Prepare data with actual dates
        const chartData = chartEntries.map((entry) => ({
            date: entry.timestamp.toLocaleDateString('nl-BE', { 
                day: '2-digit', 
                month: '2-digit' 
            }),
            fullDate: entry.timestamp.toLocaleDateString('nl-BE'),
            voor: entry.intensiteitVoor,
            na: entry.intensiteitNa,
            verbetering: entry.intensiteitVoor - entry.intensiteitNa,
            technique: entry.techniekGebruikt
        }));
        
        // Determine chart title based on filter
        let chartTitle = 'Voortgang Over Tijd';
        if (chartFilter === '10days') {
            chartTitle = 'Voortgang Laatste 10 Dagen';
        } else if (chartFilter === '30days') {
            chartTitle = 'Voortgang Laatste 30 Dagen';
        }
        
        progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => d.date),
                datasets: [
                    {
                        label: 'Voor sessie',
                        data: chartData.map(d => d.voor),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Na sessie',
                        data: chartData.map(d => d.na),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Verbetering',
                        data: chartData.map(d => d.verbetering),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        type: 'bar',
                        yAxisID: 'y1',
                        barThickness: 20
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartTitle,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return chartData[index].fullDate;
                            },
                            afterTitle: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return `Techniek: ${chartData[index].technique}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Datum'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Intensiteit (1-10)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Verbetering'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });
        
        // Update button active states
        document.getElementById('chart-10days').classList.remove('active');
        document.getElementById('chart-30days').classList.remove('active');
        document.getElementById('chart-all').classList.remove('active');
        document.getElementById(`chart-${chartFilter}`).classList.add('active');
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function updateStreak() {
        const today = new Date().toDateString();
        
        if (userStats.lastSessionDate !== today) {
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (userStats.lastSessionDate === yesterday || !userStats.lastSessionDate) {
                userStats.streakDays = (userStats.streakDays || 0) + 1;
            } else {
                userStats.streakDays = 1;
            }
            
            userStats.lastSessionDate = today;
        }
    }

    window.updateChartFilter = function(filter) {
        chartFilter = filter;
        createProgressChart();
    };

    window.updateRangeValue = function(sliderId, valueId) {
        const slider = document.getElementById(sliderId);
        const valueElement = document.getElementById(valueId);
        valueElement.textContent = slider.value;
        
        // Update position of value indicator
        const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        valueElement.style.left = percent + '%';
    };

    window.toggleSymptom = function(element) {
        const checkbox = element.querySelector('.symptom-checkbox');
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('selected', checkbox.checked);
    };

    function showUserMessage(message, type = 'info') {
        // Remove existing messages
        document.querySelectorAll('.message').forEach(msg => msg.remove());
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.textContent = message;
        
        // Add click to dismiss
        messageEl.style.cursor = 'pointer';
        messageEl.addEventListener('click', () => {
            messageEl.remove();
        });
        
        document.body.appendChild(messageEl);
        
        // Auto remove after different durations based on type
        const duration = type === 'error' ? 8000 : type === 'warning' ? 6000 : 5000;
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.remove();
            }
        }, duration);
        
        // Log to console for debugging
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // ============================================
    // EVENT LISTENERS & INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Initializing Ademruimte app...');
        
        showLoadingScreen();
        
        // Setup tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                showTab(tab);
            });
        });
        
        // Setup login form handlers
        document.getElementById('login-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });
        
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });
        
        // Setup register form handlers
        document.getElementById('register-password-confirm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerUser();
        });
        
        // Setup password reset form handler
        document.getElementById('reset-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') resetPassword();
        });
        
        // Setup range sliders
        document.getElementById('entry-before').addEventListener('input', (e) => {
            updateRangeValue('entry-before', 'before-value');
        });
        
        document.getElementById('entry-after').addEventListener('input', (e) => {
            updateRangeValue('entry-after', 'after-value');
        });
        
        // Setup technique selector for CP score field
        document.getElementById('entry-technique').addEventListener('change', (e) => {
            const cpGroup = document.getElementById('cp-score-group');
            if (e.target.value === 'Buteyko Ademhaling') {
                cpGroup.style.display = 'block';
            } else {
                cpGroup.style.display = 'none';
            }
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('journal-modal');
            if (e.target === modal) {
                closeJournalModal();
            }
        });
        
        // Initialize Firebase
        try {
            await initFirebase();
            console.log('✅ Ademruimte app initialization completed successfully');
            
            // Ensure login form is shown by default
            showLoginForm();
            
        } catch (error) {
            console.error('❌ App initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('App initialisatie mislukt. Herlaad de pagina.', 'error');
            showLoginScreen();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (breathInterval) clearInterval(breathInterval);
        if (cpInterval) clearInterval(cpInterval);
        if (crisisInterval) clearInterval(crisisInterval);
        if (crisisProtocolActive) stopCrisisProtocol();
        if (progressChart) progressChart.destroy();
        
        // Release wake lock
        releaseWakeLock();
    });

    console.log('📱 Ademruimte app loaded successfully');
</script>
</body>
</html>
