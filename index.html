<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            position: relative; /* Keep relative for potential absolute children */
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: right;
            font-size: 0.8rem;
        }

        .user-info .user-name {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .user-info button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
            min-height: 40px;
            min-width: 80px;
            transition: all 0.2s;
        }

        .user-info button:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0.5rem;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            margin-right: 0.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 44px;
            touch-action: manipulation;
        }

        .nav-tabs button.active {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .nav-tabs button:hover {
            background: #f3f4f6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .card h2 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.375rem;
        }

        .card h3 {
            color: #374151;
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        .btn {
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            text-decoration: none;
            min-height: 48px;
            touch-action: manipulation;
            user-select: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-green {
            background: #10b981;
            color: white;
        }

        .btn-green:hover {
            background: #059669;
        }

        .btn-orange {
            background: #f59e0b;
            color: white;
        }

        .btn-orange:hover {
            background: #d97706;
        }

        .btn-red {
            background: #ef4444;
            color: white;
        }

        .btn-red:hover {
            background: #dc2626;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        .btn-cyan {
            background: #06b6d4;
            color: white;
        }

        .btn-cyan:hover {
            background: #0891b2;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #1f2937;
            margin: 1.5rem 0;
            font-family: 'Courier New', monospace;
        }

        .breath-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breath-display.inhale {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            transform: scale(1.02);
        }

        .breath-display.exhale {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            transform: scale(0.98);
        }

        .breath-display.hold {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            transform: scale(1.01);
        }

        .breath-display.rest {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background: #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 0.375rem;
            transition: width 0.3s ease;
        }

        .breath-progress {
            height: 100%;
            border-radius: 0.375rem;
            transition: width linear;
        }

        .breath-progress.inhale {
            background: #3b82f6;
        }

        .breath-progress.exhale {
            background: #10b981;
        }

        .breath-progress.hold {
            background: #f59e0b;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-height: 48px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .range-input {
            width: 100%;
            margin: 0.75rem 0;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            border-radius: 5px;
            outline: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .range-input::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .range-value {
            text-align: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: #3b82f6;
            margin: 0.5rem 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            margin-left: auto;
            min-width: 40px;
            min-height: 40px;
        }

        .technique-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .technique-card h4 {
            color: #1e40af;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .technique-card p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .entry-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .entry-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .entry-result {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .entry-result.zeer-goed { color: #059669; }
        .entry-result.goed { color: #10b981; }
        .entry-result.matig { color: #f59e0b; }
        .entry-result.geen-effect { color: #6b7280; }
        .entry-result.slechter { color: #ef4444; }

        .intensity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-connected {
            color: #059669;
            font-size: 0.7rem;
        }

        .status-disconnected {
            color: #f59e0b;
            font-size: 0.7rem;
        }

        .status-error {
            color: #ef4444;
            font-size: 0.7rem;
        }

        .step-list {
            list-style: none;
            margin: 1rem 0;
        }

        .step-list li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .step-list li:before {
            content: "✓ ";
            color: #10b981;
            font-weight: bold;
        }

        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .login-card {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
            z-index: 1;
        }

        .divider span {
            background: white;
            padding: 0 1rem;
            position: relative;
            z-index: 2;
        }

        .google-btn {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 48px;
        }

        .google-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .breath-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .breath-setting {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .breath-setting label {
            display: block;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .breath-setting input {
            width: 80px;
            text-align: center;
            font-size: 1.125rem;
            font-weight: bold;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            min-height: 44px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .button-group .btn {
            flex: 1;
            min-width: 120px;
        }

        .settings-section {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid #e2e8f0;
        }

        .settings-section h3 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #6b7280;
            font-size: 0.8rem;
        }

        /* Desktop optimizations */
        @media (min-width: 768px) {
            header {
                padding: 2rem 1rem;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .container {
                max-width: 1200px;
                padding: 2rem 1rem;
            }
            
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .timer-display {
                font-size: 3rem;
            }

            .breath-display {
                font-size: 2.5rem;
                padding: 2rem;
            }

            .breath-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .user-info {
                position: absolute;
                top: 1rem;
                right: 1rem;
                text-align: right;
                margin-top: 0;
            }
        }

        /* Large screen optimizations */
        @media (min-width: 1024px) {
            .user-info {
                position: absolute;
                top: 1rem;
                right: 1rem;
                text-align: right;
                margin-top: 0;
            }
        }

        /* Smartphone optimizations (header) */
        @media (max-width: 767px) {
            header {
                padding: 1rem; /* Slightly reduced padding for smaller screens */
            }
            
            header h1 {
                font-size: 1.5rem; /* Smaller heading on small screens */
                margin-bottom: 0.25rem;
            }

            /* Make user-info flow naturally on smaller screens */
            .user-info {
                position: static;
                text-align: center;
                margin-top: 1rem; /* Add some space below the header text */
                right: auto; /* Remove absolute positioning attributes */
                top: auto;
            }

            /* Adjust header padding if user-info is static to avoid large gaps */
            header {
                padding-bottom: 1rem; 
            }
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 1rem 1.5rem;
            }
            
            .nav-tabs button {
                min-height: 44px;
                padding: 1rem 1.25rem;
            }
            
            .user-info button {
                min-height: 44px;
                min-width: 88px;
            }
        }

        /* Landscape phone optimizations */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            .timer-display, .breath-display {
                font-size: 1.5rem;
                margin: 0.5rem 0;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>🫁 Ademruimte</h1>
        <p>Jouw persoonlijke hyperventilatie helper</p>
        <div class="user-info" id="user-info">
            <div class="spinner" id="auth-loading"></div>
        </div>
        <div id="firebase-status" class="status-disconnected">
            Firebase: Initialiseren...
        </div>
    </header>

    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-card">
                <h2 style="text-align: center; margin-bottom: 1.5rem; color: #1f2937;">
                    Welkom bij Ademruimte
                </h2>
                
                <p style="text-align: center; margin-bottom: 2rem; color: #6b7280;">
                    Log in om je vooruitgang op te slaan en te synchroniseren tussen al je apparaten.
                </p>

                <button class="google-btn" onclick="signInWithGoogle()">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Doorgaan met Google
                </button>

                <div class="divider">
                    <span>of</span>
                </div>

                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">E-mail:</label>
                        <input type="email" id="login-email" class="form-input" placeholder="jouw@email.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Wachtwoord:</label>
                        <input type="password" id="login-password" class="form-input" placeholder="Wachtwoord" required>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="remember-me" checked style="width: 20px; height: 20px;">
                        <label for="remember-me" style="font-size: 0.875rem; margin: 0; cursor: pointer;">Ingelogd blijven</label>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Inloggen
                    </button>
                </form>

                <div style="text-align: center;">
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Nog geen account?
                    </p>
                    <button class="btn btn-green" onclick="showRegisterForm()" style="width: 100%;">
                        Account Aanmaken
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Account Aanmaken</h3>
                <button class="close-btn" onclick="closeRegisterModal()">&times;</button>
            </div>
            
            <form id="register-form">
                <div class="form-group">
                    <label class="form-label">Naam:</label>
                    <input type="text" id="register-name" class="form-input" placeholder="Jouw naam" required>
                </div>

                <div class="form-group">
                    <label class="form-label">E-mail:</label>
                    <input type="email" id="register-email" class="form-input" placeholder="jouw@email.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Wachtwoord:</label>
                    <input type="password" id="register-password" class="form-input" placeholder="Minimaal 6 karakters" required minlength="6">
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-green">
                        Account Aanmaken
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeRegisterModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis</button>
            <button class="tab-btn" data-tab="buteyko">🌬️ Buteyko</button>
            <button class="tab-btn" data-tab="ritueel">🕐 Ritueel</button>
            <button class="tab-btn" data-tab="gapen">🥱 Gapen</button>
            <button class="tab-btn" data-tab="emdr">💜 EMDR</button>
            <button class="tab-btn" data-tab="dagboek">📖 Dagboek</button>
        </nav>

        <div class="container">
            <div id="dashboard" class="tab-content">
                <div class="card">
                    <h2>Welkom bij Ademruimte</h2>
                    <p>Jouw persoonlijke hulp voor het omgaan met hyperventilatie en luchthonger-gevoelens.</p>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3>🚨 Crisis Hulp</h3>
                        <p>Voor wanneer je luchthonger voelt opkomen</p>
                        <button class="btn btn-red" onclick="showTab('crisis')">Open Crisis Hulp</button>
                    </div>

                    <div class="card">
                        <h3>🌬️ Buteyko Ademhaling</h3>
                        <p>CO2 tolerantie training</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>

                    <div class="card">
                        <h3>🕐 Afkoel Ritueel</h3>
                        <p>Na intensief denkwerk</p>
                        <button class="btn btn-green" onclick="showTab('ritueel')">Start Ritueel</button>
                    </div>

                    <div class="card">
                        <h3>🥱 Gaap Preventie</h3>
                        <p>Technieken voor gaapaanvallen</p>
                        <button class="btn btn-orange" onclick="showTab('gapen')">Bekijk Technieken</button>
                    </div>

                    <div class="card">
                        <h3>💜 EMDR Zelfhulp</h3>
                        <p>Voor luchthonger-gevoelens</p>
                        <button class="btn btn-purple" onclick="showTab('emdr')">Start EMDR</button>
                    </div>

                    <div class="card">
                        <h3>📖 Dagboek</h3>
                        <p>Bijhouden van patronen</p>
                        <button class="btn btn-primary" onclick="showTab('dagboek')">Open Dagboek</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Tip van de dag:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.
                </div>

            <div id="crisis" class="tab-content hidden">
                <div class="card">
                    <h2>🚨 Crisis Hulp - Luchthonger</h2>
                    <p>Voor wanneer je dat benauwde gevoel voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>1. Paradoxale Ademhaling</h4>
                    <p>Start met bewust zeer kleine, korte ademhalingen. Na 3-4 van deze mini-ademhalingen, probeer een iets langere uitademing.</p>
                </div>

                <div class="technique-card">
                    <h4>2. Purse-lip Ademhaling</h4>
                    <p>Tuut je lippen bij het uitademen om lichte weerstand te creëren. Dit helpt bij luchthonger en stabiliseert CO2-niveaus.</p>
                </div>

                <div class="technique-card">
                    <h4>3. IJswater Techniek</h4>
                    <p>Breng iets kouds tegen je gezicht (vooral rond wangen en ogen) om de duikreflex te activeren.</p>
                </div>

                <div class="technique-card">
                    <h4>4. Herframing</h4>
                    <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                </div>

                <div class="card">
                    <h3>5-4-3-2-1 Grounding</h3>
                    <ul class="step-list">
                        <li>5 dingen die je ZIET</li>
                        <li>4 dingen die je VOELT</li>
                        <li>3 dingen die je HOORT</li>
                        <li>2 dingen die je RUIKT</li>
                        <li>1 ding dat je PROEFT</li>
                    </ul>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Crisis Hulp Technieken')">
                        📝 Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <div id="buteyko" class="tab-content hidden">
                <div class="card">
                    <h2>🌬️ Buteyko Ademhaling</h2>
                    <p>Verbeter je CO2 tolerantie en verminder hyperventilatie neiging</p>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Hoe het werkt:</strong> Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus, wat hyperventilatie-episodes kan verminderen.
                </div>

                <div class="card">
                    <h3>Ademhaling Instellingen</h3>
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Inademen (sec)</label>
                            <input type="number" id="inhale-duration" value="4" min="2" max="10">
                        </div>
                        <div class="breath-setting">
                            <label>Uitademen (sec)</label>
                            <input type="number" id="exhale-duration" value="6" min="3" max="15">
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="hold-duration" value="3" min="1" max="20">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="breath-display rest" id="breath-display">
                        Klik op start om te beginnen
                    </div>

                    <div class="progress-bar">
                        <div class="breath-progress" id="breath-progress" style="width: 0%"></div>
                    </div>

                    <div style="text-align: center; margin: 1rem 0;">
                        <div id="breath-cycle-counter" style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1rem;">
                            Cyclus: 0
                        </div>
                        
                        <div class="button-group">
                            <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathExercise()">
                                ▶️ Start Buteyko
                            </button>
                            <button class="btn btn-orange" onclick="resetBreathExercise()">
                                🔄 Reset
                            </button>
                        </div>
                    </div>

                    <div id="breath-complete" class="alert alert-success hidden">
                        <strong>✅ Buteyko Sessie Voltooid!</strong><br>
                        Goed gedaan! Je hebt een volledige ademhalingssessie afgerond.
                        <br><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('Buteyko Ademhaling')">
                            📝 Dagboek Entry Maken
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>Buteyko Principes</h3>
                    <div class="technique-card">
                        <h4>Zachte Ademhaling</h4>
                        <p>Adem zo zacht mogelijk - stel je voor dat je een veertje voor je neus niet wilt laten bewegen.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Langere Uitademing</h4>
                        <p>De uitademing is langer dan de inademing om CO2 te behouden en het autonome zenuwstelsel te kalmeren.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Comfortabele Pauze</h4>
                        <p>De ademhpauze na uitademing mag nooit geforceerd aanvoelen - stop als het oncomfortabel wordt.</p>
                    </div>
                </div>
            </div>

            <div id="ritueel" class="tab-content hidden">
                <div class="card">
                    <h2>🕐 Afkoel Ritueel</h2>
                    <p>Voor na periodes van intensief denkwerk (5-10 minuten)</p>
                </div>

                <div class="card">
                    <h3 id="ritual-title">Stap 1: Fysieke Mini-Reset</h3>
                    <div class="timer-display" id="timer-display">2:00</div>
                    
                    <div id="ritual-instructions">
                        <ul class="step-list">
                            <li>Sta op en strek je volledig uit</li>
                            <li>Schud je armen en benen los</li>
                            <li>Rol je schouders 5x naar achteren</li>
                            <li>Maak kleine cirkels met je hoofd (5x elke richting)</li>
                        </ul>
                    </div>

                    <div class="button-group">
                        <button id="timer-btn" class="btn btn-green" onclick="startTimer()">▶️ Start Timer</button>
                        <button class="btn btn-primary" onclick="nextRitualStep()" id="next-btn" style="display: none;">Volgende Stap</button>
                        <button class="btn btn-orange" onclick="resetRitual()">🔄 Reset</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="ritual-progress" style="width: 20%"></div>
                    </div>

                    <div id="ritual-complete" class="alert alert-success hidden">
                        <strong>✅ Afkoel Ritueel Voltooid!</strong><br>
                        Goed gedaan! Je hebt alle stappen doorlopen.
                        <br><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('Afkoel Ritueel')">
                            📝 Dagboek Entry Maken
                        </button>
                    </div>
                </div>
            </div>

            <div id="gapen" class="tab-content hidden">
                <div class="card">
                    <h2>🥱 Gaap Preventie Technieken</h2>
                    <p>Voor wanneer je die vervelende gaapaanvallen voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>Lipremming-techniek</h4>
                    <p>Druk je lippen zachtjes op elkaar wanneer je een gaapneiging voelt. Laat de lucht langzaam door je neus in en uit gaan.</p>
                </div>

                <div class="technique-card">
                    <h4>Mini-ademhalingen</h4>
                    <p>Neem bewust 3-4 zeer kleine, ondiepe ademhalingen door je neus. Hiermee voorkom je de grote 'zucht-ademhaling'.</p>
                </div>

                <div class="technique-card">
                    <h4>Tongpositie veranderen</h4>
                    <p>Plaats je tongpunt tegen je gehemelte (achter je voortanden). Dit vermindert de neiging tot gapen.</p>
                </div>

                <div class="technique-card">
                    <h4>Water drinken</h4>
                    <p>Neem kleine slokjes water wanneer je merkt dat je begint te gapen. Dit doorbreekt het ademhalingspatroon.</p>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Belangrijk om te onthouden:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Ze geven je de kans om preventief in te grijpen voordat een volledige hyperventilatie-episode begint.
                </div>

                <div class="card">
                    <h3>Gedachte-Breaking Technieken</h3>
                    <div class="technique-card">
                        <strong>Paradoxale intentie:</strong> "Oké hersenen, jullie willen dat ik ga gapen? Prima, ik ga nu heel bewust gapen"
                    </div>
                    <div class="technique-card">
                        <strong>Herframing:</strong> "Mijn brein probeert me te beschermen, maar ik hoef niet te reageren"
                    </div>
                    <div class="technique-card">
                        <strong>Aandacht verplaatsen:</strong> Tel 5 blauwe dingen die je kunt zien
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Gaap Preventie Technieken')">
                        📝 Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <div id="emdr" class="tab-content hidden">
                <div class="card">
                    <h2>💜 EMDR Zelfhulp</h2>
                    <p>Voor luchthonger-gevoelens (dit is ondersteuning, geen vervanging voor professionele EMDR)</p>
                </div>

                <div class="alert alert-warning">
                    <strong>⚠️ Gebruik dit alleen voor milde tot matige gevoelens. Stop als je je overweldigd voelt.</strong>
                </div>

                <div class="alert alert-info">
                    <strong>🎧 Bilaterale Audio:</strong> Voor de beste ervaring, gebruik koptelefoon of oortjes. Zet het volume op een comfortabel niveau voordat je begint.
                </div>

                <div class="card">
                    <h3>🔊 Bilaterale Audio Stimulatie</h3>
                    <p style="margin-bottom: 1rem;">Een 880Hz toon die van links naar rechts beweegt om bilaterale hersenstimulatie te ondersteunen.</p>
                    
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Volume (%)</label>
                            <input type="number" id="audio-volume" value="30" min="10" max="100" step="10">
                        </div>
                        <div class="breath-setting">
                            <label>Snelheid (sec)</label>
                            <input type="number" id="audio-speed" value="2" min="1" max="5" step="0.5">
                        </div>
                        <div class="breath-setting">
                            <label>Status</label>
                            <div id="audio-status" style="font-weight: bold; color: #6b7280; margin-top: 0.5rem;">Gestopt</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="audio-btn" class="btn btn-purple" onclick="toggleBilateralAudio()">
                            🔊 Start Audio
                        </button>
                        <button class="btn btn-orange" onclick="stopBilateralAudio()">
                            🔇 Stop Audio
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 id="emdr-title">Stap 1: Voorbereiding</h3>
                    <div id="emdr-content">
                        <p>Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.</p>
                    </div>

                    <div id="emdr-intensity" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Intensiteit van luchthonger-gevoel (1-10):</label>
                            <input type="range" min="1" max="10" value="5" class="range-input" id="emdr-intensity-slider">
                            <div class="range-value" id="emdr-intensity-value">5</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="emdr-prev-btn" class="btn btn-orange" onclick="prevEmdrStep()" style="display: none;">Vorige</button>
                        <button id="emdr-next-btn" class="btn btn-purple" onclick="nextEmdrStep()">Volgende</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="emdr-progress" style="width: 20%"></div>
                    </div>

                    <div id="emdr-complete" class="alert alert-success hidden">
                        <strong>✅ EMDR Sessie Voltooid!</strong><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('EMDR Zelfhulp Sessie')">
                            📝 Dagboek Entry Maken
                        </button>
                    </div>
                </div>
            </div>

            <div id="dagboek" class="tab-content hidden">
                <div class="card">
                    <h2>📖 Dagboek</h2>
                    <p>Overzicht van je sessies en vooruitgang</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Handmatige Entry')">
                            ➕ Nieuwe Entry
                        </button>
                        <button class="btn btn-green" onclick="loadDagboekEntries()">
                            🔄 Vernieuw
                        </button>
                        <button class="btn btn-orange" onclick="exportDagboek()">
                            📥 Export Dagboek
                        </button>
                    </div>
                </div>

                <div id="dagboek-entries">
                    </div>

                <div class="card">
                    <h3>Patronen om naar uit te kijken</h3>
                    <ul class="step-list">
                        <li>Welke technieken het beste werken voor jou</li>
                        <li>Tijdstippen waarop klachten vaker voorkomen</li>
                        <li>Specifieke triggers (werk, stress, bepaalde gedachten)</li>
                        <li>Verband tussen maagklachten en ademhalingsproblemen</li>
                        <li>Verbetering in intensiteit scores over tijd</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="dagboek-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📝 Dagboek Entry</h3>
                <button class="close-btn" onclick="closeDagboekModal()">&times;</button>
            </div>
            
            <form id="dagboek-form">
                <div class="form-group">
                    <label class="form-label">Situatie/Trigger:</label>
                    <input type="text" id="entry-trigger" class="form-input" placeholder="Bijv. na intensief werken">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label class="form-label">Intensiteit voor (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before">
                        <div class="range-value" id="entry-before-value">5</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Intensiteit na (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after">
                        <div class="range-value" id="entry-after-value">5</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Resultaat:</label>
                    <select id="entry-result" class="form-select">
                        <option value="">Selecteer resultaat...</option>
                        <option value="zeer-goed">Zeer goed - volledig opgelost</option>
                        <option value="goed">Goed - duidelijke verbetering</option>
                        <option value="matig">Matig - kleine verbetering</option>
                        <option value="geen-effect">Geen effect</option>
                        <option value="slechter">Iets slechter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notities:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op?"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="saveDagboekEntry()">
                        📁 Opslaan
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeDagboekModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>📞 In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
    </footer>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Firebase configuratie
        const firebaseConfig = {
            apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
            authDomain: "ademruimte-12c09.firebaseapp.com",
            projectId: "ademruimte-12c09",
            storageBucket: "ademruimte-12c09.firebasestorage.app",
            messagingSenderId: "744941871331",
            appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
            measurementId: "G-SD2ZEYNMNY"
        };

        // Global variables
        let app, db, auth;
        let currentUser = null;
        let isFirebaseConnected = false;
        let currentTab = 'dashboard';
        let timerInterval = null;
        let currentTime = 0;
        let ritualStep = 0;
        let emdrStep = 0;
        let currentTechnique = '';
        let dagboekEntries = [];

        // Breath exercise variables
        let breathInterval = null;
        let breathPhase = 'rest'; // 'inhale', 'exhale', 'hold', 'rest'
        let breathCycleCount = 0;
        let breathPhaseTime = 0;
        let breathCycleDuration = 0;

        // Audio variables for EMDR
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;
        let pannerNode = null;
        let audioInterval = null;
        let isAudioPlaying = false;
        let panPosition = -1; // Start left (-1), move to right (1)

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            isFirebaseConnected = true;
            
            updateFirebaseStatus('connected', '🔥 Firebase: Verbonden');
            
            console.log('✅ Firebase successfully initialized');
            
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            updateFirebaseStatus('error', '🔥 Firebase: Fout. Controleer console.'); // More specific error message
        }

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            document.getElementById('auth-loading').style.display = 'none';
            
            if (user) {
                currentUser = user;
                showMainApp();
                updateUserInfo(user);
                loadDagboekEntries();
                checkForLocalData();
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        // Helper functies
        function updateFirebaseStatus(type, message) {
            const statusElement = document.getElementById('firebase-status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
        }

        function checkForLocalData() {
            const localData = localStorage.getItem('ademruimte-entries');
            // This section assumes a 'migration-section' HTML element.
            // If it doesn't exist in your HTML, this part won't have a visible effect.
            // For this specific HTML, there is no 'migration-section'.
            // const migrationSection = document.getElementById('migration-section');
            
            if (localData && JSON.parse(localData).length > 0) {
                // if (migrationSection) migrationSection.style.display = 'block';
                console.warn('Local data found. Consider adding a UI element for migration if not present.'); // Added warning
            } else {
                // if (migrationSection) migrationSection.style.display = 'none';
            }
        }

        function updateUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = 
                '<div class="user-name">👋 ' + (user.displayName || user.email) + '</div>' +
                '<button type="button" id="logout-button">Uitloggen</button>';
            
            // Fix: Attach event listener with a small delay to ensure element is rendered
            setTimeout(() => {
                const logoutBtn = document.getElementById('logout-button');
                if (logoutBtn) {
                    // Changed from directly assigning onclick to addEventListener for better practice and reliability
                    logoutBtn.addEventListener('click', function() { 
                        console.log('Logout button clicked');
                        signOut(auth).then(() => {
                            console.log('Successfully signed out');
                            // After signOut, onAuthStateChanged will handle showLoginScreen()
                        }).catch((error) => {
                            console.error('Sign out error:', error);
                            alert('Uitloggen mislukt: ' + error.message);
                        });
                    });
                } else {
                    console.error("Logout button not found after updateUserInfo. Possible timing issue.");
                }
            }, 100); // Small delay to allow DOM to update
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        // Authentication functions
        window.signInWithGoogle = async function() {
            try {
                // Set persistence to local (keep signed in)
                await setPersistence(auth, browserLocalPersistence);
                
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                console.log('✅ Google sign-in successful:', result.user.email);
            } catch (error) {
                console.error('❌ Google sign-in error:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('Inloggen met Google mislukt: Popup geblokkeerd. Sta pop-ups toe voor deze site en probeer opnieuw.');
                } else if (error.code === 'auth/cancelled-popup-request' || error.code === 'auth/web-storage-unsupported') {
                    // Specific message for user cancellation or storage issues
                    alert('Inloggen met Google geannuleerd of mislukt. Probeer het opnieuw.');
                }
                else {
                    alert('Google inloggen mislukt: ' + error.message);
                }
            }
        };

        window.showRegisterForm = function() {
            document.getElementById('register-modal').classList.add('show');
        };

        window.closeRegisterModal = function() {
            document.getElementById('register-modal').classList.remove('show');
            // Reset form
            document.getElementById('register-form').reset();
        };

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMeCheckbox = document.getElementById('remember-me');
            const rememberMe = rememberMeCheckbox ? rememberMeCheckbox.checked : true;
            
            console.log('Login attempt:', { email, rememberMe });
            
            try {
                // Set persistence based on checkbox
                if (rememberMe) {
                    console.log('Setting local persistence (stay logged in)');
                    await setPersistence(auth, browserLocalPersistence);
                } else {
                    console.log('Setting session persistence (logout when browser closes)');
                    await setPersistence(auth, browserSessionPersistence);
                }
                
                await signInWithEmailAndPassword(auth, email, password);
                console.log('✅ Email sign-in successful');
            } catch (error) {
                console.error('❌ Email sign-in error:', error);
                alert('Inloggen mislukt: ' + error.message);
            }
        });

        // Register form handler
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                // Set persistence to local (keep signed in)
                await setPersistence(auth, browserLocalPersistence);
                
                const result = await createUserWithEmailAndPassword(auth, email, password);
                
                // Update user profile with name
                await updateProfile(result.user, {
                    displayName: name
                });
                
                console.log('✅ Account created successfully');
                closeRegisterModal();
                
            } catch (error) {
                console.error('❌ Registration error:', error);
                alert('Account aanmaken mislukt: ' + error.message);
            }
        });

        // Firebase functies
        async function saveToFirestore(entry) {
            if (!isFirebaseConnected || !currentUser) {
                // Fallback naar localStorage
                const stored = JSON.parse(localStorage.getItem('ademruimte-entries') || '[]');
                const entryWithId = { ...entry, id: Date.now().toString(), bron: 'Lokaal', userId: 'local' };
                stored.unshift(entryWithId);
                localStorage.setItem('ademruimte-entries', JSON.stringify(stored));
                console.log('✅ Entry saved to localStorage (Firebase not connected or no user).');
                return { id: entryWithId.id, success: true };
            }

            try {
                const docRef = await addDoc(collection(db, "dagboekEntries"), {
                    ...entry,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                
                console.log('✅ Entry saved to Firebase with ID:', docRef.id);
                return { id: docRef.id, success: true };
                
            } catch (error) {
                console.error('❌ Error saving to Firestore:', error);
                // Fallback naar localStorage and display Firebase error message to user
                const stored = JSON.parse(localStorage.getItem('ademruimte-entries') || '[]');
                const entryWithId = { ...entry, id: Date.now().toString(), bron: `Lokaal (Firebase fout: ${error.message.substring(0, 50)}...)`, userId: currentUser?.uid || 'local' }; // Truncate error message
                stored.unshift(entryWithId);
                localStorage.setItem('ademruimte-entries', JSON.stringify(stored));
                alert(`Fout bij opslaan in Firebase: ${error.message}. Gegevens lokaal opgeslagen.`); // Alert user about the specific error
                return { id: entryWithId.id, success: false, error: error.message };
            }
        }

        async function loadFromFirestore() {
            if (!isFirebaseConnected || !currentUser) {
                // Load from localStorage
                const stored = localStorage.getItem('ademruimte-entries');
                console.log('✅ Loaded from localStorage (Firebase not connected or no user).');
                return stored ? JSON.parse(stored) : [];
            }

            try {
                const q = query(
                    collection(db, "dagboekEntries"), 
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                const querySnapshot = await getDocs(q);
                
                const entries = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    entries.push({
                        id: doc.id,
                        ...data,
                        tijdstempel: data.timestamp ? data.timestamp.toDate().toLocaleString('nl-BE') : 'Onbekend',
                        bron: "Cloud"
                    });
                });
                
                console.log('✅ Loaded', entries.length, 'entries from Firebase for user:', currentUser.email);
                return entries;
                
            } catch (error) {
                console.error('❌ Error loading from Firestore:', error);
                // Fallback naar localStorage
                const stored = localStorage.getItem('ademruimte-entries');
                alert(`Fout bij laden vanuit Firebase: ${error.message}. Lokale gegevens worden geladen.`); // Alert user about the specific error
                return stored ? JSON.parse(stored) : [];
            }
        }

        // Data migration function
        window.migrateLocalData = async function() {
            if (!currentUser) {
                alert('❌ Je moet ingelogd zijn om data te migreren');
                return;
            }

            const localData = localStorage.getItem('ademruimte-entries');
            if (!localData) {
                alert('📝 Geen lokale data gevonden om te migreren');
                return;
            }

            const entries = JSON.parse(localData);
            if (entries.length === 0) {
                alert('📝 Geen entries gevonden om te migreren');
                return;
            }

            const confirmMigration = confirm(
                `🔄 Data Migratie\n\n` +
                `Er zijn ${entries.length} lokale entries gevonden.\n` +
                `Wil je deze migreren naar je cloud account?\n\n` +
                `Dit zal ze toevoegen aan je cloud opslag.`
            );

            if (!confirmMigration) return;

            try {
                let migratedCount = 0;
                
                for (const entry of entries) {
                    // Skip entries that are already marked as cloud entries or belong to the current user (if user ID is present)
                    if (entry.bron === 'Cloud' || (entry.userId && entry.userId === currentUser.uid)) {
                        continue;
                    }

                    // Clean entry for migration - ensure only necessary fields are sent
                    const cleanEntry = {
                        techniekGebruikt: entry.techniekGebruikt,
                        trigger: entry.trigger,
                        intensiteitVoor: entry.intensiteitVoor,
                        intensiteitNa: entry.intensiteitNa,
                        resultaat: entry.resultaat,
                        notities: entry.notities,
                        // Do not include 'tijdstempel' from local storage directly if using serverTimestamp in Firestore
                        // Firebase will set its own timestamp. If you want to preserve the client-side timestamp, store it in another field.
                        // For simplicity, we'll let Firestore set it here.
                    };

                    const result = await saveToFirestore(cleanEntry); // Use the existing save function
                    if (result.success) {
                        migratedCount++;
                    } else {
                        console.warn('Skipped migration of an entry due to Firebase error:', result.error);
                    }
                }

                if (migratedCount > 0) {
                    alert(`✅ Migratie Voltooid!\n\n${migratedCount} entries zijn succesvol gemigreerd naar je cloud account.`);
                    
                    // Clear local storage after successful migration
                    localStorage.removeItem('ademruimte-entries');
                    
                    // Hide migration section (if it exists, though not in this HTML)
                    // const migrationSection = document.getElementById('migration-section');
                    // if (migrationSection) migrationSection.style.display = 'none';
                    
                    // Reload entries
                    await loadDagboekEntries();
                } else {
                    alert('📝 Geen nieuwe entries gevonden om te migreren of al gemigreerd.');
                }
                
            } catch (error) {
                console.error('❌ Migration error:', error);
                alert('❌ Migratie mislukt: ' + error.message);
            }
        };

        // Buteyko breathing exercise functions
        window.toggleBreathExercise = function() {
            if (breathInterval) {
                stopBreathExercise();
            } else {
                startBreathExercise();
            }
        };

        window.resetBreathExercise = function() {
            stopBreathExercise();
            breathCycleCount = 0;
            breathPhase = 'rest';
            updateBreathDisplay();
            updateBreathProgress(0);
            document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 0';
            document.getElementById('breath-complete').classList.add('hidden');
        };

        function startBreathExercise() {
            const inhale = parseInt(document.getElementById('inhale-duration').value);
            const exhale = parseInt(document.getElementById('exhale-duration').value);
            const hold = parseInt(document.getElementById('hold-duration').value);
            
            breathCycleDuration = inhale + exhale + hold;
            breathPhase = 'inhale';
            breathPhaseTime = 0;
            
            document.getElementById('breath-btn').innerHTML = '⏸️ Stop Buteyko';
            document.getElementById('breath-btn').className = 'btn btn-red';
            
            breathInterval = setInterval(() => {
                updateBreathCycle();
            }, 100);
        }

        function stopBreathExercise() {
            if (breathInterval) {
                clearInterval(breathInterval);
                breathInterval = null;
            }
            
            breathPhase = 'rest';
            updateBreathDisplay();
            updateBreathProgress(0);
            
            document.getElementById('breath-btn').innerHTML = '▶️ Start Buteyko';
            document.getElementById('breath-btn').className = 'btn btn-cyan';
        }

        function updateBreathCycle() {
            const inhale = parseInt(document.getElementById('inhale-duration').value);
            const exhale = parseInt(document.getElementById('exhale-duration').value);
            const hold = parseInt(document.getElementById('hold-duration').value);
            
            breathPhaseTime += 0.1;
            
            // Update phase based on timing
            let progress = 0;
            
            if (breathPhase === 'inhale') {
                progress = (breathPhaseTime / inhale) * 100;
                if (breathPhaseTime >= inhale) {
                    breathPhase = 'exhale';
                    breathPhaseTime = 0;
                }
            } else if (breathPhase === 'exhale') {
                progress = (breathPhaseTime / exhale) * 100;
                if (breathPhaseTime >= exhale) {
                    breathPhase = 'hold';
                    breathPhaseTime = 0;
                }
            } else if (breathPhase === 'hold') {
                progress = (breathPhaseTime / hold) * 100;
                if (breathPhaseTime >= hold) {
                    breathPhase = 'inhale';
                    breathPhaseTime = 0;
                    breathCycleCount++;
                    document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}`;
                    
                    // Complete after 10 cycles
                    if (breathCycleCount >= 10) {
                        stopBreathExercise();
                        document.getElementById('breath-complete').classList.remove('hidden');
                        return;
                    }
                }
            }
            
            updateBreathDisplay();
            updateBreathProgress(Math.min(progress, 100));
        }

        function updateBreathDisplay() {
            const display = document.getElementById('breath-display');
            const progressBar = document.getElementById('breath-progress');
            
            display.className = `breath-display ${breathPhase}`;
            progressBar.className = `breath-progress ${breathPhase}`;
            
            switch (breathPhase) {
                case 'inhale':
                    display.textContent = '🌬️ Inademen';
                    break;
                case 'exhale':
                    display.textContent = '💨 Uitademen';
                    break;
                case 'hold':
                    display.textContent = '⏸️ Pauze';
                    break;
                case 'rest':
                default:
                    display.textContent = 'Klik op start om te beginnen';
                    break;
            }
        }

        function updateBreathProgress(percentage) {
            document.getElementById('breath-progress').style.width = percentage + '%';
        }

        // Bilateral audio functions for EMDR
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('✅ Audio context initialized');
                } catch (error) {
                    console.error('❌ Audio context initialization failed:', error);
                    alert('Je browser ondersteunt geen Web Audio API. Probeer een moderne browser.');
                    return false;
                }
            }
            return true;
        }

        window.toggleBilateralAudio = function() {
            if (isAudioPlaying) {
                stopBilateralAudio();
            } else {
                startBilateralAudio();
            }
        };

        function startBilateralAudio() {
            if (!initAudioContext()) return;

            try {
                // Resume audio context if suspended (required by some browsers)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create oscillator for 880Hz tone
                oscillator = audioContext.createOscillator();
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5 note
                oscillator.type = 'sine'; // Smooth sine wave

                // Create gain node for volume control
                gainNode = audioContext.createGain();
                const volume = parseInt(document.getElementById('audio-volume').value) / 100;
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime); // Keep it gentle

                // Create stereo panner for left-right movement
                pannerNode = audioContext.createStereoPanner();
                pannerNode.pan.setValueAtTime(-1, audioContext.currentTime); // Start left

                // Connect audio nodes
                oscillator.connect(gainNode);
                gainNode.connect(pannerNode);
                pannerNode.connect(audioContext.destination);

                // Start oscillator
                oscillator.start();

                // Start panning animation
                startPanning();

                isAudioPlaying = true;
                document.getElementById('audio-btn').innerHTML = '⏸️ Pause Audio';
                document.getElementById('audio-btn').className = 'btn btn-red';
                document.getElementById('audio-status').textContent = 'Actief - Links naar Rechts';
                document.getElementById('audio-status').style.color = '#059669';

                console.log('✅ Bilateral audio started');

            } catch (error) {
                console.error('❌ Error starting bilateral audio:', error);
                alert('Fout bij starten audio: ' + error.message);
            }
        }

        function stopBilateralAudio() {
            try {
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                    oscillator = null;
                }

                if (gainNode) {
                    gainNode.disconnect();
                    gainNode = null;
                }

                if (pannerNode) {
                    pannerNode.disconnect();
                    pannerNode = null;
                }

                if (audioInterval) {
                    clearInterval(audioInterval);
                    audioInterval = null;
                }

                isAudioPlaying = false;
                panPosition = -1; // Reset to left
                
                document.getElementById('audio-btn').innerHTML = '🔊 Start Audio';
                document.getElementById('audio-btn').className = 'btn btn-purple';
                document.getElementById('audio-status').textContent = 'Gestopt';
                document.getElementById('audio-status').style.color = '#6b7280';

                console.log('✅ Bilateral audio stopped');

            } catch (error) {
                console.error('❌ Error stopping bilateral audio:', error);
            }
        }

        function startPanning() {
            const speed = parseFloat(document.getElementById('audio-speed').value) * 1000; // Convert to milliseconds
            const updateInterval = 50; // Update every 50ms for smooth movement
            const steps = speed / updateInterval;
            const panStep = 2 / steps; // Move from -1 to 1 in calculated steps

            panPosition = -1; // Start left
            let direction = 1; // 1 = right, -1 = left

            audioInterval = setInterval(() => {
                if (!isAudioPlaying || !pannerNode) {
                    clearInterval(audioInterval);
                    return;
                }

                panPosition += (panStep * direction);

                // Reverse direction at extremes
                if (panPosition >= 1) {
                    panPosition = 1;
                    direction = -1;
                } else if (panPosition <= -1) {
                    panPosition = -1;
                    direction = 1;
                }

                // Update panner
                pannerNode.pan.setValueAtTime(panPosition, audioContext.currentTime);

                // Update status
                const side = panPosition < -0.3 ? 'Links' : panPosition > 0.3 ? 'Rechts' : 'Midden';
                document.getElementById('audio-status').textContent = `Actief - ${side}`;

            }, updateInterval);
        }

        // Update audio settings while playing
        function updateAudioSettings() {
            if (isAudioPlaying && gainNode) {
                const volume = parseInt(document.getElementById('audio-volume').value) / 100;
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
            }
        }

        // Add event listeners for audio controls
        document.addEventListener('DOMContentLoaded', function() {
            // Audio volume control
            const volumeControl = document.getElementById('audio-volume');
            if (volumeControl) {
                volumeControl.addEventListener('input', updateAudioSettings);
            }

            // Speed control (restart audio if playing to apply new speed)
            const speedControl = document.getElementById('audio-speed');
            if (speedControl) {
                speedControl.addEventListener('change', function() {
                    if (isAudioPlaying) {
                        stopBilateralAudio();
                        setTimeout(startBilateralAudio, 100);
                    }
                });
            }
        });

        // Ritual steps
        const ritualSteps = [
            {
                title: "Stap 1: Fysieke Mini-Reset",
                duration: 120,
                instructions: [
                    "Sta op en strek je volledig uit",
                    "Schud je armen en benen los",
