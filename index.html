<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Evidence-based hulp bij hyperventilatie en maagklachten">
    <title>Ademruimte - Hyperventilatie Helper</title>

<style>
    :root {
        --primary-color: #06b6d4;
        --primary-dark: #0891b2;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --bg-card: rgba(255, 255, 255, 0.95);
        --border-radius: 1rem;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        min-height: 100vh;
        line-height: 1.6;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        min-height: calc(100vh - 120px);
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        box-shadow: var(--shadow);
    }

    .user-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 0.75rem;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }

    header h1 {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    header p {
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        opacity: 0.9;
    }

    /* Navigation */
    .nav-tabs {
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        padding: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        overflow-x: auto;
        border-bottom: 2px solid rgba(6, 182, 212, 0.1);
    }

    .nav-tabs button {
        background: none;
        border: 2px solid transparent;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: var(--transition);
        white-space: nowrap;
        color: var(--text-light);
        min-height: 44px;
    }

    .nav-tabs button:hover {
        background: rgba(6, 182, 212, 0.1);
        color: var(--primary-color);
        transform: translateY(-1px);
    }

    .nav-tabs button.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    /* Cards */
    .card {
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #06b6d4, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
    }

    /* Buttons */
    .btn {
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: var(--transition);
        text-align: center;
        display: inline-block;
        text-decoration: none;
        min-height: 44px;
        box-shadow: var(--shadow);
        font-family: inherit;
        touch-action: manipulation;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-cyan {
        background: var(--primary-color);
        color: white;
    }

    .btn-cyan:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
    }

    .btn-warning {
        background: var(--warning-color);
        color: white;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Forms */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        min-height: 44px;
        font-family: inherit;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    /* Range Slider */
    .range-group {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .range-input {
        flex: 1;
        height: 8px;
        background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
        border-radius: 4px;
        outline: none;
        -webkit-appearance: none;
    }

    .range-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    .range-value {
        font-weight: bold;
        color: var(--primary-color);
        min-width: 3rem;
        text-align: center;
    }

    /* Buteyko Timer */
    .timer-display {
        font-size: 4rem;
        font-weight: bold;
        text-align: center;
        color: var(--primary-color);
        margin: 2rem 0;
        font-family: 'Courier New', monospace;
        text-shadow: 0 2px 4px rgba(6, 182, 212, 0.2);
    }

    .breath-display {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        margin: 2rem 0;
        padding: 2rem;
        border-radius: 1.5rem;
        transition: all 0.3s ease;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
    }

    .breath-display.rest {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        color: var(--text-light);
    }

    .breath-display.inhale {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        transform: scale(1.05);
    }

    .breath-display.exhale {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        transform: scale(0.95);
    }

    .breath-display.hold {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        transform: scale(1.02);
    }

    /* Progress Bar */
    .progress-bar {
        width: 100%;
        height: 12px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        margin: 1rem 0;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
        height: 100%;
        background: var(--success-color);
        border-radius: 6px;
        transition: width 0.3s ease;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .stat-card {
        background: rgba(6, 182, 212, 0.1);
        border: 2px solid rgba(6, 182, 212, 0.2);
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition);
    }

    .stat-card:hover {
        border-color: var(--primary-color);
        background: rgba(6, 182, 212, 0.15);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-color);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-light);
        font-weight: 500;
    }

    /* Crisis Steps */
    .crisis-step {
        background: white;
        border-left: 4px solid var(--danger-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow);
    }

    .crisis-step h4 {
        color: var(--danger-color);
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }

    .crisis-step.active {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(255, 255, 255, 0.95));
    }

    .crisis-step.active h4 {
        color: var(--success-color);
    }

    /* Alerts */
    .alert {
        padding: 1.5rem;
        border-radius: 1rem;
        margin-bottom: 1.5rem;
        border: 2px solid;
    }

    .alert-info {
        background: rgba(219, 234, 254, 0.9);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .alert-success {
        background: rgba(209, 250, 229, 0.9);
        border-color: var(--success-color);
        color: #065f46;
    }

    .alert-warning {
        background: rgba(254, 243, 199, 0.9);
        border-color: var(--warning-color);
        color: #92400e;
    }

    .alert-danger {
        background: rgba(254, 226, 226, 0.9);
        border-color: var(--danger-color);
        color: #991b1b;
    }

    /* Login Screen */
    #login-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
    }

    .login-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 400px;
    }

    .google-btn {
        width: 100%;
        padding: 1rem;
        border: 2px solid #d1d5db;
        border-radius: 0.75rem;
        background: white;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s;
        min-height: 44px;
    }

    .google-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
        color: var(--text-light);
    }

    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e5e7eb;
    }

    .divider span {
        background: white;
        padding: 0 1rem;
        position: relative;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            padding: 0.5rem;
        }
        
        .nav-tabs {
            padding: 0.5rem;
            gap: 0.5rem;
        }
        
        .nav-tabs button {
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
        }
        
        .timer-display {
            font-size: 3rem;
        }
        
        .breath-display {
            font-size: 1.5rem;
            padding: 1.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .stat-number {
            font-size: 2rem;
        }
    }

    /* Hidden utility */
    .hidden {
        display: none !important;
    }

    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 1.2rem;
        height: 1.2rem;
        border: 3px solid #f3f4f6;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* User Message */
    .user-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        max-width: 90vw;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        font-weight: 500;
        border: 2px solid;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(15px);
        animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Symptom Tracker */
    .symptom-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .symptom-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: var(--transition);
    }

    .symptom-card.selected {
        border-color: var(--primary-color);
        background: rgba(6, 182, 212, 0.05);
    }

    .symptom-checkbox {
        margin-right: 0.5rem;
        transform: scale(1.2);
    }

    /* Chart Container */
    .chart-container {
        background: white;
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: var(--shadow);
        margin: 1rem 0;
        min-height: 300px;
        position: relative;
    }

    .chart-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: var(--text-light);
        font-size: 1.1rem;
    }
</style>
</head>

<body>
    <div id="login-screen">
        <div class="login-card">
            <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">
                Welkom bij Ademruimte
            </h2>
            
            <p style="text-align: center; margin-bottom: 2rem; color: var(--text-light);">
                Evidence-based hulp bij hyperventilatie en maagklachten
            </p>

            <button id="google-login-btn" class="google-btn">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="google-btn-text">Doorgaan met Google</span>
            </button>

            <div class="divider">
                <span>of</span>
            </div>

            <form id="login-form">
                <div class="form-group">
                    <label for="login-email" class="form-label">E-mail:</label>
                    <input type="email" id="login-email" class="form-input" placeholder="jouw@email.com" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Wachtwoord:</label>
                    <input type="password" id="login-password" class="form-input" placeholder="Wachtwoord" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Inloggen
                </button>
            </form>

            <p style="text-align: center; color: var(--text-light); margin-top: 1rem; font-size: 0.9rem;">
                Nog geen account? <button id="show-register" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Registreren</button>
            </p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div class="user-info" id="user-info">
                <div class="spinner"></div>
            </div>
            <h1>Ademruimte</h1>
            <p>Evidence-based hulp bij hyperventilatie en maagklachten</p>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="buteyko">💨 Buteyko</button>
            <button class="tab-btn" data-tab="dagboek">📊 Dagboek</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis Hulp</button>
        </nav>

        <main class="container">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 id="dashboard-greeting">Welkom bij Ademruimte</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Op basis van wetenschappelijk onderzoek biedt Ademruimte effectieve hulp bij hyperventilatie en gerelateerde maagklachten. 
                        <strong>70-80% van de patiënten</strong> behaalt significante verbetering met de juiste technieken.
                    </p>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">-</div>
                            <div class="stat-label">Gem. verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="last-cp">-</div>
                            <div class="stat-label">Laatste CP (sec)</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>🧠 Wetenschappelijke basis:</strong> 
                    Onderzoek toont dat hyperventilatie en maagklachten via de darm-brein-as en nervus vagus met elkaar verbonden zijn. 
                    Buteyko ademhaling helpt bij beide problemen door CO2 tolerantie te verbeteren.
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="card">
                        <h3>💨 Buteyko Training</h3>
                        <p>Wetenschappelijk bewezen effectief - symptomen kunnen binnen 2 dagen verbeteren</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>
                    <div class="card">
                        <h3>📊 Dagboek & Inzichten</h3>
                        <p>Track je vooruitgang en ontdek patronen</p>
                        <button class="btn btn-primary" onclick="showTab('dagboek')">Open Dagboek</button>
                    </div>
                    <div class="card">
                        <h3>🚨 Crisis Hulp</h3>
                        <p>Stap-voor-stap begeleiding tijdens acute klachten</p>
                        <button class="btn btn-danger" onclick="showTab('crisis')">Crisis Protocol</button>
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-danger" onclick="logout()" style="width: 100%;">
                        🚪 Uitloggen
                    </button>
                </div>
            </div>

            <!-- Buteyko -->
            <div id="buteyko" class="tab-content">
                <div class="card">
                    <h2>💨 Buteyko Ademhaling</h2>
                    <p style="margin-bottom: 1.5rem;">
                        De Buteyko methode heeft klinisch bewezen effectiviteit. 
                        <strong>Patiënten rapporteren vaak verbetering binnen 2 dagen</strong> van juiste toepassing.
                    </p>

                    <!-- CP Measurement -->
                    <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(16, 185, 129, 0.1)); 
                                border: 3px solid var(--primary-color); border-radius: 1.5rem; padding: 2rem; 
                                text-align: center; margin: 2rem 0;">
                        <h3>🎯 Controle Pauze (CP) Meting</h3>
                        <p style="margin: 1rem 0; color: var(--text-light);">
                            Adem normaal uit en houd je adem tot de <strong>eerste neiging</strong> om te ademen
                        </p>
                        
                        <div class="timer-display" id="cp-timer">00:00</div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem;">
                            <button id="cp-start-btn" class="btn btn-cyan" onclick="startCP()">
                                ⏱️ Start CP Meting
                            </button>
                            <button id="cp-stop-btn" class="btn btn-danger" onclick="stopCP()" style="display: none;">
                                ⏹️ Stop
                            </button>
                            <button class="btn btn-warning" onclick="resetCP()">
                                🔄 Reset
                            </button>
                        </div>
                        
                        <div id="cp-result" class="alert alert-success" style="display: none; margin-top: 1.5rem;">
                            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="cp-score">
                                20 seconden
                            </div>
                            <div id="cp-interpretation">
                                Gemiddelde CO2 tolerantie. Doorgaan met oefenen kan dit verbeteren.
                            </div>
                        </div>
                    </div>

                    <!-- Breathing Exercise -->
                    <div style="margin: 2rem 0;">
                        <h3>🫁 Ademhalingsoefening</h3>
                        <p style="margin-bottom: 1rem; color: var(--text-light);">
                            Volg het ritme: 4 sec inademen, 6 sec uitademen, 3 sec pauze
                        </p>
                        
                        <div class="breath-display rest" id="breath-display">
                            Klik op start om te beginnen
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="breath-progress" style="width: 0%;"></div>
                        </div>
                        
                        <div style="text-align: center; margin: 1.5rem 0;">
                            <div style="font-size: 1.25rem; color: var(--primary-color); margin-bottom: 1rem; font-weight: 600;" id="breath-counter">
                                Cyclus: 1/10
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathing()">
                                    ▶️ Start Oefening
                                </button>
                                <button class="btn btn-warning" onclick="resetBreathing()">
                                    🔄 Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="breath-complete" class="alert alert-success" style="display: none;">
                        <strong>✅ Buteyko Sessie Voltooid!</strong><br>
                        Geweldig! Je hebt 10 ademhalingscycli succesvol afgerond.
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openJournalModal('Buteyko Ademhaling - 10 cycli')">
                                📝 Toevoegen aan Dagboek
                            </button>
                            <button class="btn btn-warning" onclick="completeBreathing()">
                                ⏭️ Voltooien
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>📚 Buteyko Principes</h3>
                    <div class="crisis-step">
                        <h4>💨 Zachte Ademhaling</h4>
                        <p>Adem zo zacht mogelijk - stel je voor dat je een veertje voor je neus niet wilt laten bewegen.</p>
                    </div>
                    <div class="crisis-step">
                        <h4>⏬ Langere Uitademing</h4>
                        <p>De uitademing is langer dan de inademing om CO2 te behouden en het zenuwstelsel te kalmeren.</p>
                    </div>
                    <div class="crisis-step">
                        <h4>⏸️ Comfortabele Pauze</h4>
                        <p>De adempauze mag nooit geforceerd aanvoelen - stop als het oncomfortabel wordt.</p>
                    </div>
                    <div class="crisis-step">
                        <h4>📊 CP Score Interpretatie</h4>
                        <p><strong>10-20 sec:</strong> Lage CO2 tolerantie, meer oefening nodig<br>
                        <strong>20-40 sec:</strong> Gemiddeld, goede basis voor verbetering<br>
                        <strong>40+ sec:</strong> Goede CO2 tolerantie</p>
                    </div>
                </div>
            </div>

            <!-- Dagboek -->
            <div id="dagboek" class="tab-content">
                <div class="card">
                    <h2>📊 Dagboek & Vooruitgang</h2>
                    <p style="margin-bottom: 1.5rem;">
                        Track je symptomen en vooruitgang. Vroege interventie en patroonherkenning zijn cruciaal voor herstel.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                        <button class="btn btn-primary" onclick="openJournalModal('Handmatige Entry')">
                            ➕ Nieuwe Entry
                        </button>
                        <button class="btn btn-success" onclick="loadJournalEntries()">
                            🔄 Vernieuwen
                        </button>
                        <button class="btn btn-warning" onclick="exportJournal()">
                            📥 Export
                        </button>
                    </div>
                </div>

                <!-- Insights -->
                <div class="card" id="insights-card" style="display: none;">
                    <h3>🧠 Slimme Inzichten</h3>
                    <div id="insights-content"></div>
                </div>

                <!-- Progress Chart -->
                <div class="card">
                    <h3>📈 Vooruitgang Grafiek</h3>
                    <div class="chart-container" id="chart-container">
                        <div class="chart-empty" id="chart-empty">
                            Nog geen data beschikbaar. Maak enkele dagboekentries om je vooruitgang te zien!
                        </div>
                        <canvas id="progress-chart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- Journal Entries -->
                <div id="journal-entries"></div>
            </div>

            <!-- Crisis Hulp -->
            <div id="crisis" class="tab-content">
                <div class="card">
                    <h2>🚨 Crisis Hulp Protocol</h2>
                    <p style="margin-bottom: 1.5rem;">
                        Stap-voor-stap begeleiding tijdens acute hyperventilatie. 
                        <strong>Onderzoek toont dat gestructureerde interventie zeer effectief is.</strong>
                    </p>
                    
                    <div id="crisis-timer" class="timer-display" style="display: none;">05:00</div>
                    
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <button id="crisis-start-btn" class="btn btn-danger" onclick="startCrisis()">
                            🚨 Start Crisis Protocol
                        </button>
                        <button id="crisis-stop-btn" class="btn btn-success" onclick="stopCrisis()" style="display: none;">
                            ✅ Stop Protocol
                        </button>
                    </div>
                    
                    <div class="progress-bar" id="crisis-progress-bar" style="display: none;">
                        <div class="progress-fill" id="crisis-progress" style="width: 0%;"></div>
                    </div>
                </div>

                <div id="crisis-steps">
                    <div class="crisis-step" data-step="1">
                        <h4>1. Erken de Situatie (1 min)</h4>
                        <p><strong>Zeg tegen jezelf:</strong> "Dit is hyperventilatie, niet gevaarlijk. Het gaat voorbij."</p>
                        <p>Zoek een rustige plek en ga zitten of liggen.</p>
                    </div>

                    <div class="crisis-step" data-step="2">
                        <h4>2. Paradoxale Ademhaling (1 min)</h4>
                        <p>Start met bewust <strong>zeer kleine, korte ademhalingen</strong> door je neus.</p>
                        <p>Na 3-4 mini-ademhalingen, probeer een iets langere uitademing.</p>
                    </div>

                    <div class="crisis-step" data-step="3">
                        <h4>3. Purse-Lip Ademhaling (1 min)</h4>
                        <p>Tuut je lippen alsof je fluit bij het uitademen.</p>
                        <p>Dit creëert lichte weerstand en stabiliseert CO2-niveaus.</p>
                    </div>

                    <div class="crisis-step" data-step="4">
                        <h4>4. 5-4-3-2-1 Grounding (1 min)</h4>
                        <p>Benoem bewust:</p>
                        <p><strong>5 dingen die je ZIET - 4 dingen die je VOELT - 3 dingen die je HOORT - 2 dingen die je RUIKT - 1 ding dat je PROEFT</strong></p>
                    </div>

                    <div class="crisis-step" data-step="5">
                        <h4>5. Evaluatie & Vervolgstappen (1 min)</h4>
                        <p>Hoe voel je je nu op een schaal van 1-10?</p>
                        <p>Als nog steeds >5: herhaal stap 2-4. Als beter: maak een dagboek entry.</p>
                    </div>
                </div>

                <div id="crisis-complete" class="alert alert-success" style="display: none;">
                    <strong>✅ Crisis Protocol Voltooid!</strong><br>
                    Je hebt alle 5 stappen doorlopen. Hoe voel je je nu?
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="openJournalModal('Crisis Hulp Protocol')">
                            📝 Toevoegen aan Dagboek
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>❄️ Aanvullende Crisis Technieken</h3>
                    <div class="crisis-step">
                        <h4>IJswater Techniek</h4>
                        <p>Breng iets kouds tegen je gezicht (wangen en ogen) om de duikreflex te activeren.</p>
                    </div>
                    <div class="crisis-step">
                        <h4>Herframing</h4>
                        <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Journal Modal -->
    <div id="journal-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
         background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>📝 Dagboek Entry</h3>
                <button onclick="closeJournalModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <form id="journal-form">
                <div class="form-group">
                    <label class="form-label">Activiteit/Techniek:</label>
                    <input type="text" id="entry-technique" class="form-input" placeholder="Bijv. Buteyko oefening">
                </div>

                <div class="form-group">
                    <label class="form-label">Trigger/Situatie:</label>
                    <input type="text" id="entry-trigger" class="form-input" placeholder="Wat ging eraan vooraf?">
                </div>

                <!-- Symptom Tracker -->
                <div class="form-group">
                    <label class="form-label">Symptomen (vink aan wat van toepassing is):</label>
                    <div class="symptom-grid" id="symptom-tracker">
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="luchthonger"> Luchthonger/Dyspnoe
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="maagklachten"> Maagklachten/Reflux
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="angst"> Angst/Onrust
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="duizeligheid"> Duizeligheid
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="hartkloppingen"> Hartkloppingen
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="tintelingen"> Tintelingen
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="gapen"> Gaap-neiging
                        </label>
                        <label class="symptom-card">
                            <input type="checkbox" class="symptom-checkbox" data-symptom="concentratie"> Concentratieproblemen
                        </label>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Intensiteit vóór (1-10):</label>
                        <div class="range-group">
                            <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before" 
                                   oninput="document.getElementById('before-value').textContent = this.value">
                            <div class="range-value" id="before-value">5</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Intensiteit ná (1-10):</label>
                        <div class="range-group">
                            <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after" 
                                   oninput="document.getElementById('after-value').textContent = this.value">
                            <div class="range-value" id="after-value">5</div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="cp-score-group" style="display: none;">
                    <label class="form-label">Controle Pauze Score (seconden):</label>
                    <input type="number" id="entry-cp-score" class="form-input" placeholder="bijv. 25" min="1" max="300">
                </div>

                <div class="form-group">
                    <label class="form-label">Resultaat:</label>
                    <select id="entry-result" class="form-select">
                        <option value="">Selecteer resultaat...</option>
                        <option value="zeer-goed">Zeer goed - volledig opgelost</option>
                        <option value="goed">Goed - duidelijke verbetering</option>
                        <option value="matig">Matig - kleine verbetering</option>
                        <option value="geen-effect">Geen effect</option>
                        <option value="slechter">Iets slechter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notities:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op? Bijzonderheden?"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-primary" onclick="saveJournalEntry()" style="flex: 1;">
                        📁 Opslaan
                    </button>
                    <button type="button" class="btn btn-warning" onclick="closeJournalModal()" style="flex: 1;">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
    // App State
    let currentUser = null;
    let currentTab = 'dashboard';
    let allJournalEntries = [];
    
    // Buteyko state
    let cpInterval = null;
    let cpStartTime = 0;
    let cpIsRunning = false;
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycle = 1;
    let breathPhaseTime = 0;
    
    // Crisis state
    let crisisInterval = null;
    let crisisStep = 1;
    let crisisTimeLeft = 60; // 1 minute per step
    let crisisActive = false;
    
    // Gamification data
    let userStats = {
        totalSessions: 0,
        streakDays: 0,
        lastSessionDate: null,
        cpMeasurements: [],
        achievements: []
    };

    // Firebase config (exact same credentials)
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte.vercel.app", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Firebase modules
    let app, auth, db;

    // Initialize Firebase
    async function initFirebase() {
        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInWithRedirect, GoogleAuthProvider, getRedirectResult } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Check for redirect result
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    console.log('Google sign-in successful:', result.user.email);
                }
            } catch (error) {
                console.log('Redirect result error:', error);
            }

            // Auth state observer
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadJournalEntries();
                    updateDashboard();
                } else {
                    currentUser = null;
                    showLoginScreen();
                }
                updateUserInfo();
            });

            return true;
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            showUserMessage('Firebase kon niet worden geladen. Controleer je internetverbinding.', 'danger');
            return false;
        }
    }

    // Auth functions
    window.signInWithGoogle = async function() {
        try {
            const { GoogleAuthProvider, signInWithRedirect } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const provider = new GoogleAuthProvider();
            await signInWithRedirect(auth, provider);
        } catch (error) {
            console.error('Google sign-in failed:', error);
            showUserMessage('Google inloggen mislukt: ' + error.message, 'danger');
        }
    };

    async function signInWithEmail(email, password) {
        try {
            const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error('Email sign-in failed:', error);
            let message = 'Inloggen mislukt';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                message = 'Geen account gevonden met deze gegevens';
            } else if (error.code === 'auth/wrong-password') {
                message = 'Verkeerd wachtwoord';
            }
            showUserMessage(message, 'danger');
        }
    }

    window.logout = async function() {
        try {
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signOut(auth);
            showUserMessage('Succesvol uitgelogd!', 'success');
        } catch (error) {
            console.error('Logout failed:', error);
            showUserMessage('Uitloggen mislukt: ' + error.message, 'danger');
        }
    };

    // UI functions
    function showLoginScreen() {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        const greeting = document.getElementById('dashboard-greeting');
        
        if (currentUser) {
            const displayName = currentUser.displayName || currentUser.email;
            userInfo.innerHTML = displayName.length > 15 ? displayName.substring(0, 13) + '...' : displayName;
            
            if (greeting) {
                const firstName = currentUser.displayName ? currentUser.displayName.split(' ')[0] : 
                                 currentUser.email.split('@')[0];
                const hour = new Date().getHours();
                const timeOfDay = hour < 12 ? 'Goedemorgen' : hour < 18 ? 'Goedemiddag' : 'Goedenavond';
                greeting.textContent = `${timeOfDay}, ${firstName}!`;
            }
        } else {
            userInfo.innerHTML = '<div class="spinner"></div>';
        }
    }

    function showUserMessage(message, type = 'info') {
        const existing = document.querySelector('.user-message');
        if (existing) existing.remove();
        
        const messageEl = document.createElement('div');
        messageEl.className = `user-message alert-${type}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            if (messageEl.parentNode) messageEl.remove();
        }, 5000);
    }

    // Tab management
    window.showTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const selectedTab = document.getElementById(tabName);
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (selectedTab) selectedTab.classList.add('active');
        if (selectedBtn) selectedBtn.classList.add('active');
        
        currentTab = tabName;
        
        // Load tab-specific content
        if (tabName === 'dagboek') {
            loadJournalEntries();
        } else if (tabName === 'dashboard') {
            updateDashboard();
        }
    };

    // Buteyko functions
    window.startCP = function() {
        cpStartTime = Date.now();
        cpIsRunning = true;
        
        document.getElementById('cp-start-btn').style.display = 'none';
        document.getElementById('cp-stop-btn').style.display = 'inline-block';
        document.getElementById('cp-result').style.display = 'none';
        
        cpInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - cpStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('cp-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 100);
    };

    window.stopCP = function() {
        if (!cpIsRunning) return;
        
        const finalTime = Math.floor((Date.now() - cpStartTime) / 1000);
        cpIsRunning = false;
        
        clearInterval(cpInterval);
        
        document.getElementById('cp-start-btn').style.display = 'inline-block';
        document.getElementById('cp-stop-btn').style.display = 'none';
        
        displayCPResult(finalTime);
        
        // Store CP measurement
        userStats.cpMeasurements.push({
            score: finalTime,
            timestamp: new Date().toISOString()
        });
        
        // Set for journal entry
        window.lastCPScore = finalTime;
        
        saveUserStats();
        updateDashboard();
    };

    window.resetCP = function() {
        if (cpInterval) {
            clearInterval(cpInterval);
            cpInterval = null;
        }
        
        cpIsRunning = false;
        document.getElementById('cp-timer').textContent = '00:00';
        document.getElementById('cp-start-btn').style.display = 'inline-block';
        document.getElementById('cp-stop-btn').style.display = 'none';
        document.getElementById('cp-result').style.display = 'none';
        
        window.lastCPScore = null;
    };

    function displayCPResult(seconds) {
        const scoreEl = document.getElementById('cp-score');
        const interpretationEl = document.getElementById('cp-interpretation');
        
        scoreEl.textContent = `${seconds} seconden`;
        
        let interpretation;
        if (seconds < 10) {
            interpretation = 'Zeer lage CO2 tolerantie. Regelmatige oefening wordt sterk aangeraden.';
        } else if (seconds < 20) {
            interpretation = 'Lage CO2 tolerantie. Meer oefening kan dit verbeteren.';
        } else if (seconds < 40) {
            interpretation = 'Gemiddelde CO2 tolerantie. Doorgaan met oefenen kan dit verbeteren.';
        } else if (seconds < 60) {
            interpretation = 'Goede CO2 tolerantie. Houd dit niveau vast met regelmatige oefening.';
        } else {
            interpretation = 'Uitstekende CO2 tolerantie! Dit is een zeer goede score.';
        }
        
        interpretationEl.textContent = interpretation;
        document.getElementById('cp-result').style.display = 'block';
        
        showUserMessage(`CP Meting voltooid: ${seconds} seconden!`, 'success');
    }

    // Breathing exercise
    window.toggleBreathing = function() {
        if (breathInterval) {
            stopBreathing();
        } else {
            startBreathing();
        }
    };

    function startBreathing() {
        breathCycle = 1;
        breathPhase = 'inhale';
        breathPhaseTime = 0;
        
        document.getElementById('breath-btn').innerHTML = '⏸️ Stop Oefening';
        document.getElementById('breath-btn').className = 'btn btn-danger';
        
        breathInterval = setInterval(() => {
            updateBreathCycle();
        }, 100);
    }

    function stopBreathing() {
        if (breathInterval) {
            clearInterval(breathInterval);
            breathInterval = null;
        }
        
        document.getElementById('breath-btn').innerHTML = '▶️ Start Oefening';
        document.getElementById('breath-btn').className = 'btn btn-cyan';
        document.getElementById('breath-display').className = 'breath-display rest';
        document.getElementById('breath-display').textContent = 'Klik op start om te beginnen';
        document.getElementById('breath-progress').style.width = '0%';
    }

    function updateBreathCycle() {
        const inhaleDuration = 4;
        const exhaleDuration = 6;
        const holdDuration = 3;
        const totalDuration = inhaleDuration + exhaleDuration + holdDuration;
        
        breathPhaseTime += 0.1;
        
        let progress = 0;
        const display = document.getElementById('breath-display');
        
        if (breathPhase === 'inhale') {
            progress = (breathPhaseTime / inhaleDuration) * 100;
            display.className = 'breath-display inhale';
            display.textContent = '🌬️ Inademen';
            if (breathPhaseTime >= inhaleDuration) {
                breathPhase = 'exhale';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'exhale') {
            progress = (breathPhaseTime / exhaleDuration) * 100;
            display.className = 'breath-display exhale';
            display.textContent = '💨 Uitademen';
            if (breathPhaseTime >= exhaleDuration) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / holdDuration) * 100;
            display.className = 'breath-display hold';
            display.textContent = '⏸️ Pauze';
            if (breathPhaseTime >= holdDuration) {
                breathPhase = 'inhale';
                breathPhaseTime = 0;
                breathCycle++;
                document.getElementById('breath-counter').textContent = `Cyclus: ${breathCycle}/10`;
                
                if (breathCycle > 10) {
                    stopBreathing();
                    document.getElementById('breath-complete').style.display = 'block';
                    userStats.totalSessions++;
                    updateStreak();
                    saveUserStats();
                    updateDashboard();
                    showUserMessage('Buteyko sessie voltooid! 🎉', 'success');
                    return;
                }
            }
        }
        
        document.getElementById('breath-progress').style.width = Math.min(progress, 100) + '%';
    }

    window.resetBreathing = function() {
        stopBreathing();
        breathCycle = 1;
        document.getElementById('breath-counter').textContent = 'Cyclus: 1/10';
        document.getElementById('breath-complete').style.display = 'none';
    };

    window.completeBreathing = function() {
        document.getElementById('breath-complete').style.display = 'none';
        resetBreathing();
    };

    // Crisis protocol
    window.startCrisis = function() {
        crisisActive = true;
        crisisStep = 1;
        crisisTimeLeft = 60;
        
        document.getElementById('crisis-start-btn').style.display = 'none';
        document.getElementById('crisis-stop-btn').style.display = 'inline-block';
        document.getElementById('crisis-timer').style.display = 'block';
        document.getElementById('crisis-progress-bar').style.display = 'block';
        
        updateCrisisStep();
        
        crisisInterval = setInterval(() => {
            crisisTimeLeft--;
            updateCrisisTimer();
            
            if (crisisTimeLeft <= 0) {
                if (crisisStep < 5) {
                    crisisStep++;
                    crisisTimeLeft = 60;
                    updateCrisisStep();
                } else {
                    stopCrisis();
                    document.getElementById('crisis-complete').style.display = 'block';
                    showUserMessage('Crisis protocol voltooid! 💪', 'success');
                }
            }
        }, 1000);
    };

    window.stopCrisis = function() {
        crisisActive = false;
        
        if (crisisInterval) {
            clearInterval(crisisInterval);
            crisisInterval = null;
        }
        
        document.getElementById('crisis-start-btn').style.display = 'inline-block';
        document.getElementById('crisis-stop-btn').style.display = 'none';
        document.getElementById('crisis-timer').style.display = 'none';
        document.getElementById('crisis-progress-bar').style.display = 'none';
        
        // Reset all steps
        document.querySelectorAll('.crisis-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Track session
        userStats.totalSessions++;
        updateStreak();
        saveUserStats();
        updateDashboard();
    };

    function updateCrisisStep() {
        document.querySelectorAll('.crisis-step').forEach(step => {
            step.classList.remove('active');
        });
        
        const activeStep = document.querySelector(`.crisis-step[data-step="${crisisStep}"]`);
        if (activeStep) {
            activeStep.classList.add('active');
            activeStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        const progress = ((crisisStep - 1) / 5) * 100 + (crisisStep <= 5 ? ((60 - crisisTimeLeft) / 60) * 20 : 0);
        document.getElementById('crisis-progress').style.width = progress + '%';
    }

    function updateCrisisTimer() {
        const minutes = Math.floor(crisisTimeLeft / 60);
        const seconds = crisisTimeLeft % 60;
        document.getElementById('crisis-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        updateCrisisStep();
    }

    // Journal functions
    window.openJournalModal = function(technique = '') {
        document.getElementById('journal-modal').style.display = 'flex';
        
        // Pre-fill technique if provided
        if (technique) {
            document.getElementById('entry-technique').value = technique;
            
            // Show CP score field for Buteyko
            if (technique.includes('Buteyko') && window.lastCPScore) {
                document.getElementById('cp-score-group').style.display = 'block';
                document.getElementById('entry-cp-score').value = window.lastCPScore;
            }
            
            // Pre-set reasonable values for completed exercises
            if (technique.includes('Buteyko') || technique.includes('Crisis')) {
                document.getElementById('entry-before').value = 7;
                document.getElementById('before-value').textContent = '7';
                document.getElementById('entry-after').value = 3;
                document.getElementById('after-value').textContent = '3';
            }
        }
        
        // Reset form
        document.getElementById('entry-result').value = '';
        
        // Focus first input
        setTimeout(() => {
            document.getElementById('entry-technique').focus();
        }, 100);
    };

    window.closeJournalModal = function() {
        document.getElementById('journal-modal').style.display = 'none';
        
        // Reset form
        document.getElementById('journal-form').reset();
        document.getElementById('before-value').textContent = '5';
        document.getElementById('after-value').textContent = '5';
        document.getElementById('cp-score-group').style.display = 'none';
        
        // Reset symptom checkboxes
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    };

    window.saveJournalEntry = async function() {
        try {
            // Collect form data
            const symptoms = Array.from(document.querySelectorAll('.symptom-checkbox:checked'))
                                .map(cb => cb.dataset.symptom);
            
            const entry = {
                techniekGebruikt: document.getElementById('entry-technique').value || 'Handmatige Entry',
                trigger: document.getElementById('entry-trigger').value,
                symptomen: symptoms,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                timestamp: new Date(),
                userId: currentUser.uid,
                userEmail: currentUser.email
            };

            // Add CP score if available
            const cpScore = document.getElementById('entry-cp-score').value;
            if (cpScore && !isNaN(parseInt(cpScore))) {
                entry.cpScore = parseInt(cpScore);
            }

            if (!entry.resultaat) {
                showUserMessage('Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            // Save to Firestore
            const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            await addDoc(collection(db, "dagboekEntries"), entry);
            
            closeJournalModal();
            loadJournalEntries();
            updateDashboard();
            
            showUserMessage('✅ Dagboek entry opgeslagen!', 'success');
            
        } catch (error) {
            console.error('Save error:', error);
            showUserMessage('❌ Opslaan mislukt: ' + error.message, 'danger');
        }
    };

    async function loadJournalEntries() {
        if (!currentUser) return;
        
        try {
            const { getDocs, collection, query, where, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            const q = query(
                collection(db, "dagboekEntries"),
                where("userId", "==", currentUser.uid),
                orderBy("timestamp", "desc"),
                limit(50)
            );
            
            const snapshot = await getDocs(q);
            allJournalEntries = [];
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                allJournalEntries.push({
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                });
            });
            
            displayJournalEntries();
            generateInsights();
            createProgressChart();
            
        } catch (error) {
            console.error('Load entries failed:', error);
            showUserMessage('❌ Laden van entries mislukt: ' + error.message, 'danger');
        }
    }

    function displayJournalEntries() {
        const container = document.getElementById('journal-entries');
        
        if (!allJournalEntries.length) {
            container.innerHTML = `
                <div class="card">
                    <h3>Nog geen entries</h3>
                    <p>Maak een dagboekentry na het gebruiken van oefeningen om patronen bij te houden.</p>
                    <button class="btn btn-primary" onclick="openJournalModal('Eerste Entry')">
                        Maak je eerste entry
                    </button>
                </div>
            `;
            return;
        }
        
        let html = '<div class="card"><h3>📝 Recente Entries</h3>';
        
        allJournalEntries.slice(0, 10).forEach(entry => {
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            const improvementClass = improvement > 0 ? 'success' : improvement < 0 ? 'danger' : 'warning';
            const improvementText = improvement > 0 ? `↗️ +${improvement}` : improvement < 0 ? `↘️ ${improvement}` : '➡️ 0';
            
            html += `
                <div style="background: white; border-left: 4px solid var(--primary-color); 
                           border-radius: 0.5rem; padding: 1.5rem; margin: 1rem 0; box-shadow: var(--shadow);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <strong style="color: var(--primary-color);">${entry.techniekGebruikt}</strong>
                        <small style="color: var(--text-light);">${entry.timestamp.toLocaleDateString('nl-BE')} ${entry.timestamp.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                        <div>Vóór: <strong>${entry.intensiteitVoor}/10</strong></div>
                        <div>Ná: <strong>${entry.intensiteitNa}/10</strong></div>
                        <div class="alert-${improvementClass}" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; text-align: center; border: 1px solid;">
                            ${improvementText}
                        </div>
                    </div>
                    
                    ${entry.symptomen && entry.symptomen.length ? 
                        `<div style="margin-bottom: 0.75rem;">
                            <strong>Symptomen:</strong> ${entry.symptomen.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ')}
                        </div>` : ''
                    }
                    
                    ${entry.cpScore ? 
                        `<div style="margin-bottom: 0.75rem;">
                            <strong>CP Score:</strong> ${entry.cpScore} seconden
                        </div>` : ''
                    }
                    
                    ${entry.trigger ? `<p style="margin-bottom: 0.5rem;"><strong>Trigger:</strong> ${entry.trigger}</p>` : ''}
                    ${entry.notities ? `<p><strong>Notities:</strong> ${entry.notities}</p>` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function generateInsights() {
        const insightsCard = document.getElementById('insights-card');
        const insightsContent = document.getElementById('insights-content');
        
        if (allJournalEntries.length < 3) {
            insightsCard.style.display = 'none';
            return;
        }
        
        insightsCard.style.display = 'block';
        
        // Calculate insights based on research
        const recentEntries = allJournalEntries.slice(0, 10);
        const improvements = recentEntries.map(e => e.intensiteitVoor - e.intensiteitNa);
        const avgImprovement = improvements.reduce((sum, imp) => sum + imp, 0) / improvements.length;
        const successRate = (improvements.filter(imp => imp > 0).length / improvements.length) * 100;
        
        // Most common symptoms
        const allSymptoms = recentEntries.flatMap(e => e.symptomen || []);
        const symptomCounts = {};
        allSymptoms.forEach(symptom => {
            symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
        });
        const topSymptom = Object.keys(symptomCounts).reduce((a, b) => 
            symptomCounts[a] > symptomCounts[b] ? a : b, Object.keys(symptomCounts)[0]);
        
        // Best technique
        const techniques = {};
        recentEntries.forEach(entry => {
            if (!techniques[entry.techniekGebruikt]) {
                techniques[entry.techniekGebruikt] = [];
            }
            techniques[entry.techniekGebruikt].push(entry.intensiteitVoor - entry.intensiteitNa);
        });
        
        const bestTechnique = Object.keys(techniques).reduce((best, technique) => {
            const avgTechImprovement = techniques[technique].reduce((s, v) => s + v, 0) / techniques[technique].length;
            const bestAvg = techniques[best] ? techniques[best].reduce((s, v) => s + v, 0) / techniques[best].length : -999;
            return avgTechImprovement > bestAvg ? technique : best;
        }, Object.keys(techniques)[0]);

        let insights = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div class="stat-card">
                    <div class="stat-number">${avgImprovement.toFixed(1)}</div>
                    <div class="stat-label">Gem. Verbetering</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(successRate)}%</div>
                    <div class="stat-label">Succes Ratio</div>
                </div>
            </div>
        `;

        // Research-based insights
        if (avgImprovement > 2) {
            insights += `<div class="alert alert-success">
                <strong>🌟 Uitstekende vooruitgang!</strong> Je gemiddelde verbetering van ${avgImprovement.toFixed(1)} punten komt overeen met onderzoeksresultaten die tonen dat 70-80% van patiënten significante verbetering behaalt met de juiste technieken.
            </div>`;
        }

        if (bestTechnique) {
            insights += `<div class="alert alert-info">
                <strong>💡 Persoonlijk inzicht:</strong> ${bestTechnique} werkt het beste voor jou. Onderzoek toont dat gepersonaliseerde behandeling effectiever is.
            </div>`;
        }

        if (topSymptom === 'luchthonger' || topSymptom === 'maagklachten') {
            insights += `<div class="alert alert-info">
                <strong>🔬 Wetenschappelijk verband:</strong> Je ervaart voornamelijk ${topSymptom}. Onderzoek toont sterke verbanden tussen hyperventilatie en maagklachten via de darm-brein-as en nervus vagus.
            </div>`;
        }

        // Early intervention message
        if (allJournalEntries.length <= 10) {
            insights += `<div class="alert alert-success">
                <strong>⏰ Vroege interventie:</strong> Je bent op het juiste pad! Onderzoek toont dat vroege interventie dramatisch betere resultaten oplevert dan chronische behandeling.
            </div>`;
        }

        insightsContent.innerHTML = insights;
    }

    async function createProgressChart() {
        const chartContainer = document.getElementById('chart-container');
        const chartEmpty = document.getElementById('chart-empty');
        const canvas = document.getElementById('progress-chart');

        if (allJournalEntries.length < 2) {
            canvas.style.display = 'none';
            chartEmpty.style.display = 'flex';
            return;
        }

        chartEmpty.style.display = 'none';
        canvas.style.display = 'block';

        try {
            // Load Chart.js
            if (!window.Chart) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js';
                document.head.appendChild(script);
                
                await new Promise((resolve) => {
                    script.onload = resolve;
                });
            }

            const recentEntries = allJournalEntries.slice(0, 20).reverse(); // Last 20 entries, oldest first

            const ctx = canvas.getContext('2d');
            
            if (window.progressChart) {
                window.progressChart.destroy();
            }

            window.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentEntries.map((entry, index) => `${index + 1}`),
                    datasets: [
                        {
                            label: 'Vóór oefening',
                            data: recentEntries.map(entry => entry.intensiteitVoor),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            tension: 0.4
                        },
                        {
                            label: 'Ná oefening',
                            data: recentEntries.map(entry => entry.intensiteitNa),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Intensiteit (1-10)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sessies (meest recente)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const entry = recentEntries[index];
                                    return [
                                        `Techniek: ${entry.techniekGebruikt}`,
                                        `Verbetering: ${entry.intensiteitVoor - entry.intensiteitNa} punten`,
                                        entry.cpScore ? `CP Score: ${entry.cpScore}s` : ''
                                    ].filter(Boolean);
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Chart creation failed:', error);
            canvas.style.display = 'none';
            chartEmpty.style.display = 'flex';
            chartEmpty.textContent = 'Grafiek kon niet worden geladen';
        }
    }

    window.exportJournal = async function() {
        if (!allJournalEntries.length) {
            showUserMessage('Geen entries om te exporteren', 'warning');
            return;
        }

        let text = 'ADEMRUIMTE DAGBOEK EXPORT\n';
        text += '================================\n';
        text += `Gebruiker: ${currentUser.displayName || currentUser.email}\n`;
        text += `Export datum: ${new Date().toLocaleString('nl-BE')}\n\n`;

        allJournalEntries.forEach((entry, index) => {
            text += `ENTRY ${index + 1}\n`;
            text += `Datum: ${entry.timestamp.toLocaleString('nl-BE')}\n`;
            text += `Techniek: ${entry.techniekGebruikt}\n`;
            text += `Trigger: ${entry.trigger || 'Geen'}\n`;
            text += `Intensiteit vóór: ${entry.intensiteitVoor}/10\n`;
            text += `Intensiteit ná: ${entry.intensiteitNa}/10\n`;
            if (entry.cpScore) text += `CP Score: ${entry.cpScore} seconden\n`;
            if (entry.symptomen?.length) text += `Symptomen: ${entry.symptomen.join(', ')}\n`;
            text += `Resultaat: ${entry.resultaat}\n`;
            text += `Notities: ${entry.notities || 'Geen'}\n`;
            text += '\n---\n\n';
        });

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ademruimte-dagboek-${new Date().toLocaleDateString('nl-BE')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showUserMessage('📁 Dagboek geëxporteerd!', 'success');
    };

    // Gamification functions
    function updateStreak() {
        const today = new Date().toDateString();
        
        if (userStats.lastSessionDate !== today) {
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (userStats.lastSessionDate === yesterday || !userStats.lastSessionDate) {
                userStats.streakDays = (userStats.streakDays || 0) + 1;
            } else {
                userStats.streakDays = 1;
            }
            
            userStats.lastSessionDate = today;
        }
    }

    function updateDashboard() {
        if (!currentUser) return;
        
        // Calculate stats
        const avgImprovement = allJournalEntries.length > 0 ? 
            allJournalEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / allJournalEntries.length : 0;
        
        const lastCP = userStats.cpMeasurements.length > 0 ? 
            userStats.cpMeasurements[userStats.cpMeasurements.length - 1].score : '-';

        // Update dashboard stats
        document.getElementById('total-sessions').textContent = userStats.totalSessions;
        document.getElementById('streak-days').textContent = userStats.streakDays;
        document.getElementById('avg-improvement').textContent = avgImprovement > 0 ? '+' + avgImprovement.toFixed(1) : avgImprovement.toFixed(1);
        document.getElementById('last-cp').textContent = lastCP === '-' ? '-' : lastCP + 's';
    }

    function saveUserStats() {
        try {
            localStorage.setItem('ademruimte-stats', JSON.stringify(userStats));
        } catch (error) {
            console.log('Could not save stats to localStorage:', error);
        }
    }

    function loadUserStats() {
        try {
            const saved = localStorage.getItem('ademruimte-stats');
            if (saved) {
                userStats = { ...userStats, ...JSON.parse(saved) };
            }
        } catch (error) {
            console.log('Could not load stats from localStorage:', error);
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadUserStats();
        initFirebase();

        // Google login
        document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);

        // Email login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmail(email, password);
        });

        // Register toggle
        document.getElementById('show-register').addEventListener('click', () => {
            showUserMessage('Registratie via Google inloggen of contact opnemen.', 'info');
        });

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showTab(btn.dataset.tab);
            });
        });

        // Symptom tracking
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    this.parentElement.classList.add('selected');
                } else {
                    this.parentElement.classList.remove('selected');
                }
            });
        });

        // Modal close on outside click
        document.getElementById('journal-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('journal-modal')) {
                closeJournalModal();
            }
        });
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (cpInterval) clearInterval(cpInterval);
        if (breathInterval) clearInterval(breathInterval);
        if (crisisInterval) clearInterval(crisisInterval);
        if (window.progressChart) window.progressChart.destroy();
    });

    // Make functions globally available
    window.startCP = startCP;
    window.stopCP = stopCP;
    window.resetCP = resetCP;
    window.toggleBreathing = toggleBreathing;
    window.resetBreathing = resetBreathing;
    window.completeBreathing = completeBreathing;
    window.startCrisis = startCrisis;
    window.stopCrisis = stopCrisis;
    window.openJournalModal = openJournalModal;
    window.closeJournalModal = closeJournalModal;
    window.saveJournalEntry = saveJournalEntry;
    window.exportJournal = exportJournal;
</script>

</body>
</html>
