<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            background: linear-gradient(135deg, #06b6d4, #10b981);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.3);
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: white;
        }

        header p {
            font-size: 0.75rem;
            opacity: 0.95;
            margin: 0.25rem 0 0 0;
            color: rgba(255,255,255,0.95);
        }

        .user-info {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.8);
            max-width: 120px;
            line-height: 1.2;
            word-break: break-word;
        }

        .nav-tabs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            padding: 0.5rem;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            margin-right: 0.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-height: 44px;
            touch-action: manipulation;
            color: #6b7280;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }

        .nav-tabs button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .nav-tabs button:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        /* Emoji styling - preserve original colors */
        .nav-tabs button,
        .grid .card h3,
        .technique-card h4,
        .card h2,
        .card h3,
        .alert strong,
        .btn {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", sans-serif !important;
        }
        
        /* Preserve emoji colors globally */
        span, p, h1, h2, h3, h4, h5, h6, button, div, strong, em {
            font-family: inherit, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol";
        }

        /* Specific fixes for gradient text that affects emojis */
        .card h2 {
            background: linear-gradient(135deg, #06b6d4, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* Ensure emojis within don't get gradient applied */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji";
        }

        /* Create separate spans for emojis in titles to preserve colors */
        .emoji-icon {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
            color: initial !important;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 120px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #06b6d4, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card h3 {
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        .grid .card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 1.2rem;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .grid .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .grid .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 1.2rem 1.2rem 0 0;
        }

        .grid .card h3 {
            font-size: 1.375rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .grid .card p {
            color: #6b7280;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-block;
            text-decoration: none;
            min-height: 48px;
            touch-action: manipulation;
            user-select: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-green:hover {
            background: linear-gradient(135deg, #0ea370, #047857);
        }

        .btn-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-orange:hover {
            background: linear-gradient(135deg, #e08e0b, #c76506);
        }

        .btn-red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-red:hover {
            background: linear-gradient(135deg, #e53935, #c62828);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-purple:hover {
            background: linear-gradient(135deg, #7c4ee4, #6d28d9);
        }

        .btn-cyan {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .btn-cyan:hover {
            background: linear-gradient(135deg, #0ea5c7, #0e7490);
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            min-height: 48px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .range-input {
            width: 100%;
            margin: 0.75rem 0;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            border-radius: 5px;
            outline: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .range-input::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .range-value {
            text-align: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: #3b82f6;
            margin: 0.5rem 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            margin-left: auto;
            min-width: 40px;
            min-height: 40px;
        }

        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .login-card {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
            z-index: 1;
        }

        .divider span {
            background: white;
            padding: 0 1rem;
            position: relative;
            z-index: 2;
        }

        .google-btn {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 48px;
        }

        .google-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .breath-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breath-display.inhale {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            transform: scale(1.02);
        }

        .breath-display.exhale {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            transform: scale(0.98);
        }

        .breath-display.hold {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            transform: scale(1.01);
        }

        .breath-display.rest {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #6b7280;
        }

        .breath-display.gentle-breath {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background: #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 0.375rem;
            transition: width 0.3s ease;
        }

        .breath-progress {
            height: 100%;
            border-radius: 0.375rem;
            transition: width linear;
        }

        .breath-progress.inhale {
            background: #3b82f6;
        }

        .breath-progress.exhale {
            background: #10b981;
        }

        .breath-progress.gentle-breath {
            background: #06b6d4;
        }

        .breath-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .breath-setting {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .breath-setting label {
            display: block;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .breath-setting input {
            width: 80px;
            text-align: center;
            font-size: 1.125rem;
            font-weight: bold;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            min-height: 44px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .button-group .btn {
            flex: 1;
            min-width: 120px;
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #1f2937;
            margin: 1.5rem 0;
            font-family: 'Courier New', monospace;
        }

        .technique-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .technique-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .technique-card h4 {
            color: #667eea;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .technique-card p {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #4b5563;
        }

        .step-list {
            list-style: none;
            margin: 1rem 0;
        }

        .step-list li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .step-list li:before {
            content: "‚úì ";
            color: #10b981;
            font-weight: bold;
        }

        .settings-section {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid #e2e8f0;
        }

        .settings-section h3 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .entry-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .entry-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .entry-result {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .entry-result.zeer-goed { color: #059669; }
        .entry-result.goed { color: #10b981; }
        .entry-result.matig { color: #f59e0b; }
        .entry-result.geen-effect { color: #6b7280; }
        .entry-result.slechter { color: #ef4444; }

        .intensity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-connected {
            color: #059669;
            font-size: 0.7rem;
        }

        .status-disconnected {
            color: #f59e0b;
            font-size: 0.7rem;
        }

        .status-error {
            color: #ef4444;
            font-size: 0.7rem;
        }

        /* CSS Charts Styles - Updated */
        .chart-container {
            position: relative;
            background: rgba(255,255,255,0.8);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .chart-point {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-point:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .chart-point.voor:hover {
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .chart-point.na:hover {
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .bar-chart {
            height: 160px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .bar {
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            min-width: 40px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .bar:hover {
            transform: scale(1.05);
        }

        .bar-value {
            position: absolute;
            top: -25px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #1f2937;
            white-space: nowrap;
        }

        .bar-label {
            position: absolute;
            bottom: -30px;
            font-size: 0.7rem;
            color: #6b7280;
            white-space: nowrap;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile chart optimizations */
        @media (max-width: 768px) {
            .chart-container {
                padding: 0.75rem;
                overflow-x: auto;
            }
            
            .bar-chart {
                min-width: 300px;
                gap: 0.25rem;
                padding: 0 0.5rem;
            }
            
            .bar {
                min-width: 30px;
            }
            
            .bar-label {
                font-size: 0.65rem;
                max-width: 45px;
            }
            
            .chart-point {
                box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            }
        }

        /* Create separate spans for emojis in titles to preserve colors */
        .emoji-icon {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
            color: initial !important;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #6b7280;
            font-size: 0.8rem;
        }

        /* Desktop optimizations */
        @media (min-width: 768px) {
            header {
                padding: 1.5rem 1rem;
                min-height: 80px;
            }
            
            header h1 {
                font-size: 1.75rem;
                margin-bottom: 0.25rem;
            }

            header p {
                font-size: 0.9rem;
            }

            .user-info {
                top: 1rem;
                right: 1rem;
                font-size: 0.8rem;
                max-width: 160px;
            }
            
            .container {
                max-width: 1200px;
                padding: 2rem 1rem;
            }
            
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .timer-display {
                font-size: 3rem;
            }

            .breath-display {
                font-size: 2.5rem;
                padding: 2rem;
            }

            .breath-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Large screen optimizations */
        @media (min-width: 1024px) {
            header h1 {
                font-size: 2rem;
            }
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 1rem 1.5rem;
            }
            
            .nav-tabs button {
                min-height: 44px;
                padding: 1rem 1.25rem;
            }
        }

        /* Landscape phone optimizations */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            .timer-display, .breath-display {
                font-size: 1.5rem;
                margin: 0.5rem 0;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="user-info" id="user-info">
            <div class="spinner" id="auth-loading"></div>
        </div>
        
        <!-- Logo en titel container -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 0.25rem;">
            <!-- Ademruimte Logo SVG - Enhanced with Vibrant Coral/Orange -->
            <svg width="40" height="40" viewBox="0 0 40 40" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));">
                <!-- Background glow circle -->
                <circle cx="20" cy="20" r="18" fill="url(#backgroundGlow)" opacity="0.3">
                    <animate attributeName="opacity" values="0.2;0.4;0.2" dur="6s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Outer circle representing lungs/breath space -->
                <circle cx="20" cy="20" r="16" fill="url(#breathGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="1.5" opacity="0.9"/>
                
                <!-- Secondary breathing ring - VIBRANT CORAL -->
                <circle cx="20" cy="20" r="13" fill="none" stroke="url(#vibrantCoral)" stroke-width="2" stroke-dasharray="3,2" opacity="0.9">
                    <animate attributeName="r" values="11;15;11" dur="5s" repeatCount="indefinite"/>
                    <animate attributeName="opacity" values="0.7;1;0.7" dur="5s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-width" values="1.5;2.5;1.5" dur="5s" repeatCount="indefinite"/>
                    <animateTransform attributeName="transform" type="rotate" values="0 20 20;360 20 20" dur="20s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Main breathing pattern -->
                <circle cx="20" cy="20" r="9" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2" stroke-dasharray="4,2">
                    <animate attributeName="r" values="7;12;7" dur="4s" repeatCount="indefinite"/>
                    <animate attributeName="opacity" values="0.6;1;0.6" dur="4s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-width" values="1.5;2.5;1.5" dur="4s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Inner harmony ring -->
                <circle cx="20" cy="20" r="6" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1" stroke-dasharray="1,2">
                    <animate attributeName="r" values="5;8;5" dur="3s" repeatCount="indefinite"/>
                    <animate attributeName="opacity" values="0.3;0.9;0.3" dur="3s" repeatCount="indefinite"/>
                    <animateTransform attributeName="transform" type="rotate" values="360 20 20;0 20 20" dur="15s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Central energy core - VIBRANT CORAL CENTER -->
                <circle cx="20" cy="20" r="2.5" fill="url(#vibrantCore)">
                    <animate attributeName="r" values="2;4;2" dur="4s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Flowing air particles - Enhanced with vibrant coral accents -->
                <g opacity="0.8">
                    <!-- Particle 1 - VIBRANT CORAL -->
                    <circle cx="10" cy="14" r="1.2" fill="url(#vibrantParticle)">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 8,3; 0,0" dur="3.5s" repeatCount="indefinite"/>
                        <animate attributeName="opacity" values="0;1;0" dur="3.5s" repeatCount="indefinite"/>
                        <animate attributeName="r" values="0.8;1.5;0.8" dur="3.5s" repeatCount="indefinite"/>
                    </circle>
                    
                    <!-- Particle 2 -->
                    <circle cx="30" cy="26" r="1" fill="rgba(255,255,255,0.5)">
                        <animateTransform attributeName="transform" type="translate" values="0,0; -8,-3; 0,0" dur="3.5s" begin="1.75s" repeatCount="indefinite"/>
                        <animate attributeName="opacity" values="0;1;0" dur="3.5s" begin="1.75s" repeatCount="indefinite"/>
                        <animate attributeName="r" values="0.6;1.3;0.6" dur="3.5s" begin="1.75s" repeatCount="indefinite"/>
                    </circle>
                    
                    <!-- Particle 3 - VIBRANT ORANGE -->
                    <circle cx="15" cy="30" r="0.8" fill="#ff8a65">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 5,-8; 0,0" dur="4s" begin="2.5s" repeatCount="indefinite"/>
                        <animate attributeName="opacity" values="0;0.9;0" dur="4s" begin="2.5s" repeatCount="indefinite"/>
                    </circle>
                    
                    <!-- Particle 4 -->
                    <circle cx="25" cy="10" r="1" fill="rgba(255,255,255,0.5)">
                        <animateTransform attributeName="transform" type="translate" values="0,0; -5,8; 0,0" dur="4s" begin="1s" repeatCount="indefinite"/>
                        <animate attributeName="opacity" values="0;0.9;0" dur="4s" begin="1s" repeatCount="indefinite"/>
                    </circle>
                </g>
                
                <!-- Subtle sparkle effects - CORAL/ORANGE ACCENTS -->
                <g opacity="0.8">
                    <circle cx="12" cy="20" r="0.5" fill="#ff6b6b">
                        <animate attributeName="opacity" values="0;1;0" dur="2s" begin="0s" repeatCount="indefinite"/>
                        <animate attributeName="r" values="0.3;0.7;0.3" dur="2s" begin="0s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="28" cy="20" r="0.5" fill="rgba(255,255,255,0.9)">
                        <animate attributeName="opacity" values="0;1;0" dur="2s" begin="1s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="20" cy="12" r="0.5" fill="#ff7043">
                        <animate attributeName="opacity" values="0;1;0" dur="2s" begin="0.5s" repeatCount="indefinite"/>
                        <animate attributeName="r" values="0.3;0.7;0.3" dur="2s" begin="0.5s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="20" cy="28" r="0.5" fill="rgba(255,255,255,0.9)">
                        <animate attributeName="opacity" values="0;1;0" dur="2s" begin="1.5s" repeatCount="indefinite"/>
                    </circle>
                </g>
                
                <!-- Gradient definitions -->
                <defs>
                    <radialGradient id="backgroundGlow" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.1);stop-opacity:1" />
                        <stop offset="50%" style="stop-color:rgba(255,138,101,0.2);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgba(6,182,212,0.3);stop-opacity:1" />
                    </radialGradient>
                    
                    <radialGradient id="breathGradient" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.25);stop-opacity:1" />
                        <stop offset="40%" style="stop-color:rgba(255,138,101,0.3);stop-opacity:1" />
                        <stop offset="70%" style="stop-color:rgba(6,182,212,0.4);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgba(102,126,234,0.3);stop-opacity:1" />
                    </radialGradient>
                    
                    <!-- VIBRANT CORAL/ORANGE GRADIENTS -->
                    <linearGradient id="vibrantCoral" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#ff8a65;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ff7043;stop-opacity:0.9" />
                    </linearGradient>
                    
                    <radialGradient id="vibrantCore" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                        <stop offset="40%" style="stop-color:#ff8a65;stop-opacity:0.9" />
                        <stop offset="80%" style="stop-color:#ff6b6b;stop-opacity:0.7" />
                        <stop offset="100%" style="stop-color:#ff7043;stop-opacity:0.5" />
                    </radialGradient>
                    
                    <radialGradient id="vibrantParticle" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9" />
                        <stop offset="70%" style="stop-color:#ff8a65;stop-opacity:0.8" />
                        <stop offset="100%" style="stop-color:#ff6b6b;stop-opacity:0.6" />
                    </radialGradient>
                    
                    <!-- Subtle filter effects -->
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
            </svg>
            
            <h1 style="color: white;">Ademruimte</h1>
        </div>
        
        <p>Jouw persoonlijke hyperventilatie helper</p>
        <div id="firebase-status" class="status-disconnected">
            Firebase: Initialiseren...
        </div>
    </header>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-card">
                <h2 style="text-align: center; margin-bottom: 1.5rem; color: #1f2937;">
                    Welkom bij Ademruimte
                </h2>
                
                <p style="text-align: center; margin-bottom: 2rem; color: #6b7280;">
                    Log in om je vooruitgang op te slaan en te synchroniseren tussen al je apparaten.
                </p>

                <!-- Google Login -->
                <button class="google-btn" onclick="signInWithGoogle()">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Doorgaan met Google
                </button>

                <div class="divider">
                    <span>of</span>
                </div>

                <!-- Email/Password Login -->
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">E-mail:</label>
                        <input type="email" id="login-email" class="form-input" placeholder="jouw@email.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Wachtwoord:</label>
                        <input type="password" id="login-password" class="form-input" placeholder="Wachtwoord" required>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="remember-me" checked style="width: 20px; height: 20px;">
                        <label for="remember-me" style="font-size: 0.875rem; margin: 0; cursor: pointer;">Ingelogd blijven</label>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Inloggen
                    </button>
                </form>

                <div style="text-align: center;">
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                        Nog geen account?
                    </p>
                    <button class="btn btn-green" onclick="showRegisterForm()" style="width: 100%;">
                        Account Aanmaken
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Account Aanmaken</h3>
                <button class="close-btn" onclick="closeRegisterModal()">&times;</button>
            </div>
            
            <form id="register-form">
                <div class="form-group">
                    <label class="form-label">Naam:</label>
                    <input type="text" id="register-name" class="form-input" placeholder="Jouw naam" required>
                </div>

                <div class="form-group">
                    <label class="form-label">E-mail:</label>
                    <input type="email" id="register-email" class="form-input" placeholder="jouw@email.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Wachtwoord:</label>
                    <input type="password" id="register-password" class="form-input" placeholder="Minimaal 6 karakters" required minlength="6">
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-green">
                        Account Aanmaken
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeRegisterModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="main-app" class="hidden">
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">üè† Dashboard</button>
            <button class="tab-btn" data-tab="crisis">üö® Crisis</button>
            <button class="tab-btn" data-tab="buteyko">üå¨Ô∏è Buteyko</button>
            <button class="tab-btn" data-tab="ritueel">üïê Ritueel</button>
            <button class="tab-btn" data-tab="gapen">ü•± Gapen</button>
            <button class="tab-btn" data-tab="emdr">üíú EMDR</button>
            <button class="tab-btn" data-tab="dagboek">üìñ Dagboek</button>
        </nav>

        <div class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="card">
                    <h2>Welkom bij Ademruimte</h2>
                    <p>Jouw persoonlijke hulp voor het omgaan met hyperventilatie en luchthonger-gevoelens.</p>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3> Crisis Hulp</h3>
                        <p>Voor wanneer je luchthonger voelt opkomen</p>
                        <button class="btn btn-red" onclick="showTab('crisis')">Open Crisis Hulp</button>
                    </div>

                    <div class="card">
                        <h3> Buteyko Ademhaling</h3>
                        <p>CO2 tolerantie training</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>

                    <div class="card">
                        <h3> Afkoel Ritueel</h3>
                        <p>Na intensief denkwerk</p>
                        <button class="btn btn-green" onclick="showTab('ritueel')">Start Ritueel</button>
                    </div>

                    <div class="card">
                        <h3> Gaap Preventie</h3>
                        <p>Technieken voor gaapaanvallen</p>
                        <button class="btn btn-orange" onclick="showTab('gapen')">Bekijk Technieken</button>
                    </div>

                    <div class="card">
                        <h3>EMDR Zelfhulp</h3>
                        <p>Voor luchthonger-gevoelens</p>
                        <button class="btn btn-purple" onclick="showTab('emdr')">Start EMDR</button>
                    </div>

                    <div class="card">
                        <h3>Dagboek</h3>
                        <p>Bijhouden van patronen</p>
                        <button class="btn btn-primary" onclick="showTab('dagboek')">Open Dagboek</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Tip van de dag:</strong> <span id="daily-tip">Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.</span>
                    <button id="tip-refresh-btn" style="background: none; border: none; color: #0891b2; cursor: pointer; margin-left: 0.5rem; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; padding: 0.25rem; border-radius: 0.25rem;" onmouseover="this.style.background='rgba(8,145,178,0.1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='none'; this.style.transform='scale(1)'" title="Nieuwe tip">üîÑ</button>
                </div>

                <!-- Data Migration Section (if needed) -->
                <div class="settings-section" id="migration-section" style="display: none;">
                    <h3>üì§ Data Migratie</h3>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        Heb je eerder de app gebruikt zonder account? Migreer je lokale data naar je cloud account.
                    </p>
                    <div class="button-group">
                        <button class="btn btn-green" onclick="migrateLocalData()">
                            üì§ Migreer Lokale Data
                        </button>
                    </div>
                </div>

                <!-- Account Settings Section -->
                <div class="settings-section">
                    <h3>üë§ Account</h3>
                    <div id="account-info" style="margin-bottom: 1rem;">
                        <!-- Account info wordt hier ingevuld -->
                    </div>
                    <div class="button-group">
                        <button class="btn btn-red" onclick="performLogout()">
                            üö™ Uitloggen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Crisis Tab -->
            <div id="crisis" class="tab-content hidden">
                <div class="card">
                    <h2>üö® Crisis Hulp - Luchthonger</h2>
                    <p>Voor wanneer je dat benauwde gevoel voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>1. Paradoxale Ademhaling</h4>
                    <p>Start met bewust zeer kleine, korte ademhalingen. Na 3-4 van deze mini-ademhalingen, probeer een iets langere uitademing.</p>
                </div>

                <div class="technique-card">
                    <h4>2. Purse-lip Ademhaling</h4>
                    <p>Tuut je lippen bij het uitademen om lichte weerstand te cre√´ren. Dit helpt bij luchthonger en stabiliseert CO2-niveaus.</p>
                </div>

                <div class="technique-card">
                    <h4>3. IJswater Techniek</h4>
                    <p>Breng iets kouds tegen je gezicht (vooral rond wangen en ogen) om de duikreflex te activeren.</p>
                </div>

                <div class="technique-card">
                    <h4>4. Herframing</h4>
                    <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                </div>

                <div class="card">
                    <h3>5-4-3-2-1 Grounding</h3>
                    <ul class="step-list">
                        <li>5 dingen die je ZIET</li>
                        <li>4 dingen die je VOELT</li>
                        <li>3 dingen die je HOORT</li>
                        <li>2 dingen die je RUIKT</li>
                        <li>1 ding dat je PROEFT</li>
                    </ul>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Crisis Hulp Technieken')">
                        üìù Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content hidden">
                <div class="card">
                    <h2>üå¨Ô∏è Buteyko Ademhaling</h2>
                    <p>Verbeter je CO2 tolerantie en verminder hyperventilatie neiging</p>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Hoe het werkt:</strong> Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus, wat hyperventilatie-episodes kan verminderen.
                </div>

                <div class="card">
                    <h3>Ademhaling Instellingen</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Ademhaling Patroon:</label>
                        <select id="breathing-pattern" class="form-select" onchange="updateBreathingPattern()">
                            <option value="standard">Standaard (4-6-3)</option>
                            <option value="gentle">Zacht (2x ademhaling + pauze)</option>
                        </select>
                    </div>
                    
                    <div id="standard-controls" class="breath-controls">
                        <div class="breath-setting">
                            <label>Inademen (sec)</label>
                            <input type="number" id="inhale-duration" value="4" min="2" max="10">
                        </div>
                        <div class="breath-setting">
                            <label>Uitademen (sec)</label>
                            <input type="number" id="exhale-duration" value="6" min="3" max="15">
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="hold-duration" value="3" min="1" max="20">
                        </div>
                    </div>

                    <div id="gentle-controls" class="breath-controls hidden">
                        <div class="breath-setting">
                            <label>Cyclus Tijd (sec)</label>
                            <input type="number" id="gentle-cycle" value="10" min="8" max="15" readonly>
                        </div>
                        <div class="breath-setting">
                            <label>Pauze (sec)</label>
                            <input type="number" id="gentle-pause" value="4" min="2" max="8">
                        </div>
                        <div class="breath-setting">
                            <label>Ademhalingen</label>
                            <div style="font-weight: bold; color: #3b82f6; margin-top: 0.5rem;">2x per cyclus</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="breath-display rest" id="breath-display">
                        Klik op start om te beginnen
                    </div>

                    <div class="progress-bar">
                        <div class="breath-progress" id="breath-progress" style="width: 0%"></div>
                    </div>

                    <div style="text-align: center; margin: 1rem 0;">
                        <div id="breath-cycle-counter" style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1rem;">
                            Cyclus: 0
                        </div>
                        
                        <div class="button-group">
                            <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathExercise()">
                                ‚ñ∂Ô∏è Start Buteyko
                            </button>
                            <button class="btn btn-orange" onclick="resetBreathExercise()">
                                üîÑ Reset
                            </button>
                        </div>
                    </div>

                    <div id="breath-complete" class="alert alert-success hidden">
                        <strong>‚úÖ Buteyko Sessie Voltooid!</strong><br>
                        Goed gedaan! Je hebt een volledige ademhalingssessie afgerond.
                        <br><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('Buteyko Ademhaling')">
                            üìù Dagboek Entry Maken
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>Buteyko Principes</h3>
                    <div class="technique-card">
                        <h4>Zachte Ademhaling</h4>
                        <p>Adem zo zacht mogelijk - stel je voor dat je een veertje voor je neus niet wilt laten bewegen.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Langere Uitademing</h4>
                        <p>De uitademing is langer dan de inademing om CO2 te behouden en het autonome zenuwstelsel te kalmeren.</p>
                    </div>
                    <div class="technique-card">
                        <h4>Comfortabele Pauze</h4>
                        <p>De ademhpauze na uitademing mag nooit geforceerd aanvoelen - stop als het oncomfortabel wordt.</p>
                    </div>
                </div>
            </div>

            <!-- Ritueel Tab -->
            <div id="ritueel" class="tab-content hidden">
                <div class="card">
                    <h2>üïê Afkoel Ritueel</h2>
                    <p>Voor na periodes van intensief denkwerk (5-10 minuten)</p>
                </div>

                <div class="card">
                    <h3 id="ritual-title">Stap 1: Fysieke Mini-Reset</h3>
                    <div class="timer-display" id="timer-display">2:00</div>
                    
                    <div id="ritual-instructions">
                        <ul class="step-list">
                            <li>Sta op en strek je volledig uit</li>
                            <li>Schud je armen en benen los</li>
                            <li>Rol je schouders 5x naar achteren</li>
                            <li>Maak kleine cirkels met je hoofd (5x elke richting)</li>
                        </ul>
                    </div>

                    <div class="button-group">
                        <button id="timer-btn" class="btn btn-green" onclick="startTimer()">‚ñ∂Ô∏è Start Timer</button>
                        <button class="btn btn-primary" onclick="nextRitualStep()" id="next-btn" style="display: none;">Volgende Stap</button>
                        <button class="btn btn-cyan" onclick="skipToNextStep()" id="skip-btn">‚è≠Ô∏è Overslaan</button>
                        <button class="btn btn-orange" onclick="resetRitual()">üîÑ Reset</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="ritual-progress" style="width: 20%"></div>
                    </div>

                    <div id="ritual-complete" class="alert alert-success hidden">
                        <strong>‚úÖ Afkoel Ritueel Voltooid!</strong><br>
                        Goed gedaan! Je hebt alle stappen doorlopen.
                        <br><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('Afkoel Ritueel')">
                            üìù Dagboek Entry Maken
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gapen Tab -->
            <div id="gapen" class="tab-content hidden">
                <div class="card">
                    <h2>ü•± Gaap Preventie Technieken</h2>
                    <p>Voor wanneer je die vervelende gaapaanvallen voelt opkomen</p>
                </div>

                <div class="technique-card">
                    <h4>Lipremming-techniek</h4>
                    <p>Druk je lippen zachtjes op elkaar wanneer je een gaapneiging voelt. Laat de lucht langzaam door je neus in en uit gaan.</p>
                </div>

                <div class="technique-card">
                    <h4>Mini-ademhalingen</h4>
                    <p>Neem bewust 3-4 zeer kleine, ondiepe ademhalingen door je neus. Hiermee voorkom je de grote 'zucht-ademhaling'.</p>
                </div>

                <div class="technique-card">
                    <h4>Tongpositie veranderen</h4>
                    <p>Plaats je tongpunt tegen je gehemelte (achter je voortanden). Dit vermindert de neiging tot gapen.</p>
                </div>

                <div class="technique-card">
                    <h4>Water drinken</h4>
                    <p>Neem kleine slokjes water wanneer je merkt dat je begint te gapen. Dit doorbreekt het ademhalingspatroon.</p>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Belangrijk om te onthouden:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Ze geven je de kans om preventief in te grijpen voordat een volledige hyperventilatie-episode begint.
                </div>

                <div class="card">
                    <h3>Gedachte-Breaking Technieken</h3>
                    <div class="technique-card">
                        <strong>Paradoxale intentie:</strong> "Ok√© hersenen, jullie willen dat ik ga gapen? Prima, ik ga nu heel bewust gapen"
                    </div>
                    <div class="technique-card">
                        <strong>Herframing:</strong> "Mijn brein probeert me te beschermen, maar ik hoef niet te reageren"
                    </div>
                    <div class="technique-card">
                        <strong>Aandacht verplaatsen:</strong> Tel 5 blauwe dingen die je kunt zien
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-primary" onclick="openDagboekModal('Gaap Preventie Technieken')">
                        üìù Dagboek Entry Maken
                    </button>
                </div>
            </div>

            <!-- EMDR Tab -->
            <div id="emdr" class="tab-content hidden">
                <div class="card">
                    <h2>üíú EMDR Zelfhulp</h2>
                    <p>Voor luchthonger-gevoelens (dit is ondersteuning, geen vervanging voor professionele EMDR)</p>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Gebruik dit alleen voor milde tot matige gevoelens. Stop als je je overweldigd voelt.</strong>
                </div>

                <div class="alert alert-info">
                    <strong>üéß Bilaterale Audio:</strong> Voor de beste ervaring, gebruik koptelefoon of oortjes. Zet het volume op een comfortabel niveau voordat je begint.
                </div>

                <!-- Audio Controls -->
                <div class="card">
                    <h3>üîä Bilaterale Audio Stimulatie</h3>
                    <p style="margin-bottom: 1rem;">Een instelbare toon die van links naar rechts beweegt om bilaterale hersenstimulatie te ondersteunen.</p>
                    
                    <div class="breath-controls">
                        <div class="breath-setting">
                            <label>Volume (%)</label>
                            <input type="number" id="audio-volume" value="30" min="10" max="100" step="10">
                        </div>
                        <div class="breath-setting">
                            <label>Snelheid (sec)</label>
                            <input type="number" id="audio-speed" value="2" min="1" max="5" step="0.5">
                        </div>
                        <div class="breath-setting">
                            <label>Toonhoogte (Hz)</label>
                            <input type="number" id="audio-frequency" value="880" min="60" max="1000" step="10">
                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">60-1000 Hz</div>
                        </div>
                        <div class="breath-setting">
                            <label>Status</label>
                            <div id="audio-status" style="font-weight: bold; color: #6b7280; margin-top: 0.5rem;">Gestopt</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="audio-btn" class="btn btn-purple" onclick="toggleBilateralAudio()">
                            üîä Start Audio
                        </button>
                        <button class="btn btn-orange" onclick="stopBilateralAudio()">
                            üîá Stop Audio
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 id="emdr-title">Stap 1: Voorbereiding</h3>
                    <div id="emdr-content">
                        <p>Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.</p>
                    </div>

                    <div id="emdr-intensity" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Intensiteit van luchthonger-gevoel (1-10):</label>
                            <input type="range" min="1" max="10" value="5" class="range-input" id="emdr-intensity-slider">
                            <div class="range-value" id="emdr-intensity-value">5</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="emdr-prev-btn" class="btn btn-orange" onclick="prevEmdrStep()" style="display: none;">Vorige</button>
                        <button id="emdr-next-btn" class="btn btn-purple" onclick="nextEmdrStep()">Volgende</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="emdr-progress" style="width: 20%"></div>
                    </div>

                    <div id="emdr-complete" class="alert alert-success hidden">
                        <strong>‚úÖ EMDR Sessie Voltooid!</strong><br>
                        <button class="btn btn-primary" onclick="openDagboekModal('EMDR Zelfhulp Sessie')">
                            üìù Dagboek Entry Maken
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content hidden">
                <div class="card">
                    <h2>üìñ Dagboek</h2>
                    <p>Overzicht van je sessies en vooruitgang</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openDagboekModal('Handmatige Entry')">
                            ‚ûï Nieuwe Entry
                        </button>
                        <button class="btn btn-green" onclick="loadDagboekEntries()">
                            üîÑ Vernieuw
                        </button>
                        <button class="btn btn-orange" onclick="exportDagboek()">
                            üì• Export Dagboek
                        </button>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-section" class="card" style="display: none;">
                    <h3>üìä Jouw Vooruitgang</h3>
                    
                    <!-- Chart Container -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">Intensiteit Evolutie</h4>
                        <div id="intensity-chart" style="width: 100%; height: 300px; background: rgba(255,255,255,0.5); border-radius: 0.75rem; padding: 1rem;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>

                    <!-- Technique Effectiveness -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">Effectiviteit per Techniek</h4>
                        <div id="technique-chart" style="width: 100%; height: 250px; background: rgba(255,255,255,0.5); border-radius: 0.75rem; padding: 1rem;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal Sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">0%</div>
                            <div class="stat-label">Gem. Verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="best-technique">-</div>
                            <div class="stat-label">Beste Techniek</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen Streak</div>
                        </div>
                    </div>
                </div>

                <div id="dagboek-entries">
                    <!-- Entries worden hier geladen -->
                </div>

                <div class="card">
                    <h3>Patronen om naar uit te kijken</h3>
                    <ul class="step-list">
                        <li>Welke technieken het beste werken voor jou</li>
                        <li>Tijdstippen waarop klachten vaker voorkomen</li>
                        <li>Specifieke triggers (werk, stress, bepaalde gedachten)</li>
                        <li>Verband tussen maagklachten en ademhalingsproblemen</li>
                        <li>Verbetering in intensiteit scores over tijd</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Dagboek Modal -->
    <div id="dagboek-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Dagboek Entry</h3>
                <button class="close-btn" onclick="closeDagboekModal()">&times;</button>
            </div>
            
            <form id="dagboek-form">
                <div class="form-group">
                    <label class="form-label">Situatie/Trigger:</label>
                    <input type="text" id="entry-trigger" class="form-input" placeholder="Bijv. na intensief werken">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label class="form-label">Intensiteit voor (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-before">
                        <div class="range-value" id="entry-before-value">5</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Intensiteit na (1-10):</label>
                        <input type="range" min="1" max="10" value="5" class="range-input" id="entry-after">
                        <div class="range-value" id="entry-after-value">5</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Resultaat:</label>
                    <select id="entry-result" class="form-select">
                        <option value="">Selecteer resultaat...</option>
                        <option value="zeer-goed">Zeer goed - volledig opgelost</option>
                        <option value="goed">Goed - duidelijke verbetering</option>
                        <option value="matig">Matig - kleine verbetering</option>
                        <option value="geen-effect">Geen effect</option>
                        <option value="slechter">Iets slechter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notities:</label>
                    <textarea id="entry-notes" class="form-textarea" placeholder="Wat viel je op?"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="saveDagboekEntry()">
                        üìÅ Opslaan
                    </button>
                    <button type="button" class="btn btn-orange" onclick="closeDagboekModal()">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>üìû In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
    </footer>

    <!-- External Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Firebase en App JavaScript -->
    <script type="module">
        // Firebase modules importeren
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Firebase configuratie
        const firebaseConfig = {
            apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
            authDomain: "ademruimte-12c09.firebaseapp.com",
            projectId: "ademruimte-12c09",
            storageBucket: "ademruimte-12c09.firebasestorage.app",
            messagingSenderId: "744941871331",
            appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
            measurementId: "G-SD2ZEYNMNY"
        };

        console.log('üöÄ Starting Ademruimte app - Firebase fix applied');

        // Global variables
        let app, db, auth;
        let currentUser = null;
        let isFirebaseConnected = false;
        let currentTab = 'dashboard';
        let timerInterval = null;
        let currentTime = 0;
        let ritualStep = 0;
        let emdrStep = 0;
        let currentTechnique = '';
        let dagboekEntries = [];

        // Breath exercise variables
        let breathInterval = null;
        let breathPhase = 'rest';
        let breathCycleCount = 0;
        let breathPhaseTime = 0;
        let breathCycleDuration = 0;
        let breathingPattern = 'standard';
        let gentleBreathCount = 0;

        // Audio variables for EMDR
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;
        let pannerNode = null;
        let audioInterval = null;
        let isAudioPlaying = false;
        let panPosition = -1;

        // Wake lock for keeping screen on
        let wakeLock = null;

        // Progress tracking
        let progressData = {
            buteyko: { sessions: 0, totalTime: 0, lastSession: null },
            ritual: { sessions: 0, totalTime: 0, lastSession: null },
            emdr: { sessions: 0, totalTime: 0, lastSession: null },
            crisis: { sessions: 0, lastSession: null }
        };

        // Tips array
        const tips = [
            "Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.",
            "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
            "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
            "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
            "Een koude kompres op je gezicht activeert de duikreflex en kalmeert het zenuwstelsel.",
            "Grounding technieken zoals 5-4-3-2-1 helpen je geest terug naar het hier en nu te brengen.",
            "Zachte ademhaling is effectiever dan diepe ademhaling bij hyperventilatie.",
            "Regelmatige oefening van ademhalingstechnieken vermindert de kans op episodes.",
            "Het bijhouden van patronen in je dagboek helpt je triggers te identificeren.",
            "Na intensief denkwerk heeft je lichaam een afkoel ritueel nodig om te ontspannen."
        ];

        // Firebase initialisatie met verbeterde error handling
        try {
            console.log('üîÑ Initializing Firebase...');
            app = initializeApp(firebaseConfig);
            
            console.log('üîÑ Getting Firestore...');
            db = getFirestore(app);
            
            console.log('üîÑ Getting Auth...');
            auth = getAuth(app);
            
            console.log('üîç Firebase objects created:', {
                app: !!app,
                db: !!db, 
                auth: !!auth
            });
            
            // Test Firebase connection
            console.log('üîÑ Testing Firebase connection...');
            collection(db, "test");
            
            isFirebaseConnected = true;
            updateFirebaseStatus('connected', 'üî• Firebase: Actief');
            
            console.log('‚úÖ Firebase successfully initialized and connected');
            
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            isFirebaseConnected = false;
            updateFirebaseStatus('error', 'üî• Firebase: Offline');
            
            // Show user that they can still use the app
            setTimeout(() => {
                updateFirebaseStatus('disconnected', 'üì± Lokale modus actief');
            }, 3000);
        }

        // Initialize Firebase auth state observer
        setupAuthStateObserver();

        // Helper functies
        function updateFirebaseStatus(type, message) {
            const statusElement = document.getElementById('firebase-status');
            statusElement.textContent = message;
            statusElement.className = `status-${type}`;
        }

        // Tips functionaliteit
        function setRandomTip() {
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('daily-tip').textContent = randomTip;
        }

        window.getNewTip = function() {
            console.log('üîÑ Getting new tip...');
            setRandomTip();
        };

        // Enhanced screen switching
        function showLoginScreen() {
            const loginScreen = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');
            
            if (loginScreen && mainApp) {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                
                // Ensure login form is ready for use
                setTimeout(() => {
                    const emailField = document.getElementById('login-email');
                    if (emailField) {
                        emailField.focus();
                    }
                }, 100);
                
                console.log('‚úÖ Switched to login screen');
            }
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Setup tip refresh button after main app is shown
            setTimeout(() => {
                const tipRefreshBtn = document.getElementById('tip-refresh-btn');
                if (tipRefreshBtn) {
                    // Remove any existing listeners
                    tipRefreshBtn.removeEventListener('click', getNewTip);
                    // Add fresh listener
                    tipRefreshBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('üîÑ Tip refresh clicked in main app');
                        getNewTip();
                    });
                    console.log('‚úÖ Tip refresh button activated in main app');
                }
            }, 100);
        }

        // Function to reset login form and completely re-initialize handlers
        function resetLoginForm() {
            // Clear form fields
            const emailField = document.getElementById('login-email');
            const passwordField = document.getElementById('login-password');
            const rememberCheckbox = document.getElementById('remember-me');
            
            if (emailField) emailField.value = '';
            if (passwordField) passwordField.value = '';
            if (rememberCheckbox) rememberCheckbox.checked = true;
            
            // Clear any form validation states
            document.querySelectorAll('.form-input').forEach(input => {
                input.classList.remove('error', 'success');
            });
            
            // Completely re-setup form handlers with a small delay to ensure DOM is ready
            setTimeout(() => {
                setupLoginFormHandler();
                setupRegisterFormHandler();
                console.log('‚úÖ Login form reset and handlers re-initialized');
            }, 100);
        }

        function updateAccountInfo(user) {
            const accountInfo = document.getElementById('account-info');
            if (accountInfo) {
                accountInfo.innerHTML = 
                    '<p style="color: #6b7280; font-size: 0.9rem;">' +
                    '<strong>Ingelogd als:</strong><br>' + 
                    (user.displayName || user.email) + 
                    '</p>';
            }
        }

        // Force logout with proper Firebase re-initialization
        window.performLogout = async function() {
            if (!confirm('Weet je zeker dat je wilt uitloggen?')) {
                return;
            }
            
            // Stop any running services immediately
            if (isAudioPlaying) stopBilateralAudio();
            if (wakeLock) releaseWakeLock();
            
            // Clear global state
            currentUser = null;
            
            try {
                // Try proper Firebase signOut first
                if (auth && auth.currentUser) {
                    await auth.signOut();
                }
            } catch (error) {
                console.log('SignOut error (continuing with force logout):', error);
            }
            
            // Clear all Firebase auth data from localStorage
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.includes('firebase:authUser:') || 
                    key.includes('firebase:host:') || 
                    key.includes('firebase:heartbeat:')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Clear sessionStorage
            sessionStorage.clear();
            
            // Re-initialize Firebase auth to ensure clean state
            try {
                // Get fresh auth instance
                auth = getAuth(app);
                
                // Re-setup auth state observer
                setupAuthStateObserver();
                
            } catch (error) {
                console.error('Auth re-initialization error:', error);
            }
            
            // Force show login screen immediately
            showLoginScreen();
            resetLoginForm();
            
            console.log('‚úÖ Force logout completed with auth re-initialization');
        };

        // Separate function for auth state observer setup (backup only)
        function setupAuthStateObserver() {
            onAuthStateChanged(auth, (user) => {
                console.log('üîÑ Auth state observer - User:', user ? 'LOGGED_IN' : 'LOGGED_OUT');
                
                document.getElementById('auth-loading').style.display = 'none';
                
                // Only handle logout case - login is handled explicitly by login functions
                if (!user && currentUser) {
                    // User was logged out
                    currentUser = null;
                    console.log('‚ùå User logged out, showing login screen');
                    showLoginScreen();
                    resetLoginForm();
                } else if (user && !currentUser) {
                    // This handles initial page load with existing auth
                    currentUser = user;
                    console.log('‚úÖ Initial auth state - showing main app');
                    showMainApp();
                    updateUserInfo(user);
                    updateAccountInfo(user);
                    loadDagboekEntries();
                    checkForLocalData();
                }
                // If user exists and currentUser exists, do nothing (login functions handle this)
            }, (error) => {
                console.error('‚ùå Auth state observer error:', error);
            });
        }

        // Fixed checkForLocalData that handles Firestore issues
        function checkForLocalData() {
            const localData = localStorage.getItem('ademruimte-entries');
            const migrationSection = document.getElementById('migration-section');
            
            if (localData && JSON.parse(localData).length > 0) {
                // Only show if we can use Firestore
                if (isFirebaseConnected && currentUser) {
                    migrationSection.style.display = 'block';
                } else {
                    migrationSection.style.display = 'none';
                }
            } else {
                migrationSection.style.display = 'none';
            }
        }

        // Wake Lock API for keeping screen on
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake lock activated - screen will stay on');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake lock released');
                    });
                }
            } catch (error) {
                console.log('Wake lock not supported or failed:', error);
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('‚úÖ Wake lock released');
                } catch (error) {
                    console.log('Error releasing wake lock:', error);
                }
            }
        }

        // Load progress data
        function loadProgressData() {
            const stored = localStorage.getItem('ademruimte-progress');
            if (stored) {
                progressData = { ...progressData, ...JSON.parse(stored) };
            }
        }

        // Save progress data
        function saveProgressData() {
            localStorage.setItem('ademruimte-progress', JSON.stringify(progressData));
        }

        // Track session completion
        function trackSession(type, duration = null) {
            if (!progressData[type]) {
                progressData[type] = { sessions: 0, totalTime: 0, lastSession: null };
            }
            
            progressData[type].sessions++;
            if (duration) {
                progressData[type].totalTime += duration;
            }
            progressData[type].lastSession = new Date().toISOString();
            
            saveProgressData();
            console.log(`‚úÖ Tracked ${type} session:`, progressData[type]);
        }

        function updateUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            const displayName = user.displayName || user.email;
            const shortName = displayName.length > 15 ? displayName.substring(0, 13) + '...' : displayName;
            
            userInfo.innerHTML = 'üëã ' + shortName;
        }

        // Authentication functions with explicit navigation
        window.signInWithGoogle = async function() {
            try {
                // Ensure we have a fresh auth instance
                if (!auth) {
                    auth = getAuth(app);
                }
                
                // Set persistence to local (keep signed in)
                await setPersistence(auth, browserLocalPersistence);
                
                const provider = new GoogleAuthProvider();
                
                // Add popup configuration to avoid cache issues
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                const result = await signInWithPopup(auth, provider);
                console.log('‚úÖ Google sign-in successful:', result.user.email);
                
                // Update global state
                currentUser = result.user;
                
                // Immediately switch to main app
                showMainApp();
                updateUserInfo(result.user);
                updateAccountInfo(result.user);
                loadDagboekEntries();
                checkForLocalData();
                
            } catch (error) {
                console.error('‚ùå Google sign-in error:', error);
                
                // Handle specific error cases
                if (error.code === 'auth/popup-blocked') {
                    alert('üö´ Popup geblokkeerd!\n\nKlik opnieuw om in te loggen. Zorg ervoor dat popups toegestaan zijn voor deze site.');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    // User closed popup - no need to show error
                    console.log('User closed popup');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    // Multiple popup requests - ignore
                    console.log('Popup request cancelled (multiple attempts)');
                } else {
                    alert('Google inloggen mislukt: ' + error.message);
                }
            }
        };

        window.showRegisterForm = function() {
            document.getElementById('register-modal').classList.add('show');
        };

        window.closeRegisterModal = function() {
            document.getElementById('register-modal').classList.remove('show');
            // Reset form
            document.getElementById('register-form').reset();
        };

        // Login form handler with explicit navigation after login
        function setupLoginFormHandler() {
            const loginForm = document.getElementById('login-form');
            if (!loginForm) {
                console.log('Login form not found, retrying...');
                setTimeout(setupLoginFormHandler, 200);
                return;
            }
            
            // Remove any existing listeners to prevent duplicates
            const newForm = loginForm.cloneNode(true);
            loginForm.parentNode.replaceChild(newForm, loginForm);
            
            // Add fresh event listener
            newForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                const rememberMeCheckbox = document.getElementById('remember-me');
                const rememberMe = rememberMeCheckbox ? rememberMeCheckbox.checked : true;
                
                if (!email || !password) {
                    alert('Vul alle velden in');
                    return;
                }
                
                // Show loading state
                const submitBtn = newForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Inloggen...';
                submitBtn.disabled = true;
                
                try {
                    // Ensure we have a fresh auth instance
                    if (!auth) {
                        auth = getAuth(app);
                    }
                    
                    // Set persistence based on checkbox
                    if (rememberMe) {
                        await setPersistence(auth, browserLocalPersistence);
                    } else {
                        await setPersistence(auth, browserSessionPersistence);
                    }
                    
                    const result = await signInWithEmailAndPassword(auth, email, password);
                    console.log('‚úÖ Email sign-in successful');
                    
                    // Update global state
                    currentUser = result.user;
                    
                    // Immediately switch to main app
                    showMainApp();
                    updateUserInfo(result.user);
                    updateAccountInfo(result.user);
                    loadDagboekEntries();
                    checkForLocalData();
                    
                    // Restore button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    
                } catch (error) {
                    console.error('‚ùå Email sign-in error:', error);
                    
                    // Restore button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    
                    // User-friendly error messages
                    let errorMessage = 'Inloggen mislukt';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Geen account gevonden met dit email';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Verkeerd wachtwoord';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Ongeldig email adres';
                    } else {
                        errorMessage += ': ' + error.message;
                    }
                    
                    alert(errorMessage);
                }
            });
            
            console.log('‚úÖ Login form handler setup complete');
        }

        // Register form handler with explicit navigation
        function setupRegisterFormHandler() {
            const registerForm = document.getElementById('register-form');
            if (!registerForm) {
                setTimeout(setupRegisterFormHandler, 200);
                return;
            }
            
            // Remove any existing listeners
            const newForm = registerForm.cloneNode(true);
            registerForm.parentNode.replaceChild(newForm, registerForm);
            
            // Add fresh event listener
            newForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('register-name').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                
                if (!name || !email || !password) {
                    alert('Vul alle velden in');
                    return;
                }
                
                if (password.length < 6) {
                    alert('Wachtwoord moet minimaal 6 karakters zijn');
                    return;
                }
                
                try {
                    // Ensure we have a fresh auth instance
                    if (!auth) {
                        auth = getAuth(app);
                    }
                    
                    // Set persistence to local (keep signed in)
                    await setPersistence(auth, browserLocalPersistence);
                    
                    const result = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Update user profile with name
                    await updateProfile(result.user, {
                        displayName: name
                    });
                    
                    console.log('‚úÖ Account created successfully');
                    
                    // Update global state
                    currentUser = result.user;
                    
                    // Close modal and switch to main app
                    closeRegisterModal();
                    showMainApp();
                    updateUserInfo(result.user);
                    updateAccountInfo(result.user);
                    loadDagboekEntries();
                    checkForLocalData();
                    
                } catch (error) {
                    console.error('‚ùå Registration error:', error);
                    
                    let errorMessage = 'Account aanmaken mislukt';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Dit email adres is al in gebruik';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Wachtwoord is te zwak';
                    } else {
                        errorMessage += ': ' + error.message;
                    }
                    
                    alert(errorMessage);
                }
            });
        }

        // Fixed Firebase functions with improved error handling for index issues
        async function saveToFirestore(entry, retryCount = 0) {
            const maxRetries = 2;
            
            if (!isFirebaseConnected) {
                console.log('‚ùå Firebase not connected, using localStorage');
                return saveToLocalStorage(entry, 'Firebase niet verbonden');
            }
            
            if (!currentUser) {
                console.log('‚ùå No current user, using localStorage');
                return saveToLocalStorage(entry, 'Niet ingelogd');
            }

            try {
                console.log('‚òÅÔ∏è Saving to Firestore...');

                const docRef = await addDoc(collection(db, "dagboekEntries"), {
                    ...entry,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                
                console.log('‚úÖ Entry saved to Firestore with ID:', docRef.id);
                return { id: docRef.id, success: true, source: 'Firebase' };
                
            } catch (error) {
                console.error(`‚ùå Firestore save error (attempt ${retryCount + 1}):`, error);
                
                // Check for index errors specifically
                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    console.log('üí° Firestore index error - falling back to localStorage');
                    return saveToLocalStorage(entry, 'Firestore index niet beschikbaar');
                }
                
                // Check for other retryable errors
                const retryableErrors = [
                    'unavailable', 
                    'deadline-exceeded',
                    'aborted',
                    'internal'
                ];
                
                const isRetryable = retryableErrors.includes(error.code) || 
                                  error.message.includes('network') ||
                                  error.message.includes('timeout');
                
                if (retryCount < maxRetries && isRetryable) {
                    const delay = (retryCount + 1) * 1000;
                    console.log(`üîÑ Retrying Firestore save in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return saveToFirestore(entry, retryCount + 1);
                }
                
                console.log('üíæ Firestore failed, falling back to localStorage');
                return saveToLocalStorage(entry, `Firestore fout: ${error.code || error.message}`);
            }
        }

        function saveToLocalStorage(entry, reason) {
            const stored = JSON.parse(localStorage.getItem('ademruimte-entries') || '[]');
            const entryWithId = { 
                ...entry, 
                id: Date.now().toString(), 
                bron: 'Lokaal',
                reden: reason,
                userId: currentUser?.uid || 'local'
            };
            stored.unshift(entryWithId);
            localStorage.setItem('ademruimte-entries', JSON.stringify(stored));
            
            console.log('üíæ Entry saved to localStorage:', entryWithId);
            return { id: entryWithId.id, success: true, source: 'localStorage' };
        }

        // Fixed loadFromFirestore - removes orderBy to avoid index requirements
        async function loadFromFirestore() {
            if (!isFirebaseConnected || !currentUser) {
                console.log('üì± Loading from localStorage...');
                const stored = localStorage.getItem('ademruimte-entries');
                return stored ? JSON.parse(stored) : [];
            }

            try {
                console.log('‚òÅÔ∏è Loading entries from Firestore for user:', currentUser.email);
                
                // Use a simpler query without orderBy to avoid index requirements
                const q = query(
                    collection(db, "dagboekEntries"), 
                    where("userId", "==", currentUser.uid)
                    // Remove orderBy to avoid index requirement
                );
                
                const querySnapshot = await getDocs(q);
                
                const entries = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    entries.push({
                        id: doc.id,
                        ...data,
                        tijdstempel: data.timestamp ? data.timestamp.toDate().toLocaleString('nl-BE') : 'Onbekend',
                        bron: "Cloud"
                    });
                });
                
                // Sort in JavaScript instead of Firestore
                entries.sort((a, b) => {
                    const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA; // Newest first
                });
                
                console.log('‚úÖ Loaded', entries.length, 'entries from Firestore');
                return entries;
                
            } catch (error) {
                console.error('‚ùå Firestore query error:', error);
                console.log('üì± Falling back to localStorage due to Firestore error');
                
                // Show user that there's an issue but local data is used
                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    console.log('üí° This is a Firestore index error - using localStorage instead');
                }
                
                // Fallback to localStorage
                const stored = localStorage.getItem('ademruimte-entries');
                return stored ? JSON.parse(stored) : [];
            }
        }

        // Data migration function
        window.migrateLocalData = async function() {
            if (!currentUser) {
                alert('‚ùå Je moet ingelogd zijn om data te migreren');
                return;
            }

            const localData = localStorage.getItem('ademruimte-entries');
            if (!localData) {
                alert('üìù Geen lokale data gevonden om te migreren');
                return;
            }

            const entries = JSON.parse(localData);
            if (entries.length === 0) {
                alert('üìù Geen entries gevonden om te migreren');
                return;
            }

            const confirmMigration = confirm(
                `üîÑ Data Migratie\n\n` +
                `Er zijn ${entries.length} lokale entries gevonden.\n` +
                `Wil je deze migreren naar je cloud account?\n\n` +
                `Dit zal ze toevoegen aan je cloud opslag.`
            );

            if (!confirmMigration) return;

            try {
                let migratedCount = 0;
                
                for (const entry of entries) {
                    // Skip entries that are already marked as cloud entries
                    if (entry.bron === 'Cloud' || entry.userId === currentUser.uid) {
                        continue;
                    }

                    // Clean entry for migration
                    const cleanEntry = {
                        techniekGebruikt: entry.techniekGebruikt,
                        trigger: entry.trigger,
                        intensiteitVoor: entry.intensiteitVoor,
                        intensiteitNa: entry.intensiteitNa,
                        resultaat: entry.resultaat,
                        notities: entry.notities,
                        tijdstempel: entry.tijdstempel
                    };

                    await saveToFirestore(cleanEntry);
                    migratedCount++;
                }

                if (migratedCount > 0) {
                    alert(`‚úÖ Migratie Voltooid!\n\n${migratedCount} entries zijn succesvol gemigreerd naar je cloud account.`);
                    
                    // Clear local storage after successful migration
                    localStorage.removeItem('ademruimte-entries');
                    
                    // Hide migration section
                    document.getElementById('migration-section').style.display = 'none';
                    
                    // Reload entries
                    await loadDagboekEntries();
                } else {
                    alert('üìù Geen nieuwe entries gevonden om te migreren');
                }
                
            } catch (error) {
                console.error('‚ùå Migration error:', error);
                alert('‚ùå Migratie mislukt: ' + error.message);
            }
        };

        // Buteyko breathing exercise functions
        window.updateBreathingPattern = function() {
            breathingPattern = document.getElementById('breathing-pattern').value;
            const standardControls = document.getElementById('standard-controls');
            const gentleControls = document.getElementById('gentle-controls');
            
            if (breathingPattern === 'gentle') {
                standardControls.classList.add('hidden');
                gentleControls.classList.remove('hidden');
            } else {
                standardControls.classList.remove('hidden');
                gentleControls.classList.add('hidden');
            }
            
            // Reset if currently running
            if (breathInterval) {
                resetBreathExercise();
            }
        };

        window.toggleBreathExercise = function() {
            if (breathInterval) {
                stopBreathExercise();
            } else {
                startBreathExercise();
            }
        };

        window.resetBreathExercise = function() {
            stopBreathExercise();
            breathCycleCount = 0;
            gentleBreathCount = 0;
            breathPhase = 'rest';
            updateBreathDisplay();
            updateBreathProgress(0);
            document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 0';
            document.getElementById('breath-complete').classList.add('hidden');
        };

        function startBreathExercise() {
            // Request wake lock to keep screen on
            requestWakeLock();
            
            if (breathingPattern === 'gentle') {
                startGentleBreathing();
            } else {
                startStandardBreathing();
            }
        }

        function startStandardBreathing() {
            const inhale = parseInt(document.getElementById('inhale-duration').value);
            const exhale = parseInt(document.getElementById('exhale-duration').value);
            const hold = parseInt(document.getElementById('hold-duration').value);
            
            breathCycleDuration = inhale + exhale + hold;
            breathPhase = 'inhale';
            breathPhaseTime = 0;
            
            document.getElementById('breath-btn').innerHTML = '‚è∏Ô∏è Stop Buteyko';
            document.getElementById('breath-btn').className = 'btn btn-red';
            
            breathInterval = setInterval(() => {
                updateStandardBreathCycle();
            }, 100);
        }

        function startGentleBreathing() {
            const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
            const pauseTime = parseInt(document.getElementById('gentle-pause').value);
            
            breathPhase = 'gentle-breath';
            breathPhaseTime = 0;
            gentleBreathCount = 0;
            
            document.getElementById('breath-btn').innerHTML = '‚è∏Ô∏è Stop Buteyko';
            document.getElementById('breath-btn').className = 'btn btn-red';
            
            breathInterval = setInterval(() => {
                updateGentleBreathCycle();
            }, 100);
        }

        function stopBreathExercise() {
            if (breathInterval) {
                clearInterval(breathInterval);
                breathInterval = null;
            }
            
            // Release wake lock
            releaseWakeLock();
            
            breathPhase = 'rest';
            updateBreathDisplay();
            updateBreathProgress(0);
            
            document.getElementById('breath-btn').innerHTML = '‚ñ∂Ô∏è Start Buteyko';
            document.getElementById('breath-btn').className = 'btn btn-cyan';
        }

        function updateStandardBreathCycle() {
            const inhale = parseInt(document.getElementById('inhale-duration').value);
            const exhale = parseInt(document.getElementById('exhale-duration').value);
            const hold = parseInt(document.getElementById('hold-duration').value);
            
            breathPhaseTime += 0.1;
            
            // Update phase based on timing
            let progress = 0;
            
            if (breathPhase === 'inhale') {
                progress = (breathPhaseTime / inhale) * 100;
                if (breathPhaseTime >= inhale) {
                    breathPhase = 'exhale';
                    breathPhaseTime = 0;
                }
            } else if (breathPhase === 'exhale') {
                progress = (breathPhaseTime / exhale) * 100;
                if (breathPhaseTime >= exhale) {
                    breathPhase = 'hold';
                    breathPhaseTime = 0;
                }
            } else if (breathPhase === 'hold') {
                progress = (breathPhaseTime / hold) * 100;
                if (breathPhaseTime >= hold) {
                    breathPhase = 'inhale';
                    breathPhaseTime = 0;
                    breathCycleCount++;
                    document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}`;
                    
                    // Complete after 10 cycles
                    if (breathCycleCount >= 10) {
                        stopBreathExercise();
                        trackSession('buteyko', breathCycleCount * breathCycleDuration);
                        document.getElementById('breath-complete').classList.remove('hidden');
                        
                        // Auto-reset after completion for next session
                        setTimeout(() => {
                            document.getElementById('breath-complete').classList.add('hidden');
                            breathCycleCount = 0;
                            gentleBreathCount = 0;
                            breathPhase = 'rest';
                            updateBreathDisplay();
                            updateBreathProgress(0);
                            document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 0';
                            console.log('‚úÖ Buteyko auto-reset completed - ready for next session');
                        }, 3000); // Show completion message for 3 seconds
                        
                        return;
                    }
                }
            }
            
            updateBreathDisplay();
            updateBreathProgress(Math.min(progress, 100));
        }

        function updateGentleBreathCycle() {
            const cycleTime = parseInt(document.getElementById('gentle-cycle').value);
            const pauseTime = parseInt(document.getElementById('gentle-pause').value);
            
            breathPhaseTime += 0.1;
            let progress = 0;
            
            if (breathPhase === 'gentle-breath') {
                progress = (breathPhaseTime / cycleTime) * 100;
                if (breathPhaseTime >= cycleTime) {
                    breathPhase = 'hold';
                    breathPhaseTime = 0;
                    gentleBreathCount++;
                }
            } else if (breathPhase === 'hold') {
                progress = (breathPhaseTime / pauseTime) * 100;
                if (breathPhaseTime >= pauseTime) {
                    breathPhase = 'gentle-breath';
                    breathPhaseTime = 0;
                    breathCycleCount++;
                    document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}`;
                    
                    // Complete after 10 cycles
                    if (breathCycleCount >= 10) {
                        stopBreathExercise();
                        trackSession('buteyko', breathCycleCount * (cycleTime + pauseTime));
                        document.getElementById('breath-complete').classList.remove('hidden');
                        
                        // Auto-reset after completion for next session
                        setTimeout(() => {
                            document.getElementById('breath-complete').classList.add('hidden');
                            breathCycleCount = 0;
                            gentleBreathCount = 0;
                            breathPhase = 'rest';
                            updateBreathDisplay();
                            updateBreathProgress(0);
                            document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 0';
                            console.log('‚úÖ Buteyko gentle auto-reset completed - ready for next session');
                        }, 3000); // Show completion message for 3 seconds
                        
                        return;
                    }
                }
            }
            
            updateBreathDisplay();
            updateBreathProgress(Math.min(progress, 100));
        }

        function updateBreathDisplay() {
            const display = document.getElementById('breath-display');
            const progressBar = document.getElementById('breath-progress');
            
            display.className = `breath-display ${breathPhase}`;
            progressBar.className = `breath-progress ${breathPhase}`;
            
            switch (breathPhase) {
                case 'inhale':
                    display.textContent = 'üå¨Ô∏è Inademen';
                    break;
                case 'exhale':
                    display.textContent = 'üí® Uitademen';
                    break;
                case 'hold':
                    display.textContent = '‚è∏Ô∏è Pauze';
                    break;
                case 'gentle-breath':
                    display.textContent = `üå¨Ô∏è Zachte Ademhaling (${gentleBreathCount + 1}/2)`;
                    break;
                case 'rest':
                default:
                    display.textContent = 'Klik op start om te beginnen';
                    break;
            }
        }

        function updateBreathProgress(percentage) {
            document.getElementById('breath-progress').style.width = percentage + '%';
        }

        // Bilateral audio functions for EMDR
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('‚úÖ Audio context initialized');
                } catch (error) {
                    console.error('‚ùå Audio context initialization failed:', error);
                    alert('Je browser ondersteunt geen Web Audio API. Probeer een moderne browser.');
                    return false;
                }
            }
            return true;
        }

        window.toggleBilateralAudio = function() {
            if (isAudioPlaying) {
                stopBilateralAudio();
            } else {
                startBilateralAudio();
            }
        };

        function startBilateralAudio() {
            if (!initAudioContext()) return;

            try {
                // Resume audio context if suspended (required by some browsers)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create oscillator with user-defined frequency
                oscillator = audioContext.createOscillator();
                const frequency = parseInt(document.getElementById('audio-frequency').value);
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine'; // Smooth sine wave

                // Create gain node for volume control
                gainNode = audioContext.createGain();
                const volume = parseInt(document.getElementById('audio-volume').value) / 100;
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime); // Keep it gentle

                // Create stereo panner for left-right movement
                pannerNode = audioContext.createStereoPanner();
                pannerNode.pan.setValueAtTime(-1, audioContext.currentTime); // Start left

                // Connect audio nodes
                oscillator.connect(gainNode);
                gainNode.connect(pannerNode);
                pannerNode.connect(audioContext.destination);

                // Start oscillator
                oscillator.start();

                // Start panning animation
                startPanning();

                isAudioPlaying = true;
                document.getElementById('audio-btn').innerHTML = '‚è∏Ô∏è Pause Audio';
                document.getElementById('audio-btn').className = 'btn btn-red';
                document.getElementById('audio-status').textContent = `Actief - ${frequency}Hz - Links naar Rechts`;
                document.getElementById('audio-status').style.color = '#059669';

                console.log(`‚úÖ Bilateral audio started at ${frequency}Hz`);

            } catch (error) {
                console.error('‚ùå Error starting bilateral audio:', error);
                alert('Fout bij starten audio: ' + error.message);
            }
        }

        window.stopBilateralAudio = function() {
            try {
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                    oscillator = null;
                }

                if (gainNode) {
                    gainNode.disconnect();
                    gainNode = null;
                }

                if (pannerNode) {
                    pannerNode.disconnect();
                    pannerNode = null;
                }

                if (audioInterval) {
                    clearInterval(audioInterval);
                    audioInterval = null;
                }

                isAudioPlaying = false;
                panPosition = -1; // Reset to left
                
                document.getElementById('audio-btn').innerHTML = 'üîä Start Audio';
                document.getElementById('audio-btn').className = 'btn btn-purple';
                document.getElementById('audio-status').textContent = 'Gestopt';
                document.getElementById('audio-status').style.color = '#6b7280';

                console.log('‚úÖ Bilateral audio stopped');

            } catch (error) {
                console.error('‚ùå Error stopping bilateral audio:', error);
            }
        };

        function startPanning() {
            const speed = parseFloat(document.getElementById('audio-speed').value) * 1000; // Convert to milliseconds
            const updateInterval = 50; // Update every 50ms for smooth movement
            const steps = speed / updateInterval;
            const panStep = 2 / steps; // Move from -1 to 1 in calculated steps

            panPosition = -1; // Start left
            let direction = 1; // 1 = right, -1 = left

            audioInterval = setInterval(() => {
                if (!isAudioPlaying || !pannerNode) {
                    clearInterval(audioInterval);
                    return;
                }

                panPosition += (panStep * direction);

                // Reverse direction at extremes
                if (panPosition >= 1) {
                    panPosition = 1;
                    direction = -1;
                } else if (panPosition <= -1) {
                    panPosition = -1;
                    direction = 1;
                }

                // Update panner
                pannerNode.pan.setValueAtTime(panPosition, audioContext.currentTime);

                // Update status with frequency
                const side = panPosition < -0.3 ? 'Links' : panPosition > 0.3 ? 'Rechts' : 'Midden';
                const frequency = parseInt(document.getElementById('audio-frequency').value);
                document.getElementById('audio-status').textContent = `Actief - ${frequency}Hz - ${side}`;

            }, updateInterval);
        }

        // Update audio settings while playing
        function updateAudioSettings() {
            if (isAudioPlaying && gainNode && oscillator) {
                // Update volume
                const volume = parseInt(document.getElementById('audio-volume').value) / 100;
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
                
                // Update frequency
                const frequency = parseInt(document.getElementById('audio-frequency').value);
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                // Update status display
                const side = panPosition < -0.3 ? 'Links' : panPosition > 0.3 ? 'Rechts' : 'Midden';
                document.getElementById('audio-status').textContent = `Actief - ${frequency}Hz - ${side}`;
                
                console.log(`üîß Audio settings updated: ${frequency}Hz, ${Math.round(volume * 30)}% volume`);
            }
        }

        // Ritual steps
        const ritualSteps = [
            {
                title: "Stap 1: Fysieke Mini-Reset",
                duration: 120,
                instructions: [
                    "Sta op en strek je volledig uit",
                    "Schud je armen en benen los", 
                    "Rol je schouders 5x naar achteren",
                    "Maak kleine cirkels met je hoofd (5x elke richting)"
                ]
            },
            {
                title: "Stap 2: Zintuigelijke Verschuiving",
                duration: 120,
                instructions: [
                    "Raak 5 verschillende texturen aan in je omgeving",
                    "Luister bewust naar 3 geluiden die je kunt horen",
                    "Kijk naar iets aangenaams in de verte"
                ]
            },
            {
                title: "Stap 3: Voedings-ankerpunt",
                duration: 120,
                instructions: [
                    "Drink een half glas water, langzaam en bewust",
                    "Eet iets kleins met een sterke smaak",
                    "Let op de smaak en textuur in je mond"
                ]
            },
            {
                title: "Stap 4: Mentale Overgang",
                duration: 120,
                instructions: [
                    "Schrijf 3 woorden op die samenvatten waar je net aan werkte",
                    "Schrijf daaronder 3 woorden voor wat je nu gaat doen",
                    "Trek een lijn tussen deze sets woorden als symbolische afsluiting"
                ]
            },
            {
                title: "Stap 5: Bewegingsafsluiting",
                duration: 120,
                instructions: [
                    "Loop even rond, bij voorkeur buiten of bij een open raam",
                    "Maak 5-10 trage, bewuste stappen",
                    "Eindig met een kleine glimlach"
                ]
            }
        ];

        // EMDR steps
        const emdrSteps = [
            {
                title: "Stap 1: Voorbereiding",
                content: "Zorg dat je in een veilige, rustige ruimte bent. Heb water binnen handbereik. Stop als het te overweldigend wordt.<br><br><strong>üí° Tip:</strong> Je kunt de bilaterale audio bovenaan starten voor extra ondersteuning."
            },
            {
                title: "Stap 2: Doelgerichtheid", 
                content: "Denk heel kort aan het gevoel van luchthonger (niet meer dan 5 seconden). Schat de intensiteit en formuleer: 'Ik kan met dit gevoel omgaan'<br><br><strong>üéß Optioneel:</strong> Start nu de bilaterale audio als je koptelefoon draagt."
            },
            {
                title: "Stap 3: Bilaterale Stimulatie",
                content: "Kies √©√©n of meerdere opties:<br><br><strong>üîä Bilaterale Audio:</strong> Luister naar de 880Hz toon die van links naar rechts beweegt<br><strong>üëÄ Oogbewegingen:</strong> Beweeg je ogen langzaam van links naar rechts (15-20x)<br><strong>ü§ó Butterfly hug:</strong> Kruis je armen en tik afwisselend op je schouders<br><strong>ü¶µ Knie-tikken:</strong> Tik afwisselend op je knie√´n met je handen"
            },
            {
                title: "Stap 4: Check-in",
                content: "Hoe voelt het luchthonger-gevoel nu? Welke gedachten komen op? Accepteer wat er komt zonder oordeel.<br><br><em>Je kunt de bilaterale stimulatie voortzetten tijdens deze reflectie.</em>"
            },
            {
                title: "Stap 5: Positieve Verankering",
                content: "Focus op 'Ik kan hiermee omgaan' en doe 10-15 bilaterale bewegingen of luister naar de audio terwijl je deze gedachte vasthoudt.<br><br><strong>üîá Tip:</strong> Stop de audio als je klaar bent met de sessie."
            }
        ];

        // Tab switching
        window.showTab = function(tabName) {
            // Stop audio when leaving EMDR tab
            if (currentTab === 'emdr' && tabName !== 'emdr' && isAudioPlaying) {
                stopBilateralAudio();
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Set active button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;

            // Load content if needed
            if (tabName === 'dagboek') {
                loadDagboekEntries();
            }
        };

        // Timer functions
        window.startTimer = function() {
            // Request wake lock
            requestWakeLock();
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
                releaseWakeLock();
                return;
            }

            currentTime = ritualSteps[ritualStep].duration;
            document.getElementById('timer-btn').innerHTML = '‚è∏Ô∏è Pause Timer';
            
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerDisplay();
                
                if (currentTime <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
                    document.getElementById('next-btn').style.display = 'inline-block';
                }
            }, 1000);
        };

        window.skipToNextStep = function() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
            }
            nextRitualStep();
        };

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            document.getElementById('timer-display').textContent = display;
        }

        window.nextRitualStep = function() {
            ritualStep++;
            
            if (ritualStep >= ritualSteps.length) {
                // Ritual complete
                releaseWakeLock();
                trackSession('ritual', ritualSteps.length * 120); // Assume 2 min per step
                document.getElementById('ritual-complete').classList.remove('hidden');
                document.querySelector('#ritueel .card:nth-child(2)').style.display = 'none';
                return;
            }
            
            updateRitualDisplay();
            document.getElementById('next-btn').style.display = 'none';
        };

        window.resetRitual = function() {
            ritualStep = 0;
            currentTime = 0;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            releaseWakeLock();
            
            document.getElementById('ritual-complete').classList.add('hidden');
            document.querySelector('#ritueel .card:nth-child(2)').style.display = 'block';
            document.getElementById('timer-btn').innerHTML = '‚ñ∂Ô∏è Start Timer';
            document.getElementById('next-btn').style.display = 'none';
            
            updateRitualDisplay();
        };

        function updateRitualDisplay() {
            const step = ritualSteps[ritualStep];
            document.getElementById('ritual-title').textContent = step.title;
            currentTime = step.duration;
            updateTimerDisplay();
            
            const instructionsHtml = step.instructions.map(function(inst) {
                return '<li>' + inst + '</li>';
            }).join('');
            document.getElementById('ritual-instructions').innerHTML = '<ul class="step-list">' + instructionsHtml + '</ul>';
            
            const progress = ((ritualStep + 1) / ritualSteps.length) * 100;
            document.getElementById('ritual-progress').style.width = progress + '%';
        }

        // EMDR functions
        window.nextEmdrStep = function() {
            emdrStep++;
            
            if (emdrStep >= emdrSteps.length) {
                // EMDR complete - stop audio and track progress
                if (isAudioPlaying) {
                    stopBilateralAudio();
                }
                releaseWakeLock();
                trackSession('emdr', emdrSteps.length * 300); // Assume 5 min per step
                document.getElementById('emdr-complete').classList.remove('hidden');
                document.querySelector('#emdr .card:nth-child(4)').style.display = 'none';
                return;
            }
            
            updateEmdrDisplay();
        };

        window.prevEmdrStep = function() {
            if (emdrStep > 0) {
                emdrStep--;
                updateEmdrDisplay();
            }
        };

        function updateEmdrDisplay() {
            const step = emdrSteps[emdrStep];
            document.getElementById('emdr-title').textContent = step.title;
            document.getElementById('emdr-content').innerHTML = step.content;
            
            // Request wake lock when starting EMDR
            if (emdrStep === 0) {
                requestWakeLock();
            }
            
            // Show/hide intensity slider
            if (emdrStep === 1) {
                document.getElementById('emdr-intensity').classList.remove('hidden');
            } else {
                document.getElementById('emdr-intensity').classList.add('hidden');
            }
            
            // Show/hide navigation buttons
            document.getElementById('emdr-prev-btn').style.display = emdrStep > 0 ? 'inline-block' : 'none';
            
            if (emdrStep >= emdrSteps.length - 1) {
                document.getElementById('emdr-next-btn').textContent = 'Voltooien';
            } else {
                document.getElementById('emdr-next-btn').textContent = 'Volgende';
            }
            
            const progress = ((emdrStep + 1) / emdrSteps.length) * 100;
            document.getElementById('emdr-progress').style.width = progress + '%';
        }

        // Crisis tracking
        window.openDagboekModal = function(technique) {
            currentTechnique = technique;
            
            // Track crisis usage
            if (technique === 'Crisis Hulp Technieken') {
                trackSession('crisis');
            }
            
            document.getElementById('entry-trigger').value = technique ? `Tijdens/na ${technique}` : '';
            document.getElementById('dagboek-modal').classList.add('show');
        };

        window.closeDagboekModal = function() {
            document.getElementById('dagboek-modal').classList.remove('show');
            
            // Reset form fields
            document.getElementById('entry-trigger').value = '';
            document.getElementById('entry-before').value = '5';
            document.getElementById('entry-after').value = '5';
            document.getElementById('entry-result').value = '';
            document.getElementById('entry-notes').value = '';
            
            // Reset range displays
            document.getElementById('entry-before-value').textContent = '5';
            document.getElementById('entry-after-value').textContent = '5';
            
            currentTechnique = '';
        };

        window.saveDagboekEntry = async function() {
            try {
                const entry = {
                    techniekGebruikt: currentTechnique || 'Handmatige Entry',
                    trigger: document.getElementById('entry-trigger').value,
                    intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                    intensiteitNa: parseInt(document.getElementById('entry-after').value),
                    resultaat: document.getElementById('entry-result').value,
                    notities: document.getElementById('entry-notes').value,
                    tijdstempel: new Date().toLocaleString('nl-BE')
                };

                // Show saving state
                const saveBtn = document.querySelector('#dagboek-modal .btn-primary');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'üíæ Opslaan...';
                saveBtn.disabled = true;

                const result = await saveToFirestore(entry);
                
                // Restore button
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
                closeDagboekModal();
                
                if (currentTab === 'dagboek') {
                    await loadDagboekEntries();
                }
                
                // Show appropriate success message
                if (result.source === 'Firebase') {
                    alert('‚úÖ Entry opgeslagen in cloud!');
                } else {
                    alert('‚ö†Ô∏è Entry lokaal opgeslagen\n\n' + 
                          'Reden: ' + result.reden + '\n' +
                          'De entry is veilig bewaard op dit apparaat.');
                }
                
            } catch (error) {
                // Restore button on error
                const saveBtn = document.querySelector('#dagboek-modal .btn-primary');
                saveBtn.textContent = 'üìÅ Opslaan';
                saveBtn.disabled = false;
                
                console.error('Save error:', error);
                alert('‚ùå Opslaan mislukt: ' + error.message);
                
                // Don't close modal on error so user can try again
            }
        };

        // Cleanup when page is closed or refreshed
        window.addEventListener('beforeunload', function() {
            if (isAudioPlaying) {
                stopBilateralAudio();
            }
            if (wakeLock) {
                releaseWakeLock();
            }
        });

        window.loadDagboekEntries = async function() {
            try {
                const entries = await loadFromFirestore();
                displayDagboekEntries(entries);
                
                // Show analytics if there are entries
                if (entries && entries.length > 0) {
                    showAnalytics(entries);
                }
                
            } catch (error) {
                console.error('Load entries failed:', error);
                document.getElementById('dagboek-entries').innerHTML = 
                    '<div class="alert alert-danger">' +
                        '<strong>‚ùå Fout bij laden entries:</strong><br>' + 
                        error.message +
                    '</div>';
            }
        };

        // Analytics and charting functions (CSS-based, no external dependencies)
        function showAnalytics(entries) {
            const analyticsSection = document.getElementById('analytics-section');
            analyticsSection.style.display = 'block';
            
            // Calculate analytics
            const stats = calculateAnalytics(entries);
            
            // Update stat cards
            document.getElementById('total-sessions').textContent = stats.totalSessions;
            document.getElementById('avg-improvement').textContent = stats.avgImprovement + '%';
            document.getElementById('best-technique').textContent = stats.bestTechnique;
            document.getElementById('streak-days').textContent = stats.streakDays;
            
            // Render CSS-based charts
            try {
                renderCSSIntensityChart(entries);
                renderCSSTechniqueChart(entries);
                console.log('‚úÖ CSS charts rendered successfully');
            } catch (error) {
                console.error('‚ùå Chart rendering error:', error);
            }
        }

        function renderCSSIntensityChart(entries) {
            const chartContainer = document.getElementById('intensity-chart');
            
            // Prepare data - last 8 sessions for better readability
            const chartData = entries.slice(-8).reverse();
            
            if (chartData.length === 0) {
                chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; flex-direction: column;"><div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div><div>Nog geen data voor grafiek</div><div style="font-size: 0.8rem; margin-top: 0.5rem;">Maak een paar dagboek entries</div></div>';
                return;
            }

            // Calculate chart dimensions and positions
            const chartWidth = 280;  // Fixed width for consistent mobile rendering
            const chartHeight = 180;
            const marginLeft = 30;
            const sessionWidth = chartData.length > 1 ? (chartWidth - 20) / (chartData.length - 1) : chartWidth / 2;
            
            // Prepare SVG path data for lines
            let voorLinePoints = [];
            let naLinePoints = [];
            
            // Create chart HTML
            let chartHTML = '<div class="chart-container">';
            chartHTML += '<h4 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 0.9rem; font-weight: 600;">Intensiteit Evolutie (Voor/Na)</h4>';
            chartHTML += '<div style="position: relative; width: 100%; overflow-x: auto;">';
            
            // Y-axis labels
            chartHTML += '<div class="chart-y-axis" style="position: absolute; left: 0; top: 2rem; height: 180px; display: flex; flex-direction: column-reverse; justify-content: space-between; font-size: 0.7rem; color: #6b7280; width: 25px; z-index: 2;">';
            for (let i = 0; i <= 10; i += 2) {
                chartHTML += `<div style="text-align: right; padding-right: 5px;">${i}</div>`;
            }
            chartHTML += '</div>';
            
            // Chart container with SVG overlay
            chartHTML += `<div style="margin-left: ${marginLeft}px; position: relative; width: ${chartWidth}px; height: ${chartHeight}px; border-left: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">`;
            
            // SVG for connecting lines
            chartHTML += `<svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;" viewBox="0 0 ${chartWidth} ${chartHeight}">`;
            chartHTML += '<defs><style>.line-voor { stroke: #ef4444; stroke-width: 2; fill: none; stroke-dasharray: 3,3; } .line-na { stroke: #10b981; stroke-width: 2; fill: none; }</style></defs>';
            
            // Calculate line coordinates and create paths
            chartData.forEach((entry, index) => {
                const x = index * sessionWidth + 10;
                const voorY = chartHeight - ((entry.intensiteitVoor || 0) / 10) * chartHeight;
                const naY = chartHeight - ((entry.intensiteitNa || 0) / 10) * chartHeight;
                
                voorLinePoints.push(`${x},${voorY}`);
                naLinePoints.push(`${x},${naY}`);
            });
            
            // Add SVG paths for lines
            if (voorLinePoints.length > 1) {
                chartHTML += `<polyline class="line-voor" points="${voorLinePoints.join(' ')}" />`;
            }
            if (naLinePoints.length > 1) {
                chartHTML += `<polyline class="line-na" points="${naLinePoints.join(' ')}" />`;
            }
            
            chartHTML += '</svg>';
            
            // Data points and labels
            chartData.forEach((entry, index) => {
                const x = index * sessionWidth;
                const voorY = chartHeight - ((entry.intensiteitVoor || 0) / 10) * chartHeight - 4; // -4 for dot radius
                const naY = chartHeight - ((entry.intensiteitNa || 0) / 10) * chartHeight - 4;
                
                // Extract date from timestamp 
                let dateLabel = `#${index + 1}`;
                if (entry.tijdstempel) {
                    const datePart = entry.tijdstempel.split(' ')[0]; // Get date part
                    if (datePart) {
                        const parts = datePart.split('/');
                        if (parts.length >= 2) {
                            dateLabel = `${parts[0]}/${parts[1]}`; // DD/MM format
                        }
                    }
                }
                
                chartHTML += `<div style="position: absolute; left: ${x}px; top: 0; width: 20px; height: 100%; display: flex; flex-direction: column; align-items: center;">`;
                
                // Voor point
                chartHTML += `<div class="chart-point voor" style="position: absolute; top: ${voorY}px; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; border: 2px solid #dc2626; z-index: 3; cursor: pointer;" title="Voor: ${entry.intensiteitVoor}/10 (${entry.tijdstempel})"></div>`;
                
                // Na point  
                chartHTML += `<div class="chart-point na" style="position: absolute; top: ${naY}px; width: 8px; height: 8px; border-radius: 50%; background: #10b981; border: 2px solid #059669; z-index: 3; cursor: pointer;" title="Na: ${entry.intensiteitNa}/10 (${entry.tijdstempel})"></div>`;
                
                // Date label
                chartHTML += `<div style="position: absolute; bottom: -25px; font-size: 0.65rem; color: #6b7280; white-space: nowrap; text-align: center; transform: translateX(-50%); max-width: 40px; overflow: hidden; text-overflow: ellipsis;">${dateLabel}</div>`;
                
                chartHTML += '</div>';
            });
            
            chartHTML += '</div>'; // Close chart container
            
            // Legend
            chartHTML += '<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; font-size: 0.8rem; flex-wrap: wrap;">';
            chartHTML += '<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></div><span>Voor sessie</span></div>';
            chartHTML += '<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></div><span>Na sessie</span></div>';
            chartHTML += '<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 20px; height: 2px; background: #ef4444; opacity: 0.6; border-radius: 1px;"></div><span style="font-size: 0.7rem;">Voor lijn</span></div>';
            chartHTML += '<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 20px; height: 2px; background: #10b981; border-radius: 1px;"></div><span style="font-size: 0.7rem;">Na lijn</span></div>';
            chartHTML += '</div>';
            
            chartHTML += '</div></div>';
            
            chartContainer.innerHTML = chartHTML;
        }

        function renderCSSTechniqueChart(entries) {
            const chartContainer = document.getElementById('technique-chart');
            
            // Calculate technique effectiveness
            const techniqueStats = {};
            entries.forEach(entry => {
                if (entry.techniekGebruikt && entry.intensiteitVoor && entry.intensiteitNa) {
                    if (!techniqueStats[entry.techniekGebruikt]) {
                        techniqueStats[entry.techniekGebruikt] = { improvements: [], count: 0 };
                    }
                    const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                    techniqueStats[entry.techniekGebruikt].improvements.push(improvement);
                    techniqueStats[entry.techniekGebruikt].count++;
                }
            });

            const chartData = Object.keys(techniqueStats).map(technique => {
                const stats = techniqueStats[technique];
                const avgImprovement = stats.improvements.reduce((a, b) => a + b, 0) / stats.count;
                return {
                    techniek: technique.length > 12 ? technique.substring(0, 10) + '...' : technique,
                    verbetering: Math.round(avgImprovement * 10) / 10,
                    sessies: stats.count
                };
            }).sort((a, b) => b.verbetering - a.verbetering).slice(0, 5);

            if (chartData.length === 0) {
                chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; flex-direction: column;"><div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div><div>Nog geen techniek data</div></div>';
                return;
            }

            // Find max value for scaling
            const maxValue = Math.max(...chartData.map(d => d.verbetering));
            const scale = maxValue > 0 ? 160 / maxValue : 1;

            // Create bar chart HTML
            let chartHTML = '<div class="chart-container">';
            chartHTML += '<h4 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 0.9rem; font-weight: 600;">Top 5 Effectiefste Technieken</h4>';
            chartHTML += '<div class="bar-chart">';
            
            chartData.forEach(item => {
                const height = Math.max(20, item.verbetering * scale);
                chartHTML += `<div class="bar" style="height: ${height}px;" title="${item.techniek}: ${item.verbetering} punten verbetering">`;
                chartHTML += `<div class="bar-value">+${item.verbetering}</div>`;
                chartHTML += `<div class="bar-label">${item.techniek}</div>`;
                chartHTML += '</div>';
            });
            
            chartHTML += '</div></div>';
            
            chartContainer.innerHTML = chartHTML;
        }

        function calculateAnalytics(entries) {
            const totalSessions = entries.length;
            
            // Calculate average improvement
            let totalImprovement = 0;
            let validEntries = 0;
            
            entries.forEach(entry => {
                if (entry.intensiteitVoor && entry.intensiteitNa) {
                    const improvement = ((entry.intensiteitVoor - entry.intensiteitNa) / entry.intensiteitVoor) * 100;
                    totalImprovement += improvement;
                    validEntries++;
                }
            });
            
            const avgImprovement = validEntries > 0 ? Math.round(totalImprovement / validEntries) : 0;
            
            // Find best technique
            const techniqueStats = {};
            entries.forEach(entry => {
                if (entry.techniekGebruikt && entry.intensiteitVoor && entry.intensiteitNa) {
                    if (!techniqueStats[entry.techniekGebruikt]) {
                        techniqueStats[entry.techniekGebruikt] = { total: 0, count: 0 };
                    }
                    const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                    techniqueStats[entry.techniekGebruikt].total += improvement;
                    techniqueStats[entry.techniekGebruikt].count++;
                }
            });
            
            let bestTechnique = '-';
            let bestAvg = -10;
            Object.keys(techniqueStats).forEach(technique => {
                const avg = techniqueStats[technique].total / techniqueStats[technique].count;
                if (avg > bestAvg) {
                    bestAvg = avg;
                    bestTechnique = technique.substring(0, 15) + (technique.length > 15 ? '...' : '');
                }
            });
            
            // Calculate streak (simplified - consecutive days with entries)
            const streakDays = Math.min(7, totalSessions); // Simple approximation
            
            return {
                totalSessions,
                avgImprovement,
                bestTechnique,
                streakDays
            };
        }

        window.exportDagboek = async function() {
            try {
                const entries = await loadFromFirestore();
                
                if (!entries || entries.length === 0) {
                    alert('üìù Geen entries om te exporteren');
                    return;
                }
                
                let exportText = 'ADEMRUIMTE DAGBOEK EXPORT\n';
                exportText += '================================\n';
                exportText += 'Gebruiker: ' + (currentUser ? (currentUser.displayName || currentUser.email) : 'Onbekend') + '\n';
                exportText += 'Export datum: ' + new Date().toLocaleString('nl-BE') + '\n\n';
                
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    exportText += 'ENTRY ' + (i + 1) + '\n';
                    exportText += 'Datum: ' + entry.tijdstempel + '\n';
                    exportText += 'Techniek: ' + entry.techniekGebruikt + '\n';
                    exportText += 'Trigger: ' + (entry.trigger || 'Geen') + '\n';
                    exportText += 'Intensiteit voor: ' + entry.intensiteitVoor + '/10\n';
                    exportText += 'Intensiteit na: ' + entry.intensiteitNa + '/10\n';
                    exportText += 'Resultaat: ' + getResultaatText(entry.resultaat) + '\n';
                    exportText += 'Notities: ' + (entry.notities || 'Geen') + '\n';
                    exportText += 'Bron: ' + (entry.bron || 'Onbekend') + '\n';
                    exportText += '\n---\n\n';
                }
                
                // Create downloadable file
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ademruimte-dagboek-' + new Date().toLocaleDateString('nl-BE') + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('üìÅ Dagboek ge√´xporteerd als tekstbestand!');
                
            } catch (error) {
                alert('‚ùå Fout bij exporteren: ' + error.message);
            }
        };

        function displayDagboekEntries(entries) {
            const container = document.getElementById('dagboek-entries');
            
            if (!entries || entries.length === 0) {
                container.innerHTML = 
                    '<div class="card">' +
                        '<h3>Nog geen entries</h3>' +
                        '<p>Maak een dagboekentry na het gebruiken van oefeningen om patronen bij te houden.</p>' +
                        '<button class="btn btn-primary" onclick="openDagboekModal(\'Eerste Entry\')">' +
                            'Maak je eerste entry' +
                        '</button>' +
                    '</div>';
                return;
            }
            
            // Add a header for the entries list
            let entriesHtml = '<div class="card"><h3>üìù Alle Dagboek Entries</h3><p style="color: #6b7280; margin-bottom: 1.5rem;">Chronologisch overzicht van je sessies</p></div>';
            
            entriesHtml += entries.map(entry => {
                return '<div class="entry-card">' +
                    '<div class="entry-header">' +
                        '<div>' +
                            '<div class="entry-title">' + entry.techniekGebruikt + '</div>' +
                            '<div style="font-size: 0.8rem; color: #6b7280;">' +
                                entry.tijdstempel + ' ‚Ä¢ ' +
                                '<span style="color: #0891b2; font-size: 0.75rem;">' + (entry.bron || 'Onbekend') + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="entry-result ' + entry.resultaat + '">' +
                            getResultaatText(entry.resultaat) +
                        '</div>' +
                    '</div>' +
                    '<div class="intensity-grid">' +
                        '<div style="font-size: 0.85rem;">' +
                            '<span style="color: #6b7280;">Voor:</span>' +
                            '<span style="font-weight: 500; margin-left: 0.25rem; color: #1f2937;">' + entry.intensiteitVoor + '/10</span>' +
                        '</div>' +
                        '<div style="font-size: 0.85rem;">' +
                            '<span style="color: #6b7280;">Na:</span>' +
                            '<span style="font-weight: 500; margin-left: 0.25rem; color: #1f2937;">' + entry.intensiteitNa + '/10</span>' +
                        '</div>' +
                    '</div>' +
                    (entry.trigger ? '<p style="font-size: 0.85rem; margin-bottom: 0.5rem; color: #1f2937;"><strong>Trigger:</strong> ' + entry.trigger + '</p>' : '') +
                    (entry.notities ? '<p style="font-size: 0.85rem; color: #1f2937;"><strong>Notities:</strong> ' + entry.notities + '</p>' : '') +
                '</div>';
            }).join('');
            
            container.innerHTML = entriesHtml;
        }

        function getResultaatText(resultaat) {
            const mapping = {
                'zeer-goed': 'Zeer goed',
                'goed': 'Goed',
                'matig': 'Matig',
                'geen-effect': 'Geen effect',
                'slechter': 'Slechter'
            };
            return mapping[resultaat] || resultaat;
        }

        // Range slider updates
        document.getElementById('emdr-intensity-slider').addEventListener('input', function() {
            document.getElementById('emdr-intensity-value').textContent = this.value;
        });

        document.getElementById('entry-before').addEventListener('input', function() {
            document.getElementById('entry-before-value').textContent = this.value;
        });

        document.getElementById('entry-after').addEventListener('input', function() {
            document.getElementById('entry-after-value').textContent = this.value;
        });

        // Tab switching event listeners
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                showTab(tab);
            });
        });

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ App initializing...');
            
            // Load progress data
            loadProgressData();
            
            // Set random tip of the day
            setRandomTip();
            
            // Setup tip refresh button
            const tipRefreshBtn = document.getElementById('tip-refresh-btn');
            if (tipRefreshBtn) {
                tipRefreshBtn.addEventListener('click', function() {
                    console.log('üîÑ Tip refresh button clicked');
                    getNewTip();
                });
                console.log('‚úÖ Tip refresh button listener added');
            } else {
                console.log('‚ö†Ô∏è Tip refresh button not found yet');
                // Try again after a short delay
                setTimeout(() => {
                    const btn = document.getElementById('tip-refresh-btn');
                    if (btn) {
                        btn.addEventListener('click', getNewTip);
                        console.log('‚úÖ Tip refresh button listener added (delayed)');
                    }
                }, 1000);
            }
            
            // Initialize ritual display
            updateRitualDisplay();
            
            // Initialize EMDR display  
            updateEmdrDisplay();

            // Initialize breath display
            updateBreathDisplay();

            // Setup form handlers
            setupLoginFormHandler();
            setupRegisterFormHandler();

            // Audio volume control
            const volumeControl = document.getElementById('audio-volume');
            if (volumeControl) {
                volumeControl.addEventListener('input', updateAudioSettings);
            }

            // Audio frequency control
            const frequencyControl = document.getElementById('audio-frequency');
            if (frequencyControl) {
                frequencyControl.addEventListener('input', updateAudioSettings);
                
                // Add validation to keep frequency within bounds
                frequencyControl.addEventListener('blur', function() {
                    let freq = parseInt(this.value);
                    if (freq < 60) {
                        freq = 60;
                        this.value = 60;
                    } else if (freq > 1000) {
                        freq = 1000;
                        this.value = 1000;
                    }
                    if (isAudioPlaying) updateAudioSettings();
                });
            }

            // Speed control (restart audio if playing to apply new speed)
            const speedControl = document.getElementById('audio-speed');
            if (speedControl) {
                speedControl.addEventListener('change', function() {
                    if (isAudioPlaying) {
                        stopBilateralAudio();
                        setTimeout(startBilateralAudio, 100);
                    }
                });
            }
            
            console.log('‚úÖ App initialization complete');
        });
    </script>
</body>
</html>
