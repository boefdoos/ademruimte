<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Chart.js voor statistieken -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
        --buteyko-primary: #06b6d4;
        --buteyko-secondary: #0891b2;
        --success-gradient: linear-gradient(135deg, #10b981, #059669);
        --warning-gradient: linear-gradient(135deg, #f59e0b, #d97706);
        --danger-gradient: linear-gradient(135deg, #ef4444, #dc2626);
        --primary-color: #06b6d4;
    }

    /* Reset en basis styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:before, *:after {
        box-sizing: border-box;
    }

    html {
        border: none;
        outline: none;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    .hidden { display: none !important; }
    
    /* Container */
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    .header-title h1 {
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-title p {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        opacity: 0.9;
        font-weight: 400;
    }

    .user-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 0.9rem;
        min-height: 44px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .logout-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.85rem;
        transition: var(--transition-base);
    }

    .logout-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Navigation Tabs */
    .nav-tabs {
        background: rgba(255,255,255,0.1);
        padding: 1rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .tab-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
        white-space: nowrap;
    }

    .tab-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: translateY(-1px);
    }

    .tab-btn.active {
        background: rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        font-weight: 600;
    }

    /* Cards */
    .card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .card h3 {
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: var(--transition-base);
        min-height: var(--touch-target);
        position: relative;
        overflow: hidden;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.3);
    }

    .btn-primary.active {
        background: linear-gradient(135deg, #0891b2, #0e7490);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        transform: none;
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
    }

    .btn-warning {
        background: var(--warning-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-warning:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-danger {
        background: var(--danger-gradient);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
    }

    .btn-orange {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-orange:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(234, 88, 12, 0.3);
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition-base);
        background: white;
        min-height: var(--touch-target);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    select.form-control {
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    /* Range Slider */
    .range-container {
        position: relative;
        margin: 1rem 0;
    }

    .range-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        outline: none;
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
    }

    .range-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    .range-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
    }

    .range-value {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .stat-card {
        background: rgba(255,255,255,0.5);
        padding: 1.5rem 1rem;
        border-radius: var(--border-radius);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        transition: var(--transition-base);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-light);
        font-weight: 500;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Breathing Circle */
    .breathing-circle {
        width: 200px;
        height: 200px;
        border: 4px solid var(--primary-color);
        border-radius: 50%;
        margin: 2rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 700;
        color: #0891b2;
        transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
        position: relative;
        background: rgba(6, 182, 212, 0.1);
        transform: scale(1);
        text-align: center;
        line-height: 1.3;
        padding: 2rem;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    .breathing-circle.inhale {
        background: rgba(6, 182, 212, 0.2);
        color: #0891b2;
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
    }

    .breathing-circle.exhale {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
        color: #047857;
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
    }

    .breathing-circle.hold {
        background: rgba(245, 158, 11, 0.2);
        border-color: #f59e0b;
        color: #d97706;
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.4);
    }

    /* CP Measurement */
    .cp-display {
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        color: var(--primary-color);
        margin: 1rem 0;
        font-family: 'Monaco', 'Menlo', monospace;
    }

    .cp-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    /* Progress Chart */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 2rem 0;
        background: rgba(255,255,255,0.1);
        border-radius: var(--border-radius);
        padding: 1rem;
    }

    /* Messages */
    .message {
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        animation: slideInDown 0.3s ease;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 350px;
        box-shadow: var(--shadow-md);
        border: 2px solid transparent;
        font-size: 0.9rem;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .message.success {
        background: rgba(16, 185, 129, 0.95);
        color: white;
        border-color: #059669;
        backdrop-filter: blur(10px);
    }

    .message.warning {
        background: rgba(245, 158, 11, 0.95);
        color: white;
        border-color: #d97706;
        backdrop-filter: blur(10px);
    }

    .message.danger, .message.error {
        background: rgba(239, 68, 68, 0.95);
        color: white;
        border-color: #dc2626;
        backdrop-filter: blur(10px);
        font-weight: 600;
    }

    .message.info {
        background: rgba(6, 182, 212, 0.95);
        color: white;
        border-color: #0891b2;
        backdrop-filter: blur(10px);
    }

    .message:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md), 0 4px 20px rgba(0,0,0,0.1);
    }

    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Loading States */
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--card-background);
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-md);
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 1rem;
        top: 1rem;
    }

    .close:hover {
        color: #000;
    }

    /* Button Groups */
    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .container {
            padding: 0.5rem;
        }
        
        .card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .user-info {
            position: static;
            justify-content: center;
            margin-bottom: 1rem;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-tabs {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .tab-btn {
            width: 100%;
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            font-size: 1rem;
            padding: 1.5rem;
        }
        
        .cp-display {
            font-size: 2rem;
        }
        
        .message {
            position: relative;
            top: auto;
            right: auto;
            max-width: none;
            margin: 1rem 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        .button-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .button-group .btn {
            width: 100%;
        }
    }

    /* Auth Screen Styles */
    #auth-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .auth-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        width: 100%;
        max-width: 450px;
        text-align: center;
    }

    .auth-card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
    }

    .auth-card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
    }

    /* Crisis Help Styles */
    .crisis-card {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
    }

    .crisis-card h3 {
        color: white;
    }

    /* Crisis Protocol Specific Styles */
    #crisis-protocol .card {
        animation: slideInUp 0.4s ease-out;
        border: 2px solid var(--primary-color);
    }

    #crisis-protocol .breathing-circle {
        width: 150px;
        height: 150px;
        font-size: 1.1rem;
        padding: 1.5rem;
    }

    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    #protocol-timer {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 1.1rem;
        letter-spacing: 1px;
    }

    #protocol-progress {
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
    }

    .loading-text {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Status Indicators */
    .status-connected {
        background: #10b981 !important;
        box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    }

    .status-disconnected {
        background: #f59e0b !important;
        box-shadow: 0 0 6px rgba(245, 158, 11, 0.5);
    }

    .status-error {
        background: #ef4444 !important;
        box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
    }

    /* Sensatie Checkboxes */
    .symptom-checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .symptom-checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: var(--transition-base);
        background: rgba(255,255,255,0.5);
    }

    .symptom-checkbox-item:hover {
        background: rgba(6, 182, 212, 0.1);
    }

    .symptom-checkbox-item.selected {
        background: rgba(6, 182, 212, 0.2);
        border: 1px solid var(--primary-color);
    }

    .symptom-checkbox {
        margin-right: 0.5rem;
    }

    /* Checkbox Styling */
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
        cursor: pointer;
    }

    /* DEV_MODE indicator styles */
    .dev-mode-indicator {
        position: fixed;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, #ff0000, #cc0000);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        display: none;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .dev-mode-indicator.active {
        display: block;
        animation: pulse-dev 2s ease-in-out infinite;
    }
    
    @keyframes pulse-dev {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    .dev-mode-indicator:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
    }
    
    /* ============================================
       COOKIE CONSENT BANNER & FOOTER
       ============================================ */
    
    .cookie-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 3px solid var(--primary-color);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        z-index: 10000;
        padding: 1.5rem;
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    
    .cookie-content {
        max-width: 1000px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 2rem;
        flex-wrap: wrap;
    }
    
    .cookie-content h3 {
        margin: 0;
        color: var(--text-dark);
        font-size: 1.25rem;
    }
    
    .cookie-text {
        flex: 1;
        min-width: 300px;
    }
    
    .cookie-text p {
        margin: 0.5rem 0 0 0;
        color: var(--text-light);
        line-height: 1.6;
    }
    
    .cookie-text a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
    }
    
    .cookie-text a:hover {
        text-decoration: underline;
    }
    
    .cookie-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .footer {
        background: var(--card-bg);
        border-top: 1px solid #e5e7eb;
        padding: 1rem;
        margin-top: 3rem;
        text-align: center;
    }
    
    .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .footer-links {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .footer-links a {
        color: var(--text-light);
        text-decoration: none;
        font-size: 0.85rem;
    }
    
    .footer-links a:hover {
        color: var(--primary-color);
    }
    
    .footer-info {
        color: var(--text-light);
        font-size: 0.75rem;
    }
    
    .footer-info p {
        margin: 0;
    }
    
    @media (max-width: 768px) {
        .cookie-content {
            flex-direction: column;
            align-items: stretch;
        }
        
        .cookie-buttons {
            width: 100%;
        }
        
        .cookie-buttons button {
            flex: 1;
        }
        
        .footer-links {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="auth-loading" class="hidden">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; color: white;">
            <div style="text-align: center;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p class="loading-text">Ademruimte wordt geladen...</p>
            </div>
        </div>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-card">
            <div id="login-form">
                <h2>Inloggen bij Ademruimte</h2>
                <p>Vul je gegevens in om door te gaan</p>
                
                <div class="form-group">
                    <label for="login-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="login-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Wachtwoord" required>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <input type="checkbox" id="remember-me" style="margin: 0; flex-shrink: 0;">
                    <label for="remember-me" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Onthoud mij</label>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="login-btn" onclick="loginUser()">
                        <span>üîë Inloggen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1rem; font-size: 0.875rem;">
                    <button onclick="showPasswordResetForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; text-decoration: underline;">Wachtwoord vergeten?</button>
                </p>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Nog geen account? 
                    <button id="show-register" onclick="showRegisterForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Registreren</button>
                </p>
            </div>
            
            <div id="register-form" class="hidden">
                <h2>Account Aanmaken</h2>
                <p>Maak een nieuw account aan voor Ademruimte</p>
                
                <div class="form-group">
                    <label for="register-name">Volledige naam:</label>
                    <input type="text" class="form-control" id="register-name" placeholder="Je naam" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="register-email" placeholder="je@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">Wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password" placeholder="Minimaal 6 karakters" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password-confirm">Bevestig wachtwoord:</label>
                    <input type="password" class="form-control" id="register-password-confirm" placeholder="Herhaal wachtwoord" required>
                </div>
                
                <div style="background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.85rem;">
                    <p style="margin: 0; color: var(--text-dark);">
                        <i class="fas fa-shield-alt"></i> Door een account aan te maken, ga je akkoord met ons 
                        <a href="privacy-policy.html" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">privacybeleid</a> 
                        en het gebruik van cookies voor app functionaliteit.
                    </p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="register-btn" onclick="registerUser()">
                        <span>‚úÖ Account Aanmaken</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Al een account? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
            
            <div id="password-reset-form" class="hidden">
                <h2>Wachtwoord Resetten</h2>
                <p>Vul je e-mailadres in om een reset link te ontvangen</p>
                
                <div class="form-group">
                    <label for="reset-email">E-mailadres:</label>
                    <input type="email" class="form-control" id="reset-email" placeholder="je@email.com" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-warning" id="reset-btn" onclick="resetPassword()">
                        <span>üìß Reset Link Versturen</span>
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; font-size: 0.875rem;">
                    Weet je je wachtwoord weer? 
                    <button onclick="showLoginForm()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: 600;">Inloggen</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header>
            <div class="user-info" id="user-info">
                <div class="spinner"></div>
            </div>
            <div class="header-title">
                <h1>Ademruimte</h1>
                <p>Evidence-based hulp bij hyperventilatie en gerelateerde klachten</p>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</button>
            <button class="tab-btn" data-tab="buteyko"><i class="fas fa-lungs"></i> Buteyko</button>
            <button class="tab-btn" data-tab="resonant"><i class="fas fa-heartbeat"></i> Resonant</button>
            <button class="tab-btn" data-tab="dagboek"><i class="fas fa-chart-bar"></i> Dagboek</button>
            <button class="tab-btn" data-tab="crisis"><i class="fas fa-exclamation-triangle"></i> Crisis Hulp</button>
            <button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Instellingen</button>
        </nav>

        <main class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 id="dashboard-greeting">Welkom bij Ademruimte</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Op basis van wetenschappelijk onderzoek biedt Ademruimte effectieve hulp bij chronische hyperventilatie en bijkomende klachten. 
                        <strong>70-80% van de pati√´nten</strong> behaalt significante verbetering met de juiste technieken.
                    </p>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-sessions">0</div>
                            <div class="stat-label">Totaal sessies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streak-days">0</div>
                            <div class="stat-label">Dagen streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avg-improvement">-</div>
                            <div class="stat-label">Gem. verbetering</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="last-cp">-</div>
                            <div class="stat-label">Laatste CP</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-bullseye"></i> Jouw Persoonlijke Inzichten</h3>
                    <div id="insights-content">
                        <p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>
                    </div>
                </div>

                <div class="card" id="active-medications-card" style="display: none;">
                    <h3><i class="fas fa-pills"></i> Actieve Medicaties</h3>
                    <div id="active-medications-content">
                        <p style="color: var(--text-light);">Geen actieve medicaties geregistreerd.</p>
                    </div>
                    <small style="color: var(--text-light); display: block; margin-top: 1rem;">
                        üí° Track je medicatie via dagboek entries om langetermijn patronen te analyseren
                    </small>
                </div>

                <div class="card">
                    <h3><i class="fas fa-lightbulb"></i> Jouw Persoonlijke Tip</h3>
                    <div id="tip-content">
                        <p>Start met je eerste oefening om persoonlijke tips te ontvangen!</p>
                    </div>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-wind"></i> Buteyko Ademhaling</h2>
                    <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                        De Buteyko methode helpt je CO2-tolerantie te verbeteren en hyperventilatie te reduceren.
                    </p>
                    <div id="haptic-indicator" style="display: none; background: rgba(16, 185, 129, 0.1); padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem;">
                        <i class="fas fa-mobile-alt" style="color: #10b981;"></i> <span style="color: #047857;">Haptische feedback actief</span>
                    </div>

                    <!-- Control Pause Measurement -->
                    <div class="card" style="background: rgba(6, 182, 212, 0.1); border: 2px solid rgba(6, 182, 212, 0.2);">
                        <h3>‚è±Ô∏è Control Pause (CP) Meting</h3>
                        <p style="margin-bottom: 1rem;">Meet je CO2-tolerantie. Normale waarden: 20-40 seconden.</p>
                        
                        <div class="cp-display" id="cp-timer">00</div>
                        
                        <div class="cp-controls">
                            <button class="btn btn-primary" id="start-cp" onclick="startCPMeasurement()">Start CP Meting</button>
                            <button class="btn btn-danger" id="stop-cp" onclick="stopCPMeasurement()" disabled>Stop</button>
                            <button class="btn btn-warning" id="reset-cp" onclick="resetCPMeasurement()">Reset</button>
                        </div>
                        
                        <div id="cp-instructions" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 0.5rem;">
                            <strong>Instructies:</strong>
                            <ol style="margin-top: 0.5rem;">
                                <li>Adem normaal in en uit</li>
                                <li>Na een normale uitademing, houd je adem in</li>
                                <li>Klik "Start CP Meting" en stop zodra je de eerste drang voelt om te ademen</li>
                                <li>Dit is je Control Pause score</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Breathing Exercise -->
                    <div class="card">
                        <h3><i class="fas fa-lungs"></i> Ademhalingsoefening</h3>
                        
                        <div class="form-group">
                            <label for="breathing-pattern"><i class="fas fa-lungs"></i> Selecteer Buteyko patroon:</label>
                            <select class="form-control" id="breathing-pattern" onchange="updateBreathingPattern()">
                                <option value="gentle" selected>Zachte oefening (10 sec vrij ademhalen + adempauze)</option>
                                <option value="extended">Verlengde adempauze (in/uit ‚Üí pauze ‚Üí herhaal)</option>
                            </select>
                        </div>

                        <div class="form-group" id="hold-duration-group" style="display: block;">
                            <label style="margin-bottom: 0.5rem; display: block;">‚è±Ô∏è Adempauze duur: <strong><span id="hold-duration-display">3</span> seconden</strong></label>
                            <div class="range-container">
                                <input type="range" class="range-slider" id="hold-duration-slider" min="2" max="10" value="3" oninput="updateHoldDuration()">
                            </div>
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;" id="hold-tip">
                                üí° Tip: Begin met 3 seconden en verhoog geleidelijk naarmate je CO2-tolerantie verbetert.
                            </small>
                        </div>

                        <div class="form-group" id="haptic-toggle-container" style="display: none;">
                            <label style="margin-bottom: 0.5rem; display: block;"><i class="fas fa-mobile-alt"></i> Haptische feedback (trillingen):</label>
                            <button class="btn btn-secondary" id="haptic-toggle" onclick="toggleHaptics()" style="width: 100%;">
                                <span id="haptic-status">Uitgeschakeld</span>
                                <small style="display: block; font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.9;">
                                    Alleen Android ‚Ä¢ Voel vibraties bij fase overgangen
                                </small>
                            </button>
                        </div>

                        <div class="breathing-circle" id="breathing-circle">
                            Bereid je voor
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" id="start-breathing" onclick="startBreathing()">Start Oefening</button>
                            <button class="btn btn-danger" id="stop-breathing" onclick="stopBreathing()" disabled>Stop</button>
                        </div>

                        <div id="breathing-info" style="text-align: center; margin-top: 1rem;">
                            <p><strong>Cyclus:</strong> <span id="cycle-count">0</span> <span id="cycle-target">van 20</span></p>
                            <p><strong>Fase:</strong> <span id="current-phase">Rust</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resonant Breathing Tab -->
            <div id="resonant" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-heartbeat"></i> Resonant Breathing</h2>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Resonant breathing (coherent breathing) activeert je parasympathische zenuwstelsel en verbetert HRV. 
                        <strong>Aanbevolen:</strong> 2√ó per dag, 20 minuten.
                    </p>

                    <!-- Session Setup -->
                    <div class="card" style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.2);">
                        <h3><i class="fas fa-cog"></i> Sessie Instellingen</h3>
                        
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Sessie duur:</label>
                            <div class="button-group" style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="setResonantDuration(10)">10 min</button>
                                <button class="btn btn-secondary" onclick="setResonantDuration(15)">15 min</button>
                                <button class="btn btn-primary" onclick="setResonantDuration(20)">20 min ‚≠ê</button>
                            </div>
                            <p id="resonant-duration-display" style="margin-top: 0.5rem; color: var(--text-dark); font-weight: 600;">
                                Geselecteerd: 20 minuten
                            </p>
                        </div>

                        <div class="form-group">
                            <label style="margin-bottom: 0.5rem; display: block;">
                                <i class="fas fa-lungs"></i> Ademhalingsritme: <strong><span id="resonant-bpm-display">5.5</span> ademhalingen/min</strong>
                            </label>
                            <div class="range-container">
                                <input type="range" class="range-slider" id="resonant-bpm-slider" 
                                       min="4.5" max="6.5" step="0.5" value="5.5" 
                                       oninput="updateResonantBPM()">
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                <span>4.5 bpm</span>
                                <span>5.5 bpm (aanbevolen)</span>
                                <span>6.5 bpm</span>
                            </div>
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                üí° 5.5 ademhalingen/min is het "sweet spot" voor de meeste mensen. Begin hier en pas aan indien nodig.
                            </small>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-volume-up"></i> Audio begeleiding:</label>
                            <select class="form-control" id="resonant-audio" onchange="updateResonantAudio()">
                                <option value="silence" selected>Stil</option>
                                <option value="tones">Zachte tonen</option>
                            </select>
                        </div>
                    </div>

                    <!-- Breathing Exercise -->
                    <div class="card">
                        <h3><i class="fas fa-play-circle"></i> Sessie</h3>
                        
                        <div class="resonant-circle-container" style="position: relative; display: flex; justify-content: center; align-items: center; min-height: 350px;">
                            <canvas id="resonant-circle" width="300" height="300" style="max-width: 100%;"></canvas>
                            <div id="resonant-phase-text" style="position: absolute; font-size: 1.5rem; font-weight: 600; color: var(--text-dark);">
                                Klaar om te starten
                            </div>
                        </div>

                        <div class="button-group" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" id="start-resonant" onclick="startResonantBreathing()">
                                <i class="fas fa-play"></i> Start Sessie
                            </button>
                            <button class="btn btn-warning" id="pause-resonant" onclick="pauseResonantBreathing()" disabled>
                                <i class="fas fa-pause"></i> Pauze
                            </button>
                            <button class="btn btn-danger" id="stop-resonant" onclick="stopResonantBreathing()" disabled>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>

                        <div id="resonant-info" style="text-align: center; margin-top: 1.5rem; background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 0.5rem;">
                            <p style="margin-bottom: 0.5rem;">
                                <strong>Tijd:</strong> <span id="resonant-time-display">20:00</span>
                            </p>
                            <p style="margin-bottom: 0;">
                                <strong>Voortgang:</strong> <span id="resonant-progress">0%</span>
                            </p>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="card" style="background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.2);">
                        <h3><i class="fas fa-info-circle"></i> Instructies</h3>
                        <ol style="margin-left: 1.5rem; line-height: 1.8;">
                            <li>Kies je sessieduur (20 min aanbevolen)</li>
                            <li>Pas indien gewenst het ademritme aan (5.5 bpm is ideaal)</li>
                            <li>Klik "Start Sessie"</li>
                            <li>Volg de cirkel: groter = inademen, kleiner = uitademen</li>
                            <li>Houd het ritme comfortabel - geen air hunger!</li>
                            <li>Na afloop kun je je ervaring bijhouden in het dagboek</li>
                        </ol>
                        <p style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.5); border-radius: 0.5rem;">
                            <strong>üí° Tip:</strong> Resonant breathing werkt <em>cumulatief</em>. De effecten bouwen op over weken. 
                            Consistentie is belangrijker dan perfectie!
                        </p>
                    </div>

                    <!-- Weekly Progress -->
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Deze Week</h3>
                        <div id="resonant-weekly-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700; color: #10b981;"><span id="resonant-sessions-count">0</span></div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Sessies voltooid</div>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;"><span id="resonant-adherence">0</span>%</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Therapietrouw (doel: 14)</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;"><span id="resonant-total-minutes">0</span></div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Totale minuten</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dagboek Tab -->
            <div id="dagboek" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Dagboek & Statistieken</h2>
                    
                    <div class="button-group" style="margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="openJournalModal()"><i class="fas fa-pen"></i> Nieuwe Entry</button>
                        <button class="btn btn-success" onclick="exportDagboek()"><i class="fas fa-download"></i> Exporteer</button>
                    </div>

                    <div class="form-group">
                        <label for="journal-filter">Filter dagboek entries:</label>
                        <select class="form-control" id="journal-filter" onchange="filterJournalEntries()">
                            <option value="last7" selected>Laatste 7 dagen</option>
                            <option value="last30">Laatste 30 dagen</option>
                            <option value="all">Alle entries</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">üìà Statistiek periode:</label>
                        <div class="button-group">
                            <button class="btn btn-primary" id="chart-10days" onclick="updateChartFilter('10days')">Laatste 10 dagen</button>
                            <button class="btn btn-primary" id="chart-30days" onclick="updateChartFilter('30days')">Laatste 30 dagen</button>
                            <button class="btn btn-primary" id="chart-all" onclick="updateChartFilter('all')">Alle data</button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>

                    <div id="journal-entries">
                        <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                            <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crisis Help Tab -->
            <div id="crisis" class="tab-content">
                <div class="card crisis-card">
                    <h2><i class="fas fa-exclamation-triangle"></i> Crisis Hulp</h2>
                    <p style="margin-bottom: 2rem;">Directe hulp bij acute hyperventilatie of paniekaanvallen.</p>

                    <div class="button-group">
                        <button class="btn btn-warning" onclick="startCrisisProtocol()">üÜò Start Noodprotocol</button>
                        <button class="btn btn-primary" onclick="startCrisisBreathing()"><i class="fas fa-lungs"></i> Simpele Nood Ademhaling</button>
                    </div>

                    <!-- Crisis Protocol Interface -->
                    <div id="crisis-protocol" class="hidden" style="margin-top: 2rem; text-align: center;">
                        <div class="card" style="background: rgba(255,255,255,0.95); color: var(--text-dark); margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 id="protocol-step-title" style="color: #1f2937; font-weight: 700; margin: 0;">STOP - Je bent veilig</h3>
                                <div style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 2rem; font-weight: bold; min-width: 80px;">
                                    <span id="protocol-timer">00:30</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="background: rgba(6, 182, 212, 0.15); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid var(--primary-color);">
                                    <p id="protocol-instructions" style="font-size: 1.15rem; font-weight: 600; margin: 0; color: #1f2937; line-height: 1.6;">
                                        Dit is hyperventilatie en het gaat voorbij. Leg je hand op je buik en voel je ademhaling.
                                    </p>
                                </div>
                            </div>

                            <div class="breathing-circle" id="protocol-circle" style="width: 150px; height: 150px; margin: 1rem auto;">
                                Voel je ademhaling...
                            </div>

                            <div style="background: rgba(16, 185, 129, 0.15); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                                <p id="protocol-encouragement" style="margin: 0; font-weight: 600; color: #065f46; font-size: 1.05rem;">
                                    Je bent veilig. Dit gevoel is tijdelijk.
                                </p>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <div style="background: rgba(0,0,0,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="protocol-progress" style="background: var(--primary-color); height: 100%; width: 0%; transition: width 1s linear;"></div>
                                </div>
                                <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                                    Stap <span id="protocol-current-step">1</span> van <span id="protocol-total-steps">5</span>
                                </small>
                            </div>

                            <button class="btn btn-danger" onclick="stopCrisisProtocol()" style="margin-top: 1rem;">
                                Stoppen
                            </button>
                        </div>
                    </div>

                    <!-- Simple Crisis Breathing -->
                    <div id="crisis-breathing" class="hidden" style="margin-top: 2rem;">
                        <div class="breathing-circle" id="crisis-circle">
                            Volg de cirkel
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-danger" onclick="stopCrisisBreathing()">Stop</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìû Noodhulp</h3>
                    <p><strong>Bij acute noodsituaties:</strong></p>
                    <ul style="margin: 1rem 0;">
                        <li>üöë Spoeddiensten: 112</li>
                        <li>ü©∫ Huisarts: Contacteer je eigen huisarts</li>
                        <li>üß† Zelfmoordlijn: 1813 of 0800 32 123</li>
                        <li>üí¨ Tele-onthaal: 106</li>
                    </ul>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-cog"></i> Instellingen</h2>
                    
                    <!-- Account Info -->
                    <div class="card" style="background: rgba(6, 182, 212, 0.1); border: 2px solid rgba(6, 182, 212, 0.2);">
                        <h3><i class="fas fa-user"></i> Account</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: var(--text-light);">Email:</span>
                                <span id="settings-email" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: var(--text-light);">Account aangemaakt:</span>
                                <span id="settings-created" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: var(--text-light);">Totaal sessies:</span>
                                <span id="settings-sessions" style="font-weight: 600;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy & Data -->
                    <div class="card" style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.2);">
                        <h3><i class="fas fa-shield-alt"></i> Privacy & Gegevens</h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">
                            Je hebt volledige controle over je gegevens volgens de AVG/GDPR.
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <button class="btn btn-primary" onclick="window.open('privacy-policy.html', '_blank')" style="width: 100%;">
                                <i class="fas fa-file-contract"></i> Privacybeleid
                            </button>
                            
                            <button class="btn btn-success" onclick="exportUserData()" style="width: 100%;">
                                <i class="fas fa-download"></i> Exporteer Mijn Gegevens
                                <small style="display: block; font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.9;">
                                    Download al je data in JSON formaat
                                </small>
                            </button>
                            
                            <button class="btn btn-secondary" onclick="manageCookieConsent()" style="width: 100%;">
                                <i class="fas fa-cookie-bite"></i> Cookie Voorkeuren
                                <small style="display: block; font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.9;">
                                    Beheer je toestemming
                                </small>
                            </button>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.2);">
                        <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">
                            <strong>Waarschuwing:</strong> Deze actie kan niet ongedaan worden gemaakt.
                        </p>
                        
                        <button class="btn btn-danger" onclick="deleteUserAccount()" style="width: 100%;">
                            <i class="fas fa-trash-alt"></i> Account Permanent Verwijderen
                            <small style="display: block; font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.9;">
                                Verwijdert al je gegevens permanent
                            </small>
                        </button>
                    </div>

                    <!-- App Info -->
                    <div class="card">
                        <h3><i class="fas fa-info-circle"></i> Over Ademruimte</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; color: var(--text-light);">
                            <p><strong>Versie:</strong> 1.0.0</p>
                            <p><strong>Laatst bijgewerkt:</strong> 12 januari 2026</p>
                            <p><strong>Contact:</strong> <span id="settings-email-display"></span></p>
                            <p style="margin-top: 1rem;">
                                Ademruimte helpt bij het bijhouden en verbeteren van chronische hyperventilatie 
                                door middel van de wetenschappelijk onderbouwde Buteyko methode.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journal-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJournalModal()">&times;</span>
            <h2><i class="fas fa-pen"></i> Nieuwe Dagboek Entry</h2>
            
            <div class="form-group">
                <label for="entry-technique">Techniek gebruikt:</label>
                <select class="form-control" id="entry-technique">
                    <option value="Buteyko Ademhaling">Buteyko Ademhaling</option>
                    <option value="Resonant Breathing">Resonant Breathing</option>
                    <option value="Crisis Ademhaling">Crisis Ademhaling</option>
                    <option value="Noodprotocol">Noodprotocol</option>
                    <option value="Handmatige Entry">Handmatige Entry</option>
                </select>
            </div>

            <div class="form-group">
                <label for="entry-trigger">Trigger/Oorzaak:</label>
                <input type="text" class="form-control" id="entry-trigger" placeholder="Wat triggerde de symptomen?">
            </div>

            <div class="form-group">
                <label for="entry-before">Intensiteit v√≥√≥r (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-before" min="1" max="10" value="5" oninput="updateRangeValue('entry-before', 'before-value')">
                    <div class="range-value" id="before-value">5</div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-after">Intensiteit na (1-10):</label>
                <div class="range-container">
                    <input type="range" class="range-slider" id="entry-after" min="1" max="10" value="5" oninput="updateRangeValue('entry-after', 'after-value')">
                    <div class="range-value" id="after-value">5</div>
                </div>
            </div>

            <div class="form-group" id="cp-score-group">
                <label for="entry-cp-score"><i class="fas fa-stopwatch"></i> Control Pause Score (optioneel, in seconden):</label>
                <input type="number" class="form-control" id="entry-cp-score" min="1" max="120" placeholder="Bijv. 25">
                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                    Vul je CP score in als je deze hebt gemeten. Normale waarden: 20-40 seconden.
                </small>
            </div>

            <div class="form-group">
                <label>Sensaties (selecteer van toepassing):</label>
                <div class="symptom-checkbox-container">
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Kortademigheid">
                        <label>Kortademigheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Luchthonger">
                        <label>Luchthonger</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Drukkend gevoel borst">
                        <label>Drukkend gevoel borst</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Hartkloppingen">
                        <label>Hartkloppingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Duizeligheid">
                        <label>Duizeligheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Tintelingen">
                        <label>Tintelingen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Geforceerd gapen">
                        <label>Geforceerd gapen</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Neus optrekken">
                        <label>Neus optrekken</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Piekergedachten">
                        <label>Piekergedachten</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Frustratie">
                        <label>Frustratie</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Onwerkelijke gevoelens">
                        <label>Onwerkelijke gevoelens</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Vermoeidheid">
                        <label>Vermoeidheid</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Paniek">
                        <label>Paniek</label>
                    </div>
                    <div class="symptom-checkbox-item" onclick="toggleSymptom(this)">
                        <input type="checkbox" class="symptom-checkbox" data-symptom="Angst">
                        <label>Angst</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="entry-result">Resultaat:</label>
                <select class="form-control" id="entry-result">
                    <option value="">Selecteer resultaat</option>
                    <option value="Veel beter">Veel beter</option>
                    <option value="Beter">Beter</option>
                    <option value="Iets beter">Iets beter</option>
                    <option value="Geen verandering">Geen verandering</option>
                    <option value="Slechter">Slechter</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="entry-has-medication" onchange="toggleMedicationFields()" style="width: auto;">
                    üíä Medicatie event toevoegen
                </label>
            </div>

            <div id="medication-fields" style="display: none; background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="entry-med-action">Actie:</label>
                    <select class="form-control" id="entry-med-action">
                        <option value="">Selecteer actie...</option>
                        <option value="started">‚úÖ Gestart met medicijn</option>
                        <option value="stopped">‚õî Gestopt met medicijn</option>
                        <option value="dose_change">üîÑ Dosiswijziging</option>
                        <option value="extra">‚ûï Extra dosis genomen</option>
                        <option value="regular">üìÖ Reguliere dosis (voor tracking)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="entry-med-name">Medicijn naam:</label>
                    <input type="text" class="form-control" id="entry-med-name" placeholder="Bijv. Lorazepam, Sertraline, Propranolol">
                    <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                        üí° Voor tracking: anxiolytica, antidepressiva, b√®tablokkers, of andere medicatie gerelateerd aan je klachten
                    </small>
                </div>

                <div class="form-group">
                    <label for="entry-med-dose">Dosering:</label>
                    <input type="text" class="form-control" id="entry-med-dose" placeholder="Bijv. 20mg, 40mg, 0.5mg">
                </div>

                <div class="form-group" id="med-previous-dose-group" style="display: none;">
                    <label for="entry-med-previous-dose">Vorige dosering (bij wijziging):</label>
                    <input type="text" class="form-control" id="entry-med-previous-dose" placeholder="Bijv. 20mg">
                </div>

                <div class="form-group">
                    <label for="entry-med-reason">Reden (optioneel):</label>
                    <input type="text" class="form-control" id="entry-med-reason" placeholder="Bijv. Arts advies, verhoogde klachten, preventief">
                </div>
            </div>

            <div class="form-group">
                <label for="entry-notes">Notities:</label>
                <textarea class="form-control" id="entry-notes" placeholder="Extra opmerkingen..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="saveJournalEntry()"><i class="fas fa-save"></i> Opslaan</button>
                <button class="btn btn-orange" onclick="closeJournalModal()">Annuleren</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: rgba(255,255,255,0.8); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">üìû In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <!-- Developer Credit -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8;">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>

<script type="module">
    // Firebase configuration (exact same credentials)
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte.vercel.app", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Global variables
    let app, auth, db, currentUser = null;
    let currentTab = 'dashboard';
    let allJournalEntries = [];
    let allCPMeasurements = [];
    let progressChart = null;
    let chartFilter = '10days'; // New default: last 10 days

    // Resonant Breathing variables
    let resonantDuration = 20; // minutes
    let resonantBPM = 5.5; // breaths per minute
    let resonantAudioMode = 'silence';
    let resonantInterval = null;
    let resonantStartTime = null;
    let resonantPaused = false;
    let resonantCanvas = null;
    let resonantCtx = null;
    let resonantAnimationId = null;
    let resonantSessions = [];
    let resonantAudioContext = null;
    let resonantLastPhase = null; // Track phase changes for audio cues

    // ===========================================
    // DEV_MODE CONFIGURATION
    // ===========================================
    const DEV_MODE = localStorage.getItem('ADEMRUIMTE_DEV_MODE') === 'true';
    
    // Toggle DEV_MODE with keyboard shortcut (Ctrl+Shift+D)
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            const newMode = !DEV_MODE;
            localStorage.setItem('ADEMRUIMTE_DEV_MODE', newMode.toString());
            location.reload();
        }
    });
    
    // DEV_MODE: Create mock user to bypass authentication
    if (DEV_MODE) {
        // Create a mock current user for development
        currentUser = {
            uid: 'dev-user-123',
            email: 'dev@ademruimte.local',
            displayName: 'DEV User',
            emailVerified: true
        };
        
        console.log('%cüîß DEV_MODE ENABLED - Authentication bypassed', 'background: #ff0000; color: white; font-size: 16px; padding: 4px 8px; border-radius: 4px;');
        console.log('Press Ctrl+Shift+D to toggle DEV_MODE');
        console.log('Mock user:', currentUser);
    }
    
    // Show DEV_MODE indicator
    if (DEV_MODE) {
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addDevIndicator);
        } else {
            addDevIndicator();
        }
    }
    
    function addDevIndicator() {
        const devIndicator = document.createElement('div');
        devIndicator.className = 'dev-mode-indicator active';
        devIndicator.innerHTML = 'üîß DEV MODE (No Auth)';
        devIndicator.title = 'Druk Ctrl+Shift+D om uit te schakelen';
        devIndicator.onclick = () => {
            localStorage.setItem('ADEMRUIMTE_DEV_MODE', 'false');
            location.reload();
        };
        document.body.appendChild(devIndicator);
    }
    
    // Enhanced logging function for dev mode
    function devLog(message, data = null) {
        if (DEV_MODE) {
            console.log('%c[DEV]', 'color: #ff0000; font-weight: bold;', message, data || '');
        }
    }
    
    // Enhanced error logging for dev mode
    function devError(message, error = null) {
        if (DEV_MODE) {
            console.error('%c[DEV ERROR]', 'color: #ff0000; font-weight: bold;', message, error || '');
        }
    }

    // ============================================
    // GDPR COMPLIANCE FUNCTIONS
    // ============================================
    
    // Cookie consent management
    function checkCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            // Show banner after short delay
            setTimeout(() => {
                document.getElementById('cookie-banner').style.display = 'block';
            }, 1000);
        }
        return consent;
    }
    
    window.acceptCookies = function() {
        localStorage.setItem('cookieConsent', JSON.stringify({
            essential: true,
            functional: true,
            acceptedAt: new Date().toISOString(),
            version: '1.0'
        }));
        document.getElementById('cookie-banner').style.display = 'none';
        console.log('‚úÖ Cookie consent gegeven');
    }
    
    window.acceptEssentialOnly = function() {
        localStorage.setItem('cookieConsent', JSON.stringify({
            essential: true,
            functional: false,
            acceptedAt: new Date().toISOString(),
            version: '1.0'
        }));
        document.getElementById('cookie-banner').style.display = 'none';
        console.log('‚úÖ Alleen essenti√´le cookies geaccepteerd');
    }
    
    window.manageCookieConsent = function() {
        const consent = JSON.parse(localStorage.getItem('cookieConsent') || '{}');
        const message = `Huidige cookie voorkeuren:
        
Essenti√´le cookies: ‚úÖ Altijd aan (vereist voor login)
Functionele cookies: ${consent.functional ? '‚úÖ Aan' : '‚ùå Uit'}
Geaccepteerd op: ${consent.acceptedAt ? new Date(consent.acceptedAt).toLocaleString('nl-NL') : 'Nog niet geaccepteerd'}

Wil je je voorkeuren wijzigen?`;
        
        if (confirm(message)) {
            // Reset consent and show banner again
            localStorage.removeItem('cookieConsent');
            document.getElementById('cookie-banner').style.display = 'block';
        }
    }
    
    // Export user data (GDPR Art. 20)
    window.exportUserData = async function() {
        if (!currentUser) {
            alert('Je moet ingelogd zijn om data te exporteren.');
            return;
        }
        
        try {
            const exportData = {
                exportDate: new Date().toISOString(),
                exportVersion: '1.0',
                account: {
                    email: currentUser.email,
                    uid: currentUser.uid,
                    createdAt: currentUser.metadata.creationTime,
                    lastSignIn: currentUser.metadata.lastSignInTime
                },
                userStats: {
                    ...userStats,
                    sessionDates: Array.from(userStats.sessionDates || [])
                },
                journalEntries: allJournalEntries.map(entry => ({
                    ...entry,
                    timestamp: entry.timestamp.toISOString()
                })),
                cpMeasurements: allCPMeasurements.map(cp => ({
                    ...cp,
                    timestamp: cp.timestamp ? new Date(cp.timestamp).toISOString() : null
                }))
            };
            
            // Download as JSON
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ademruimte-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showUserMessage('‚úÖ Data succesvol ge√´xporteerd!', 'success');
        } catch (error) {
            console.error('Export error:', error);
            showUserMessage('‚ùå Fout bij exporteren: ' + error.message, 'error');
        }
    }
    
    // Delete user account (GDPR Art. 17)
    window.deleteUserAccount = async function() {
        if (!currentUser) {
            alert('Je moet ingelogd zijn.');
            return;
        }
        
        // Triple confirmation for safety
        const confirm1 = confirm(
            '‚ö†Ô∏è WAARSCHUWING: Weet je ZEKER dat je je account wilt verwijderen?\n\n' +
            'Dit verwijdert:\n' +
            '‚Ä¢ Al je dagboek entries\n' +
            '‚Ä¢ Al je CP metingen\n' +
            '‚Ä¢ Al je statistieken\n' +
            '‚Ä¢ Je account\n\n' +
            'Deze actie kan NIET ongedaan worden gemaakt!'
        );
        
        if (!confirm1) return;
        
        const confirm2 = prompt(
            'Type "VERWIJDER" (hoofdletters) om te bevestigen dat je je account permanent wilt verwijderen:'
        );
        
        if (confirm2 !== 'VERWIJDER') {
            alert('Verwijdering geannuleerd. Je account is veilig.');
            return;
        }
        
        try {
            showUserMessage('üóëÔ∏è Account wordt verwijderd...', 'warning');
            
            // Import required Firebase functions
            const { deleteDoc, doc, getDocs, collection, query, where } = 
                await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            const { deleteUser } = 
                await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            // Delete user stats
            try {
                await deleteDoc(doc(db, "userStats", currentUser.uid));
                console.log('‚úÖ User stats deleted');
            } catch (error) {
                console.warn('User stats deletion failed:', error);
            }
            
            // Delete all journal entries
            try {
                const entriesSnap = await getDocs(
                    query(collection(db, "dagboekEntries"), 
                    where("userId", "==", currentUser.uid))
                );
                
                let deletedCount = 0;
                for (const entryDoc of entriesSnap.docs) {
                    await deleteDoc(entryDoc.ref);
                    deletedCount++;
                }
                console.log(`‚úÖ ${deletedCount} journal entries deleted`);
            } catch (error) {
                console.warn('Journal entries deletion failed:', error);
            }
            
            // Delete Firebase Auth account
            await deleteUser(currentUser);
            
            // Clear local storage
            localStorage.clear();
            
            alert('‚úÖ Je account is succesvol verwijderd. Je wordt nu uitgelogd.');
            window.location.reload();
            
        } catch (error) {
            console.error('Delete account error:', error);
            
            if (error.code === 'auth/requires-recent-login') {
                alert(
                    '‚ö†Ô∏è Voor je veiligheid moet je opnieuw inloggen om je account te verwijderen.\n\n' +
                    'Log uit, log opnieuw in, en probeer het dan nog een keer.'
                );
            } else {
                alert('‚ùå Fout bij verwijderen: ' + error.message + '\n\nProbeer opnieuw in te loggen en het nog een keer te proberen.');
            }
        }
    }
    
    // Update settings UI when tab is opened
    function updateSettingsUI() {
        if (currentUser) {
            document.getElementById('settings-email').textContent = currentUser.email;
            document.getElementById('settings-created').textContent = 
                new Date(currentUser.metadata.creationTime).toLocaleDateString('nl-NL');
            document.getElementById('settings-sessions').textContent = 
                userStats.totalSessions || 0;
        }
    }
    
    // Check cookie consent on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkCookieConsent();
    });
    
    // Initialize bot-protected emails
    function initializeEmails() {
        // Email: troostberg@gmail.com (base64 encoded for bot protection)
        const email = atob('dHJvb3N0YmVyZ0BnbWFpbC5jb20=');
        
        // Settings tab contact email
        const settingsEmail = document.getElementById('settings-email-display');
        if (settingsEmail) {
            settingsEmail.textContent = email;
        }
        
        console.log('‚úÖ Bot-protected emails initialized');
    }

    // Breathing exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 0;
    let breathingPattern = 'gentle';
    let isBreathing = false;
    let customHoldDuration = 3; // Default hold duration for gentle and extended exercises

    // ============================================
    // HAPTIC FEEDBACK FOR MOBILE DEVICES
    // ============================================
    
    // Check if haptic feedback is supported
    const supportsHaptics = 'vibrate' in navigator;
    
    // Haptics enabled state (default off, user must opt-in)
    let hapticsEnabled = localStorage.getItem('hapticsEnabled') === 'true' || false;
    
    // Haptic patterns for different breathing phases
    const hapticPatterns = {
        inhale: [50],           // Short pulse at start of inhale
        exhale: [30, 50, 30],   // Double pulse pattern for exhale
        hold: [100],            // Longer pulse for hold/pause
        complete: [50, 100, 50, 100, 50] // Success pattern when cycle completes
    };
    
    // Function to trigger haptic feedback
    function triggerHaptic(patternName) {
        if (!supportsHaptics || !hapticsEnabled) {
            devLog('Haptic feedback skipped:', !supportsHaptics ? 'not supported' : 'disabled by user');
            return;
        }
        
        const pattern = hapticPatterns[patternName];
        if (pattern) {
            try {
                navigator.vibrate(pattern);
                devLog('Haptic feedback triggered:', patternName);
            } catch (error) {
                devError('Haptic feedback error:', error);
            }
        }
    }
    
    // Toggle haptic feedback
    window.toggleHaptics = function() {
        hapticsEnabled = !hapticsEnabled;
        localStorage.setItem('hapticsEnabled', hapticsEnabled);
        updateHapticUI();
        
        // Give haptic feedback when enabling
        if (hapticsEnabled && supportsHaptics) {
            navigator.vibrate([50, 100, 50]); // Confirmation pattern
        }
        
        devLog('Haptics toggled:', hapticsEnabled);
    };
    
    // Update haptic UI elements
    function updateHapticUI() {
        const toggle = document.getElementById('haptic-toggle');
        const status = document.getElementById('haptic-status');
        const indicator = document.getElementById('haptic-indicator');
        
        if (toggle && status) {
            if (hapticsEnabled) {
                status.textContent = 'Ingeschakeld';
                toggle.classList.remove('btn-secondary');
                toggle.classList.add('btn-success');
            } else {
                status.textContent = 'Uitgeschakeld';
                toggle.classList.remove('btn-success');
                toggle.classList.add('btn-secondary');
            }
        }
        
        if (indicator) {
            indicator.style.display = (hapticsEnabled && supportsHaptics) ? 'block' : 'none';
        }
    }
    
    // Initialize UI on load
    document.addEventListener('DOMContentLoaded', function() {
        if (supportsHaptics) {
            console.log('‚úÖ Haptic feedback supported on this device');
            // Show toggle button
            const toggleContainer = document.getElementById('haptic-toggle-container');
            if (toggleContainer) {
                toggleContainer.style.display = 'block';
            }
        } else {
            console.log('‚ÑπÔ∏è Haptic feedback not available (desktop or unsupported browser)');
        }
        
        updateHapticUI();
    });

    // CP measurement variables
    let cpInterval = null;
    let cpStartTime = 0;
    let cpIsRunning = false;
    let latestCPScore = null; // Track latest CP score
    
    // IMPROVED: Better CP score management
    let recentCPScores = []; // Store multiple recent scores
    let lastCPTimestamp = null;

    // Crisis variables
    let crisisInterval = null;
    let crisisProtocolActive = false;
    let crisisStep = 0;
    let crisisTimer = 0;
    let crisisStepDuration = 0;

    // Wake lock variables
    let wakeLock = null;

    // User stats - IMPROVED: Better streak tracking
    let userStats = {
        totalSessions: 0,
        streakDays: 0,
        lastSessionDate: null,
        cpMeasurements: [],
        achievements: [],
        sessionDates: new Set(), // Track unique session dates
        activeMedications: [],    // List of currently active medications
        medicationEvents: []      // Historical log of all medication events
    };

    // Crisis protocol steps
    const crisisProtocolSteps = [
        {
            name: "Stop & Erken",
            duration: 30,
            title: "STOP - Je bent veilig",
            instructions: "Dit is hyperventilatie en het gaat voorbij. Je bent NIET in gevaar. Leg je hand op je buik en voel je ademhaling.",
            breathingText: "Voel je buik rustig bewegen...",
            encouragement: "Je bent veilig. Dit gevoel is tijdelijk en onschadelijk."
        },
        {
            name: "Buteyko Ademhaling", 
            duration: 90,
            title: "Verminder Je Ademhaling",
            instructions: "Adem MINDER, niet meer. Neem kleine ademhalingen door je neus. Na elke UIT-ademin: Pauzeer 2-3 seconden voordat je weer inademt. Dit herstelt je CO2.",
            breathingText: "In door neus... Uit... Pauze 2-3 sec...",
            encouragement: "Perfect! Minder ademen herstelt je CO2 balans."
        },
        {
            name: "Grounding 5-4-3-2-1",
            duration: 60, 
            title: "Focus Naar Buiten",
            instructions: "Kijk om je heen en benoem hardop of in gedachten: 5 dingen die je ZIET ‚Ä¢ 4 dingen die je aanraakt/VOELT ‚Ä¢ 3 dingen die je HOORT ‚Ä¢ 2 dingen die je RUIKT ‚Ä¢ 1 ding dat je PROEFT",
            breathingText: "Kijk, voel, luister...",
            encouragement: "Je hersenen komen terug uit alarmmodus. Goed bezig!"
        },
        {
            name: "Natuurlijke Ademhaling",
            duration: 60,
            title: "Laat Los", 
            instructions: "Laat je ademhaling nu natuurlijk worden. Adem rustig in door je neus, ontspannen uit door je neus of mond. Geen controle meer nodig.",
            breathingText: "Natuurlijk en rustig...",
            encouragement: "Je lichaam regelt zichzelf weer. De crisis is voorbij."
        },
        {
            name: "Bevestiging",
            duration: 30,
            title: "Je Hebt Het Overwonnen",
            instructions: "Het ergste is voorbij. Je hebt controle teruggekregen door de juiste technieken toe te passen. Onthoud: je kunt dit elke keer weer.",
            breathingText: "Je bent sterker dan je angst",
            encouragement: "Geweldig gedaan! Je hebt de crisis succesvol doorstaan."
        }
    ];

    // IMPROVED: Evidence-based tips focusing on process, not immediate results
    const appTips = [
        "Chronische hyperventilatie vraagt geduld: de meeste pati√´nten zien betekenisvolle verbetering na 2-8 weken consistent oefenen.",
        "Focus op het proces, niet op perfecte resultaten. Elke oefening bouwt nieuwe neurale pathways op, ook als je geen direct verschil voelt.",
        "Veel lichamelijke klachten kunnen samenhangen met chronische hyperventilatie. De Buteyko methode kan meerdere symptomen tegelijk verbeteren.",
        "Bij luchthonger: probeer paradoxale ademhaling - MINDER ademen, niet meer. Dit voelt contra-intu√Øtief maar herstelt je CO2 balans.",
        "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend voor je zenuwstelsel.",
        "Buteyko ademhaling traint je lichaam om te wennen aan gezondere CO2 niveaus. Dit is een leerproces dat tijd nodig heeft.",
        "Een normale Control Pause is tussen de 20-40 seconden. Begin laag en bouw GELEIDELIJK op. Forceren kan averechts werken.",
        "Regelmatige CP metingen helpen patronen te herkennen, maar variatie is normaal. Let meer op trends dan dagelijkse schommelingen.",
        "Interoceptieve bewustwording: leer je lichamelijke sensaties te observeren zonder onmiddellijk in paniek te raken of ze te interpreteren als gevaar.",
        "Het noodprotocol doorbreekt de vicieuze cirkel van hyperventilatie ‚Üí paniek ‚Üí meer hyperventilatie door herkenning en gecontroleerde blootstelling.",
        "Graded exposure: begin met kleine ongemakken en bouw langzaam tolerantie op. Dit is hoe je brein leert dat sensaties niet gevaarlijk zijn.",
        "Consistentie is belangrijker dan perfectie. 5 minuten dagelijks oefenen werkt beter dan 1 uur per week."
    ];

    // ============================================
    // WAKE LOCK FUNCTIONS
    // ============================================

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('üì± Wake lock activated - scherm blijft aan');
                
                // Show visual indicator
                showUserMessage('üì± Scherm blijft aan tijdens oefening', 'info');
                
                wakeLock.addEventListener('release', () => {
                    console.log('üì± Wake lock released - scherm mag uitgaan');
                });
                
                return true;
            } else {
                console.warn('‚ö†Ô∏è Wake Lock API not supported');
                showUserMessage('‚ö†Ô∏è Scherm wake lock niet ondersteund door deze browser', 'warning');
                return false;
            }
        } catch (error) {
            console.error('‚ùå Wake lock request failed:', error);
            return false;
        }
    }

    async function releaseWakeLock() {
        try {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('üì± Wake lock manually released');
            }
        } catch (error) {
            console.error('‚ùå Wake lock release failed:', error);
        }
    }

    // Handle page visibility changes (when user switches tabs/apps)
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            // Reacquire wake lock when returning to the page during active exercises
            if (isBreathing || crisisProtocolActive || cpIsRunning || crisisInterval) {
                await requestWakeLock();
            }
        }
    });

    // ============================================
    // FIREBASE INITIALIZATION & AUTH
    // ============================================

    async function initFirebase() {
        try {
            // DEV_MODE: Skip Firebase and use mock user
            if (DEV_MODE) {
                devLog('üîß DEV_MODE: Bypassing Firebase authentication');
                
                // Show main app immediately
                showMainApp();
                updateUserInfo();
                updateStatusIndicator('connected');
                
                // Initialize with empty data
                allJournalEntries = [];
                allCPMeasurements = [];
                updateDashboard();
                generateInsights();
                
                showUserMessage('üîß DEV_MODE: Ingelogd als test gebruiker (geen Firebase)', 'info');
                
                return true;
            }
            
            // Normal Firebase initialization
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Set persistence based on remember me (default to session)
            await setPersistence(auth, browserSessionPersistence);

            // Auth state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    updateUserInfo();
                    updateStatusIndicator('connected');
                    
                    // Load data immediately when user logs in
                    try {
                        await loadUserStats(); // NEW: Load user stats first
                        await loadJournalEntries();
                        updateDashboard();
                        generateInsights();
                    } catch (error) {
                        console.error('Error loading data on login:', error);
                        showUserMessage('Gegevens laden mislukt, probeer te verversen', 'warning');
                    }
                } else {
                    currentUser = null;
                    showLoginScreen();
                    updateStatusIndicator('disconnected');
                }
            });

            return true;
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('Firebase kon niet worden geladen. Controleer je internetverbinding.', 'error');
            return false;
        }
    }

    // NEW: Load and save user stats to Firebase
    async function loadUserStats() {
        if (!currentUser) return;
        
        try {
            const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            const userStatsDoc = await getDoc(doc(db, "userStats", currentUser.uid));
            
            if (userStatsDoc.exists()) {
                const data = userStatsDoc.data();
                userStats = {
                    ...userStats,
                    ...data,
                    sessionDates: new Set(data.sessionDates || []),
                    lastSessionDate: data.lastSessionDate?.toDate?.() || data.lastSessionDate,
                    activeMedications: data.activeMedications || [],
                    medicationEvents: data.medicationEvents || [],
                    cpMeasurements: (data.cpMeasurements || []).map(cp => ({
                        ...cp,
                        timestamp: cp.timestamp?.toDate?.() || cp.timestamp || new Date(cp.timestamp)
                    }))
                };
            }
        } catch (error) {
            console.error('Error loading user stats:', error);
        }
    }

    async function saveUserStats() {
        if (!currentUser) return;
        
        // Skip Firebase in DEV_MODE
        if (DEV_MODE) {
            devLog('üîß DEV_MODE: UserStats saved locally only', userStats);
            return;
        }
        
        try {
            const { setDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            const statsToSave = {
                ...userStats,
                sessionDates: Array.from(userStats.sessionDates),
                lastSessionDate: userStats.lastSessionDate
            };
            
            await setDoc(doc(db, "userStats", currentUser.uid), statsToSave, { merge: true });
        } catch (error) {
            console.warn('UserStats save failed - check Firebase rules:', error);
            // App continues to work with local stats only
        }
    }

    // ============================================
    // UI STATE MANAGEMENT
    // ============================================

    function showMainApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function showLoginScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-loading').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
    }

    function showLoadingScreen() {
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('auth-loading').classList.remove('hidden');
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        if (currentUser) {
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Gebruiker';
            const initials = displayName.includes('@') ? 
                displayName.split('@')[0].substring(0, 2).toUpperCase() :
                displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            
            userInfo.innerHTML = `
                <div class="user-avatar">${initials}</div>
                <span style="font-weight: 500;">${initials}</span>
                <button class="logout-btn" onclick="logout()">Uitloggen</button>
            `;
        } else {
            userInfo.innerHTML = '<div class="spinner"></div>';
        }
    }

    function updateStatusIndicator(status) {
        const dot = document.getElementById('firebase-status-dot');
        if (dot) {
            dot.className = `status-${status}`;
        }
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================

    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active to selected button
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        currentTab = tabName;
        
        // Load data based on tab
        if (tabName === 'dagboek') {
            createProgressChart();
            // Set default active state for chart filter (10 days)
            setTimeout(() => {
                document.getElementById('chart-10days').classList.add('active');
            }, 100);
        }
        
        // Update settings UI when settings tab is opened
        if (tabName === 'settings') {
            updateSettingsUI();
        }
    }

    // ============================================
    // AUTHENTICATION FUNCTIONS
    // ============================================

    window.showLoginForm = function() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('password-reset-form').classList.add('hidden');
        
        // Reset other forms
        document.getElementById('register-name').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-password-confirm').value = '';
        document.getElementById('reset-email').value = '';
    };

    window.showRegisterForm = function() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('password-reset-form').classList.add('hidden');
        
        // Reset other forms
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('remember-me').checked = false;
        document.getElementById('reset-email').value = '';
    };

    window.showPasswordResetForm = function() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('password-reset-form').classList.remove('hidden');
        
        // Reset other forms
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('remember-me').checked = false;
        document.getElementById('register-name').value = '';
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-password-confirm').value = '';
    };

    window.loginUser = async function() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;

        if (!email || !password) {
            showUserMessage('‚ö†Ô∏è Vul alle velden in', 'warning');
            return;
        }

        const loginBtn = document.getElementById('login-btn');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Inloggen...';
        loginBtn.disabled = true;

        try {
            const { signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            // Set persistence based on remember me checkbox
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            
            await signInWithEmailAndPassword(auth, email, password);
            showUserMessage('‚úÖ Succesvol ingelogd!', 'success');
            
        } catch (error) {
            console.error('Login error:', error);
            let errorMessage = '‚ùå Inloggen mislukt. Controleer je gegevens.';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'üö´ Dit account is uitgeschakeld.';
                    break;
                case 'auth/user-not-found':
                    errorMessage = '‚ùì Geen account gevonden met dit e-mailadres.';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'üîê Onjuist wachtwoord. Probeer opnieuw.';
                    break;
                case 'auth/invalid-credential':
                    errorMessage = '‚ùå Ongeldige inloggegevens. Controleer email en wachtwoord.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = '‚è±Ô∏è Te veel pogingen. Probeer het later opnieuw.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
    };

    window.registerUser = async function() {
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;

        if (!name || !email || !password || !passwordConfirm) {
            showUserMessage('‚ö†Ô∏è Vul alle velden in', 'warning');
            return;
        }

        if (password !== passwordConfirm) {
            showUserMessage('üîê Wachtwoorden komen niet overeen', 'warning');
            return;
        }

        if (password.length < 6) {
            showUserMessage('üîí Wachtwoord moet minimaal 6 karakters bevatten', 'warning');
            return;
        }

        const registerBtn = document.getElementById('register-btn');
        const originalText = registerBtn.innerHTML;
        registerBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Account aanmaken...';
        registerBtn.disabled = true;

        try {
            const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Update user profile with display name
            await updateProfile(userCredential.user, {
                displayName: name
            });

            showUserMessage('‚úÖ Account succesvol aangemaakt!', 'success');
            
        } catch (error) {
            console.error('Registration error:', error);
            let errorMessage = '‚ùå Registratie mislukt. Probeer het opnieuw.';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'üìß Dit e-mailadres is al in gebruik.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = 'üö´ E-mail/wachtwoord accounts zijn uitgeschakeld.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'üîí Wachtwoord is te zwak. Kies een sterker wachtwoord.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
    };

    window.resetPassword = async function() {
        const email = document.getElementById('reset-email').value.trim();

        if (!email) {
            showUserMessage('‚ö†Ô∏è Vul je e-mailadres in', 'warning');
            return;
        }

        const resetBtn = document.getElementById('reset-btn');
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Versturen...';
        resetBtn.disabled = true;

        try {
            const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            await sendPasswordResetEmail(auth, email);
            
            showUserMessage('üìß Wachtwoord reset link verstuurd! Controleer je e-mail.', 'success');
            
            // Auto-switch back to login form after successful reset
            setTimeout(() => {
                showLoginForm();
            }, 3000);
            
        } catch (error) {
            console.error('Password reset error:', error);
            let errorMessage = '‚ùå Reset mislukt. Probeer het opnieuw.';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = '‚ö†Ô∏è Ongeldig e-mailadres.';
                    break;
                case 'auth/user-not-found':
                    errorMessage = '‚ùì Geen account gevonden met dit e-mailadres.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'üì° Netwerkfout. Controleer je internetverbinding.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = '‚è±Ô∏è Te veel pogingen. Probeer het later opnieuw.';
                    break;
            }
            
            showUserMessage(errorMessage, 'error');
        }

        resetBtn.innerHTML = originalText;
        resetBtn.disabled = false;
    };

    window.logout = async function() {
        try {
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            await signOut(auth);
            showUserMessage('üëã Je bent uitgelogd', 'info');
        } catch (error) {
            console.error('Logout error:', error);
            showUserMessage('‚ùå Uitloggen mislukt', 'error');
        }
    };

    // ============================================
    // BUTEYKO FUNCTIONS
    // ============================================

    window.startCPMeasurement = function() {
        if (cpIsRunning) return;
        
        cpStartTime = Date.now();
        cpIsRunning = true;
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        document.getElementById('start-cp').disabled = true;
        document.getElementById('stop-cp').disabled = false;
        
        cpInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - cpStartTime) / 1000);
            document.getElementById('cp-timer').textContent = elapsed.toString().padStart(2, '0');
        }, 1000);
    };

    window.stopCPMeasurement = function() {
        if (!cpIsRunning) return;
        
        clearInterval(cpInterval);
        const cpScore = Math.floor((Date.now() - cpStartTime) / 1000);
        
        cpIsRunning = false;
        
        // IMPROVED: Store CP score with timestamp
        const cpData = {
            score: cpScore,
            timestamp: new Date(),
            used: false // Track if this score has been used in journal
        };
        
        // Keep recent scores (last 5 measurements, max 24 hours old)
        recentCPScores.unshift(cpData);
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        recentCPScores = recentCPScores
            .filter(cp => cp.timestamp > oneDayAgo)
            .slice(0, 5);
        
        lastCPTimestamp = new Date();
        latestCPScore = cpScore; // Keep for immediate use
        
        console.log('üîµ CP Score saved:', cpScore, 'Recent scores:', recentCPScores.length);
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
        
        // Save CP measurement
        const cpMeasurement = {
            score: cpScore,
            timestamp: new Date(),
            userId: currentUser?.uid,
            userEmail: currentUser?.email
        };
        
        allCPMeasurements.push(cpMeasurement);
        userStats.cpMeasurements.push(cpMeasurement);
        
        // Save to Firebase
        if (currentUser) {
            saveCPMeasurement(cpMeasurement);
        }
        
        updateDashboard();
        showUserMessage(`CP Score: ${cpScore} seconden geregistreerd! Deze wordt automatisch ingevuld bij je volgende Buteyko oefening.`, 'success');
    };

    window.resetCPMeasurement = function() {
        clearInterval(cpInterval);
        
        // Release wake lock if CP was running
        if (cpIsRunning) {
            releaseWakeLock();
        }
        
        cpIsRunning = false;
        
        document.getElementById('cp-timer').textContent = '00';
        document.getElementById('start-cp').disabled = false;
        document.getElementById('stop-cp').disabled = true;
    };

    async function saveCPMeasurement(measurement) {
        // Skip Firebase in DEV_MODE
        if (DEV_MODE) {
            devLog('üîß DEV_MODE: CP measurement saved locally only', measurement);
            return;
        }
        
        try {
            const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            await addDoc(collection(db, "cpMeasurements"), measurement);
        } catch (error) {
            console.error('Save CP error:', error);
        }
    }

    // ============================================
    // BREATHING EXERCISES
    // ============================================

    // Function to get breathing pattern with current settings
    function getBreathingPattern(patternName) {
        const patterns = {
            gentle: { 
                freeBreathing: 10, 
                hold: customHoldDuration,
                cycles: 20, 
                description: `10 sec vrij ademhalen + ${customHoldDuration} sec pauze`,
                type: 'gentle'
            },
            extended: {
                inhale: 4,
                exhale: 4,
                hold: customHoldDuration,
                cycles: 15,
                description: `In/uit (4s) ‚Üí pauze ${customHoldDuration}s ‚Üí herhaal`,
                type: 'extended'
            }
        };
        return patterns[patternName] || patterns.gentle;
    }

    window.updateHoldDuration = function() {
        const slider = document.getElementById('hold-duration-slider');
        const display = document.getElementById('hold-duration-display');
        customHoldDuration = parseInt(slider.value);
        display.textContent = customHoldDuration;
        
        // Update pattern description if gentle or extended is selected
        if (breathingPattern === 'gentle' || breathingPattern === 'extended') {
            const pattern = getBreathingPattern(breathingPattern);
            const targetElement = document.getElementById('cycle-target');
            if (targetElement) {
                targetElement.textContent = `van ${pattern.cycles}`;
            }
        }
        
        devLog('Hold duration updated:', customHoldDuration);
    };

    window.updateBreathingPattern = function() {
        breathingPattern = document.getElementById('breathing-pattern').value;
        const pattern = getBreathingPattern(breathingPattern);
        const targetElement = document.getElementById('cycle-target');
        const holdGroup = document.getElementById('hold-duration-group');
        const holdTip = document.getElementById('hold-tip');
        
        // Show/hide hold duration slider
        if (holdGroup) {
            if (breathingPattern === 'gentle' || breathingPattern === 'extended') {
                holdGroup.style.display = 'block';
                
                // Update tip based on pattern
                if (holdTip) {
                    if (breathingPattern === 'extended') {
                        holdTip.innerHTML = 'üí° Tip: Dit patroon helpt je CO2-tolerantie maximaal te verbeteren. Start met 3-4 seconden.';
                    } else {
                        holdTip.innerHTML = 'üí° Tip: Begin met 3 seconden en verhoog geleidelijk naarmate je CO2-tolerantie verbetert.';
                    }
                }
            } else {
                holdGroup.style.display = 'none';
            }
        }
        
        if (targetElement) {
            targetElement.textContent = `van ${pattern.cycles}`;
        }
        
        devLog('Breathing pattern updated:', breathingPattern, pattern);
    };

    // Medication tracking functions
    window.toggleMedicationFields = function() {
        const checkbox = document.getElementById('entry-has-medication');
        const fields = document.getElementById('medication-fields');
        
        if (checkbox.checked) {
            fields.style.display = 'block';
        } else {
            fields.style.display = 'none';
            // Clear medication fields
            document.getElementById('entry-med-action').selectedIndex = 0;
            document.getElementById('entry-med-name').value = '';
            document.getElementById('entry-med-dose').value = '';
            document.getElementById('entry-med-previous-dose').value = '';
            document.getElementById('entry-med-reason').value = '';
            document.getElementById('med-previous-dose-group').style.display = 'none';
        }
    };

    // Add event listener for medication action dropdown
    document.addEventListener('DOMContentLoaded', function() {
        const medActionSelect = document.getElementById('entry-med-action');
        if (medActionSelect) {
            medActionSelect.addEventListener('change', function() {
                const previousDoseGroup = document.getElementById('med-previous-dose-group');
                if (this.value === 'dose_change') {
                    previousDoseGroup.style.display = 'block';
                } else {
                    previousDoseGroup.style.display = 'none';
                }
            });
        }
    });

    // Update active medications list based on event
    function updateActiveMedications(event) {
        const { action, name, dose } = event;
        
        switch(action) {
            case 'started':
                // Add to active medications if not already present
                const existingMed = userStats.activeMedications.find(m => m.name.toLowerCase() === name.toLowerCase());
                if (!existingMed) {
                    userStats.activeMedications.push({
                        name: name,
                        dose: dose,
                        startedAt: new Date()
                    });
                    devLog('Medication added to active list:', name);
                }
                break;
                
            case 'stopped':
                // Remove from active medications
                userStats.activeMedications = userStats.activeMedications.filter(
                    m => m.name.toLowerCase() !== name.toLowerCase()
                );
                devLog('Medication removed from active list:', name);
                break;
                
            case 'dose_change':
                // Update dosage
                const medToUpdate = userStats.activeMedications.find(m => m.name.toLowerCase() === name.toLowerCase());
                if (medToUpdate) {
                    medToUpdate.dose = dose;
                    medToUpdate.lastChanged = new Date();
                    devLog('Medication dosage updated:', name, dose);
                }
                break;
                
            case 'extra':
            case 'regular':
                // These don't affect active medications list, just event log
                devLog('Medication event logged (no change to active list):', action, name);
                break;
        }
        
        // Save updated medications
        saveUserStats();
    }

    // Rebuild medication tracking from journal entries (data recovery)
    function rebuildMedicationTrackingFromEntries() {
        // Count medication events in entries vs userStats
        const entriesWithMeds = allJournalEntries.filter(e => e.medicationEvent);
        const statsEventCount = userStats.medicationEvents.length;
        
        devLog('Medication tracking check:', {
            entriesWithMeds: entriesWithMeds.length,
            statsEvents: statsEventCount,
            activeMeds: userStats.activeMedications.length
        });
        
        // If there's a significant mismatch, rebuild
        if (entriesWithMeds.length > statsEventCount + 5) {
            console.warn('‚ö†Ô∏è Medication tracking mismatch detected. Rebuilding from entries...');
            
            // Clear existing data
            userStats.medicationEvents = [];
            userStats.activeMedications = [];
            
            // Rebuild chronologically (oldest first)
            const sortedEntries = [...allJournalEntries]
                .filter(e => e.medicationEvent)
                .sort((a, b) => a.timestamp - b.timestamp);
            
            sortedEntries.forEach(entry => {
                const event = entry.medicationEvent;
                
                // Add to events history
                userStats.medicationEvents.push(event);
                
                // Update active medications
                updateActiveMedications(event);
            });
            
            console.log('‚úÖ Medication tracking rebuilt:', {
                events: userStats.medicationEvents.length,
                active: userStats.activeMedications.length
            });
            
            // Save rebuilt data
            saveUserStats();
        }
    }

    // Format medication event for display
    function formatMedicationEvent(event) {
        const actionIcons = {
            started: '‚úÖ',
            stopped: '‚õî',
            dose_change: 'üîÑ',
            extra: '‚ûï',
            regular: 'üìÖ'
        };
        
        const actionLabels = {
            started: 'Gestart met',
            stopped: 'Gestopt met',
            dose_change: 'Dosiswijziging',
            extra: 'Extra dosis',
            regular: 'Reguliere dosis'
        };
        
        const icon = actionIcons[event.action] || 'üíä';
        const label = actionLabels[event.action] || event.action;
        
        let html = `<div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(147, 51, 234, 0.1); border-left: 3px solid #9333ea; border-radius: 0.25rem;">`;
        html += `<small><strong>${icon} ${label}:</strong> ${event.name}`;
        
        if (event.dose) {
            html += ` <span style="color: var(--text-light);">(${event.dose})</span>`;
        }
        
        if (event.action === 'dose_change' && event.previousDose) {
            html += ` <span style="color: var(--text-light);">‚Üê was ${event.previousDose}</span>`;
        }
        
        if (event.reason) {
            html += `<br><em style="color: var(--text-light); font-size: 0.85em;">Reden: ${event.reason}</em>`;
        }
        
        html += `</small></div>`;
        return html;
    }

    window.startBreathing = function() {
        if (isBreathing) return;
        
        isBreathing = true;
        breathCycleCount = 0;
        breathPhase = 'prepare';
        
        const circle = document.getElementById('breathing-circle');
        const pattern = getBreathingPattern(breathingPattern);
        
        devLog('Starting breathing exercise:', { pattern: breathingPattern, config: pattern });
        
        document.getElementById('start-breathing').disabled = true;
        document.getElementById('stop-breathing').disabled = false;
        document.getElementById('cycle-count').textContent = '0';
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        // Preparation phase
        circle.textContent = "Bereid je voor... üßò";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        setTimeout(() => {
            if (!isBreathing) return;
            startBreathingCycle(pattern);
        }, 2000);
    };

    function startBreathingCycle(pattern) {
        if (!isBreathing) return;
        
        const circle = document.getElementById('breathing-circle');
        let phaseTime = 0;
        
        // Determine initial phase based on pattern type
        let currentPhase;
        if (breathingPattern === 'gentle') {
            currentPhase = 'freeBreathing';
        } else if (breathingPattern === 'extended') {
            currentPhase = 'inhale';
        } else {
            currentPhase = 'inhale';
        }
        
        let completedCycles = 0;
        let totalCycles = pattern.cycles || 10;
        
        devLog('Starting breathing cycle:', { pattern: breathingPattern, totalCycles, initialPhase: currentPhase });
        
        breathInterval = setInterval(() => {
            if (!isBreathing) return;
            
            phaseTime++;
            
            switch(currentPhase) {
                case 'freeBreathing':
                    // Trigger haptic at phase start
                    if (phaseTime === 1) {
                        triggerHaptic('inhale');
                    }
                    
                    circle.textContent = `Vrij ademen - ${phaseTime}s`;
                    circle.className = "breathing-circle";
                    document.getElementById('current-phase').textContent = 'Vrij ademhalen';
                    
                    // Subtle breathing animation - gentle pulsing
                    const breathingPhase = Math.sin((phaseTime * Math.PI * 4) / 10); // 4 breaths in 10 seconds
                    const gentleScale = 1 + (0.08 * breathingPhase);
                    circle.style.transform = `scale(${gentleScale})`;
                    
                    if (phaseTime >= (pattern.freeBreathing || 10)) {
                        phaseTime = 0;
                        currentPhase = 'hold';
                        triggerHaptic('hold'); // Haptic for transition to hold
                    }
                    break;
                    
                case 'inhale':
                    // Trigger haptic at phase start
                    if (phaseTime === 1) {
                        triggerHaptic('inhale');
                    }
                    
                    if (breathingPattern === 'extended') {
                        circle.textContent = `Inademen (${phaseTime}s)`;
                        circle.className = "breathing-circle inhale";
                        document.getElementById('current-phase').textContent = 'Inademen';
                        
                        const inhaleProgress = phaseTime / pattern.inhale;
                        const inhaleScale = 1 + (0.15 * Math.min(inhaleProgress, 1));
                        circle.style.transform = `scale(${inhaleScale})`;
                        
                        if (phaseTime >= pattern.inhale) {
                            phaseTime = 0;
                            currentPhase = 'exhale';  // Extended: go to exhale
                            triggerHaptic('exhale'); // Haptic for exhale transition
                        }
                    } else {
                        circle.textContent = `Inademen (${phaseTime}s)`;
                        circle.className = "breathing-circle inhale";
                        document.getElementById('current-phase').textContent = 'Inademen';
                        
                        const inhaleProgress = phaseTime / pattern.inhale;
                        const inhaleScale = 1 + (0.15 * Math.min(inhaleProgress, 1));
                        circle.style.transform = `scale(${inhaleScale})`;
                        
                        if (phaseTime >= pattern.inhale) {
                            phaseTime = 0;
                            const nextPhase = pattern.hold > 0 ? 'hold' : 'exhale';
                            currentPhase = nextPhase;
                            triggerHaptic(nextPhase); // Haptic for next phase
                        }
                    }
                    break;
                    
                case 'hold':
                    // Trigger haptic at phase start
                    if (phaseTime === 1) {
                        triggerHaptic('hold');
                    }
                    
                    if (breathingPattern === 'gentle') {
                        circle.textContent = `Vasthouden (${phaseTime}s)`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.1)';
                        
                        if (phaseTime >= pattern.hold) {
                            phaseTime = 0;
                            // For gentle pattern, complete the cycle after hold
                            completedCycles++;
                            document.getElementById('cycle-count').textContent = completedCycles;
                            
                            devLog('Gentle cycle completed:', completedCycles, 'of', totalCycles);
                            
                            if (completedCycles >= totalCycles) {
                                triggerHaptic('complete'); // Success haptic!
                                stopBreathing();
                                return;
                            } else {
                                currentPhase = 'freeBreathing';
                                triggerHaptic('inhale'); // Next cycle start
                            }
                        }
                    } else if (breathingPattern === 'extended') {
                        circle.textContent = `Adempauze (${phaseTime}s)`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Adempauze';
                        circle.style.transform = 'scale(1.0)';
                        
                        if (phaseTime >= pattern.hold) {
                            phaseTime = 0;
                            // For extended pattern, complete cycle after hold
                            completedCycles++;
                            document.getElementById('cycle-count').textContent = completedCycles;
                            
                            devLog('Extended cycle completed:', completedCycles, 'of', totalCycles);
                            
                            if (completedCycles >= totalCycles) {
                                triggerHaptic('complete'); // Success haptic!
                                stopBreathing();
                                return;
                            } else {
                                currentPhase = 'inhale';  // Start new cycle
                                triggerHaptic('inhale'); // Next cycle start
                            }
                        }
                    } else {
                        circle.textContent = `Vasthouden (${phaseTime}s)`;
                        circle.className = "breathing-circle hold";
                        document.getElementById('current-phase').textContent = 'Vasthouden';
                        circle.style.transform = 'scale(1.15)';
                        
                        if (phaseTime >= pattern.hold) {
                            phaseTime = 0;
                            currentPhase = 'exhale';
                            triggerHaptic('exhale'); // Exhale transition
                        }
                    }
                    break;
                    
                case 'exhale':
                    // Trigger haptic at phase start
                    if (phaseTime === 1) {
                        triggerHaptic('exhale');
                    }
                    
                    circle.textContent = `Uitademen (${phaseTime}s)`;
                    circle.className = "breathing-circle exhale";
                    document.getElementById('current-phase').textContent = 'Uitademen';
                    
                    // Smooth scaling animation
                    const exhaleProgress = phaseTime / pattern.exhale;
                    const exhaleScale = 1.15 - (0.3 * Math.min(exhaleProgress, 1));
                    circle.style.transform = `scale(${exhaleScale})`;
                    
                    if (phaseTime >= pattern.exhale) {
                        phaseTime = 0;
                        
                        if (breathingPattern === 'extended') {
                            // For extended: go to hold after exhale
                            currentPhase = 'hold';
                            triggerHaptic('hold'); // Haptic for hold transition
                        } else {
                            // For standard/advanced: complete cycle
                            completedCycles++;
                            document.getElementById('cycle-count').textContent = completedCycles;
                            
                            devLog('Standard/Advanced cycle completed:', completedCycles, 'of', totalCycles);
                            
                            if (completedCycles >= totalCycles) {
                                triggerHaptic('complete'); // Success haptic!
                                stopBreathing();
                                return;
                            } else {
                                currentPhase = 'inhale';
                                triggerHaptic('inhale'); // Next cycle start
                            }
                        }
                    }
                    break;
            }
        }, 1000);
    }

    window.stopBreathing = function() {
        isBreathing = false;
        clearInterval(breathInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        const circle = document.getElementById('breathing-circle');
        circle.textContent = "Goed gedaan! üéâ";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        document.getElementById('start-breathing').disabled = false;
        document.getElementById('stop-breathing').disabled = true;
        document.getElementById('current-phase').textContent = 'Voltooid';
        
        // IMPROVED: Update stats with better streak tracking
        userStats.totalSessions++;
        updateStreak();
        saveUserStats(); // Save updated stats
        
        // FIXED: More robust cycle counting and debugging
        let completedCycles = 0;
        const cycleCountElement = document.getElementById('cycle-count');
        
        if (cycleCountElement && cycleCountElement.textContent) {
            completedCycles = parseInt(cycleCountElement.textContent) || 0;
        }
        
        const pattern = getBreathingPattern(breathingPattern);
        const targetCycles = pattern ? (pattern.cycles || 10) : 10;
        
        // Enhanced debugging
        console.log('=== BREATHING SESSION DEBUG ===');
        console.log('Completed cycles:', completedCycles);
        console.log('Target cycles:', targetCycles);
        console.log('Pattern:', breathingPattern);
        console.log('Pattern object:', pattern);
        console.log('Should open modal:', completedCycles >= targetCycles);
        console.log('Latest CP Score available:', latestCPScore);
        
        // FIXED: Always try to open modal if reasonable completion
        if (completedCycles > 0 && completedCycles >= Math.floor(targetCycles * 0.8)) {
            console.log('‚úÖ Opening journal modal for breathing session (80% completion threshold met)');
            
            // Ensure modal opens even if there are timing issues
            setTimeout(() => {
                try {
                    openJournalModal('Buteyko Ademhaling');
                    showUserMessage('üéâ Oefening voltooid! Vul je ervaring in.', 'success');
                } catch (error) {
                    console.error('Error opening journal modal:', error);
                    // Fallback: show message to manually open journal
                    showUserMessage('Oefening voltooid! Klik op "Nieuwe Entry" om je ervaring bij te houden.', 'info');
                }
            }, 1000);
        } else if (completedCycles > 0) {
            console.log('‚ö†Ô∏è Session partially completed but below threshold');
            showUserMessage(`Oefening gestopt na ${completedCycles}/${targetCycles} cycli. Probeer de volgende keer de volledige oefening te voltooien.`, 'warning');
        } else {
            console.log('‚ùå No meaningful session to record');
        }
        
        updateDashboard();
    };

    // ============================================
    // RESONANT BREATHING FUNCTIONS
    // ============================================

    // Initialize canvas after DOM loads
    function initResonantCanvas() {
        resonantCanvas = document.getElementById('resonant-circle');
        if (!resonantCanvas) return;
        
        resonantCtx = resonantCanvas.getContext('2d');
        resonantCanvas.width = 300;
        resonantCanvas.height = 300;
        
        // Draw initial state
        drawResonantCircle(0.5, 'Klaar om te starten');
    }

    // Draw breathing circle with smooth animation
    function drawResonantCircle(scale, text) {
        if (!resonantCtx) return;
        
        const canvas = resonantCanvas;
        const ctx = resonantCtx;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const baseRadius = 80;
        const radius = baseRadius * scale;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Create gradient based on phase
        const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
        if (scale > 0.5) {
            // Inhaling - blue gradient
            gradient.addColorStop(0, '#4A90E2');
            gradient.addColorStop(1, '#2563eb');
        } else {
            // Exhaling - green gradient
            gradient.addColorStop(0, '#7ED321');
            gradient.addColorStop(1, '#10b981');
        }
        
        // Draw circle
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // Add glow effect
        ctx.shadowBlur = 20;
        ctx.shadowColor = scale > 0.5 ? '#4A90E2' : '#7ED321';
        
        // Update text element
        const textElement = document.getElementById('resonant-phase-text');
        if (textElement) {
            textElement.textContent = text;
            textElement.style.color = scale > 0.5 ? '#2563eb' : '#10b981';
        }
    }

    // Initialize audio context for resonant breathing
    function initResonantAudio() {
        if (!resonantAudioContext) {
            try {
                resonantAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('‚úÖ Resonant audio context initialized');
            } catch (error) {
                console.warn('‚ö†Ô∏è Web Audio API not supported:', error);
            }
        }
    }

    // Play a tone for breath guidance
    function playResonantTone(frequency = 440, duration = 0.15) {
        if (resonantAudioMode === 'silence' || !resonantAudioContext) return;
        
        try {
            // Resume audio context if suspended (browser autoplay policy)
            if (resonantAudioContext.state === 'suspended') {
                resonantAudioContext.resume();
            }
            
            const oscillator = resonantAudioContext.createOscillator();
            const gainNode = resonantAudioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(resonantAudioContext.destination);
            
            // Soft, gentle tone
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            
            // Fade in and out
            gainNode.gain.setValueAtTime(0, resonantAudioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, resonantAudioContext.currentTime + 0.05);
            gainNode.gain.linearRampToValueAtTime(0, resonantAudioContext.currentTime + duration);
            
            oscillator.start(resonantAudioContext.currentTime);
            oscillator.stop(resonantAudioContext.currentTime + duration);
        } catch (error) {
            console.warn('Audio playback error:', error);
        }
    }

    // Animate the breathing circle
    function animateResonantBreath() {
        if (resonantPaused) return;
        
        const breathCycleTime = 60 / resonantBPM; // Total time for one breath (in/out)
        const inhaleTime = breathCycleTime / 2;
        const exhaleTime = breathCycleTime / 2;
        
        const elapsed = (Date.now() - resonantStartTime) / 1000;
        const cyclePosition = (elapsed % breathCycleTime) / breathCycleTime;
        
        // Calculate scale with smooth easing
        let scale, phase;
        if (cyclePosition < 0.5) {
            // Inhale phase (0 to 0.5)
            const t = cyclePosition * 2; // 0 to 1
            scale = 0.5 + (easeInOutSine(t) * 0.5); // 0.5 to 1.0
            phase = 'IN';
        } else {
            // Exhale phase (0.5 to 1.0)
            const t = (cyclePosition - 0.5) * 2; // 0 to 1
            scale = 1.0 - (easeInOutSine(t) * 0.5); // 1.0 to 0.5
            phase = 'UIT';
        }
        
        // Trigger audio cue on phase change
        if (phase !== resonantLastPhase) {
            resonantLastPhase = phase;
            
            if (resonantAudioMode === 'tones') {
                // Higher tone for inhale, lower for exhale
                const frequency = phase === 'IN' ? 523.25 : 392.00; // C5 for inhale, G4 for exhale
                playResonantTone(frequency, 0.15);
            }
        }
        
        drawResonantCircle(scale, phase);
        
        // Update timer
        updateResonantTimer();
        
        // Continue animation ONLY if session is still active
        // Check if resonantStartTime still exists (gets set to null on stop/complete)
        if (resonantStartTime && !resonantPaused) {
            resonantAnimationId = requestAnimationFrame(animateResonantBreath);
        }
    }

    // Easing function for smooth breathing
    function easeInOutSine(t) {
        return -(Math.cos(Math.PI * t) - 1) / 2;
    }

    // Update timer display
    function updateResonantTimer() {
        if (!resonantStartTime) return;
        
        const elapsed = Math.floor((Date.now() - resonantStartTime) / 1000);
        const totalSeconds = resonantDuration * 60;
        const remaining = Math.max(0, totalSeconds - elapsed);
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        const timeDisplay = document.getElementById('resonant-time-display');
        if (timeDisplay) {
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        const progress = Math.min(100, Math.round((elapsed / totalSeconds) * 100));
        const progressDisplay = document.getElementById('resonant-progress');
        if (progressDisplay) {
            progressDisplay.textContent = `${progress}%`;
        }
        
        // Check if session complete
        if (remaining === 0 && !resonantPaused) {
            completeResonantSession();
        }
    }

    // Session control functions
    window.setResonantDuration = function(minutes) {
        resonantDuration = minutes;
        const display = document.getElementById('resonant-duration-display');
        if (display) {
            display.textContent = `Geselecteerd: ${minutes} minuten${minutes === 20 ? ' ‚≠ê' : ''}`;
        }
        
        // Update buttons visual feedback
        document.querySelectorAll('#resonant button.btn-secondary, #resonant button.btn-primary').forEach(btn => {
            const btnMinutes = parseInt(btn.textContent);
            if (btnMinutes === minutes) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
        });
        
        devLog('Resonant duration set:', minutes, 'minutes');
    };

    window.updateResonantBPM = function() {
        const slider = document.getElementById('resonant-bpm-slider');
        resonantBPM = parseFloat(slider.value);
        
        const display = document.getElementById('resonant-bpm-display');
        if (display) {
            display.textContent = resonantBPM.toFixed(1);
        }
        
        devLog('Resonant BPM set:', resonantBPM);
    };

    window.updateResonantAudio = function() {
        const select = document.getElementById('resonant-audio');
        resonantAudioMode = select.value;
        
        // Initialize audio context if switching from silence to tones
        if (resonantAudioMode !== 'silence' && !resonantAudioContext) {
            initResonantAudio();
        }
        
        // Play a test sound to show it works
        if (resonantAudioMode === 'tones') {
            playResonantTone(523.25, 0.15);
            showUserMessage('üîä Zachte tonen geactiveerd - je hoort een beep bij elke fase overgang', 'info');
        } else {
            showUserMessage('üîá Audio uitgeschakeld', 'info');
        }
        
        devLog('Resonant audio mode:', resonantAudioMode);
    };

    window.startResonantBreathing = function() {
        if (!resonantCanvas) {
            initResonantCanvas();
        }
        
        // Initialize audio if needed (and not silence mode)
        if (resonantAudioMode !== 'silence' && !resonantAudioContext) {
            initResonantAudio();
        }
        
        // Request wake lock
        requestWakeLock();
        
        resonantStartTime = Date.now();
        resonantPaused = false;
        resonantLastPhase = null; // Reset phase tracking for audio cues
        
        // Update button states
        document.getElementById('start-resonant').disabled = true;
        document.getElementById('pause-resonant').disabled = false;
        document.getElementById('stop-resonant').disabled = false;
        
        // Start animation
        animateResonantBreath();
        
        const audioMsg = resonantAudioMode === 'tones' ? ' met zachte tonen' : '';
        showUserMessage(`‚ú® Resonant breathing sessie gestart: ${resonantDuration} minuten op ${resonantBPM} bpm${audioMsg}`, 'success');
        devLog('Resonant session started:', { duration: resonantDuration, bpm: resonantBPM, audio: resonantAudioMode });
    };

    window.pauseResonantBreathing = function() {
        resonantPaused = !resonantPaused;
        
        const pauseBtn = document.getElementById('pause-resonant');
        if (resonantPaused) {
            if (resonantAnimationId) {
                cancelAnimationFrame(resonantAnimationId);
            }
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Hervat';
            drawResonantCircle(0.75, 'PAUZE');
            showUserMessage('‚è∏Ô∏è Sessie gepauzeerd', 'info');
        } else {
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pauze';
            animateResonantBreath();
            showUserMessage('‚ñ∂Ô∏è Sessie hervat', 'info');
        }
    };

    window.stopResonantBreathing = function() {
        // Stop animation
        if (resonantAnimationId) {
            cancelAnimationFrame(resonantAnimationId);
            resonantAnimationId = null;
        }
        
        // Release wake lock
        releaseWakeLock();
        
        // Calculate session time
        const elapsed = resonantStartTime ? Math.floor((Date.now() - resonantStartTime) / 1000) : 0;
        const completedMinutes = Math.floor(elapsed / 60);
        const targetMinutes = resonantDuration;
        const completionPercentage = Math.min(100, Math.round((completedMinutes / targetMinutes) * 100));
        
        // Reset UI
        document.getElementById('start-resonant').disabled = false;
        document.getElementById('pause-resonant').disabled = true;
        document.getElementById('stop-resonant').disabled = true;
        document.getElementById('pause-resonant').innerHTML = '<i class="fas fa-pause"></i> Pauze';
        
        drawResonantCircle(0.5, 'Sessie gestopt');
        
        // Reset state variables
        resonantPaused = false;
        resonantStartTime = null;
        resonantLastPhase = null; // Reset phase tracking
        
        // Show message
        if (completionPercentage >= 80) {
            showUserMessage(`‚úÖ Sessie voltooid: ${completedMinutes}/${targetMinutes} minuten (${completionPercentage}%)`, 'success');
        } else {
            showUserMessage(`‚ö†Ô∏è Sessie gestopt: ${completedMinutes}/${targetMinutes} minuten (${completionPercentage}%)`, 'warning');
        }
        
        devLog('Resonant session stopped:', { completed: completedMinutes, target: targetMinutes });
    };

    function completeResonantSession() {
        // Stop animation
        if (resonantAnimationId) {
            cancelAnimationFrame(resonantAnimationId);
            resonantAnimationId = null;
        }
        
        // Release wake lock
        releaseWakeLock();
        
        // Save session data
        const session = {
            type: 'resonant_breathing',
            timestamp: new Date(),
            duration: resonantDuration,
            breathRate: resonantBPM,
            completed: true,
            userId: currentUser?.uid,
            userEmail: currentUser?.email
        };
        
        resonantSessions.push(session);
        
        // Update UI
        document.getElementById('start-resonant').disabled = false;
        document.getElementById('pause-resonant').disabled = true;
        document.getElementById('stop-resonant').disabled = true;
        document.getElementById('pause-resonant').innerHTML = '<i class="fas fa-pause"></i> Pauze';
        
        drawResonantCircle(0.75, 'VOLTOOID! üéâ');
        
        // Reset state variables
        resonantPaused = false;
        resonantStartTime = null;
        resonantLastPhase = null; // Reset phase tracking for next session
        
        // Update stats
        userStats.totalSessions++;
        updateStreak();
        saveUserStats();
        
        // Update weekly stats
        updateResonantWeeklyStats();
        
        // Success message with option to journal
        setTimeout(() => {
            showUserMessage('üéâ Resonant breathing sessie voltooid! Vul je ervaring in het dagboek in.', 'success');
            
            // Ask if user wants to journal
            if (confirm('Wil je deze sessie in je dagboek bijhouden?')) {
                openJournalModal('Resonant Breathing');
            }
        }, 1000);
        
        devLog('Resonant session completed:', session);
    }

    function updateResonantWeeklyStats() {
        // Calculate this week's sessions
        const now = new Date();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        weekStart.setHours(0, 0, 0, 0);
        
        const thisWeekSessions = resonantSessions.filter(s => 
            new Date(s.timestamp) >= weekStart && s.completed
        );
        
        const sessionsCount = thisWeekSessions.length;
        const targetSessions = 14; // 2 per day √ó 7 days
        const adherence = Math.min(100, Math.round((sessionsCount / targetSessions) * 100));
        const totalMinutes = thisWeekSessions.reduce((sum, s) => sum + s.duration, 0);
        
        // Update display
        const countEl = document.getElementById('resonant-sessions-count');
        const adherenceEl = document.getElementById('resonant-adherence');
        const minutesEl = document.getElementById('resonant-total-minutes');
        
        if (countEl) countEl.textContent = sessionsCount;
        if (adherenceEl) adherenceEl.textContent = adherence;
        if (minutesEl) minutesEl.textContent = totalMinutes;
        
        devLog('Weekly resonant stats updated:', { sessions: sessionsCount, adherence, minutes: totalMinutes });
    }

    // ============================================
    // CRISIS HELP FUNCTIONS
    // ============================================

    window.startCrisisProtocol = function() {
        document.getElementById('crisis-protocol').classList.remove('hidden');
        document.getElementById('crisis-breathing').classList.add('hidden');
        
        crisisProtocolActive = true;
        crisisStep = 0;
        crisisTimer = 0;
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        // Update total steps display
        document.getElementById('protocol-total-steps').textContent = crisisProtocolSteps.length;
        
        runCrisisProtocolStep();
    };

    function runCrisisProtocolStep() {
        if (!crisisProtocolActive || crisisStep >= crisisProtocolSteps.length) return;
        
        const step = crisisProtocolSteps[crisisStep];
        crisisStepDuration = step.duration;
        crisisTimer = crisisStepDuration;
        
        // Trigger haptic feedback at step start
        triggerHaptic('inhale'); // Gentle notification for new step
        
        // Update UI for current step
        document.getElementById('protocol-step-title').textContent = step.title;
        document.getElementById('protocol-instructions').textContent = step.instructions;
        document.getElementById('protocol-encouragement').textContent = step.encouragement;
        document.getElementById('protocol-current-step').textContent = crisisStep + 1;
        
        // Update circle
        const circle = document.getElementById('protocol-circle');
        circle.textContent = step.breathingText;
        
        // Set circle style based on step
        switch(crisisStep) {
            case 0: // Stop & Erken
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1)';
                break;
            case 1: // Paradoxale Ademhaling
                circle.className = "breathing-circle hold";
                startParadoxicalBreathing(circle);
                break;
            case 2: // Grounding
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1.05)';
                startGroundingAnimation(circle);
                break;
            case 3: // Rustgevende Ademhaling
                circle.className = "breathing-circle inhale";
                startGentleBreathing(circle);
                break;
            case 4: // Bevestiging
                circle.className = "breathing-circle";
                circle.style.transform = 'scale(1)';
                break;
        }
        
        // Start timer for this step
        crisisInterval = setInterval(updateCrisisTimer, 1000);
    }

    function updateCrisisTimer() {
        if (!crisisProtocolActive) return;
        
        crisisTimer--;
        
        // Update timer display
        const minutes = Math.floor(crisisTimer / 60);
        const seconds = crisisTimer % 60;
        document.getElementById('protocol-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress bar
        const progress = ((crisisStepDuration - crisisTimer) / crisisStepDuration) * 100;
        document.getElementById('protocol-progress').style.width = progress + '%';
        
        // Move to next step when timer reaches 0
        if (crisisTimer <= 0) {
            clearInterval(crisisInterval);
            crisisStep++;
            
            if (crisisStep < crisisProtocolSteps.length) {
                // Small pause between steps
                setTimeout(runCrisisProtocolStep, 1000);
            } else {
                // Protocol completed
                completeCrisisProtocol();
            }
        }
    }

    function startParadoxicalBreathing(circle) {
        let phase = 'small-inhale';
        let phaseTimer = 0;
        
        const breathingInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 1) {
                clearInterval(breathingInterval);
                return;
            }
            
            phaseTimer++;
            
            switch(phase) {
                case 'small-inhale':
                    if (phaseTimer === 1) {
                        triggerHaptic('inhale'); // Haptic at phase start
                    }
                    circle.textContent = "Klein inademen...";
                    circle.className = "breathing-circle inhale";
                    circle.style.transform = 'scale(1.05)';
                    if (phaseTimer >= 2) {
                        phase = 'hold';
                        phaseTimer = 0;
                        triggerHaptic('hold'); // Haptic for hold
                    }
                    break;
                case 'hold':
                    circle.textContent = "Vasthouden...";
                    circle.className = "breathing-circle hold";
                    circle.style.transform = 'scale(1.05)';
                    if (phaseTimer >= 3) {
                        phase = 'small-exhale';
                        phaseTimer = 0;
                        triggerHaptic('exhale'); // Haptic for exhale
                    }
                    break;
                case 'small-exhale':
                    circle.textContent = "Klein uitademen...";
                    circle.className = "breathing-circle exhale";
                    circle.style.transform = 'scale(0.95)';
                    if (phaseTimer >= 2) {
                        phase = 'small-inhale';
                        phaseTimer = 0;
                        triggerHaptic('inhale'); // Haptic for next cycle
                    }
                    break;
            }
        }, 1000);
    }

    function startGroundingAnimation(circle) {
        let colorIndex = 0;
        const colors = ['#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
        const texts = [
            "Zoek 5 dingen die je ziet...",
            "Voel 4 verschillende texturen...", 
            "Luister naar 3 geluiden...",
            "Focus op je omgeving...",
            "Je bent hier en nu..."
        ];
        let textIndex = 0;
        
        const groundingInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 2) {
                clearInterval(groundingInterval);
                return;
            }
            
            circle.style.borderColor = colors[colorIndex];
            circle.textContent = texts[textIndex];
            colorIndex = (colorIndex + 1) % colors.length;
            textIndex = (textIndex + 1) % texts.length;
        }, 3000);
    }

    function startGentleBreathing(circle) {
        let phase = 'inhale';
        let phaseTimer = 0;
        
        const gentleInterval = setInterval(() => {
            if (!crisisProtocolActive || crisisStep !== 3) {
                clearInterval(gentleInterval);
                return;
            }
            
            phaseTimer++;
            
            if (phase === 'inhale') {
                circle.textContent = "Rustig inademen...";
                circle.className = "breathing-circle inhale";
                const progress = phaseTimer / 4;
                const scale = 1 + (0.08 * Math.min(progress, 1));
                circle.style.transform = `scale(${scale})`;
                
                if (phaseTimer >= 4) {
                    phase = 'exhale';
                    phaseTimer = 0;
                }
            } else {
                circle.textContent = "Langzaam uitademen...";
                circle.className = "breathing-circle exhale";
                const progress = phaseTimer / 6;
                const scale = 1.08 - (0.08 * Math.min(progress, 1));
                circle.style.transform = `scale(${scale})`;
                
                if (phaseTimer >= 6) {
                    phase = 'inhale';
                    phaseTimer = 0;
                }
            }
        }, 1000);
    }

    function completeCrisisProtocol() {
        // Trigger success haptic pattern
        triggerHaptic('complete');
        
        // Update UI to show completion
        document.getElementById('protocol-step-title').textContent = "üéâ Protocol Voltooid";
        document.getElementById('protocol-instructions').textContent = "Je hebt het noodprotocol succesvol doorlopen. Je bent weer in controle.";
        document.getElementById('protocol-encouragement').textContent = "Je bent sterk! Overweeg om deze ervaring in je dagboek te noteren.";
        
        const circle = document.getElementById('protocol-circle');
        circle.textContent = "Voltooid! üéâ";
        circle.className = "breathing-circle";
        circle.style.transform = 'scale(1)';
        
        // Release wake lock
        releaseWakeLock();
        
        // Auto-close after 5 seconds and offer journal entry
        setTimeout(() => {
            stopCrisisProtocol();
            setTimeout(() => {
                openJournalModal('Noodprotocol');
            }, 1000);
        }, 5000);
    }

    window.stopCrisisProtocol = function() {
        crisisProtocolActive = false;
        clearInterval(crisisInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('crisis-protocol').classList.add('hidden');
        
        // Reset variables
        crisisStep = 0;
        crisisTimer = 0;
        crisisStepDuration = 0;
    };

    window.startCrisisBreathing = function() {
        document.getElementById('crisis-breathing').classList.remove('hidden');
        document.getElementById('crisis-protocol').classList.add('hidden');
        
        // Request wake lock to keep screen on
        requestWakeLock();
        
        const circle = document.getElementById('crisis-circle');
        let phase = 'inhale';
        let phaseCount = 0;
        
        // Reset circle to initial state
        circle.style.transform = 'scale(1)';
        circle.className = "breathing-circle";
        
        crisisInterval = setInterval(() => {
            phaseCount++;
            
            if (phase === 'inhale') {
                circle.textContent = `Adem in (${phaseCount})`;
                circle.className = "breathing-circle inhale";
                
                // Smooth inhale animation
                const inhaleProgress = phaseCount / 4;
                const inhaleScale = 1 + (0.15 * Math.min(inhaleProgress, 1));
                circle.style.transform = `scale(${inhaleScale})`;
                
                if (phaseCount >= 4) {
                    phaseCount = 0;
                    phase = 'exhale';
                }
            } else {
                circle.textContent = `Adem uit (${phaseCount})`;
                circle.className = "breathing-circle exhale";
                
                // Smooth exhale animation
                const exhaleProgress = phaseCount / 6;
                const exhaleScale = 1.15 - (0.25 * Math.min(exhaleProgress, 1));
                circle.style.transform = `scale(${exhaleScale})`;
                
                if (phaseCount >= 6) {
                    phaseCount = 0;
                    phase = 'inhale';
                }
            }
        }, 1000);
    };

    window.stopCrisisBreathing = function() {
        clearInterval(crisisInterval);
        
        // Release wake lock
        releaseWakeLock();
        
        document.getElementById('crisis-breathing').classList.add('hidden');
        
        // Reset circle to original state
        const circle = document.getElementById('crisis-circle');
        circle.style.transform = 'scale(1)';
        circle.className = "breathing-circle";
        circle.textContent = "Volg de cirkel";
        
        // Auto-open journal modal
        setTimeout(() => {
            openJournalModal('Crisis Ademhaling');
        }, 500);
    };

    // ============================================
    // JOURNAL FUNCTIONS
    // ============================================

    window.openJournalModal = function(technique = '') {
        console.log('üìù Opening journal modal for technique:', technique);
        
        document.getElementById('journal-modal').style.display = 'block';
        
        if (technique) {
            document.getElementById('entry-technique').value = technique;
            
            // IMPROVED: Smart CP score handling for Buteyko
            if (technique === 'Buteyko Ademhaling') {
                // CP veld is altijd zichtbaar, vul alleen intelligente suggestie in
                
                // Try to find the best CP score to use
                let scoreToUse = null;
                let scoreSource = '';
                
                // 1. Check for very recent CP score (within last hour)
                if (latestCPScore !== null && lastCPTimestamp) {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (lastCPTimestamp > oneHourAgo) {
                        scoreToUse = latestCPScore;
                        scoreSource = 'laatste meting (binnen het uur)';
                    }
                }
                
                // 2. Check recent unused CP scores
                if (!scoreToUse && recentCPScores.length > 0) {
                    const unusedScore = recentCPScores.find(cp => !cp.used);
                    if (unusedScore) {
                        scoreToUse = unusedScore.score;
                        scoreSource = 'recente meting';
                        // Mark as used
                        unusedScore.used = true;
                    }
                }
                
                // 3. Use most recent score as fallback
                if (!scoreToUse && recentCPScores.length > 0) {
                    scoreToUse = recentCPScores[0].score;
                    scoreSource = 'laatste beschikbare meting';
                }
                
                // Auto-populate if score found
                if (scoreToUse !== null) {
                    document.getElementById('entry-cp-score').value = scoreToUse;
                    console.log(`‚úÖ CP score ${scoreToUse} ingevuld (bron: ${scoreSource})`);
                    
                    // Show helpful message
                    const cpField = document.getElementById('entry-cp-score');
                    if (cpField) {
                        cpField.style.backgroundColor = '#e0f7fa';
                        cpField.title = `Automatisch ingevuld van ${scoreSource}`;
                        setTimeout(() => {
                            cpField.style.backgroundColor = '';
                        }, 3000);
                    }
                } else {
                    console.log('‚ö†Ô∏è Geen recente CP score beschikbaar voor automatische invulling');
                }
            }
        }
        
        // Focus first input
        setTimeout(() => {
            document.getElementById('entry-technique').focus();
        }, 100);
    };

    window.closeJournalModal = function() {
        document.getElementById('journal-modal').style.display = 'none';
        
        // Reset form
        document.getElementById('entry-technique').selectedIndex = 0;
        document.getElementById('entry-trigger').value = '';
        document.getElementById('entry-before').value = '5';
        document.getElementById('entry-after').value = '5';
        document.getElementById('before-value').textContent = '5';
        document.getElementById('after-value').textContent = '5';
        document.getElementById('entry-result').selectedIndex = 0;
        document.getElementById('entry-notes').value = '';
        
        // Reset medication fields
        document.getElementById('entry-has-medication').checked = false;
        document.getElementById('medication-fields').style.display = 'none';
        document.getElementById('entry-med-action').selectedIndex = 0;
        document.getElementById('entry-med-name').value = '';
        document.getElementById('entry-med-dose').value = '';
        document.getElementById('entry-med-previous-dose').value = '';
        document.getElementById('entry-med-reason').value = '';
        document.getElementById('med-previous-dose-group').style.display = 'none';
        document.getElementById('entry-cp-score').value = '';
        // CP field blijft altijd zichtbaar
        
        // Reset symptom checkboxes
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
        
        // IMPROVED: Only clear latestCPScore if it's older than 2 hours
        if (lastCPTimestamp) {
            const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
            if (lastCPTimestamp < twoHoursAgo) {
                latestCPScore = null;
                console.log('üßπ Cleared old CP score (>2 hours)');
            }
        }
    };

    window.saveJournalEntry = async function() {
        try {
            // Collect form data
            const sensations = Array.from(document.querySelectorAll('.symptom-checkbox:checked'))
                                .map(cb => cb.dataset.symptom);
            
            const entry = {
                techniekGebruikt: document.getElementById('entry-technique').value,
                trigger: document.getElementById('entry-trigger').value,
                sensaties: sensations,
                intensiteitVoor: parseInt(document.getElementById('entry-before').value),
                intensiteitNa: parseInt(document.getElementById('entry-after').value),
                resultaat: document.getElementById('entry-result').value,
                notities: document.getElementById('entry-notes').value,
                timestamp: new Date(),
                userId: currentUser?.uid,
                userEmail: currentUser?.email
            };

            // Handle medication event if checkbox is checked
            const hasMedication = document.getElementById('entry-has-medication').checked;
            if (hasMedication) {
                const medAction = document.getElementById('entry-med-action').value;
                const medName = document.getElementById('entry-med-name').value.trim();
                const medDose = document.getElementById('entry-med-dose').value.trim();
                const medReason = document.getElementById('entry-med-reason').value.trim();
                
                if (medAction && medName) {
                    const medicationEvent = {
                        action: medAction,
                        name: medName,
                        dose: medDose,
                        reason: medReason,
                        timestamp: new Date()
                    };
                    
                    // For dose changes, include previous dose
                    if (medAction === 'dose_change') {
                        medicationEvent.previousDose = document.getElementById('entry-med-previous-dose').value.trim();
                    }
                    
                    // Add to entry
                    entry.medicationEvent = medicationEvent;
                    
                    // Update active medications list
                    updateActiveMedications(medicationEvent);
                    
                    // Log to medication events history
                    userStats.medicationEvents.push(medicationEvent);
                    
                    devLog('Medication event added:', medicationEvent);
                }
            }

            // Add CP score if available
            const cpScore = document.getElementById('entry-cp-score').value;
            if (cpScore && !isNaN(parseInt(cpScore))) {
                entry.cpScore = parseInt(cpScore);
            }
            
            devLog('Saving journal entry:', entry);

            if (!entry.resultaat) {
                showUserMessage('‚ö†Ô∏è Selecteer een resultaat voor de dagboek entry.', 'warning');
                return;
            }

            // Add to local array
            allJournalEntries.unshift(entry);
            
            // IMPROVED: Update streak tracking - add today's date to session dates
            const today = new Date().toDateString();
            userStats.sessionDates.add(today);
            userStats.lastSessionDate = new Date();
            updateStreak();
            saveUserStats();
            
            // Save to Firebase (skip in DEV_MODE)
            if (currentUser && !DEV_MODE) {
                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                await addDoc(collection(db, "dagboekEntries"), entry);
                devLog('Entry saved to Firebase');
            } else if (DEV_MODE) {
                devLog('üîß DEV_MODE: Entry saved locally only (not to Firebase)', entry);
            }
            
            closeJournalModal();
            displayJournalEntries();
            updateDashboard();
            generateInsights();
            
            // Show prominent success message with details
            const improvementText = entry.intensiteitVoor > entry.intensiteitNa ? 
                ` Verbetering: ${entry.intensiteitVoor} ‚Üí ${entry.intensiteitNa}` : '';
            showUserMessage(`‚úÖ Entry opgeslagen!${improvementText}`, 'success');
            
        } catch (error) {
            console.error('Save error:', error);
            showUserMessage('‚ùå Opslaan mislukt: ' + error.message, 'error');
        }
    };

    async function loadJournalEntries() {
        if (!currentUser) return;
        
        // DEV_MODE: Skip Firebase loading, use local data only
        if (DEV_MODE) {
            devLog('üîß DEV_MODE: Skipping Firebase, using local storage only');
            allJournalEntries = [];
            allCPMeasurements = [];
            displayJournalEntries();
            generateInsights();
            createProgressChart();
            return;
        }
        
        try {
            const { getDocs, collection, query, where, orderBy } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            
            // Load journal entries
            try {
                const journalQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const journalSnapshot = await getDocs(journalQuery);
                allJournalEntries = [];
                
                journalSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (orderError) {
                // Fallback without orderBy
                const simpleQuery = query(
                    collection(db, "dagboekEntries"),
                    where("userId", "==", currentUser.uid)
                );
                
                const simpleSnapshot = await getDocs(simpleQuery);
                allJournalEntries = [];
                
                simpleSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allJournalEntries.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // Sort manually
                allJournalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            // Load CP measurements
            try {
                const cpQuery = query(
                    collection(db, "cpMeasurements"),
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc")
                );
                
                const cpSnapshot = await getDocs(cpQuery);
                allCPMeasurements = [];
                
                cpSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allCPMeasurements.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
            } catch (cpError) {
                console.warn('CP measurements loading failed:', cpError);
                allCPMeasurements = [];
            }
            
            // IMPROVED: Build session dates set for streak calculation
            userStats.sessionDates = new Set();
            allJournalEntries.forEach(entry => {
                const dateString = entry.timestamp.toDateString();
                userStats.sessionDates.add(dateString);
            });
            
            // IMPROVED: Rebuild medication tracking from entries if userStats is missing data
            rebuildMedicationTrackingFromEntries();
            
            displayJournalEntries();
            generateInsights();
            createProgressChart();
            
            // Set default chart filter state (10 days)
            if (currentTab === 'dagboek') {
                setTimeout(() => {
                    document.getElementById('chart-10days').classList.add('active');
                }, 100);
            }
            
        } catch (error) {
            console.error('Load entries failed:', error);
            showUserMessage('‚ùå Laden van entries mislukt: ' + error.message, 'error');
        }
    }

    function displayJournalEntries() {
        const container = document.getElementById('journal-entries');
        
        if (allJournalEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Nog geen dagboek entries. Begin met je eerste oefening!</p>
                </div>
            `;
            return;
        }

        // Apply default filter (last 7 days) on first load
        const filterSelect = document.getElementById('journal-filter');
        const currentFilter = filterSelect ? filterSelect.value : 'last7';
        
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        switch(currentFilter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
            case 'all':
            default:
                filteredEntries = [...allJournalEntries];
                break;
        }

        if (filteredEntries.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: var(--text-light); margin: 2rem 0;">
                    <p>Geen entries gevonden voor de geselecteerde periode.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('journal-filter').value='all'; filterJournalEntries();">Toon alle entries</button>
                </div>
            `;
            return;
        }

        // Group entries by month for display
        const entriesByMonth = {};
        filteredEntries.forEach(entry => {
            const monthKey = entry.timestamp.toLocaleDateString('nl-BE', { 
                year: 'numeric', 
                month: 'long' 
            });
            
            if (!entriesByMonth[monthKey]) {
                entriesByMonth[monthKey] = [];
            }
            entriesByMonth[monthKey].push(entry);
        });

        let html = '';
        
        Object.keys(entriesByMonth).forEach(month => {
            const entries = entriesByMonth[month];
            
            html += `
                <div class="card">
                    <h3>üìÖ ${month}</h3>
                    <div style="display: grid; gap: 1rem;">
            `;
            
            entries.forEach(entry => {
                const improvement = entry.intensiteitVoor - entry.intensiteitNa;
                const improvementColor = improvement > 0 ? '#10b981' : improvement < 0 ? '#ef4444' : '#6b7280';
                
                html += `
                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${improvementColor};">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                            <strong>${entry.techniekGebruikt}</strong>
                            <small style="color: var(--text-light);">${entry.timestamp.toLocaleDateString('nl-BE')}</small>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin: 0.5rem 0;">
                            <div><small>Voor: ${entry.intensiteitVoor}/10</small></div>
                            <div><small>Na: ${entry.intensiteitNa}/10</small></div>
                            <div><small>Verschil: ${improvement > 0 ? '+' : ''}${improvement}</small></div>
                            ${entry.cpScore ? `<div><small>CP: ${entry.cpScore}s</small></div>` : ''}
                        </div>
                        
                        ${entry.trigger ? `<div style="margin: 0.5rem 0;"><small><strong>Trigger:</strong> ${entry.trigger}</small></div>` : ''}
                        ${entry.sensaties && entry.sensaties.length ? `<div style="margin: 0.5rem 0;"><small><strong>Sensaties:</strong> ${entry.sensaties.join(', ')}</small></div>` : ''}
                        ${entry.symptomen && entry.symptomen.length ? `<div style="margin: 0.5rem 0;"><small><strong>Sensaties:</strong> ${entry.symptomen.join(', ')}</small></div>` : ''}
                        
                        <div style="margin: 0.5rem 0;">
                            <span style="background: ${improvementColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                ${entry.resultaat}
                            </span>
                        </div>
                        
                        ${entry.medicationEvent ? formatMedicationEvent(entry.medicationEvent) : ''}
                        ${entry.medicatie ? `<div style="margin: 0.5rem 0;"><small><strong>üíä Medicatie:</strong> ${entry.medicatie}</small></div>` : ''}
                        ${entry.notities ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-light);"><small>${entry.notities}</small></div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    window.filterJournalEntries = function() {
        const filter = document.getElementById('journal-filter').value;
        let filteredEntries = [...allJournalEntries];
        
        const now = new Date();
        
        switch(filter) {
            case 'last7':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= weekAgo);
                break;
            case 'last30':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= monthAgo);
                break;
        }
        
        // Update display with filtered entries
        const originalEntries = allJournalEntries;
        allJournalEntries = filteredEntries;
        displayJournalEntries();
        allJournalEntries = originalEntries;
    };

    window.exportDagboek = function() {
        let text = 'Ademruimte Dagboek Export\n';
        text += '==========================\n\n';
        
        allJournalEntries.forEach(entry => {
            text += `Datum: ${entry.timestamp.toLocaleString('nl-BE')}\n`;
            text += `Techniek: ${entry.techniekGebruikt}\n`;
            text += `Trigger: ${entry.trigger || 'Geen'}\n`;
            text += `Intensiteit v√≥√≥r: ${entry.intensiteitVoor}/10\n`;
            text += `Intensiteit n√°: ${entry.intensiteitNa}/10\n`;
            if (entry.cpScore) text += `CP Score: ${entry.cpScore} seconden\n`;
            // Support both old (symptomen) and new (sensaties) entries
            const sensations = entry.sensaties || entry.symptomen;
            if (sensations?.length) text += `Sensaties: ${sensations.join(', ')}\n`;
            text += `Resultaat: ${entry.resultaat}\n`;
            text += `Notities: ${entry.notities || 'Geen'}\n`;
            text += '\n---\n\n';
        });

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ademruimte-dagboek-${new Date().toLocaleDateString('nl-BE')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showUserMessage('üìÅ Dagboek ge√´xporteerd!', 'success');
    };

    // ============================================
    // DASHBOARD & STATISTICS
    // ============================================

    function updateDashboard() {
        if (!currentUser) return;
        
        // Update greeting
        const greeting = document.getElementById('dashboard-greeting');
        const hour = new Date().getHours();
        let timeGreeting = 'Goedemorgen';
        if (hour >= 12) timeGreeting = 'Goedemiddag';
        if (hour >= 18) timeGreeting = 'Goedenavond';
        
        const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'daar';
        const firstName = displayName.includes(' ') ? displayName.split(' ')[0] : displayName;
        
        greeting.textContent = `${timeGreeting}, ${firstName}!`;
        
        // Calculate stats
        const allCPData = [...userStats.cpMeasurements, ...allCPMeasurements]
            .filter(cp => cp.score !== undefined)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const avgImprovement = allJournalEntries.length > 0 ? 
            allJournalEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / allJournalEntries.length : 0;
        
        const lastCP = allCPData.length > 0 ? allCPData[0].score : null;
        
        // IMPROVED: Calculate streak properly
        const currentStreak = calculateCurrentStreak();
        
        // Update stats display
        document.getElementById('total-sessions').textContent = userStats.totalSessions + allJournalEntries.length;
        document.getElementById('streak-days').textContent = currentStreak;
        document.getElementById('avg-improvement').textContent = avgImprovement > 0 ? 
            `+${avgImprovement.toFixed(1)}` : avgImprovement.toFixed(1);
        document.getElementById('last-cp').textContent = lastCP ? `${lastCP}s` : '-';
        
        // Update personalized tip
        updatePersonalizedTip();
        
        // Update active medications display
        updateActiveMedicationsDisplay();
    }

    // Update active medications display on dashboard
    function updateActiveMedicationsDisplay() {
        const card = document.getElementById('active-medications-card');
        const content = document.getElementById('active-medications-content');
        
        if (!card || !content) return;
        
        if (userStats.activeMedications.length === 0) {
            card.style.display = 'none';
            return;
        }
        
        card.style.display = 'block';
        
        let html = '<div style="display: grid; gap: 0.75rem;">';
        
        userStats.activeMedications.forEach(med => {
            const startedDate = new Date(med.startedAt).toLocaleDateString('nl-BE');
            const duration = Math.floor((new Date() - new Date(med.startedAt)) / (1000 * 60 * 60 * 24));
            
            html += `
                <div style="padding: 0.75rem; background: rgba(147, 51, 234, 0.1); border-left: 3px solid #9333ea; border-radius: 0.25rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${med.name}</strong>
                            ${med.dose ? `<span style="color: var(--text-light);"> ‚Ä¢ ${med.dose}</span>` : ''}
                        </div>
                        <small style="color: var(--text-light);">${duration} dagen</small>
                    </div>
                    <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                        Gestart: ${startedDate}
                        ${med.lastChanged ? ` ‚Ä¢ Laatst gewijzigd: ${new Date(med.lastChanged).toLocaleDateString('nl-BE')}` : ''}
                    </small>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        devLog('Active medications updated:', userStats.activeMedications.length);
    }

    // IMPROVED: Proper streak calculation
    function calculateCurrentStreak() {
        if (userStats.sessionDates.size === 0) return 0;
        
        const dates = Array.from(userStats.sessionDates)
            .map(dateStr => new Date(dateStr))
            .sort((a, b) => b - a); // Sort descending (newest first)
        
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Normalize dates to compare just day/month/year
        const normalizeDate = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const todayNorm = normalizeDate(today);
        const yesterdayNorm = normalizeDate(yesterday);
        
        let streak = 0;
        let currentDate = todayNorm;
        
        // Check if there's a session today or yesterday to start the streak
        const latestSessionNorm = normalizeDate(dates[0]);
        if (latestSessionNorm.getTime() === todayNorm.getTime() || 
            latestSessionNorm.getTime() === yesterdayNorm.getTime()) {
            
            // Count consecutive days working backwards
            for (const sessionDate of dates) {
                const sessionNorm = normalizeDate(sessionDate);
                if (sessionNorm.getTime() === currentDate.getTime()) {
                    streak++;
                    currentDate = new Date(currentDate.getTime() - 24 * 60 * 60 * 1000);
                } else if (sessionNorm.getTime() < currentDate.getTime()) {
                    // Gap found, stop counting
                    break;
                }
            }
        }
        
        return streak;
    }

    // IMPROVED: Better streak update logic
    function updateStreak() {
        const today = new Date().toDateString();
        userStats.sessionDates.add(today);
        userStats.lastSessionDate = new Date();
    }

    function updatePersonalizedTip() {
        const tipContainer = document.getElementById('tip-content');
        
        if (allJournalEntries.length === 0) {
            // Fallback to evidence-based tips when no data
            const tipIndex = new Date().getDate() % appTips.length;
            tipContainer.innerHTML = `<p>${appTips[tipIndex]}</p>`;
            return;
        }
        
        const personalizedTip = generatePersonalizedTip();
        tipContainer.innerHTML = personalizedTip;
    }

    function generatePersonalizedTip() {
        const recentEntries = allJournalEntries.slice(0, 10);
        const allTimeEntries = allJournalEntries;
        
        // Focus on meaningful notes analysis
        const meaningfulNotes = allTimeEntries.filter(e => e.notities && e.notities.trim().length > 10);
        
        if (meaningfulNotes.length === 0) {
            // Fallback to evidence-based tips when no meaningful notes
            const tipIndex = new Date().getDate() % appTips.length;
            return `<p>${appTips[tipIndex]}</p>`;
        }
        
        const personalInsights = analyzeUserNotesEvidence(meaningfulNotes, allTimeEntries);
        
        if (personalInsights.length === 0) {
            // Fallback if no insights found
            const tipIndex = new Date().getDate() % appTips.length;
            return `<p>${appTips[tipIndex]}</p>`;
        }
        
        // Rotate through insights based on day
        const insightIndex = new Date().getDate() % personalInsights.length;
        const selectedInsight = personalInsights[insightIndex];
        
        return `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="font-size: 1.5rem; margin-top: 0.1rem;">${selectedInsight.icon}</div>
                <div>
                    <p style="margin: 0; font-weight: 500;">${selectedInsight.text}</p>
                    <small style="color: var(--text-light); font-size: 0.8rem; margin-top: 0.5rem; display: block;">
                        ${selectedInsight.evidenceBase}
                    </small>
                </div>
            </div>
        `;
    }

    // IMPROVED: Evidence-based analysis following CBT principles
    function analyzeUserNotesEvidence(meaningfulNotes, allEntries) {
        const insights = [];
        const allNotesText = meaningfulNotes.map(e => e.notities.toLowerCase()).join(' ');
        
        // PRINCIPLE 1: Behavioral activation and engagement patterns
        const engagementWords = ['vol', 'voltooid', 'afgemaakt', 'gedaan', 'klaar', 'bezig', 'oefening', 'sessie'];
        const engagementCount = engagementWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (engagementCount >= 3) {
            insights.push({
                icon: 'üéØ',
                text: 'Je toont goede therapietrouw en betrokkenheid bij je oefeningen. Deze consistentie is cruciaal voor het opbouwen van nieuwe ademhalingspatronen.',
                evidenceBase: 'Gebaseerd op gedragsactivatie principes uit CBT'
            });
        }
        
        // PRINCIPLE 2: Interoceptive awareness development
        const awarenessWords = ['voel', 'merk', 'besef', 'bewust', 'aandacht', 'focus', 'concentreer', 'observeer'];
        const awarenessCount = awarenessWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (awarenessCount >= 4) {
            insights.push({
                icon: 'üëÅÔ∏è',
                text: 'Je ontwikkelt interoceptieve bewustwording - het vermogen om je lichamelijke sensaties waar te nemen zonder direct te oordelen. Dit is een kernvaardigheid bij hyperventilatie.',
                evidenceBase: 'Interoceptieve exposure therapie voor paniekaandoeningen'
            });
        }
        
        // PRINCIPLE 3: Catastrophic misinterpretation patterns
        const catastrophicWords = ['eng', 'gevaarlijk', 'verkeerd', 'fout', 'bang', 'paniek', 'bezorgd', 'angstig'];
        const balancedWords = ['normaal', 'gewoon', 'ok√©', 'logisch', 'begrijpelijk', 'tijdelijk'];
        
        const catastrophicCount = catastrophicWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        const balancedCount = balancedWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (balancedCount > catastrophicCount && balancedCount >= 2) {
            insights.push({
                icon: 'üß†',
                text: 'Je toont cognitieve herstructurering - je interpreteert lichamelijke sensaties steeds meer als normale fenomenen in plaats van bedreigingen.',
                evidenceBase: 'Cognitieve herstructurering volgens Beck\'s CBT model'
            });
        } else if (catastrophicCount >= 3) {
            insights.push({
                icon: 'üí≠',
                text: 'Je notities bevatten woorden die duiden op catastrofale interpretaties. Probeer je lichaamssensaties te observeren als informatief, niet als gevaarlijk.',
                evidenceBase: 'Behandeling van catastrofale misinterpretaties (Clark, 1986)'
            });
        }
        
        // PRINCIPLE 4: Graded exposure and tolerance building
        const toleranceWords = ['doorstaan', 'volhouden', 'blijven', 'accepteren', 'toelaten', 'laten'];
        const avoidanceWords = ['stoppen', 'vluchten', 'vermijden', 'niet', 'geen'];
        
        const toleranceCount = toleranceWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        const avoidanceCount = avoidanceWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (toleranceCount >= 2) {
            insights.push({
                icon: 'üí™',
                text: 'Je toont distress tolerantie - de vaardigheid om ongemak te doorstaan zonder te vluchten. Dit bouwt vertrouwen op dat sensaties voorbijgaan.',
                evidenceBase: 'Distress tolerantie uit Dialectische Gedragstherapie'
            });
        }
        
        // PRINCIPLE 5: Process vs outcome focus
        const processWords = ['proces', 'leren', 'oefenen', 'ontwikkelen', 'groeien', 'bouwen', 'stap'];
        const outcomeWords = ['resultaat', 'beter', 'genezen', 'weg', 'klaar', 'af'];
        
        const processCount = processWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (processCount >= 3) {
            insights.push({
                icon: 'üå±',
                text: 'Je focust op het leerproces - dit is essentieel bij chronische hyperventilatie. Verandering gebeurt geleidelijk door consistent oefenen.',
                evidenceBase: 'Procesfocus verhoogt therapiesucces bij ademhalingsstoornissen'
            });
        }
        
        // PRINCIPLE 6: Self-efficacy and mastery experiences
        const masteryWords = ['lukt', 'kan', 'succesvol', 'goed', 'beter', 'verbeterd', 'gelukt', 'controle'];
        const helplessnessWords = ['lukt niet', 'kan niet', 'hopeloos', 'nutteloos', 'geen zin'];
        
        const masteryCount = masteryWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (masteryCount >= 4) {
            insights.push({
                icon: 'üéñÔ∏è',
                text: 'Je bouwt self-efficacy op - het vertrouwen dat je je ademhaling kunt be√Ønvloeden. Deze mastery experiences versterken je herstel.',
                evidenceBase: 'Self-efficacy theorie van Bandura toegepast op ademhalingsstoornissen'
            });
        }
        
        // PRINCIPLE 7: Emotional regulation patterns
        const emotionWords = ['rustig', 'kalm', 'ontspannen', 'gefrustreerd', 'boos', 'verdrietig', 'blij'];
        const regulationWords = ['adem', 'rustig', 'kalm', 'ontspan', 'focus'];
        
        const emotionCount = emotionWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        const regulationCount = regulationWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (emotionCount >= 3 && regulationCount >= 2) {
            insights.push({
                icon: 'üåä',
                text: 'Je gebruikt ademhaling als emotieregulatietechniek. Dit helpt je autonome zenuwstelsel te kalmeren en stressresponsen te moduleren.',
                evidenceBase: 'Ademhaling als emotieregulatie strategie in moderne psychotherapie'
            });
        }
        
        // PRINCIPLE 8: Mindfulness and present-moment awareness
        const mindfulnessWords = ['nu', 'moment', 'aanwezig', 'hier', 'focus', 'aandacht', 'bewust'];
        const ruminationWords = ['altijd', 'nooit', 'steeds', 'constant', 'waarom', 'als'];
        
        const mindfulnessCount = mindfulnessWords.reduce((count, word) => 
            count + (allNotesText.split(word).length - 1), 0);
        
        if (mindfulnessCount >= 4) {
            insights.push({
                icon: 'üßò',
                text: 'Je toont mindful awareness - aandacht voor het huidige moment. Dit doorbreekt ruminatieve denkpatronen die hyperventilatie kunnen triggeren.',
                evidenceBase: 'Mindfulness-based interventies voor ademhalingsstoornissen'
            });
        }
        
        return insights;
    }

    function generateInsights() {
        const insightsContainer = document.getElementById('insights-content');
        
        if (allJournalEntries.length === 0) {
            insightsContainer.innerHTML = '<p style="color: var(--text-light);">Start met je eerste oefening om persoonlijke inzichten te ontvangen!</p>';
            return;
        }
        
        const insights = generateDetailedInsights();
        insightsContainer.innerHTML = insights;
    }

    // IMPROVED: Evidence-based insights focusing on therapeutic progress
    function generateDetailedInsights() {
        const recentEntries = allJournalEntries.slice(0, 20);
        const allTimeEntries = allJournalEntries;
        let insights = [];
        
        // INSIGHT 1: Long-term progress patterns (not immediate results)
        if (allTimeEntries.length >= 10) {
            const earlyEntries = allTimeEntries.slice(-10); // First 10 entries
            const laterEntries = allTimeEntries.slice(0, 10); // Last 10 entries
            
            const earlyAvg = earlyEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / earlyEntries.length;
            const laterAvg = laterEntries.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / laterEntries.length;
            
            if (laterAvg > earlyAvg + 0.5) {
                insights.push(`üå± <strong>Langetermijn verbetering</strong>: Je gemiddelde verbetering per sessie is toegenomen van ${earlyAvg.toFixed(1)} naar ${laterAvg.toFixed(1)} punten. Dit toont dat je ademhalingsvaardigheden zich geleidelijk ontwikkelen.`);
            }
        }
        
        // INSIGHT 2: Consistency and therapeutic engagement
        const uniqueDays = new Set(allTimeEntries.map(e => e.timestamp.toDateString())).size;
        const daysSinceFirst = allTimeEntries.length > 0 ? 
            Math.ceil((new Date() - allTimeEntries[allTimeEntries.length - 1].timestamp) / (1000 * 60 * 60 * 24)) : 0;
        
        if (daysSinceFirst > 7) {
            const consistencyRate = uniqueDays / daysSinceFirst;
            if (consistencyRate > 0.4) {
                insights.push(`‚≠ê <strong>Uitstekende therapietrouw</strong>: Je hebt ${uniqueDays} van de laatste ${daysSinceFirst} dagen geoefend (${(consistencyRate * 100).toFixed(0)}%). Deze consistentie is cruciaal voor neuroplasticiteit en het hertrainen van ademhalingspatronen.`);
            } else if (consistencyRate < 0.2) {
                insights.push(`üìÖ <strong>Regelmat verbetert effectiviteit</strong>: Dagelijkse korte oefeningen (5-10 min) zijn effectiever dan sporadische lange sessies voor het hertrainen van automatische ademhalingspatronen.`);
            }
        }
        
        // INSIGHT 3: Technique mastery and learning progression
        const techniqueStats = {};
        allTimeEntries.forEach(entry => {
            const technique = entry.techniekGebruikt;
            const improvement = entry.intensiteitVoor - entry.intensiteitNa;
            
            if (!techniqueStats[technique]) {
                techniqueStats[technique] = { 
                    total: 0, 
                    totalImprovement: 0, 
                    recent: [], 
                    early: []
                };
            }
            
            techniqueStats[technique].total++;
            techniqueStats[technique].totalImprovement += improvement;
            
            // Track recent vs early performance
            if (techniqueStats[technique].total <= 5) {
                techniqueStats[technique].early.push(improvement);
            }
            if (allTimeEntries.indexOf(entry) < 10) {
                techniqueStats[technique].recent.push(improvement);
            }
        });
        
        const techniques = Object.keys(techniqueStats).filter(t => techniqueStats[t].total >= 5);
        if (techniques.length > 0) {
            techniques.forEach(technique => {
                const stats = techniqueStats[technique];
                if (stats.recent.length >= 3 && stats.early.length >= 3) {
                    const recentAvg = stats.recent.reduce((sum, val) => sum + val, 0) / stats.recent.length;
                    const earlyAvg = stats.early.reduce((sum, val) => sum + val, 0) / stats.early.length;
                    
                    if (recentAvg > earlyAvg + 0.5) {
                        insights.push(`üìö <strong>Techniek verbetering</strong>: Je ${technique} vaardigheid is toegenomen. Dit toont motorisch leren - je zenuwstelsel past zich aan de nieuwe ademhalingspatronen aan.`);
                    }
                }
            });
        }
        
        // INSIGHT 4: Trigger pattern recognition and self-awareness
        const triggerAnalysis = {};
        allTimeEntries.filter(e => e.trigger && e.trigger.trim().length > 2).forEach(entry => {
            const trigger = entry.trigger.toLowerCase().trim();
            if (!triggerAnalysis[trigger]) {
                triggerAnalysis[trigger] = {
                    count: 0,
                    totalImprovement: 0,
                    avgBefore: 0
                };
            }
            triggerAnalysis[trigger].count++;
            triggerAnalysis[trigger].totalImprovement += (entry.intensiteitVoor - entry.intensiteitNa);
            triggerAnalysis[trigger].avgBefore += entry.intensiteitVoor;
        });
        
        const significantTriggers = Object.keys(triggerAnalysis).filter(t => triggerAnalysis[t].count >= 3);
        if (significantTriggers.length > 0) {
            const mostFrequentTrigger = significantTriggers.reduce((a, b) => 
                triggerAnalysis[a].count > triggerAnalysis[b].count ? a : b);
            
            insights.push(`üéØ <strong>Zelfkennis ontwikkeling</strong>: Je hebt "${mostFrequentTrigger}" ${triggerAnalysis[mostFrequentTrigger].count} keer ge√Ødentificeerd als trigger. Deze bewustwording helpt bij het ontwikkelen van preventieve strategie√´n.`);
        }
        
        // INSIGHT 5: Sensory awareness and interoceptive accuracy
        const sensationTracking = {};
        allTimeEntries.forEach(entry => {
            const sensations = entry.sensaties || entry.symptomen || [];
            sensations.forEach(sensation => {
                if (!sensationTracking[sensation]) {
                    sensationTracking[sensation] = {
                        count: 0,
                        improvements: []
                    };
                }
                sensationTracking[sensation].count++;
                sensationTracking[sensation].improvements.push(entry.intensiteitVoor - entry.intensiteitNa);
            });
        });
        
        const frequentSensations = Object.keys(sensationTracking).filter(s => sensationTracking[s].count >= 5);
        if (frequentSensations.length > 0) {
            const topSensation = frequentSensations.reduce((a, b) => 
                sensationTracking[a].count > sensationTracking[b].count ? a : b);
            
            insights.push(`üîç <strong>Interoceptieve training</strong>: Je monitort "${topSensation}" consequent (${sensationTracking[topSensation].count}x). Het bijhouden van lichamelijke sensaties verbetert je interoceptieve accuraatheid.`);
        }
        
        // INSIGHT 6: CP progression and physiological adaptation
        if (allCPMeasurements.length >= 5) {
            const sortedCP = [...allCPMeasurements].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const firstThree = sortedCP.slice(0, 3);
            const lastThree = sortedCP.slice(-3);
            
            const firstAvg = firstThree.reduce((sum, cp) => sum + cp.score, 0) / firstThree.length;
            const lastAvg = lastThree.reduce((sum, cp) => sum + cp.score, 0) / lastThree.length;
            
            if (lastAvg > firstAvg + 2) {
                insights.push(`üí® <strong>CO2 tolerantie verbetering</strong>: Je gemiddelde CP is gestegen van ${firstAvg.toFixed(1)}s naar ${lastAvg.toFixed(1)}s. Dit toont fysiologische aanpassing aan gezondere CO2 niveaus.`);
            }
        }
        
        // INSIGHT 7: Emotional regulation development
        const emotionalWords = {
            calm: ['rustig', 'kalm', 'ontspannen', 'vredig'],
            anxious: ['angstig', 'onrustig', 'gespannen', 'zenuwachtig'],
            frustrated: ['gefrustreerd', 'boos', 'ge√Ørriteerd'],
            confident: ['zelfverzekerd', 'controle', 'vertrouwen']
        };
        
        const meaningfulNotes = allTimeEntries.filter(e => e.notities && e.notities.trim().length > 10);
        if (meaningfulNotes.length >= 5) {
            const allNotes = meaningfulNotes.map(e => e.notities.toLowerCase()).join(' ');
            
            const calmCount = emotionalWords.calm.reduce((count, word) => 
                count + (allNotes.split(word).length - 1), 0);
            const anxiousCount = emotionalWords.anxious.reduce((count, word) => 
                count + (allNotes.split(word).length - 1), 0);
            
            if (calmCount > anxiousCount && calmCount >= 3) {
                insights.push(`üåä <strong>Emotieregulatie verbetering</strong>: Je notities bevatten meer woorden gerelateerd aan kalmte dan angst. Dit suggereert verbeterde emotionele zelfregulatie.`);
            }
        }
        
        // INSIGHT 13: Medication correlation analysis
        const entriesWithMeds = allTimeEntries.filter(e => e.medicationEvent);
        if (entriesWithMeds.length >= 5) {
            const medStarts = entriesWithMeds.filter(e => e.medicationEvent.action === 'started');
            const medStops = entriesWithMeds.filter(e => e.medicationEvent.action === 'stopped');
            
            // Analyze improvement before and after starting medication
            if (medStarts.length > 0) {
                const medName = medStarts[0].medicationEvent.name;
                const medStartDate = new Date(medStarts[0].timestamp);
                
                // Get entries before and after medication start
                const beforeMed = allTimeEntries.filter(e => new Date(e.timestamp) < medStartDate).slice(0, 10);
                const afterMed = allTimeEntries.filter(e => new Date(e.timestamp) >= medStartDate).slice(0, 10);
                
                if (beforeMed.length >= 3 && afterMed.length >= 3) {
                    const avgBeforeMed = beforeMed.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / beforeMed.length;
                    const avgAfterMed = afterMed.reduce((sum, e) => sum + (e.intensiteitVoor - e.intensiteitNa), 0) / afterMed.length;
                    
                    if (avgAfterMed > avgBeforeMed + 0.5) {
                        insights.push(`üíä <strong>Medicatie correlatie</strong>: Sinds start ${medName} is je gemiddelde verbetering toegenomen van ${avgBeforeMed.toFixed(1)} naar ${avgAfterMed.toFixed(1)} punten. Blijf dit monitoren met je arts.`);
                    } else if (avgAfterMed < avgBeforeMed - 0.5) {
                        insights.push(`üíä <strong>Medicatie observatie</strong>: Je gemiddelde verbetering is ${avgBeforeMed.toFixed(1)} ‚Üí ${avgAfterMed.toFixed(1)} sinds ${medName}. Bespreek dit patroon met je arts.`);
                    }
                }
            }
            
            // Track medication changes
            if (userStats.medicationEvents.length >= 3) {
                const recentEvents = userStats.medicationEvents.slice(-5);
                const uniqueMeds = new Set(recentEvents.map(e => e.name.toLowerCase()));
                
                if (uniqueMeds.size >= 3) {
                    insights.push(`üíä <strong>Medicatie monitoring</strong>: Je hebt ${userStats.medicationEvents.length} medicatie events gelogd. Deze data helpt bij het analyseren van langetermijn patronen.`);
                }
            }
        }
        
        // INSIGHT 14: Active medication tracking
        if (userStats.activeMedications.length > 0) {
            const longTermMeds = userStats.activeMedications.filter(med => {
                const duration = (new Date() - new Date(med.startedAt)) / (1000 * 60 * 60 * 24);
                return duration >= 30;
            });
            
            if (longTermMeds.length > 0) {
                const medName = longTermMeds[0].name;
                const duration = Math.floor((new Date() - new Date(longTermMeds[0].startedAt)) / (1000 * 60 * 60 * 24));
                insights.push(`üìÖ <strong>Langetermijn medicatie</strong>: Je gebruikt ${medName} al ${duration} dagen. Overweeg met je arts te bespreken of deze medicatie nog nodig is gezien je voortgang.`);
            }
        }
        
        if (insights.length === 0) {
            insights.push('üìä Blijf regelmatig oefenen en je ervaringen bijhouden. Betekenisvolle patronen worden zichtbaar na 2-4 weken consistent gebruik.');
        }
        
        // Limit to 5 most relevant insights (increased from 4)
        const selectedInsights = insights.slice(0, 5);
        
        return selectedInsights.map(insight => `<p>${insight}</p>`).join('');
    }

    function createProgressChart() {
        if (!currentUser || allJournalEntries.length === 0) return;
        
        const ctx = document.getElementById('progress-chart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (progressChart) {
            progressChart.destroy();
        }
        
        // Filter data based on current chart filter
        let filteredEntries = [...allJournalEntries];
        const now = new Date();
        
        if (chartFilter === '10days') {
            const tenDaysAgo = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000);
            filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= tenDaysAgo);
        } else if (chartFilter === '30days') {
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            filteredEntries = allJournalEntries.filter(entry => entry.timestamp >= thirtyDaysAgo);
        }
        
        // Sort by timestamp (oldest first for chart)
        filteredEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Take last 50 entries to keep chart readable (for 'all' filter)
        const chartEntries = chartFilter === 'all' ? filteredEntries.slice(-50) : filteredEntries;
        
        // Prepare data with actual dates
        const chartData = chartEntries.map((entry) => ({
            date: entry.timestamp.toLocaleDateString('nl-BE', { 
                day: '2-digit', 
                month: '2-digit' 
            }),
            fullDate: entry.timestamp.toLocaleDateString('nl-BE'),
            voor: entry.intensiteitVoor,
            na: entry.intensiteitNa,
            verbetering: entry.intensiteitVoor - entry.intensiteitNa,
            technique: entry.techniekGebruikt,
            cpScore: entry.cpScore || null
        }));
        
        // Prepare CP measurements data aligned with chart entries
        const cpData = chartData.map(d => d.cpScore);
        const hasCPData = cpData.some(cp => cp !== null && cp !== undefined);
        
        devLog('Chart data prepared:', { entries: chartData.length, hasCPData });
        
        // Determine chart title based on filter
        let chartTitle = 'Voortgang Over Tijd';
        if (chartFilter === '10days') {
            chartTitle = 'Voortgang Laatste 10 Dagen';
        } else if (chartFilter === '30days') {
            chartTitle = 'Voortgang Laatste 30 Dagen';
        }
        
        progressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => d.date),
                datasets: [
                    {
                        label: 'Voor sessie',
                        data: chartData.map(d => d.voor),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Na sessie',
                        data: chartData.map(d => d.na),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Verbetering',
                        data: chartData.map(d => d.verbetering),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        type: 'bar',
                        yAxisID: 'y1',
                        barThickness: 20
                    },
                    ...(hasCPData ? [{
                        label: 'Control Pause (CP)',
                        data: cpData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        yAxisID: 'y2',
                        spanGaps: true,
                        borderDash: [5, 5]
                    }] : [])
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartTitle,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return chartData[index].fullDate;
                            },
                            afterTitle: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return `Techniek: ${chartData[index].technique}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Datum'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Intensiteit (1-10)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Verbetering'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    },
                    ...(hasCPData ? {
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'CP (seconden)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                beginAtZero: true,
                                max: 60
                            }
                        }
                    } : {})
                }
            }
        });
        
        // Update button active states
        document.getElementById('chart-10days').classList.remove('active');
        document.getElementById('chart-30days').classList.remove('active');
        document.getElementById('chart-all').classList.remove('active');
        document.getElementById(`chart-${chartFilter}`).classList.add('active');
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    window.updateChartFilter = function(filter) {
        chartFilter = filter;
        createProgressChart();
    };

    window.updateRangeValue = function(sliderId, valueId) {
        const slider = document.getElementById(sliderId);
        const valueElement = document.getElementById(valueId);
        valueElement.textContent = slider.value;
        
        // Update position of value indicator
        const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        valueElement.style.left = percent + '%';
    };

    window.toggleSymptom = function(element) {
        const checkbox = element.querySelector('.symptom-checkbox');
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('selected', checkbox.checked);
    };

    function showUserMessage(message, type = 'info') {
        // Remove existing messages
        document.querySelectorAll('.message').forEach(msg => msg.remove());
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.textContent = message;
        
        // Add click to dismiss
        messageEl.style.cursor = 'pointer';
        messageEl.addEventListener('click', () => {
            messageEl.remove();
        });
        
        document.body.appendChild(messageEl);
        
        // Auto remove after different durations based on type
        const duration = type === 'error' ? 8000 : type === 'warning' ? 6000 : 5000;
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.remove();
            }
        }, duration);
        
        // Log to console for debugging
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // ============================================
    // EVENT LISTENERS & INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Initializing Ademruimte app...');
        
        showLoadingScreen();
        
        // Bot-protected email initialization
        initializeEmails();
        
        // Setup tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                showTab(tab);
            });
        });
        
        // Setup login form handlers
        document.getElementById('login-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });
        
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });
        
        // Setup register form handlers
        document.getElementById('register-password-confirm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerUser();
        });
        
        // Setup password reset form handler
        document.getElementById('reset-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') resetPassword();
        });
        
        // Setup range sliders
        document.getElementById('entry-before').addEventListener('input', (e) => {
            updateRangeValue('entry-before', 'before-value');
        });
        
        document.getElementById('entry-after').addEventListener('input', (e) => {
            updateRangeValue('entry-after', 'after-value');
        });
        
        // Setup technique selector for CP score field
        document.getElementById('entry-technique').addEventListener('change', (e) => {
            const cpGroup = document.getElementById('cp-score-group');
            if (e.target.value === 'Buteyko Ademhaling') {
                cpGroup.style.display = 'block';
            } else {
                cpGroup.style.display = 'none';
            }
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('journal-modal');
            if (e.target === modal) {
                closeJournalModal();
            }
        });
        
        // Initialize Firebase
        try {
            await initFirebase();
            console.log('‚úÖ Ademruimte app initialization completed successfully');
            
            // Initialize resonant breathing canvas
            initResonantCanvas();
            console.log('‚úÖ Resonant breathing canvas initialized');
            
            // Ensure login form is shown by default
            showLoginForm();
            
        } catch (error) {
            console.error('‚ùå App initialization failed:', error);
            updateStatusIndicator('error');
            showUserMessage('App initialisatie mislukt. Herlaad de pagina.', 'error');
            showLoginScreen();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (breathInterval) clearInterval(breathInterval);
        if (cpInterval) clearInterval(cpInterval);
        if (crisisInterval) clearInterval(crisisInterval);
        if (crisisProtocolActive) stopCrisisProtocol();
        if (progressChart) progressChart.destroy();
        if (resonantAnimationId) cancelAnimationFrame(resonantAnimationId);
        
        // Release wake lock
        releaseWakeLock();
    });

    // ============================================
    // DEBUG FUNCTIONS
    // ============================================

    // Enhanced debugging function
    function debugBreathingSession() {
        console.log('=== BREATHING SESSION STATE ===');
        console.log('isBreathing:', isBreathing);
        console.log('breathingPattern:', breathingPattern);
        console.log('breathCycleCount:', breathCycleCount);
        
        const cycleElement = document.getElementById('cycle-count');
        console.log('Cycle count element:', cycleElement);
        console.log('Cycle count text:', cycleElement ? cycleElement.textContent : 'NOT FOUND');
        
        const pattern = getBreathingPattern(breathingPattern);
        console.log('Current pattern:', pattern);
        console.log('Target cycles:', pattern ? pattern.cycles : 'UNDEFINED');
        
        console.log('Recent CP scores:', recentCPScores);
        console.log('Latest CP score:', latestCPScore);
        console.log('Last CP timestamp:', lastCPTimestamp);
    }

    // Add debug button for localhost/development
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1') || window.location.hostname.includes('192.168')) {
        document.addEventListener('DOMContentLoaded', () => {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = 'üêõ Debug';
            debugBtn.style.cssText = 'position:fixed;top:10px;left:10px;z-index:9999;background:red;color:white;border:none;padding:5px;border-radius:3px;font-size:12px;';
            debugBtn.onclick = debugBreathingSession;
            document.body.appendChild(debugBtn);
        });
    }

    console.log('üîß Ademruimte bug fixes loaded successfully');
    console.log('üì± Ademruimte app loaded successfully');
</script>

<!-- Cookie Consent Banner -->
<div id="cookie-banner" class="cookie-banner" style="display: none;">
    <div class="cookie-content">
        <div class="cookie-text">
            <h3>üç™ Cookies & Privacy</h3>
            <p>
                We gebruiken essenti√´le cookies voor login en app functionaliteit. 
                Door verder te gaan stem je in met ons gebruik van cookies. 
                Lees ons <a href="privacy-policy.html" target="_blank">privacybeleid</a> voor meer informatie.
            </p>
        </div>
        <div class="cookie-buttons">
            <button onclick="acceptCookies()" class="btn btn-primary">
                Accepteren
            </button>
            <button onclick="acceptEssentialOnly()" class="btn btn-secondary">
                Alleen essenti√´le
            </button>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-links">
            <a href="privacy-policy.html" target="_blank">Privacybeleid</a>
            <span style="color: #d1d5db;">¬∑</span>
            <a href="#" id="footer-email-link" onclick="location.href=atob('bWFpbHRvOnRyb29zdGJlcmdAZ21haWwuY29t'); return false;">Contact</a>
            <span style="color: #d1d5db;">¬∑</span>
            <a href="#" onclick="event.preventDefault(); manageCookieConsent();">Cookies</a>
        </div>
        <div class="footer-info">
            <p>¬© 2026 Ademruimte ¬∑ Geen vervanging voor medische zorg</p>
        </div>
    </div>
</footer>

</body>
</html>
